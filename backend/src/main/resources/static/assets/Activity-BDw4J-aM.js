import{_ as Ve,r as i,a as R,b0 as Te,S as he,b as Ee,o as Ce,d as q,e as x,h as g,f as t,w as r,v,m as l,l as j,aN as L,x as y,i as G,aK as Ue,j as p,k as H,T as O,U as w,g as J,y as K,A as _e,z as Z,aZ as ke,C as b,F as P,D as xe,H as Pe,a2 as ze,I as Ae,E as Q,b1 as W,ar as De,N as I,P as u,af as Me}from"./index-D-KotFfR.js";import{T as Be,E as Fe}from"./style-CweoS2Oz.js";import{g as Se,b as He,d as Ie,u as Ne,e as Ye}from"./activity-BF46yyu5.js";import"./request-D0VF7A5d.js";const $e={class:"activity-management-container"},Re={class:"page-header"},qe={key:0,class:"pagination-container"},je={style:{border:"1px solid #ccc"}},Le={class:"dialog-footer"},Ge={class:"dialog-footer"},Oe=["src"],Je={name:"ActivityManagement"},Ke=Object.assign(Je,{setup(Ze){const z=i(!1),A=i([]),D=i(0),T=i(1),C=i(10),h=R({keyword:"",status:null}),V=i(!1),M=i("发布活动"),U=i(!1),_=i(!1),k=i(!1),B=i(!1),f=i(null),s=i({id:null,title:"",location:"",startTime:null,endTime:null,description:"",posterUrl:"",status:1}),c=i([]),F=i(!1),N=i(""),X=i("/activities/poster/upload"),ee=i({Authorization:`Bearer ${Te()}`}),m=he(),le={},te={placeholder:"请输入活动详情..."},ae=a=>{m.value=a};Ee(()=>{const a=m.value;a!=null&&a.destroy()});const oe=(a,e)=>{var n;a.code===200&&((n=a.data)!=null&&n.url)?(s.value.posterUrl=a.data.url,c.value=[{name:e.name,url:a.data.url}],u.success("封面上传成功")):(u.error(a.message||"封面上传失败"),c.value=[])},re=(a,e)=>{s.value.posterUrl="",c.value=[]},se=a=>{N.value=a.url||s.value.posterUrl,F.value=!0},ie=a=>["image/jpeg","image/png","image/gif"].includes(a.type)?a.size/1024/1024>2?(u.error("封面图片大小不能超过 2MB!"),!1):!0:(u.error("封面图片只支持 JPG/PNG/GIF 格式!"),!1),ue=a=>{console.error("上传错误",a),u.error("上传失败")},ne=R({title:[{required:!0,message:"请输入活动标题",trigger:"blur"}],location:[{required:!0,message:"请输入活动地点",trigger:"blur"}],startTime:[{required:!0,message:"请选择开始时间",trigger:"change"}],endTime:[{required:!0,message:"请选择结束时间",trigger:"change"},{validator:(a,e,n)=>{s.value.startTime&&e&&new Date(e)<=new Date(s.value.startTime)?n(new Error("结束时间必须晚于开始时间")):n()},trigger:"change"}],description:[{required:!0,message:"请输入活动描述",trigger:"blur"},{validator:(a,e,n)=>{const d=m.value;d&&d.isEmpty()?n(new Error("请输入活动描述")):n()},trigger:"blur"}],status:[{required:!0,message:"请设置活动状态",trigger:"change"}]}),de=()=>{f.value&&f.value.resetFields(),s.value={id:null,title:"",location:"",startTime:null,endTime:null,description:"",posterUrl:"",status:1},c.value=[],_.value=!1,k.value=!1},E=async()=>{z.value=!0;try{const a={page:T.value,size:C.value,...h},e=await Se(a);A.value=e.data.records||[],D.value=e.data.total||0}catch(a){console.error("获取活动列表失败",a),u.error("获取活动列表失败")}finally{z.value=!1}},Y=()=>{T.value=1,E()},ve=a=>{C.value=a,T.value=1,E()},pe=a=>{T.value=a,E()},me=()=>{_.value=!1,M.value="发布活动",s.value={id:null,title:"",location:"",startTime:null,endTime:null,description:"",posterUrl:"",status:1},c.value=[],f.value&&f.value.clearValidate(),m.value&&m.value.setHtml(""),V.value=!0},fe=async a=>{_.value=!0,M.value="编辑活动",k.value=!0,s.value={id:null,title:"",location:"",startTime:null,endTime:null,description:"",posterUrl:"",status:1},c.value=[],f.value&&f.value.clearValidate(),V.value=!0;try{const e=await He(a.id);s.value={...e.data},s.value.posterUrl&&(c.value=[{name:"封面图",url:s.value.posterUrl}]),m.value&&m.value.setHtml(s.value.description||"")}catch(e){console.error("获取活动详情失败",e),u.error("获取活动详情失败"),V.value=!1}finally{k.value=!1}},ce=a=>{Me.confirm(`确定要删除活动 ${a.title} 吗?`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await Ie(a.id),u.success("删除成功"),E()}catch(e){console.error("删除活动失败",e),u.error("删除活动失败")}}).catch(()=>{u.info("已取消删除")})},ge=async a=>{U.value=!0,u.info(`查看活动 ${a.title} 报名情况功能待实现`)},ye=()=>{f.value.validate(async a=>{var e,n;if(a){B.value=!0;try{const d=m.value;if(!d)throw new Error("编辑器未初始化");const o={...s.value,description:d.getHtml()};_.value?(await Ne(o.id,o),u.success("活动更新成功")):(await Ye(o),u.success("活动发布成功")),V.value=!1,E()}catch(d){console.error("提交活动失败",d),u.error(((n=(e=d==null?void 0:d.response)==null?void 0:e.data)==null?void 0:n.message)||"提交活动失败")}finally{B.value=!1}}else return console.log("活动表单验证失败"),!1})},we=a=>{const e={1:"报名中",2:"进行中",3:"已结束",0:"已取消"};return e[a]!==void 0?e[a]:"未知"},be=a=>({1:"success",2:"warning",3:"info",0:"danger"})[a]||"info",S=a=>{if(!a)return"-";try{return new Date(a).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})}catch{return a}};return Ce(()=>{E()}),(a,e)=>{const n=ke,d=Pe;return x(),q("div",$e,[g("div",Re,[e[16]||(e[16]=g("h2",null,"活动管理",-1)),t(l(y),{type:"primary",onClick:me},{default:r(()=>[t(l(j),null,{default:r(()=>[t(l(L))]),_:1}),e[15]||(e[15]=v(" 发布活动 "))]),_:1})]),t(l(J),{class:"filter-card"},{default:r(()=>[t(l(G),{inline:!0,model:h,onSubmit:Ue(Y,["prevent"])},{default:r(()=>[t(l(p),{label:"关键词"},{default:r(()=>[t(l(H),{modelValue:h.keyword,"onUpdate:modelValue":e[0]||(e[0]=o=>h.keyword=o),clearable:"",placeholder:"活动标题/地点",style:{width:"250px"}},null,8,["modelValue"])]),_:1}),t(l(p),{label:"状态"},{default:r(()=>[t(l(O),{modelValue:h.status,"onUpdate:modelValue":e[1]||(e[1]=o=>h.status=o),clearable:"",placeholder:"选择状态",style:{width:"120px"}},{default:r(()=>[t(l(w),{value:1,label:"报名中"}),t(l(w),{value:2,label:"进行中"}),t(l(w),{value:3,label:"已结束"}),t(l(w),{value:0,label:"已取消"})]),_:1},8,["modelValue"])]),_:1}),t(l(p),null,{default:r(()=>[t(l(y),{type:"primary",onClick:Y},{default:r(()=>e[17]||(e[17]=[v(" 查询 ")])),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),t(l(J),{class:"activity-list-card"},{default:r(()=>[K((x(),Z(n,{"table-data":A.value,data:A.value,style:{width:"100%"}},{default:r(()=>[t(l(b),{label:"活动标题","min-width":"200",prop:"title","show-overflow-tooltip":""}),t(l(b),{label:"活动地点",prop:"location",width:"150"}),t(l(b),{label:"开始时间",prop:"startTime",width:"180"},{default:r(o=>[v(P(S(o.row.startTime)),1)]),_:1}),t(l(b),{label:"结束时间",prop:"endTime",width:"180"},{default:r(o=>[v(P(S(o.row.endTime)),1)]),_:1}),t(l(b),{label:"报名人数",prop:"currentParticipants",width:"100"}),t(l(b),{label:"状态",prop:"status",width:"100"},{default:r(o=>[t(l(xe),{type:be(o.row.status)},{default:r(()=>[v(P(we(o.row.status)),1)]),_:2},1032,["type"])]),_:1}),t(l(b),{label:"发布时间",prop:"createTime",width:"180"},{default:r(o=>[v(P(S(o.row.createTime)),1)]),_:1}),t(l(b),{fixed:"right",label:"操作",width:"220"},{default:r(o=>[t(l(y),{size:"small",type:"success",onClick:$=>ge(o.row)},{default:r(()=>e[18]||(e[18]=[v(" 报名情况 ")])),_:2},1032,["onClick"]),t(l(y),{size:"small",type:"primary",onClick:$=>fe(o.row)},{default:r(()=>e[19]||(e[19]=[v(" 编辑 ")])),_:2},1032,["onClick"]),t(l(y),{size:"small",type:"danger",onClick:$=>ce(o.row)},{default:r(()=>e[20]||(e[20]=[v(" 删除 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["table-data","data"])),[[d,z.value]]),D.value>0?(x(),q("div",qe,[t(l(ze),{"current-page":T.value,"onUpdate:currentPage":e[2]||(e[2]=o=>T.value=o),"page-size":C.value,"onUpdate:pageSize":e[3]||(e[3]=o=>C.value=o),"page-sizes":[10,20,50,100],total:D.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ve,onCurrentChange:pe},null,8,["current-page","page-size","total"])])):_e("",!0)]),_:1}),t(l(I),{modelValue:V.value,"onUpdate:modelValue":e[11]||(e[11]=o=>V.value=o),"close-on-click-modal":!1,title:M.value,top:"5vh",width:"80%",onClose:de},{footer:r(()=>[g("span",Le,[t(l(y),{onClick:e[10]||(e[10]=o=>V.value=!1)},{default:r(()=>e[22]||(e[22]=[v("取消")])),_:1}),t(l(y),{loading:B.value,type:"primary",onClick:ye},{default:r(()=>e[23]||(e[23]=[v("确定")])),_:1},8,["loading"])])]),default:r(()=>[K((x(),Z(l(G),{ref_key:"activityFormRef",ref:f,model:s.value,rules:ne,"label-width":"100px"},{default:r(()=>[t(l(p),{label:"活动标题",prop:"title"},{default:r(()=>[t(l(H),{modelValue:s.value.title,"onUpdate:modelValue":e[4]||(e[4]=o=>s.value.title=o),placeholder:"请输入活动标题"},null,8,["modelValue"])]),_:1}),t(l(p),{label:"活动地点",prop:"location"},{default:r(()=>[t(l(H),{modelValue:s.value.location,"onUpdate:modelValue":e[5]||(e[5]=o=>s.value.location=o),placeholder:"请输入活动地点"},null,8,["modelValue"])]),_:1}),t(l(Ae),{gutter:20},{default:r(()=>[t(l(Q),{span:12},{default:r(()=>[t(l(p),{label:"开始时间",prop:"startTime"},{default:r(()=>[t(l(W),{modelValue:s.value.startTime,"onUpdate:modelValue":e[6]||(e[6]=o=>s.value.startTime=o),placeholder:"选择开始时间",style:{width:"100%"},type:"datetime","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1})]),_:1}),t(l(Q),{span:12},{default:r(()=>[t(l(p),{label:"结束时间",prop:"endTime"},{default:r(()=>[t(l(W),{modelValue:s.value.endTime,"onUpdate:modelValue":e[7]||(e[7]=o=>s.value.endTime=o),placeholder:"选择结束时间",style:{width:"100%"},type:"datetime","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(l(p),{label:"活动描述",prop:"description"},{default:r(()=>[g("div",je,[t(l(Be),{"default-config":le,editor:m.value,mode:"default",style:{"border-bottom":"1px solid #ccc"}},null,8,["editor"]),t(l(Fe),{modelValue:s.value.description,"onUpdate:modelValue":e[8]||(e[8]=o=>s.value.description=o),"default-config":te,mode:"default",style:{height:"300px","overflow-y":"hidden"},onOnCreated:ae},null,8,["modelValue"])])]),_:1}),t(l(p),{label:"封面图片",prop:"posterUrl"},{default:r(()=>[t(l(De),{action:X.value,"before-upload":ie,"file-list":c.value,headers:ee.value,limit:1,"on-error":ue,"on-preview":se,"on-remove":re,"on-success":oe,"show-file-list":!0,"list-type":"picture-card"},{tip:r(()=>e[21]||(e[21]=[g("div",{class:"el-upload__tip"}," 只能上传一张封面图，建议尺寸 750x300，大小不超过 2MB ",-1)])),default:r(()=>[t(l(j),null,{default:r(()=>[t(l(L))]),_:1})]),_:1},8,["action","file-list","headers"])]),_:1}),t(l(p),{label:"状态",prop:"status"},{default:r(()=>[t(l(O),{modelValue:s.value.status,"onUpdate:modelValue":e[9]||(e[9]=o=>s.value.status=o),placeholder:"设置活动状态"},{default:r(()=>[t(l(w),{value:1,label:"报名中"}),t(l(w),{value:2,label:"进行中"}),t(l(w),{value:3,label:"已结束"}),t(l(w),{value:0,label:"已取消"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])),[[d,k.value]])]),_:1},8,["modelValue","title"]),t(l(I),{modelValue:U.value,"onUpdate:modelValue":e[13]||(e[13]=o=>U.value=o),title:"活动报名情况",width:"60%"},{footer:r(()=>[g("span",Ge,[t(l(y),{onClick:e[12]||(e[12]=o=>U.value=!1)},{default:r(()=>e[24]||(e[24]=[v("关闭")])),_:1})])]),default:r(()=>[e[25]||(e[25]=g("p",null,"报名列表待实现...",-1))]),_:1},8,["modelValue"]),t(l(I),{modelValue:F.value,"onUpdate:modelValue":e[14]||(e[14]=o=>F.value=o)},{default:r(()=>[g("img",{src:N.value,alt:"Preview Image",style:{display:"block","max-width":"100%",margin:"0 auto"}},null,8,Oe)]),_:1},8,["modelValue"])])}}}),ll=Ve(Ke,[["__scopeId","data-v-e6e1a548"]]);export{ll as default};
