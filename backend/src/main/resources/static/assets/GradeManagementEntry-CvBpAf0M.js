import{_ as W,ad as X,u as j,r as u,c as J,o as Y,aW as Z,d as L,e as o,h as E,z as c,f as d,w as i,K as U,L as q,m as l,U as A,T as F,G as ee,y as ae,A as te,k as le,V as se,x as re,v as b,B as oe,C as g,aX as ne,D as S,F as ue,H as de,a2 as ie,g as ce,P as m}from"./index-B2T-xuoP.js";import{b as me}from"./course-C-HDut7x.js";import{r as ve,a as pe}from"./grade-ClhaH1VJ.js";import{b as fe}from"./formatters-COdykrJD.js";import{g as ge}from"./term-BB3--eF6.js";import"./request-CvcqSNCl.js";const ye={class:"grade-container"},he={class:"page-header"},we={class:"course-selector"},Ce={class:"filter-container"},be={__name:"GradeManagementEntry",setup(xe){const x=X(),M=j(),y=u(!1),I=u(!1),_=u([]),n=u(""),h=u([]),v=u(""),f=u([]),N=u(""),w=u(1),T=u(15),C=u(0),P=J(()=>{const a=N.value.toLowerCase();return a?f.value.filter(t=>{var s,e;return((s=t.student)==null?void 0:s.studentId)&&t.student.studentId.includes(a)||((e=t.student)==null?void 0:e.realName)&&t.student.realName.toLowerCase().includes(a)}):f.value}),$=async()=>{try{const a=await me();_.value=a.data||[]}catch(a){console.error("获取教师课程列表失败",a),m.error("获取教师课程列表失败")}},G=async()=>{I.value=!0;try{const a=await ge({sortByCreateDesc:!0});a.code===200&&Array.isArray(a.data)?(h.value=a.data,h.value.length>0&&(v.value=h.value[0].id,$())):m.error(a.message||"获取学期列表失败")}catch(a){console.error("获取学期列表失败:",a),m.error("获取学期列表失败")}finally{I.value=!1}},V=async()=>{var a,t;if(!n.value||!v.value){f.value=[],C.value=0;return}y.value=!0;try{const s={page:w.value,size:T.value,termId:v.value},e=await pe(n.value,s);f.value=(((a=e.data)==null?void 0:a.list)||[]).map(p=>({...p,changed:!1})),C.value=((t=e.data)==null?void 0:t.total)||0}catch(s){console.error("获取学生成绩列表失败",s),m.error("获取学生成绩列表失败"),f.value=[],C.value=0}finally{y.value=!1}},Q=a=>{a.changed=!0},B=async()=>{w.value=1,M.push({query:{...x.query,courseId:n.value}}),await V()},R=async()=>{w.value=1,await V()},H=a=>{w.value=a,V()},K=async()=>{var e,p,D;const a=f.value.filter(r=>r.changed);if(a.length===0){m.info("没有需要保存的修改");return}y.value=!0;let t=0,s=0;for(const r of a)try{const z={id:r.id,studentId:r.studentId,courseId:n.value,score:r.score},k=await ve(z);k.code===200&&k.data?(r.id=k.data.id||r.id,r.updateTime=new Date,r.changed=!1,t++):(s++,m.error(`保存 ${((e=r.student)==null?void 0:e.realName)||r.studentId} 成绩失败: ${k.message||"未知错误"}`))}catch(z){console.error(`保存学生 ${((p=r.student)==null?void 0:p.realName)||r.studentId} 成绩失败`,z),s++,m.error(`保存 ${((D=r.student)==null?void 0:D.realName)||r.studentId} 成绩失败`)}y.value=!1,s>0?m.warning(`${t}条成绩保存成功，${s}条保存失败，请检查`):m.success(`${t}条成绩保存成功`)},O=async()=>{await G(),await $();let a=x.query.courseId,t=x.query.termId,s=!1;t&&h.value.some(e=>e.id===t)?(v.value=t,s=!0):v.value&&(s=!0),a&&_.value.some(e=>e.id===a)&&(n.value=a,s=!0),s&&n.value&&v.value&&await V()};return Y(()=>{O()}),Z(()=>x.query.courseId,a=>{a&&a!==n.value&&_.value.some(t=>t.id===a)&&(n.value=a,B())}),(a,t)=>{const s=de;return o(),L("div",ye,[E("div",he,[t[3]||(t[3]=E("h2",null,"成绩管理",-1)),E("div",we,[d(l(F),{modelValue:v.value,"onUpdate:modelValue":t[0]||(t[0]=e=>v.value=e),placeholder:"选择学期",clearable:"",filterable:"",loading:I.value,style:{width:"200px","margin-right":"10px"},onChange:R},{default:i(()=>[(o(!0),L(U,null,q(h.value,e=>(o(),c(l(A),{key:e.id,label:e.termName,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"]),d(l(F),{modelValue:n.value,"onUpdate:modelValue":t[1]||(t[1]=e=>n.value=e),clearable:"",placeholder:"选择课程",style:{width:"220px"},onChange:B},{default:i(()=>[(o(!0),L(U,null,q(_.value,e=>(o(),c(l(A),{key:e.id,label:e.courseName,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),n.value?(o(),c(l(ce),{key:1,class:"grade-card"},{default:i(()=>[E("div",Ce,[d(l(le),{modelValue:N.value,"onUpdate:modelValue":t[2]||(t[2]=e=>N.value=e),"prefix-icon":l(se),clearable:"",placeholder:"搜索学号或姓名",style:{width:"250px","margin-right":"10px"}},null,8,["modelValue","prefix-icon"]),d(l(re),{link:"",type:"primary",onClick:K},{default:i(()=>t[4]||(t[4]=[b("保存所有修改")])),_:1})]),ae((o(),c(l(oe),{data:P.value,"empty-text":"暂无学生或成绩记录",style:{width:"100%"}},{default:i(()=>[d(l(g),{label:"学号",prop:"student.studentId",width:"150"}),d(l(g),{label:"姓名",prop:"student.realName",width:"120"}),d(l(g),{label:"班级",prop:"student.className",width:"180"}),d(l(g),{label:"成绩",width:"150"},{default:i(({row:e})=>[d(l(ne),{modelValue:e.score,"onUpdate:modelValue":p=>e.score=p,max:100,min:0,precision:1,step:1,size:"small",style:{width:"100px"},onChange:p=>Q(e)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),d(l(g),{label:"状态",width:"100"},{default:i(({row:e})=>[e.changed?(o(),c(l(S),{key:0,size:"small",type:"warning"},{default:i(()=>t[5]||(t[5]=[b("已修改")])),_:1})):e.id?(o(),c(l(S),{key:1,size:"small",type:"success"},{default:i(()=>t[6]||(t[6]=[b("已录入")])),_:1})):(o(),c(l(S),{key:2,size:"small",type:"info"},{default:i(()=>t[7]||(t[7]=[b("未录入")])),_:1}))]),_:1}),d(l(g),{label:"上次更新","min-width":"150"},{default:i(({row:e})=>[b(ue(l(fe)(e.updateTime)),1)]),_:1})]),_:1},8,["data"])),[[s,y.value]]),C.value>T.value?(o(),c(l(ie),{key:0,"current-page":w.value,"page-size":T.value,total:C.value,background:"",layout:"prev, pager, next, total",style:{"margin-top":"20px","text-align":"right"},onCurrentChange:H},null,8,["current-page","page-size","total"])):te("",!0)]),_:1})):(o(),c(l(ee),{key:0,description:"请选择一个课程进行成绩管理"}))])}}},Te=W(be,[["__scopeId","data-v-4ba6a6dc"]]);export{Te as default};
