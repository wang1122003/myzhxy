import{_ as se,u as le,r as m,a as U,o as re,n as ie,c as de,b as ce,d as h,e as f,f as o,w as a,E as ue,g as me,h as i,i as pe,j as fe,k as _e,l as ge,m as z,p as ve,q as ye,s as we,t as he,v as p,x as be,y as q,z as K,A as R,B as ke,C as Ee,D as Ce,F as b,G as Te,H as xe,I as Ne,J as Ve,K as Le,L as He,M as Ue,N as Re,O as Ie,P as _}from"./index-B2T-xuoP.js";/* empty css                   *//* empty css                   *//* empty css               *//* empty css                        */import{g as Be,a as De}from"./notice-Bm9D3gjc.js";import{l as Fe}from"./user-D4eBv3A5.js";import{d as $e}from"./file-6fcn3QKr.js";import{g as Me}from"./common-Dmk-JHZR.js";import"./request-CvcqSNCl.js";const Ae={class:"home-container"},je={class:"card-header"},Oe={key:0},Pe={class:"notice-content"},ze={class:"notice-info"},qe=["innerHTML"],Ke={key:0,class:"notice-attachments"},Se={class:"dialog-footer"},Ge={name:"HomePage"},Je=Object.assign(Ge,{setup(Qe){const g=le(),I=m(null),v=m([]),k=m(!1),N=m(!1),V=m(!1),y=m(!1),L=m(!1),E=U({}),B=m([]),S=m("400px"),d=U({id:null,title:"",publisher:"",publishTime:"",content:"",attachments:[]}),l=U({username:"",password:"",remember:!1}),G={username:[{required:!0,message:"请输入用户名",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"}]};re(async()=>{const t=localStorage.getItem("username");t&&(l.username=t,l.remember=!0),await Promise.all([J(),Q()]),ie(()=>{H()}),window.addEventListener("resize",H)});const J=async()=>{k.value=!0;try{const t=await Be();t.code===200||t.success===!0?v.value=Array.isArray(t.data)?t.data.slice(0,5):[]:(console.error("获取最近通知失败:",t.message),v.value=[])}catch(t){console.error("获取最近通知异常:",t),v.value=[]}finally{k.value=!1}},Q=async()=>{N.value=!0;try{const t=await Me();B.value=t.data||[]}catch(t){console.error("获取通知类型失败",t)}finally{N.value=!1}},D=de(()=>{const t={};return B.value.forEach(e=>{t[e.typeCode]={name:e.typeName,tag:e.tagType||"info"}}),t}),F=()=>{I.value.validate(async t=>{var e,u;if(t){V.value=!0;try{const n=await Fe({username:l.username,password:l.password});if(n&&n.code===200&&n.data){const r=Ie({token:n.data.token,user:n.data.user});l.remember?localStorage.setItem("username",l.username):localStorage.removeItem("username"),_.success("登录成功"),console.log("[HomePage] Redirecting based on role from authLogin:",r),r==="admin"?g.push("/admin/notice"):r==="teacher"?g.push("/teacher"):r==="student"?g.push("/student"):g.push("/")}else _.error((n==null?void 0:n.message)||"登录失败，请检查用户名或密码")}catch(n){console.error("登录请求失败:",n);const r=((u=(e=n==null?void 0:n.response)==null?void 0:e.data)==null?void 0:u.message)||(n==null?void 0:n.message);_.error(r||"登录请求失败")}finally{V.value=!1}}else return console.log("表单验证失败"),!1})},W=async t=>{L.value=!0,y.value=!0,d.id=null;try{const e=await De(t.id);Object.assign(d,e.data)}catch(e){console.error("获取通知详情失败",e),_.error("获取通知详情失败"),y.value=!1}finally{L.value=!1}},X=()=>{g.push("/notices")},$=t=>{if(!t)return"";try{return new Date(t).toLocaleString("zh-CN",{hour12:!1})}catch{return t}},Y=async t=>{if(!t||!t.id){_.warning("无效的文件信息");return}E[t.id]=!0;try{const e=await $e(t.id),u=e.headers["content-disposition"];let n=t.name;if(u){const w=u.match(/filename\*?=UTF-8''(.*)$/i)||u.match(/filename="(.*)"$/i);w&&w[1]&&(n=decodeURIComponent(w[1]))}const r=new Blob([e.data],{type:e.headers["content-type"]}),C=window.URL.createObjectURL(r),c=document.createElement("a");c.href=C,c.setAttribute("download",n),document.body.appendChild(c),c.click(),document.body.removeChild(c),window.URL.revokeObjectURL(C),_.success(`附件 ${n} 下载成功`)}catch(e){console.error("下载附件失败",e),_.error(`下载附件 ${t.name} 失败`)}finally{E[t.id]=!1}},H=()=>{const e=window.innerHeight-300;S.value=e>200?`${e}px`:"200px"};return ce(()=>{window.removeEventListener("resize",H)}),(t,e)=>{const u=ge,n=_e,r=fe,C=he,c=be,w=pe,M=me,A=ue,T=Ee,Z=Ce,ee=ke,te=Te,oe=Ne,j=Ve,ae=Ue,ne=Re,O=xe;return f(),h("div",Ae,[o(oe,{gutter:20},{default:a(()=>[o(A,{md:8,sm:24,xs:24,class:"login-col"},{default:a(()=>[o(M,{class:"login-card home-card"},{default:a(()=>[e[7]||(e[7]=i("div",{class:"login-header card-header"},[i("h2",null,"用户登录")],-1)),o(w,{ref_key:"loginFormRef",ref:I,model:l,rules:G,"label-width":"0"},{default:a(()=>[o(r,{prop:"username"},{default:a(()=>[o(n,{modelValue:l.username,"onUpdate:modelValue":e[0]||(e[0]=s=>l.username=s),clearable:"",placeholder:"用户名"},{prefix:a(()=>[o(u,null,{default:a(()=>[o(z(ve))]),_:1})]),_:1},8,["modelValue"])]),_:1}),o(r,{prop:"password"},{default:a(()=>[o(n,{modelValue:l.password,"onUpdate:modelValue":e[1]||(e[1]=s=>l.password=s),clearable:"",placeholder:"密码","show-password":"",type:"password",onKeyup:ye(F,["enter"])},{prefix:a(()=>[o(u,null,{default:a(()=>[o(z(we))]),_:1})]),_:1},8,["modelValue"])]),_:1}),o(r,null,{default:a(()=>[o(C,{modelValue:l.remember,"onUpdate:modelValue":e[2]||(e[2]=s=>l.remember=s)},{default:a(()=>e[5]||(e[5]=[p(" 记住用户名 ")])),_:1},8,["modelValue"])]),_:1}),o(r,null,{default:a(()=>[o(c,{loading:V.value,style:{width:"100%"},type:"primary",onClick:F},{default:a(()=>e[6]||(e[6]=[p(" 登 录 ")])),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),o(A,{md:16,sm:24,xs:24,class:"notice-col"},{default:a(()=>[q((f(),K(M,{class:"notice-card home-card"},{header:a(()=>[i("div",je,[e[9]||(e[9]=i("span",null,"通知公告",-1)),o(c,{link:"",type:"primary",onClick:X},{default:a(()=>e[8]||(e[8]=[p(" 查看全部 ")])),_:1})])]),default:a(()=>[o(ee,{data:v.value,style:{width:"100%"},"empty-text":" "},{default:a(()=>[o(T,{label:"标题",prop:"title","show-overflow-tooltip":""}),o(T,{label:"类型",prop:"type",width:"100"},{default:a(s=>{var x;return[o(Z,{type:((x=D.value[s.row.type])==null?void 0:x.tag)||"info"},{default:a(()=>{var P;return[p(b(((P=D.value[s.row.type])==null?void 0:P.name)||"其他"),1)]}),_:2},1032,["type"])]}),_:1}),o(T,{label:"发布时间",prop:"createTime",width:"180"},{default:a(s=>[p(b($(s.row.createTime)),1)]),_:1}),o(T,{label:"操作",width:"100"},{default:a(s=>[o(c,{link:"",type:"primary",onClick:x=>W(s.row)},{default:a(()=>e[10]||(e[10]=[p(" 查看 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"]),v.value.length===0&&!k.value?(f(),K(te,{key:0,description:"暂无通知公告"})):R("",!0)]),_:1})),[[O,k.value||N.value]])]),_:1})]),_:1}),o(ne,{modelValue:y.value,"onUpdate:modelValue":e[4]||(e[4]=s=>y.value=s),title:d.title,"append-to-body":"",top:"5vh",width:"60%"},{footer:a(()=>[i("span",Se,[o(c,{onClick:e[3]||(e[3]=s=>y.value=!1)},{default:a(()=>e[12]||(e[12]=[p("关 闭")])),_:1})])]),default:a(()=>[d.id?q((f(),h("div",Oe,[i("div",Pe,[i("div",ze,[i("span",null,"发布人："+b(d.publisher),1),i("span",null,"发布时间："+b($(d.publishTime)),1)]),o(j),i("div",{class:"notice-text",innerHTML:d.content},null,8,qe),d.attachments&&d.attachments.length?(f(),h("div",Ke,[o(j),e[11]||(e[11]=i("h4",null,"附件：",-1)),i("ul",null,[(f(!0),h(Le,null,He(d.attachments,s=>(f(),h("li",{key:s.id},[o(ae,{disabled:E[s.id],loading:E[s.id],type:"primary",onClick:x=>Y(s)},{default:a(()=>[p(b(s.name),1)]),_:2},1032,["disabled","loading","onClick"])]))),128))])])):R("",!0)])])),[[O,L.value]]):R("",!0)]),_:1},8,["modelValue","title"])])}}}),lt=se(Je,[["__scopeId","data-v-a16363ee"]]);export{lt as default};
