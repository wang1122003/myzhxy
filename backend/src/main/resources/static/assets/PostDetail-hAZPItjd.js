import{_ as b,a5 as $,a6 as ee,Z as te,$ as oe,Y as ae,a7 as le,R as D,d,e as r,h as a,f as t,w as l,v,l as ne,x as se,z as U,a3 as ie,K as M,A as E,F as u,D as re,a4 as ce,a8 as H,L as j,g as de,a9 as ue,aa as _e,ab as me,k as fe,ac as ve,G as he,ad as ke,u as pe,c as G,ae as ge,r as h,o as ye,P as _,af as Ce}from"./index-B2T-xuoP.js";/* empty css                         *//* empty css                  */import{e as we,f as Le,h as Te,z as Ee,j as q,k as Re,l as ze,m as Ie,n as Ne,o as De}from"./zh-CN-CcJggdWD.js";import"./request-CvcqSNCl.js";const xe={name:"PostDetail",components:{ArrowLeft:le,Star:ae,View:oe,ChatDotRound:te,ChatLineRound:ee,MoreFilled:$},setup(){const K=ke(),n=pe(),Y=ge(),e=G(()=>Y.userInfo||{}),C=G(()=>K.params.id),p=G(()=>!!localStorage.getItem("token")),k=h({}),f=h(!0),m=h(!1),P="/src/assets/default-avatar.png",w=h([]),g=h(""),L=h(!1),R=h(null),x=h(null),y=h(""),z=h(""),I=h(!1),N=async()=>{f.value=!0;try{const o=await we(C.value);k.value=o.data}catch(o){console.error("获取帖子详情失败:",o),_.error("获取帖子详情失败"),k.value={}}finally{f.value=!1}},T=async()=>{commentLoading.value=!0;try{const o=await Le(C.value,{page:commentPage.value,size:commentPageSize.value});w.value=o.data||[],w.value.forEach(c=>{c.likeLoading=!1,c.replies&&c.replies.forEach(X=>{X.likeLoading=!1})})}catch(o){console.error("获取评论失败:",o),_.error("获取评论失败"),w.value=[]}finally{commentLoading.value=!1}},A=()=>{n.push("/login")},B=async()=>{if(!p.value){_.warning("请先登录");return}m.value=!0;try{k.value.liked?(await Ne(C.value),k.value.liked=!1,k.value.likeCount--):(await De(C.value),k.value.liked=!0,k.value.likeCount++)}catch(o){console.error("点赞操作失败:",o),_.error("操作失败")}finally{m.value=!1}},S=async o=>{if(!p.value){_.warning("请先登录");return}o.likeLoading=!0;try{o.liked?(await Re(o.id),o.liked=!1,o.likeCount--):(await ze(o.id),o.liked=!0,o.likeCount++)}catch(c){console.error("点赞评论操作失败:",c),_.error("操作失败")}finally{o.likeLoading=!1}},F=async o=>{if(!Z(o)){_.warning("您没有权限删除此评论");return}try{await Ce.confirm("确定要删除这条评论吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Ie(o.id),_.success("评论已删除"),T()}catch(c){c!=="cancel"&&(console.error("删除评论失败:",c),_.error("删除评论失败"))}},s=async()=>{if(!p.value){_.warning("请先登录");return}if(!g.value.trim()){_.warning("评论内容不能为空");return}L.value=!0;try{await q({postId:C.value,content:g.value.trim()}),_.success("评论发表成功"),g.value="",T(),N()}catch(o){console.error("发表评论失败:",o),_.error("发表评论失败")}finally{L.value=!1}},i=(o,c=null)=>{if(!p.value){_.warning("请先登录");return}R.value=o.id,x.value=c||o,z.value=c?c.author?c.author.realName||c.author.username:c.authorName||"":o.author?o.author.realName||o.author.username:o.authorName||"",y.value=""},V=()=>{R.value=null,x.value=null,z.value="",y.value=""},J=async()=>{if(!p.value){_.warning("请先登录");return}if(!y.value.trim()){_.warning("回复内容不能为空");return}I.value=!0;try{await q({postId:C.value,parentId:R.value,replyToId:x.value.id,content:y.value.trim()}),_.success("回复发表成功"),V(),T(),N()}catch(o){console.error("发表回复失败:",o),_.error("发表回复失败")}finally{I.value=!1}},Z=o=>p.value&&(o.authorId===e.value.id||e.value.role==="admin"),O=o=>{if(!o)return"-";try{const c=new Date(o);return Te(c,new Date,{addSuffix:!0,locale:Ee})}catch{return o}},Q=()=>{n.push("/forum")},W=()=>{const o=document.getElementById("comments-section");o&&o.scrollIntoView({behavior:"smooth",block:"start"})};return ye(()=>{N(),T()}),{post:k,loading:f,likeLoading:m,comments:w,commentContent:g,submittingComment:L,replyingTo:R,replyContent:y,replyingToName:z,submittingReply:I,userInfo:e,isLoggedIn:p,defaultAvatar:P,goBack:Q,scrollToComments:W,handleLike:B,submitComment:s,canEditComment:Z,handleDeleteComment:F,handleLikeComment:S,handleReply:i,cancelReply:V,submitReply:J,formatTime:O,goToLogin:A}}},Ve={class:"post-detail-container"},Ae={class:"page-header"},Be={class:"post-detail-content"},Me={class:"post-header"},Pe={class:"post-title"},Se={key:0,class:"post-category"},Fe={class:"post-meta"},Ue={class:"post-author"},He={class:"author-info"},je={class:"author-name"},Ge={class:"post-time"},Ke={class:"post-actions"},Ye=["innerHTML"],Ze={key:0,class:"post-tags"},qe={class:"card-header"},Je={key:0,class:"no-comments"},Oe={key:1,class:"comment-list"},Qe={class:"comment-header"},We={class:"comment-author"},Xe={class:"author-info"},be={class:"author-name"},$e={class:"comment-time"},et={key:0,class:"comment-actions"},tt={class:"comment-content"},ot={class:"comment-footer"},at={key:0,class:"sub-comments"},lt={class:"comment-header"},nt={class:"comment-author"},st={class:"author-info"},it={class:"author-name"},rt={key:0,class:"reply-to"},ct={class:"comment-time"},dt={key:0,class:"comment-actions"},ut={class:"comment-content"},_t={class:"comment-footer"},mt={key:1,class:"reply-box"},ft={class:"reply-actions"},vt={key:2,class:"comment-form"},ht={class:"comment-submit"},kt={key:3,class:"login-hint"},pt={class:"login-action"};function gt(K,n,Y,e,C,p){const k=D("ArrowLeft"),f=ne,m=se,P=ie,w=re,g=ce,L=D("Star"),R=D("View"),x=D("ChatDotRound"),y=de,z=D("MoreFilled"),I=me,N=_e,T=ue,A=D("ChatLineRound"),B=fe,S=ve,F=he;return r(),d("div",Ve,[a("div",Ae,[t(m,{link:"",onClick:e.goBack},{default:l(()=>[t(f,null,{default:l(()=>[t(k)]),_:1}),n[2]||(n[2]=v(" 返回论坛 "))]),_:1},8,["onClick"])]),a("div",Be,[e.loading?(r(),U(P,{key:0,rows:15,animated:""})):e.post.id?(r(),d(M,{key:1},[t(y,{class:"post-card"},{default:l(()=>[a("div",Me,[a("div",Pe,[a("h1",null,u(e.post.title),1),e.post.category?(r(),d("div",Se,[t(w,{size:"small"},{default:l(()=>[v(u(e.post.category),1)]),_:1})])):E("",!0)]),a("div",Fe,[a("div",Ue,[t(g,{size:40,src:e.post.avatar||e.defaultAvatar},null,8,["src"]),a("div",He,[a("div",je,u(e.post.author?e.post.author.realName||e.post.author.username:e.post.authorName),1),a("div",Ge,u(e.formatTime(e.post.createTime)),1)])]),a("div",Ke,[t(m,{class:H({"active-like":e.post.liked}),loading:e.likeLoading,link:"",onClick:e.handleLike},{default:l(()=>[t(f,null,{default:l(()=>[t(L)]),_:1}),a("span",null,u(e.post.likeCount||0),1)]),_:1},8,["class","loading","onClick"]),t(m,{link:""},{default:l(()=>[t(f,null,{default:l(()=>[t(R)]),_:1}),a("span",null,u(e.post.viewCount||0),1)]),_:1}),t(m,{link:"",onClick:e.scrollToComments},{default:l(()=>[t(f,null,{default:l(()=>[t(x)]),_:1}),a("span",null,u(e.post.commentCount||0),1)]),_:1},8,["onClick"])])])]),n[4]||(n[4]=a("div",{class:"post-divider"},null,-1)),a("div",{class:"post-content",innerHTML:e.post.content},null,8,Ye),e.post.tags&&e.post.tags.length>0?(r(),d("div",Ze,[n[3]||(n[3]=a("span",{class:"tag-label"},"标签:",-1)),(r(!0),d(M,null,j(e.post.tags,s=>(r(),U(w,{key:s.id,class:"tag-item",effect:"plain",size:"small"},{default:l(()=>[v(u(s.name),1)]),_:2},1024))),128))])):E("",!0)]),_:1}),t(y,{id:"comments-section",class:"comments-card"},{header:l(()=>[a("div",qe,[a("h3",null,"评论 ("+u(e.comments.length)+")",1)])]),default:l(()=>[e.comments.length===0?(r(),d("div",Je," 暂无评论，快来发表第一条评论吧 ")):(r(),d("div",Oe,[(r(!0),d(M,null,j(e.comments,s=>(r(),d("div",{key:s.id,class:"comment-item"},[a("div",Qe,[a("div",We,[t(g,{size:32,src:s.avatar||e.defaultAvatar},null,8,["src"]),a("div",Xe,[a("div",be,u(s.author?s.author.realName||s.author.username:s.authorName),1),a("div",$e,u(e.formatTime(s.createTime)),1)])]),e.canEditComment(s)?(r(),d("div",et,[t(T,null,{dropdown:l(()=>[t(N,null,{default:l(()=>[t(I,{onClick:i=>e.handleDeleteComment(s)},{default:l(()=>n[5]||(n[5]=[v("删除")])),_:2},1032,["onClick"])]),_:2},1024)]),default:l(()=>[t(f,null,{default:l(()=>[t(z)]),_:1})]),_:2},1024)])):E("",!0)]),a("div",tt,u(s.content),1),a("div",ot,[t(m,{class:H({"active-like":s.liked}),loading:s.likeLoading,link:"",size:"small",onClick:i=>e.handleLikeComment(s)},{default:l(()=>[t(f,null,{default:l(()=>[t(L)]),_:1}),a("span",null,u(s.likeCount||0),1)]),_:2},1032,["class","loading","onClick"]),t(m,{link:"",size:"small",onClick:i=>e.handleReply(s)},{default:l(()=>[t(f,null,{default:l(()=>[t(A)]),_:1}),n[6]||(n[6]=a("span",null,"回复",-1))]),_:2},1032,["onClick"])]),s.replies&&s.replies.length>0?(r(),d("div",at,[(r(!0),d(M,null,j(s.replies,i=>(r(),d("div",{key:i.id,class:"sub-comment-item"},[a("div",lt,[a("div",nt,[t(g,{size:28,src:i.avatar||e.defaultAvatar},null,8,["src"]),a("div",st,[a("div",it,[v(u(i.author?i.author.realName||i.author.username:"")+" ",1),i.replyToAuthor?(r(),d("span",rt," 回复 "+u(i.replyToAuthor.realName||i.replyToAuthor.username),1)):E("",!0)]),a("div",ct,u(e.formatTime(i.createTime)),1)])]),e.canEditComment(i)?(r(),d("div",dt,[t(T,null,{dropdown:l(()=>[t(N,null,{default:l(()=>[t(I,{onClick:V=>e.handleDeleteComment(i)},{default:l(()=>n[7]||(n[7]=[v("删除")])),_:2},1032,["onClick"])]),_:2},1024)]),default:l(()=>[t(f,null,{default:l(()=>[t(z)]),_:1})]),_:2},1024)])):E("",!0)]),a("div",ut,u(i.content),1),a("div",_t,[t(m,{class:H({"active-like":i.liked}),loading:i.likeLoading,link:"",size:"small",onClick:V=>e.handleLikeComment(i)},{default:l(()=>[t(f,null,{default:l(()=>[t(L)]),_:1}),a("span",null,u(i.likeCount||0),1)]),_:2},1032,["class","loading","onClick"]),t(m,{link:"",size:"small",onClick:V=>e.handleReply(s,i)},{default:l(()=>[t(f,null,{default:l(()=>[t(A)]),_:1}),n[8]||(n[8]=a("span",null,"回复",-1))]),_:2},1032,["onClick"])])]))),128))])):E("",!0),e.replyingTo===s.id?(r(),d("div",mt,[t(B,{modelValue:e.replyContent,"onUpdate:modelValue":n[0]||(n[0]=i=>e.replyContent=i),placeholder:e.replyingToName?`回复 ${e.replyingToName}`:"回复评论",rows:2,maxlength:"500","show-word-limit":"",type:"textarea"},null,8,["modelValue","placeholder"]),a("div",ft,[t(m,{size:"small",onClick:e.cancelReply},{default:l(()=>n[9]||(n[9]=[v("取消")])),_:1},8,["onClick"]),t(m,{loading:e.submittingReply,size:"small",type:"primary",onClick:e.submitReply},{default:l(()=>n[10]||(n[10]=[v(" 回复 ")])),_:1},8,["loading","onClick"])])])):E("",!0)]))),128))])),e.isLoggedIn?(r(),d("div",vt,[n[12]||(n[12]=a("h4",{class:"comment-form-title"},"发表评论",-1)),t(B,{modelValue:e.commentContent,"onUpdate:modelValue":n[1]||(n[1]=s=>e.commentContent=s),rows:3,maxlength:"500",placeholder:"请输入评论内容...","show-word-limit":"",type:"textarea"},null,8,["modelValue"]),a("div",ht,[t(m,{disabled:!e.commentContent.trim(),loading:e.submittingComment,type:"primary",onClick:e.submitComment},{default:l(()=>n[11]||(n[11]=[v(" 发表评论 ")])),_:1},8,["disabled","loading","onClick"])])])):(r(),d("div",kt,[t(S,{closable:!1,"show-icon":"",title:"请登录后参与评论",type:"info"},{default:l(()=>[a("div",pt,[t(m,{size:"small",type:"primary",onClick:e.goToLogin},{default:l(()=>n[13]||(n[13]=[v("去登录")])),_:1},8,["onClick"])])]),_:1})]))]),_:1})],64)):(r(),U(F,{key:2,description:"帖子不存在或已被删除"},{default:l(()=>[t(m,{type:"primary",onClick:e.goBack},{default:l(()=>n[14]||(n[14]=[v("返回论坛")])),_:1},8,["onClick"])]),_:1}))])])}const Et=b(xe,[["render",gt],["__scopeId","data-v-faa50654"]]);export{Et as default};
