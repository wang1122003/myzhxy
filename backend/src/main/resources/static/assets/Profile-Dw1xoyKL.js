import{_ as oe,u as re,r as b,a as D,c as z,ax as s,ay as te,o as se,d as N,e as _,h as V,f as a,w as l,v as n,x as de,a4 as ne,m as d,az as ue,F as p,aA as ie,l as me,aB as pe,aC as fe,A as y,aD as ve,aE as g,K as k,g as ce,i as ge,z as h,j as _e,k as we,aF as be,aG as Ve,N as ye,aH as Pe,P as i,aI as Ue}from"./index-B2T-xuoP.js";/* empty css                   *//* empty css                       *//* empty css                 *//* empty css                             *//* empty css                    *//* empty css                  */import{g as Ne,u as Ee,c as ke}from"./user-D4eBv3A5.js";import"./request-CvcqSNCl.js";const Ae={class:"profile-container"},xe={class:"page-header"},Ce={class:"profile-info"},Re={class:"avatar-container"},Fe={class:"info-container"},Ie={class:"dialog-footer"},je={__name:"Profile",setup(Be){const q=re(),P=b(!1),E=b(!1),x=b(null),C=b(null),U=b(!1),w=b(!1),o=D({username:"",realName:"",gender:null,department:"",major:"",className:"",title:"",email:"",phone:""}),c=D({oldPassword:"",newPassword:"",confirmPassword:""}),R=()=>{s.value&&(o.username=s.value.username||"",o.realName=s.value.realName||"",o.gender=s.value.gender,o.department=s.value.department||"",o.major=s.value.major||"",o.className=s.value.className||"",o.title=s.value.title||"",o.email=s.value.email||"",o.phone=s.value.phone||"")},S=z(()=>{var t;return`/api/file/upload/avatar/${(t=s.value)==null?void 0:t.id}`}),$=z(()=>({Authorization:te.value||""})),G={email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:["blur","change"]}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号格式",trigger:["blur","change"]}]},M={oldPassword:[{required:!0,message:"请输入旧密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度不能少于6位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(t,e,u)=>{e!==c.newPassword?u(new Error("两次输入密码不一致!")):u()},trigger:"blur"}]},F=async()=>{var t;w.value=!0;try{const e=await Ne();e.code===200&&e.data?(Pe(e.data),setUserAvatar(e.data.avatar),R()):(i.error(e.message||"获取用户信息失败"),e.code===401&&await A())}catch(e){console.error("获取用户信息异常:",e),i.error("获取用户信息异常"),((t=e==null?void 0:e.response)==null?void 0:t.status)===401&&await A()}finally{w.value=!1}};se(F);const T=()=>{R(),P.value=!0},W=()=>{x.value.validate(async t=>{if(t){const e={gender:o.gender,email:o.email,phone:o.phone,...g.value==="teacher"&&{title:o.title}};w.value=!0;try{const u=await Ee(e);u.code===0||u.code===200?(i.success("更新成功"),P.value=!1,await F()):i.error(u.message||"更新失败")}catch(u){console.error("更新用户信息失败:",u),i.error("更新用户信息失败，请稍后再试")}finally{w.value=!1}}})},H=t=>t.type.startsWith("image/")?t.size/1024/1024>5?(i.error("图片大小不能超过 5MB!"),!1):(U.value=!0,!0):(i.error("请上传图片格式文件!"),!1),J=(t,e)=>{if(U.value=!1,t.code===0||t.code===200){i.success("头像上传成功");const u=t.data.url;setUserAvatar(u),s.value&&(s.value.avatar=u)}else i.error(t.message||"头像上传失败")},K=t=>{U.value=!1,console.error("头像上传失败:",t);try{const e=JSON.parse(t.message||"{}");i.error(e.message||"头像上传失败，请检查网络或联系管理员")}catch{i.error("头像上传失败，请检查网络或联系管理员")}},A=async()=>{await Ue(),q.push("/"),i.info("会话已过期，请重新登录")},L=t=>t===1?"男":t===0?"女":"未知",O=t=>t==="student"?"学生":t==="teacher"?"教师":t==="admin"?"管理员":"未知角色",Q=()=>{C.value.validate(async t=>{if(t){w.value=!0;try{const e=await ke({oldPassword:c.oldPassword,newPassword:c.newPassword});e.code===0||e.code===200?(i.success("密码修改成功，请重新登录"),E.value=!1,await A()):i.error(e.message||"密码修改失败")}catch(e){console.error("修改密码失败:",e),i.error(e.message||"修改密码失败，请稍后再试")}finally{w.value=!1}}})};return(t,e)=>{const u=de,X=ne,Y=me,Z=ie,f=ve,ee=fe,ae=ce,v=we,m=_e,I=Ve,le=be,j=ge,B=ye;return _(),N("div",Ae,[V("div",xe,[e[17]||(e[17]=V("h2",null,"个人信息",-1)),a(u,{type:"primary",onClick:T},{default:l(()=>e[16]||(e[16]=[n(" 编辑信息 ")])),_:1})]),a(ae,{class:"profile-card"},{default:l(()=>[V("div",Ce,[V("div",Re,[a(X,{size:100,src:d(ue)},{default:l(()=>{var r;return[n(p((r=d(s).realName)==null?void 0:r.substring(0,1)),1)]}),_:1},8,["src"]),a(Z,{action:S.value,"before-upload":H,disabled:U.value,headers:$.value,"on-error":K,"on-success":J,"show-file-list":!1,class:"avatar-uploader"},{default:l(()=>[a(u,{loading:U.value,size:"small",type:"primary"},{default:l(()=>[a(Y,null,{default:l(()=>[a(d(pe))]),_:1}),e[18]||(e[18]=n(" 更换头像 "))]),_:1},8,["loading"])]),_:1},8,["action","disabled","headers"])]),V("div",Fe,[a(ee,{column:2,border:"",title:"基本信息"},{default:l(()=>[a(f,{label:"用户名/学号/工号"},{default:l(()=>[n(p(d(s).username),1)]),_:1}),a(f,{label:"姓名"},{default:l(()=>[n(p(d(s).realName),1)]),_:1}),a(f,{label:"性别"},{default:l(()=>[n(p(L(d(s).gender)),1)]),_:1}),a(f,{label:"邮箱"},{default:l(()=>[n(p(d(s).email),1)]),_:1}),a(f,{label:"手机"},{default:l(()=>[n(p(d(s).phone),1)]),_:1}),a(f,{label:"角色"},{default:l(()=>[n(p(O(d(s).role)),1)]),_:1}),d(g)==="student"?(_(),N(k,{key:0},[a(f,{label:"院系"},{default:l(()=>[n(p(d(s).department),1)]),_:1}),a(f,{label:"专业"},{default:l(()=>[n(p(d(s).major),1)]),_:1}),a(f,{label:"班级"},{default:l(()=>[n(p(d(s).className),1)]),_:1})],64)):y("",!0),d(g)==="teacher"?(_(),N(k,{key:1},[a(f,{label:"院系"},{default:l(()=>[n(p(d(s).department),1)]),_:1}),a(f,{label:"职称"},{default:l(()=>[n(p(d(s).title||"暂无"),1)]),_:1})],64)):y("",!0),d(g)==="admin"?(_(),N(k,{key:2},[],64)):y("",!0)]),_:1})])])]),_:1}),a(B,{modelValue:P.value,"onUpdate:modelValue":e[10]||(e[10]=r=>P.value=r),title:"编辑个人信息",width:"500px"},{footer:l(()=>[V("span",Ie,[a(u,{onClick:e[9]||(e[9]=r=>P.value=!1)},{default:l(()=>e[21]||(e[21]=[n("取消")])),_:1}),a(u,{type:"primary",onClick:W},{default:l(()=>e[22]||(e[22]=[n("保存")])),_:1})])]),default:l(()=>[a(j,{ref_key:"formRef",ref:x,model:o,rules:G,"label-width":"100px"},{default:l(()=>[a(m,{label:"用户名",prop:"username"},{default:l(()=>[a(v,{modelValue:o.username,"onUpdate:modelValue":e[0]||(e[0]=r=>o.username=r),disabled:!0},null,8,["modelValue"])]),_:1}),a(m,{label:"姓名",prop:"realName"},{default:l(()=>[a(v,{modelValue:o.realName,"onUpdate:modelValue":e[1]||(e[1]=r=>o.realName=r),disabled:!0},null,8,["modelValue"])]),_:1}),a(m,{label:"性别",prop:"gender"},{default:l(()=>[a(le,{modelValue:o.gender,"onUpdate:modelValue":e[2]||(e[2]=r=>o.gender=r)},{default:l(()=>[a(I,{value:1},{default:l(()=>e[19]||(e[19]=[n("男")])),_:1}),a(I,{value:0},{default:l(()=>e[20]||(e[20]=[n("女")])),_:1})]),_:1},8,["modelValue"])]),_:1}),d(g)==="student"||d(g)==="teacher"?(_(),h(m,{key:0,label:"院系",prop:"department"},{default:l(()=>[a(v,{modelValue:o.department,"onUpdate:modelValue":e[3]||(e[3]=r=>o.department=r),disabled:!0},null,8,["modelValue"])]),_:1})):y("",!0),d(g)==="student"?(_(),N(k,{key:1},[a(m,{label:"专业",prop:"major"},{default:l(()=>[a(v,{modelValue:o.major,"onUpdate:modelValue":e[4]||(e[4]=r=>o.major=r),disabled:!0},null,8,["modelValue"])]),_:1}),a(m,{label:"班级",prop:"className"},{default:l(()=>[a(v,{modelValue:o.className,"onUpdate:modelValue":e[5]||(e[5]=r=>o.className=r),disabled:!0},null,8,["modelValue"])]),_:1})],64)):y("",!0),d(g)==="teacher"?(_(),h(m,{key:2,label:"职称",prop:"title"},{default:l(()=>[a(v,{modelValue:o.title,"onUpdate:modelValue":e[6]||(e[6]=r=>o.title=r)},null,8,["modelValue"])]),_:1})):y("",!0),a(m,{label:"邮箱",prop:"email"},{default:l(()=>[a(v,{modelValue:o.email,"onUpdate:modelValue":e[7]||(e[7]=r=>o.email=r)},null,8,["modelValue"])]),_:1}),a(m,{label:"手机",prop:"phone"},{default:l(()=>[a(v,{modelValue:o.phone,"onUpdate:modelValue":e[8]||(e[8]=r=>o.phone=r)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(B,{modelValue:E.value,"onUpdate:modelValue":e[15]||(e[15]=r=>E.value=r),title:"修改密码",width:"400px"},{footer:l(()=>[a(u,{onClick:e[14]||(e[14]=r=>E.value=!1)},{default:l(()=>e[23]||(e[23]=[n("取消")])),_:1}),a(u,{type:"primary",onClick:Q},{default:l(()=>e[24]||(e[24]=[n("确认修改")])),_:1})]),default:l(()=>[a(j,{ref_key:"passwordFormRef",ref:C,model:c,rules:M,"label-width":"100px"},{default:l(()=>[a(m,{label:"旧密码",prop:"oldPassword"},{default:l(()=>[a(v,{modelValue:c.oldPassword,"onUpdate:modelValue":e[11]||(e[11]=r=>c.oldPassword=r),"show-password":"",type:"password"},null,8,["modelValue"])]),_:1}),a(m,{label:"新密码",prop:"newPassword"},{default:l(()=>[a(v,{modelValue:c.newPassword,"onUpdate:modelValue":e[12]||(e[12]=r=>c.newPassword=r),"show-password":"",type:"password"},null,8,["modelValue"])]),_:1}),a(m,{label:"确认密码",prop:"confirmPassword"},{default:l(()=>[a(v,{modelValue:c.confirmPassword,"onUpdate:modelValue":e[13]||(e[13]=r=>c.confirmPassword=r),"show-password":"",type:"password"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},We=oe(je,[["__scopeId","data-v-6131a699"]]);export{We as default};
