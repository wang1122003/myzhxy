import{_ as we,r as o,a as re,c as _e,o as Te,d as f,e as n,h as S,f as t,y as se,w as r,v as y,m as a,x as _,i as ue,aQ as Ce,j as m,T as k,K as I,L as V,z as p,U as h,k as Se,q as Ee,l as Re,V as oe,aV as xe,g as de,H as Ne,A as We,B as De,C as Ue,F as Fe,a2 as ze,I as E,E as g,b7 as ne,aX as ie,N as qe,P as v,af as Be}from"./index-B2T-xuoP.js";/* empty css                        */import{b as $e,c as Oe,d as Pe,u as Ae,e as Me}from"./schedule-OzHb4cyJ.js";import{a as Le,c as me,e as He}from"./common-Dmk-JHZR.js";import{h as je}from"./course-C-HDut7x.js";import{h as Ke}from"./user-D4eBv3A5.js";import{b as Qe}from"./classroom-CUj5OrHJ.js";import{g as Xe}from"./term-BB3--eF6.js";import"./request-CvcqSNCl.js";const Ge={class:"schedule-management-container"},Je={class:"page-header"},Ye={class:"list-view"},Ze={key:0,class:"pagination-container"},el={class:"dialog-footer"},ll={name:"ScheduleManagement"},al=Object.assign(ll,{setup(tl){const q=o(!1),Q=o(!1),C=o(!1),R=o([]),x=o([]),B=o([]),N=o(0),T=o(1),W=o(10),c=re({termId:null,teacherName:"",courseName:"",className:"",weekDay:null,keyword:""}),w=o(!1),$=o("添加课表项"),O=o(!1),P=o(!1),D=o(!1),U=o(null),u=o({id:null,termId:null,courseId:null,teacherId:null,classId:null,classroomId:null,weekDay:null,startTime:null,endTime:null,startWeek:1,endWeek:16}),ve=re({termId:[formRules.required],courseId:[formRules.required],teacherId:[formRules.required],classId:[formRules.required],classroomId:[formRules.required],weekDay:[formRules.required],startTime:[formRules.required],endTime:[formRules.required,{validator:(s,e,d)=>{u.value.startTime&&e<=u.value.startTime?d(new Error("结束时间必须晚于开始时间")):d()},trigger:"change"}],startWeek:[formRules.required],endWeek:[{required:!0,message:"请输入结束周",trigger:"blur"},{validator:(s,e,d)=>{u.value.startWeek&&e<u.value.startWeek?d(new Error("结束周不能小于开始周")):d()},trigger:"blur"}]}),X=o([]),G=o([]),J=o([]),Y=o([]),A=o(!1),M=o(!1),L=o(!1),H=o(!1),Z=o([]),F=o([]),ce=async()=>{Q.value=!0,C.value=!0;try{const[s,e]=await Promise.all([Le(),me()]);x.value=s.data||[],B.value=e.data||[],x.value.length>0&&!c.termId&&(c.termId=x.value[0].value,await b())}catch(s){console.error("获取初始数据失败",s),v.error("获取学期/星期数据失败")}finally{Q.value=!1,C.value=!1}},b=async()=>{if(!c.termId){v.warning("请先选择学期");return}q.value=!0;try{const s={page:T.value,size:W.value,...c},e=await $e(s);R.value=e.data.records||[],N.value=e.data.total||0}catch(s){console.error("获取课表失败",s),v.error("获取课表失败"),R.value=[],N.value=0}finally{q.value=!1}},fe=_e(()=>{const s={};return B.value.forEach(e=>{s[e.value]=e.label}),s}),ee=s=>fe.value[s]||"",pe=s=>{W.value=s,T.value=1,b()},ge=s=>{T.value=s,b()},le=()=>{j(),$.value="手动添加课表项",w.value=!0,ae()},be=async s=>{j(),$.value="编辑课表项",D.value=!0,O.value=!0,w.value=!0,ae();try{const d={...(await Oe(s.id)).data};d.startTime&&d.startTime.includes(":")&&(d.startTime=d.startTime.substring(0,5)),d.endTime&&d.endTime.includes(":")&&(d.endTime=d.endTime.substring(0,5)),u.value=d}catch(e){console.error("获取课表详情失败",e),v.error("获取课表详情失败"),w.value=!1}finally{O.value=!1}},ye=s=>{Be.confirm(`确定要删除 ${s.courseName} (星期${ee(s.weekday)} ${s.startTime}-${s.endTime}) 这条课表记录吗?`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await Pe(s.id),v.success("删除成功"),b()}catch(e){console.error("删除课表项失败",e),v.error("删除课表项失败")}}).catch(()=>{})},ae=async()=>{var s;A.value=!0,M.value=!0,L.value=!0,H.value=!0;try{const[e,d,i,K]=await Promise.all([je(),Ke(),He(),Qe()]);X.value=e.data||[],G.value=((s=d.data)==null?void 0:s.list)||d.data||[],J.value=i.data||[],Y.value=K.data||[]}catch(e){console.error("获取下拉选项失败",e),v.error("获取课程/教师/班级/教室列表失败")}finally{A.value=!1,M.value=!1,L.value=!1,H.value=!1}},j=()=>{U.value&&U.value.resetFields(),u.value={id:null,termId:c.termId,courseId:null,teacherId:null,classId:null,classroomId:null,weekDay:null,startTime:null,endTime:null,startWeek:1,endWeek:16},D.value=!1},ke=()=>{U.value.validate(async s=>{var e,d;if(s){P.value=!0;try{const i={...u.value};D.value?(await Ae(i.id,i),v.success("更新成功")):(await Me(i),v.success("添加成功")),w.value=!1,b()}catch(i){console.error("提交课表项失败",i),v.error(((d=(e=i==null?void 0:i.response)==null?void 0:e.data)==null?void 0:d.message)||"提交失败，可能存在时间冲突")}finally{P.value=!1}}else return console.log("课表表单验证失败"),!1})},Ie=async()=>{try{const s=await Xe({sortByCreateDesc:!0});if(s.code===200&&s.data){Z.value=s.data;const e=s.data.find(d=>d.current===1);e&&(c.termId=e.id,b())}else v.error(s.message||"获取学期列表失败")}catch(s){console.error("获取学期列表失败",s),v.error("获取学期列表时发生错误")}},z=()=>{T.value=1,b()},Ve=async()=>{C.value=!0;try{const s=await me();s.success&&Array.isArray(s.data)?F.value=s.data.map(e=>({label:e.label,value:e.value})):(v.error(s.message||"获取星期列表失败"),F.value=[])}catch(s){console.error("获取星期列表失败:",s),v.error("获取星期列表失败"),F.value=[]}finally{C.value=!1}};return Te(()=>{ce(),Ie(),Ve()}),(s,e)=>{const d=Re,i=Ue,K=De,te=Ne;return n(),f("div",Ge,[S("div",Je,[e[18]||(e[18]=S("h2",null,"课表管理",-1)),S("div",null,[t(a(_),{type:"primary",onClick:le},{default:r(()=>e[17]||(e[17]=[y(" 手动添加 ")])),_:1})])]),t(a(de),{class:"filter-card"},{default:r(()=>[t(a(ue),{inline:!0,model:c,onSubmit:Ce(b,["prevent"])},{default:r(()=>[t(a(m),{label:"学期"},{default:r(()=>[t(a(k),{modelValue:c.termId,"onUpdate:modelValue":e[0]||(e[0]=l=>c.termId=l),placeholder:"选择学期",clearable:"",filterable:"",onChange:z,style:{width:"200px"}},{default:r(()=>[(n(!0),f(I,null,V(Z.value,l=>(n(),p(a(h),{key:l.id,label:l.termName,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(a(m),{label:"星期"},{default:r(()=>[t(a(k),{modelValue:c.weekDay,"onUpdate:modelValue":e[1]||(e[1]=l=>c.weekDay=l),placeholder:"选择星期",clearable:"",onChange:z,style:{width:"150px"}},{default:r(()=>[(n(!0),f(I,null,V(F.value,l=>(n(),p(a(h),{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(a(m),{label:"关键词"},{default:r(()=>[t(a(Se),{modelValue:c.keyword,"onUpdate:modelValue":e[2]||(e[2]=l=>c.keyword=l),placeholder:"搜索课程/教师/教室",clearable:"",style:{width:"240px"},onKeyup:Ee(z,["enter"])},{prefix:r(()=>[t(d,null,{default:r(()=>[t(a(oe))]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(a(m),null,{default:r(()=>[t(a(_),{type:"primary",onClick:z,icon:a(oe)},{default:r(()=>e[19]||(e[19]=[y("查询")])),_:1},8,["icon"]),t(a(_),{icon:a(xe),onClick:le},{default:r(()=>e[20]||(e[20]=[y("添加排课")])),_:1},8,["icon"])]),_:1})]),_:1},8,["model"])]),_:1}),se((n(),p(a(de),{class:"schedule-card"},{default:r(()=>[S("div",Ye,[t(K,{"table-data":R.value,data:R.value,border:"",style:{width:"100%"}},{default:r(()=>[t(i,{label:"课程名称",prop:"courseName"}),t(i,{label:"授课教师",prop:"teacherName"}),t(i,{label:"班级",prop:"className"}),t(i,{label:"星期",prop:"weekday"},{default:r(l=>[y(Fe(ee(l.row.weekday)),1)]),_:1}),t(i,{label:"开始时间",prop:"startTime"}),t(i,{label:"结束时间",prop:"endTime"}),t(i,{label:"教室",prop:"classroomName"}),t(i,{label:"操作",width:"150"},{default:r(l=>[t(a(_),{size:"small",type:"primary",onClick:he=>be(l.row)},{default:r(()=>e[21]||(e[21]=[y(" 编辑 ")])),_:2},1032,["onClick"]),t(a(_),{size:"small",type:"danger",onClick:he=>ye(l.row)},{default:r(()=>e[22]||(e[22]=[y(" 删除 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["table-data","data"])]),N.value>0?(n(),f("div",Ze,[t(a(ze),{"current-page":T.value,"onUpdate:currentPage":e[3]||(e[3]=l=>T.value=l),"page-size":W.value,"onUpdate:pageSize":e[4]||(e[4]=l=>W.value=l),"page-sizes":[10,20,50,100],total:N.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:pe,onCurrentChange:ge},null,8,["current-page","page-size","total"])])):We("",!0)]),_:1})),[[te,q.value||C.value]]),t(a(qe),{modelValue:w.value,"onUpdate:modelValue":e[16]||(e[16]=l=>w.value=l),title:$.value,width:"700px",onClose:j},{footer:r(()=>[S("span",el,[t(a(_),{onClick:e[15]||(e[15]=l=>w.value=!1)},{default:r(()=>e[23]||(e[23]=[y("取消")])),_:1}),t(a(_),{loading:P.value,type:"primary",onClick:ke},{default:r(()=>e[24]||(e[24]=[y("确定")])),_:1},8,["loading"])])]),default:r(()=>[se((n(),p(a(ue),{ref_key:"scheduleFormRef",ref:U,model:u.value,rules:ve,"label-width":"100px"},{default:r(()=>[t(a(E),{gutter:20},{default:r(()=>[t(a(g),{span:12},{default:r(()=>[t(a(m),{label:"学期",prop:"termId"},{default:r(()=>[t(a(k),{modelValue:u.value.termId,"onUpdate:modelValue":e[5]||(e[5]=l=>u.value.termId=l),disabled:D.value,filterable:"",placeholder:"选择学期"},{default:r(()=>[(n(!0),f(I,null,V(x.value,l=>(n(),p(a(h),{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1}),t(a(g),{span:12},{default:r(()=>[t(a(m),{label:"课程",prop:"courseId"},{default:r(()=>[t(a(k),{modelValue:u.value.courseId,"onUpdate:modelValue":e[6]||(e[6]=l=>u.value.courseId=l),loading:A.value,filterable:"",placeholder:"选择课程"},{default:r(()=>[(n(!0),f(I,null,V(X.value,l=>(n(),p(a(h),{key:l.id,label:`${l.courseNo} - ${l.courseName}`,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1})]),_:1}),t(a(E),{gutter:20},{default:r(()=>[t(a(g),{span:12},{default:r(()=>[t(a(m),{label:"教师",prop:"teacherId"},{default:r(()=>[t(a(k),{modelValue:u.value.teacherId,"onUpdate:modelValue":e[7]||(e[7]=l=>u.value.teacherId=l),loading:M.value,filterable:"",placeholder:"选择教师"},{default:r(()=>[(n(!0),f(I,null,V(G.value,l=>(n(),p(a(h),{key:l.id,label:l.realName||l.username,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1}),t(a(g),{span:12},{default:r(()=>[t(a(m),{label:"班级",prop:"classId"},{default:r(()=>[t(a(k),{modelValue:u.value.classId,"onUpdate:modelValue":e[8]||(e[8]=l=>u.value.classId=l),loading:L.value,filterable:"",placeholder:"选择班级"},{default:r(()=>[(n(!0),f(I,null,V(J.value,l=>(n(),p(a(h),{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1})]),_:1}),t(a(E),{gutter:20},{default:r(()=>[t(a(g),{span:12},{default:r(()=>[t(a(m),{label:"教室",prop:"classroomId"},{default:r(()=>[t(a(k),{modelValue:u.value.classroomId,"onUpdate:modelValue":e[9]||(e[9]=l=>u.value.classroomId=l),loading:H.value,filterable:"",placeholder:"选择教室"},{default:r(()=>[(n(!0),f(I,null,V(Y.value,l=>(n(),p(a(h),{key:l.id,label:`${l.building} - ${l.name}`,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1}),t(a(g),{span:12},{default:r(()=>[t(a(m),{label:"星期",prop:"weekDay"},{default:r(()=>[t(a(k),{modelValue:u.value.weekDay,"onUpdate:modelValue":e[10]||(e[10]=l=>u.value.weekDay=l),placeholder:"选择星期"},{default:r(()=>[(n(!0),f(I,null,V(B.value,l=>(n(),p(a(h),{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(a(E),{gutter:20},{default:r(()=>[t(a(g),{span:12},{default:r(()=>[t(a(m),{label:"开始时间段",prop:"startTime"},{default:r(()=>[t(a(ne),{modelValue:u.value.startTime,"onUpdate:modelValue":e[11]||(e[11]=l=>u.value.startTime=l),end:"22:00",format:"HH:mm",start:"07:00",placeholder:"选择开始时间",step:"00:15"},null,8,["modelValue"])]),_:1})]),_:1}),t(a(g),{span:12},{default:r(()=>[t(a(m),{label:"结束时间段",prop:"endTime"},{default:r(()=>[t(a(ne),{modelValue:u.value.endTime,"onUpdate:modelValue":e[12]||(e[12]=l=>u.value.endTime=l),end:"22:00",format:"HH:mm",start:"07:00",placeholder:"选择结束时间",step:"00:15"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(a(E),{gutter:20},{default:r(()=>[t(a(g),{span:12},{default:r(()=>[t(a(m),{label:"开始周",prop:"startWeek"},{default:r(()=>[t(a(ie),{modelValue:u.value.startWeek,"onUpdate:modelValue":e[13]||(e[13]=l=>u.value.startWeek=l),max:25,min:1,placeholder:"起始周"},null,8,["modelValue"])]),_:1})]),_:1}),t(a(g),{span:12},{default:r(()=>[t(a(m),{label:"结束周",prop:"endWeek"},{default:r(()=>[t(a(ie),{modelValue:u.value.endWeek,"onUpdate:modelValue":e[14]||(e[14]=l=>u.value.endWeek=l),max:25,min:1,placeholder:"结束周"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","rules"])),[[te,O.value]])]),_:1},8,["modelValue","title"])])}}}),cl=we(al,[["__scopeId","data-v-ab704b67"]]);export{cl as default};
