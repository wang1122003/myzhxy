<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.campus.dao.CommentDao">
    <!-- 定义Comment的结果映射 -->
    <resultMap id="CommentResultMap" type="com.campus.entity.Comment">
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="post_id" jdbcType="INTEGER" property="postId"/>
        <result column="user_id" jdbcType="INTEGER" property="userId"/>
        <result column="content" jdbcType="LONGVARCHAR" property="content"/>
        <result column="parent_id" jdbcType="INTEGER" property="parentId"/>
        <result column="like_count" jdbcType="INTEGER" property="likeCount"/>
        <result column="status" jdbcType="VARCHAR" property="status"/>
        <result column="creation_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
        <result column="replies" jdbcType="VARCHAR" property="repliesJson"/>
        <!-- 作者信息 (使用嵌套的 resultMap 或 association) -->
        <!-- 确保 User 实体类有对应的属性 -->
        <association property="author" javaType="com.campus.entity.User">
            <id column="u_id" property="id"/>
            <result column="username" property="username"/>
            <result column="real_name" property="realName"/>
            <result column="avatar_url" property="avatarUrl"/>
        </association>
        <!-- 如果需要 Post 信息 -->
        <!--
        <association property="post" javaType="com.campus.entity.Post">
            <id column="p_id" property="id"/>
            <result column="p_title" property="title"/>
        </association>
        -->
        <!-- 如果需要回复列表 (通常使用 select 嵌套查询实现) -->
        <!--
        <collection property="replies" ofType="com.campus.entity.Comment" select="getRepliesByCommentId" column="id"/>
        -->
    </resultMap>

    <!-- 通用查询结果列 (为 JOIN 查询添加别名) -->
    <sql id="Base_Column_List">
        c.id, c.post_id, c.user_id, c.content, c.parent_id,
        c.like_count, c.status, c.creation_time, c.update_time, c.replies
    </sql>
    <sql id="User_Columns">
        u.id as u_id, u.username, u.real_name, u.avatar_url
    </sql>
    <sql id="Post_Columns">
        p.id as p_id, p.title as p_title
    </sql>

    <!-- 获取所有评论（分页） -->
    <select id="getAllComments" resultMap="CommentResultMap">
        SELECT
        <include refid="Base_Column_List"/>,
        <include refid="User_Columns"/>
        FROM comment c
        LEFT JOIN user u ON c.user_id = u.id
        <where>
            <if test="status != null">
                AND c.status = #{status,jdbcType=VARCHAR}
            </if>
            <if test="postId != null">
                AND c.post_id = #{postId,jdbcType=INTEGER}
            </if>
            <if test="userId != null">
                AND c.user_id = #{userId,jdbcType=INTEGER}
            </if>
        </where>
        ORDER BY c.creation_time DESC
        <if test="offset != null and limit != null">
            limit #{offset,jdbcType=INTEGER}, #{limit,jdbcType=INTEGER}
        </if>
    </select>

    <!-- 获取评论总数 -->
    <select id="getCommentCount" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM comment c
        <where>
            <if test="status != null">
                AND c.status = #{status,jdbcType=VARCHAR}
            </if>
            <if test="postId != null">
                AND c.post_id = #{postId,jdbcType=INTEGER}
            </if>
            <if test="userId != null">
                AND c.user_id = #{userId,jdbcType=INTEGER}
            </if>
        </where>
    </select>

    <!-- 根据ID获取评论（包含作者） -->
    <select id="getCommentById" parameterType="java.lang.Integer" resultMap="CommentResultMap">
        SELECT
        <include refid="Base_Column_List"/>,
        <include refid="User_Columns"/>
        FROM comment c
        LEFT JOIN user u ON c.user_id = u.id
        WHERE c.id = #{id,jdbcType=INTEGER}
    </select>

    <!-- 根据帖子ID获取根评论（分页，包含作者） -->
    <select id="getCommentsByPostId" parameterType="java.lang.Integer" resultMap="CommentResultMap">
        SELECT
        <include refid="Base_Column_List"/>,
        <include refid="User_Columns"/>
        FROM comment c
        LEFT JOIN user u ON c.user_id = u.id
        WHERE c.post_id = #{postId,jdbcType=INTEGER}
        AND c.parent_id IS NULL
        <if test="status != null">
            AND c.status = #{status,jdbcType=VARCHAR}
        </if>
        ORDER BY c.creation_time ASC
        <if test="offset != null and limit != null">
            limit #{offset,jdbcType=INTEGER}, #{limit,jdbcType=INTEGER}
        </if>
    </select>

    <!-- 根据作者ID获取评论（分页，包含作者和帖子标题） -->
    <select id="getCommentsByAuthorId" parameterType="java.lang.Integer" resultMap="CommentResultMap">
        SELECT
        <include refid="Base_Column_List"/>,
        <include refid="User_Columns"/>,
        p.id as p_id, p.title as p_title
        FROM comment c
        LEFT JOIN user u ON c.user_id = u.id
        LEFT JOIN post p ON c.post_id = p.id
        WHERE c.user_id = #{userId,jdbcType=INTEGER}
        <if test="status != null">
            AND c.status = #{status,jdbcType=VARCHAR}
        </if>
        ORDER BY c.creation_time DESC
        <if test="offset != null and limit != null">
            limit #{offset,jdbcType=INTEGER}, #{limit,jdbcType=INTEGER}
        </if>
    </select>

    <!-- 获取评论的回复（分页，包含作者） -->
    <select id="getRepliesByCommentId" parameterType="java.lang.Integer" resultMap="CommentResultMap">
        SELECT
        <include refid="Base_Column_List"/>,
        <include refid="User_Columns"/>
        FROM comment c
        LEFT JOIN user u ON c.user_id = u.id
        WHERE c.parent_id = #{commentId,jdbcType=INTEGER}
        <if test="status != null">
            AND c.status = #{status,jdbcType=VARCHAR}
        </if>
        ORDER BY c.creation_time ASC
        <if test="offset != null and limit != null">
            limit #{offset,jdbcType=INTEGER}, #{limit,jdbcType=INTEGER}
        </if>
    </select>

    <!-- 获取评论树结构 (使用 WITH RECURSIVE, 需要数据库支持，如 MySQL 8.0+) -->
    <!-- 这个查询比较复杂，其 ResultMap 可能需要单独定义或调整 CommentResultMap -->
    <select id="getCommentTree" parameterType="java.lang.Integer" resultMap="CommentResultMap">
        WITH RECURSIVE comment_tree AS (
            SELECT
                c.id, c.post_id, c.user_id, c.content, c.parent_id,
        c.like_count, c.status, c.creation_time, c.update_time, c.replies,
        u.id as u_id, u.username, u.real_name, u.avatar_url,
        p.id as p_id, p.title as p_title,
                0 as level
        FROM comment c
        LEFT JOIN user u ON c.user_id = u.id
        LEFT JOIN post p ON c.post_id = p.id
            WHERE c.post_id = #{postId,jdbcType=INTEGER}
            AND c.parent_id IS NULL
            AND c.status = 'Active'

            UNION ALL

            SELECT
                c.id, c.post_id, c.user_id, c.content, c.parent_id,
        c.like_count, c.status, c.creation_time, c.update_time, c.replies,
        u.id as u_id, u.username, u.real_name, u.avatar_url,
        p.id as p_id, p.title as p_title,
                ct.level + 1 as level
        FROM comment c
        LEFT JOIN user u ON c.user_id = u.id
        LEFT JOIN post p ON c.post_id = p.id
            INNER JOIN comment_tree ct ON c.parent_id = ct.id
            WHERE c.status = 'Active'
        )
        SELECT *
        FROM comment_tree
        ORDER BY level ASC, creation_time ASC
    </select>

    <!-- 搜索评论（分页，包含作者和帖子标题） -->
    <select id="searchComments" resultMap="CommentResultMap">
        SELECT
        <include refid="Base_Column_List"/>,
        <include refid="User_Columns"/>,
        <include refid="Post_Columns"/>
        FROM comment c
        LEFT JOIN user u ON c.user_id = u.id
        LEFT JOIN post p ON c.post_id = p.id
        <where>
            <if test="keyword != null and keyword != ''">
                AND c.content LIKE CONCAT('%', #{keyword,jdbcType=VARCHAR}, '%')
            </if>
            <if test="status != null">
                AND c.status = #{status,jdbcType=VARCHAR}
            </if>
            <if test="postId != null">
                AND c.post_id = #{postId,jdbcType=INTEGER}
            </if>
            <if test="userId != null">
                AND c.user_id = #{userId,jdbcType=INTEGER}
            </if>
        </where>
        ORDER BY c.creation_time DESC
        <if test="offset != null and limit != null">
            limit #{offset,jdbcType=INTEGER}, #{limit,jdbcType=INTEGER}
        </if>
    </select>

    <!-- 添加评论 -->
    <insert id="addComment" parameterType="com.campus.entity.Comment" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO comment (post_id, user_id, content, parent_id, like_count, status, creation_time, update_time, replies)
        VALUES (#{postId,jdbcType=INTEGER}, #{userId,jdbcType=INTEGER}, #{content,jdbcType=LONGVARCHAR},
                #{parentId,jdbcType=INTEGER}, #{likeCount,jdbcType=INTEGER},
                #{status,jdbcType=VARCHAR}, NOW(), NOW(), #{repliesJson,jdbcType=VARCHAR})
    </insert>

    <!-- 批量添加评论 -->
    <insert id="batchAddComments" parameterType="java.util.List">
        INSERT INTO comment (post_id, user_id, content, parent_id, like_count, status, creation_time, update_time, replies)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.postId,jdbcType=INTEGER}, #{item.userId,jdbcType=INTEGER}, #{item.content,jdbcType=LONGVARCHAR},
            #{item.parentId,jdbcType=INTEGER}, #{item.likeCount,jdbcType=INTEGER},
            #{item.status,jdbcType=VARCHAR}, NOW(), NOW(), #{item.repliesJson,jdbcType=VARCHAR})
        </foreach>
    </insert>

    <!-- 更新评论 -->
    <update id="updateComment" parameterType="com.campus.entity.Comment">
        UPDATE comment
        <set>
            <if test="content != null">
                content = #{content,jdbcType=LONGVARCHAR},
            </if>
            <if test="status != null">
                status = #{status,jdbcType=VARCHAR},
            </if>
            <if test="likeCount != null">
                like_count = #{likeCount,jdbcType=INTEGER},
            </if>
            <if test="repliesJson != null">
                replies = #{repliesJson,jdbcType=VARCHAR},
            </if>
            update_time = NOW()
        </set>
        WHERE id = #{id,jdbcType=INTEGER}
    </update>

    <!-- 批量更新评论状态 -->
    <update id="batchUpdateCommentStatus">
        UPDATE comment
        SET status = #{status,jdbcType=VARCHAR},
            update_time = NOW()
        WHERE id IN
        <foreach collection="commentIds" item="commentId" open="(" separator="," close=")">
            #{commentId,jdbcType=INTEGER}
        </foreach>
    </update>

    <!-- 删除评论 (及其子评论，如果需要递归删除) -->
    <delete id="deleteComment" parameterType="java.lang.Integer">
        DELETE FROM comment
        WHERE id = #{id,jdbcType=INTEGER}
    </delete>

    <!-- 批量删除评论 -->
    <delete id="batchDeleteComments">
        DELETE FROM comment
        WHERE id IN
        <foreach collection="commentIds" item="commentId" open="(" separator="," close=")">
            #{commentId,jdbcType=INTEGER}
        </foreach>
    </delete>

    <!-- 更新评论状态 -->
    <update id="updateCommentStatus">
        UPDATE comment
        SET status = #{status,jdbcType=VARCHAR},
            update_time = NOW()
        WHERE id = #{id,jdbcType=INTEGER}
    </update>

    <!-- 增加点赞数 -->
    <update id="incrementLikeCount" parameterType="java.lang.Integer">
        UPDATE comment
        SET like_count = like_count + 1,
            update_time = NOW()
        WHERE id = #{id,jdbcType=INTEGER}
    </update>

    <!-- 减少点赞数 -->
    <update id="decrementLikeCount" parameterType="java.lang.Integer">
        UPDATE comment
        SET like_count = like_count - 1,
            update_time = NOW()
        WHERE id = #{id,jdbcType=INTEGER}
        AND like_count > 0
    </update>

    <!-- 获取评论统计信息 -->
    <select id="getCommentStats" resultType="java.util.Map">
        SELECT
            COUNT(*) as total_comments,
            SUM(CASE WHEN status = 'Active' THEN 1 ELSE 0 END) as active_comments,
            SUM(CASE WHEN parent_id IS NULL THEN 1 ELSE 0 END) as root_comments,
            SUM(CASE WHEN parent_id IS NOT NULL THEN 1 ELSE 0 END) as reply_comments,
            SUM(like_count) as total_likes,
            COUNT(DISTINCT user_id) as total_authors,
            COUNT(DISTINCT post_id) as total_posts,
            AVG(like_count) as avg_likes,
            MAX(like_count) as max_likes
        FROM comment
    </select>

    <!-- 获取帖子的评论统计信息 -->
    <select id="getPostCommentStats" parameterType="java.lang.Integer" resultType="java.util.Map">
        SELECT
            COUNT(*) as total_comments,
            SUM(CASE WHEN parent_id IS NULL THEN 1 ELSE 0 END) as root_comments,
            SUM(CASE WHEN parent_id IS NOT NULL THEN 1 ELSE 0 END) as reply_comments,
            SUM(like_count) as total_likes,
            COUNT(DISTINCT user_id) as total_authors,
            AVG(like_count) as avg_likes,
            MAX(like_count) as max_likes
        FROM comment
        WHERE post_id = #{postId,jdbcType=INTEGER}
    </select>

    <!-- 获取作者评论统计信息 -->
    <select id="getAuthorCommentStats" parameterType="java.lang.Integer" resultType="java.util.Map">
        SELECT
            COUNT(*) as total_comments,
            SUM(CASE WHEN parent_id IS NULL THEN 1 ELSE 0 END) as root_comments,
            SUM(CASE WHEN parent_id IS NOT NULL THEN 1 ELSE 0 END) as reply_comments,
            SUM(like_count) as total_likes,
            COUNT(DISTINCT post_id) as total_posts,
            AVG(like_count) as avg_likes,
            MAX(like_count) as max_likes
        FROM comment
        WHERE user_id = #{userId,jdbcType=INTEGER}
    </select>

    <!-- 获取评论发布趋势 -->
    <select id="getCommentPublishTrend" resultType="java.util.Map">
        SELECT
            DATE_FORMAT(creation_time, '%Y-%m-%d') as date,
            COUNT(*) as comment_count,
            SUM(CASE WHEN parent_id IS NULL THEN 1 ELSE 0 END) as root_count,
            SUM(CASE WHEN parent_id IS NOT NULL THEN 1 ELSE 0 END) as reply_count,
            SUM(like_count) as like_count
        FROM comment
        WHERE creation_time >= DATE_SUB(NOW(), INTERVAL 30 DAY)
        GROUP BY DATE_FORMAT(creation_time, '%Y-%m-%d')
        ORDER BY date ASC
    </select>

    <!-- 获取热门评论 -->
    <select id="getHotComments" resultType="java.util.Map">
        SELECT
            c.id as comment_id,
            c.content,
            c.like_count,
            c.creation_time,
            u.id as u_id,
            u.username,
            u.real_name,
            u.avatar_url,
            p.id as post_id,
            p.title as post_title
        FROM comment c
        LEFT JOIN user u ON c.user_id = u.id
        LEFT JOIN post p ON c.post_id = p.id
        WHERE c.status = 'Active'
        <if test="postId != null">
            AND c.post_id = #{postId,jdbcType=INTEGER}
        </if>
        ORDER BY c.like_count DESC
        limit #{limit,jdbcType=INTEGER}
    </select>
</mapper>