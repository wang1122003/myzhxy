import{_ as Z,ad as ee,u as ae,c as T,r as n,aR as te,o as le,d as B,e as i,f as s,y as $,m as l,aT as se,H as oe,z as C,w as o,h as f,A as F,T as re,K as ne,L as ue,U as de,k as ie,q as ce,l as pe,V as me,x as w,v as c,B as ve,C as x,aS as fe,D as G,F as A,a2 as ge,G as ye,g as he,az as Ce,N as we,P as r,af as z}from"./index-DrN7HJWs.js";import{r as xe,a as _e}from"./grade-ChswwjGh.js";import{b as be}from"./formatters-COdykrJD.js";import{b as Ee}from"./course-BxgJ8J8R.js";import{g as ke}from"./term-iCmPGzOk.js";import"./request-BGbcGZqw.js";const Ie={class:"course-grades-container"},Ve={class:"clearfix"},Te={class:"toolbar"},Be={class:"filter-area"},ze={class:"action-buttons"},Ne={key:0,class:"pagination-container"},Se={class:"dialog-footer"},Ue={name:"CourseGrades"},De=Object.assign(Ue,{setup($e){const N=ee(),S=ae(),g=T(()=>N.params.courseId),U=T(()=>N.query.courseName||"未命名课程"),P=n(null),p=n([]),E=n(0),y=n(1),k=n(20),I=T(()=>p.value.some(e=>e.changed)),_=n(!1),b=n(null),D=n([]),m=n(null),V=n(""),K=async()=>{if(g.value)try{const e=await Ee(g.value);P.value=e.data}catch(e){console.error("获取课程信息失败:",e),r.error("获取课程信息失败")}},L=async()=>{try{const e=await ke({sortByCreateDesc:!0});e.code===200&&Array.isArray(e.data)?(D.value=e.data,e.data.length>0&&!m.value&&(m.value=e.data[0].id,v())):r.error(e.message||"获取学期列表失败")}catch(e){console.error("获取学期列表失败:",e),r.error("获取学期列表失败")}},v=async()=>{var e,a;if(!g.value||!m.value){p.value=[],m.value||r.info("请选择学期以查看成绩");return}try{const u={courseId:g.value,termId:m.value},d=await _e(u);p.value=((e=d.data)==null?void 0:e.list)||d.data||[],E.value=((a=d.data)==null?void 0:a.total)||0}catch(u){console.error("获取成绩列表失败:",u),r.error("获取成绩列表失败"),p.value=[],E.value=0}};te(m,e=>{e?v():p.value=[]});const M=e=>{e.changed=!0},R=async()=>{var d;const e=p.value.filter(t=>t.changed);if(e.length===0){r.info("没有需要保存的修改");return}loading.value=!0;let a=0,u=0;for(const t of e)try{const h={id:t.id,studentId:t.studentId,courseId:t.courseId,score:t.score};await xe(h),t.changed=!1,a++}catch(h){console.error(`保存学生 ${((d=t.student)==null?void 0:d.realName)||t.studentId} 成绩失败`,h),u++}loading.value=!1,u>0?r.error(`${a}条成绩保存成功，${u}条保存失败`):r.success(`${a}条成绩保存成功`)},j=async()=>{try{loading.value=!0,await exportGrades(g.value),r.success("成绩导出成功")}catch(e){console.error("成绩导出失败",e),r.error("成绩导出失败")}finally{loading.value=!1}},q=()=>{_.value=!0,b.value=null},H=e=>{b.value=e},O=async()=>{if(!b.value){r.warning("请先选择文件");return}try{loading.value=!0;const e=new FormData;e.append("file",b.value.raw),e.append("courseId",g.value),await importGrades(e),r.success("成绩导入成功"),_.value=!1,await v()}catch(e){console.error("成绩导入失败",e),r.error("成绩导入失败: "+(e.message||"未知错误"))}finally{loading.value=!1}},J=()=>{I.value?z.confirm("有未保存的成绩修改，确定要离开吗？","提示",{confirmButtonText:"确定离开",cancelButtonText:"取消",type:"warning"}).then(()=>{S.push({name:"TeacherCourses"})}).catch(()=>{}):S.push({name:"TeacherCourses"})},Q=e=>{I.value?z.confirm("有未保存的成绩修改，更改页面大小将丢失这些修改，是否继续？","提示",{confirmButtonText:"继续",cancelButtonText:"取消",type:"warning"}).then(()=>{k.value=e,y.value=1,v()}).catch(()=>{}):(k.value=e,y.value=1,v())},W=e=>{I.value?z.confirm("有未保存的成绩修改，更改页码将丢失这些修改，是否继续？","提示",{confirmButtonText:"继续",cancelButtonText:"取消",type:"warning"}).then(()=>{y.value=e,v()}).catch(()=>{}):(y.value=e,v())},X=()=>{v()},Y=()=>{console.log("搜索关键词:",V.value)};return le(()=>{L(),K()}),(e,a)=>{const u=pe,d=oe;return i(),B("div",Ie,[s(l(se),{title:`课程成绩管理 - ${U.value}`,onBack:J},null,8,["title"]),$((i(),C(l(he),{class:"grades-card"},{header:o(()=>[f("div",Ve,[f("span",null,A(U.value)+" - 成绩录入",1),s(l(w),{link:"",style:{float:"right",padding:"3px 0"},type:"primary",onClick:R},{default:o(()=>a[6]||(a[6]=[c("保存所有修改 ")])),_:1})])]),default:o(()=>[f("div",Te,[f("div",Be,[s(l(re),{modelValue:m.value,"onUpdate:modelValue":a[0]||(a[0]=t=>m.value=t),placeholder:"选择学期",clearable:"",style:{width:"200px","margin-right":"10px"},onChange:X},{default:o(()=>[(i(!0),B(ne,null,ue(D.value,t=>(i(),C(l(de),{key:t.id,label:t.termName,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),s(l(ie),{modelValue:V.value,"onUpdate:modelValue":a[1]||(a[1]=t=>V.value=t),clearable:"",placeholder:"搜索学生姓名或学号",style:{width:"240px"},onKeyup:ce(Y,["enter"])},{prefix:o(()=>[s(u,null,{default:o(()=>[s(l(me))]),_:1})]),_:1},8,["modelValue"])]),f("div",ze,[s(l(w),{link:"",style:{padding:"3px 0"},type:"primary",onClick:j},{default:o(()=>a[7]||(a[7]=[c("导出成绩")])),_:1}),s(l(w),{link:"",style:{padding:"3px 0"},type:"primary",onClick:q},{default:o(()=>a[8]||(a[8]=[c("导入成绩")])),_:1})])]),$((i(),C(l(ve),{data:p.value,"empty-text":"暂无学生或成绩记录",style:{width:"100%"}},{default:o(()=>[s(l(x),{label:"学号",prop:"student.studentId",width:"120"}),s(l(x),{label:"姓名",prop:"student.realName",width:"100"}),s(l(x),{label:"班级",prop:"student.className",width:"150"}),s(l(x),{label:"成绩",width:"150"},{default:o(({row:t})=>[s(l(fe),{modelValue:t.score,"onUpdate:modelValue":h=>t.score=h,min:0,max:100,precision:1,step:1,size:"small",style:{width:"100px"},onChange:h=>M(t)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),s(l(x),{label:"状态",width:"80"},{default:o(({row:t})=>[t.changed?(i(),C(l(G),{key:0,size:"small",type:"warning"},{default:o(()=>a[9]||(a[9]=[c("已修改")])),_:1})):(i(),C(l(G),{key:1,size:"small",type:"info"},{default:o(()=>a[10]||(a[10]=[c("未修改")])),_:1}))]),_:1}),s(l(x),{label:"上次更新时间","min-width":"150"},{default:o(({row:t})=>[c(A(l(be)(t.updateTime)),1)]),_:1})]),_:1},8,["data"])),[[d,e.loading]]),E.value>0?(i(),B("div",Ne,[s(l(ge),{"current-page":y.value,"onUpdate:currentPage":a[2]||(a[2]=t=>y.value=t),"page-size":k.value,"onUpdate:pageSize":a[3]||(a[3]=t=>k.value=t),"page-sizes":[10,20,50,100],total:E.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:Q,onCurrentChange:W},null,8,["current-page","page-size","total"])])):F("",!0),p.value.length===0&&!e.loading?(i(),C(l(ye),{key:1,description:"暂无学生数据"})):F("",!0)]),_:1})),[[d,e.loading]]),s(l(we),{modelValue:_.value,"onUpdate:modelValue":a[5]||(a[5]=t=>_.value=t),title:"导入成绩",width:"500px"},{footer:o(()=>[f("span",Se,[s(l(w),{onClick:a[4]||(a[4]=t=>_.value=!1)},{default:o(()=>a[13]||(a[13]=[c("取消")])),_:1}),s(l(w),{disabled:!b.value,type:"primary",onClick:O},{default:o(()=>a[14]||(a[14]=[c(" 确认导入 ")])),_:1},8,["disabled"])])]),default:o(()=>[s(l(Ce),{"auto-upload":!1,limit:1,"on-change":H,accept:".xlsx,.xls,.csv",action:"#",class:"upload-demo"},{trigger:o(()=>[s(l(w),{type:"primary"},{default:o(()=>a[11]||(a[11]=[c("选择文件")])),_:1})]),tip:o(()=>a[12]||(a[12]=[f("div",{class:"el-upload__tip"}," 请上传Excel或CSV格式的成绩单文件。文件格式要求：第一列为学号，之后依次为考勤分、作业分、考试分。 ",-1)])),_:1})]),_:1},8,["modelValue"])])}}}),Me=Z(De,[["__scopeId","data-v-2fa00d11"]]);export{Me as default};
