import{_ as Z,ad as ee,u as ae,c as T,r as u,aQ as te,o as le,d as B,e as i,f as s,y as $,m as l,aN as se,H as oe,z as C,w as o,h as v,A as F,T as ne,K as re,L as ue,U as de,k as ie,q as ce,l as pe,V as me,x as w,v as c,B as fe,C as x,aR as ve,D as G,F as L,a2 as ge,G as ye,g as he,az as Ce,N as we,P as n,af as N}from"./index-gQMZQ2sp.js";/* empty css                   */import{f as xe,e as _e,r as be,i as Ee,a as ke}from"./formatters-CFKJmp8n.js";import{b as Ie}from"./course-DXTLIjhn.js";import{g as Ve}from"./term-BwK5SD_a.js";import"./request-DfavLRg_.js";import"./api-endpoints-Ctc2JoQP.js";const Te={class:"course-grades-container"},Be={class:"clearfix"},Ne={class:"toolbar"},ze={class:"filter-area"},Se={class:"action-buttons"},Ue={key:0,class:"pagination-container"},De={class:"dialog-footer"},$e={name:"CourseGrades"},Fe=Object.assign($e,{setup(Ge){const z=ee(),S=ae(),g=T(()=>z.params.courseId),U=T(()=>z.query.courseName||"未命名课程"),P=u(null),p=u([]),E=u(0),y=u(1),k=u(20),I=T(()=>p.value.some(e=>e.changed)),_=u(!1),b=u(null),D=u([]),f=u(null),V=u(""),K=async()=>{if(g.value)try{const e=await Ie(g.value);P.value=e.data}catch(e){console.error("获取课程信息失败:",e),n.error("获取课程信息失败")}},M=async()=>{try{const e=await Ve();if(e.code===200&&e.data){D.value=e.data;const a=e.data.find(r=>r.current===1);a&&(f.value=a.id,m())}else n.error(e.message||"获取学期列表失败")}catch(e){console.error("获取学期列表失败:",e),n.error("获取学期列表时发生错误")}},m=async()=>{var e,a;if(!g.value||!f.value){p.value=[],f.value||n.info("请选择学期以查看成绩");return}try{const r={courseId:g.value,termId:f.value},d=await ke(r);p.value=((e=d.data)==null?void 0:e.list)||d.data||[],E.value=((a=d.data)==null?void 0:a.total)||0}catch(r){console.error("获取成绩列表失败:",r),n.error("获取成绩列表失败"),p.value=[],E.value=0}};te(f,e=>{e?m():p.value=[]});const R=e=>{e.changed=!0},j=async()=>{var d;const e=p.value.filter(t=>t.changed);if(e.length===0){n.info("没有需要保存的修改");return}loading.value=!0;let a=0,r=0;for(const t of e)try{const h={id:t.id,studentId:t.studentId,courseId:t.courseId,score:t.score};await be(h),t.changed=!1,a++}catch(h){console.error(`保存学生 ${((d=t.student)==null?void 0:d.realName)||t.studentId} 成绩失败`,h),r++}loading.value=!1,r>0?n.error(`${a}条成绩保存成功，${r}条保存失败`):n.success(`${a}条成绩保存成功`)},q=async()=>{try{loading.value=!0,await _e(g.value),n.success("成绩导出成功")}catch(e){console.error("成绩导出失败",e),n.error("成绩导出失败")}finally{loading.value=!1}},A=()=>{_.value=!0,b.value=null},H=e=>{b.value=e},O=async()=>{if(!b.value){n.warning("请先选择文件");return}try{loading.value=!0;const e=new FormData;e.append("file",b.value.raw),e.append("courseId",g.value),await Ee(e),n.success("成绩导入成功"),_.value=!1,await m()}catch(e){console.error("成绩导入失败",e),n.error("成绩导入失败: "+(e.message||"未知错误"))}finally{loading.value=!1}},Q=()=>{I.value?N.confirm("有未保存的成绩修改，确定要离开吗？","提示",{confirmButtonText:"确定离开",cancelButtonText:"取消",type:"warning"}).then(()=>{S.push({name:"TeacherCourses"})}).catch(()=>{}):S.push({name:"TeacherCourses"})},J=e=>{I.value?N.confirm("有未保存的成绩修改，更改页面大小将丢失这些修改，是否继续？","提示",{confirmButtonText:"继续",cancelButtonText:"取消",type:"warning"}).then(()=>{k.value=e,y.value=1,m()}).catch(()=>{}):(k.value=e,y.value=1,m())},W=e=>{I.value?N.confirm("有未保存的成绩修改，更改页码将丢失这些修改，是否继续？","提示",{confirmButtonText:"继续",cancelButtonText:"取消",type:"warning"}).then(()=>{y.value=e,m()}).catch(()=>{}):(y.value=e,m())},X=()=>{m()},Y=()=>{console.log("搜索关键词:",V.value)};return le(()=>{K(),M()}),(e,a)=>{const r=pe,d=oe;return i(),B("div",Te,[s(l(se),{title:`课程成绩管理 - ${U.value}`,onBack:Q},null,8,["title"]),$((i(),C(l(he),{class:"grades-card"},{header:o(()=>[v("div",Be,[v("span",null,L(U.value)+" - 成绩录入",1),s(l(w),{link:"",style:{float:"right",padding:"3px 0"},type:"primary",onClick:j},{default:o(()=>a[6]||(a[6]=[c("保存所有修改 ")])),_:1})])]),default:o(()=>[v("div",Ne,[v("div",ze,[s(l(ne),{modelValue:f.value,"onUpdate:modelValue":a[0]||(a[0]=t=>f.value=t),placeholder:"选择学期",clearable:"",style:{width:"200px","margin-right":"10px"},onChange:X},{default:o(()=>[(i(!0),B(re,null,ue(D.value,t=>(i(),C(l(de),{key:t.id,label:t.termName,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),s(l(ie),{modelValue:V.value,"onUpdate:modelValue":a[1]||(a[1]=t=>V.value=t),clearable:"",placeholder:"搜索学生姓名或学号",style:{width:"240px"},onKeyup:ce(Y,["enter"])},{prefix:o(()=>[s(r,null,{default:o(()=>[s(l(me))]),_:1})]),_:1},8,["modelValue"])]),v("div",Se,[s(l(w),{link:"",style:{padding:"3px 0"},type:"primary",onClick:q},{default:o(()=>a[7]||(a[7]=[c("导出成绩")])),_:1}),s(l(w),{link:"",style:{padding:"3px 0"},type:"primary",onClick:A},{default:o(()=>a[8]||(a[8]=[c("导入成绩")])),_:1})])]),$((i(),C(l(fe),{data:p.value,"empty-text":"暂无学生或成绩记录",style:{width:"100%"}},{default:o(()=>[s(l(x),{label:"学号",prop:"student.studentId",width:"120"}),s(l(x),{label:"姓名",prop:"student.realName",width:"100"}),s(l(x),{label:"班级",prop:"student.className",width:"150"}),s(l(x),{label:"成绩",width:"150"},{default:o(({row:t})=>[s(l(ve),{modelValue:t.score,"onUpdate:modelValue":h=>t.score=h,min:0,max:100,precision:1,step:1,size:"small",style:{width:"100px"},onChange:h=>R(t)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),s(l(x),{label:"状态",width:"80"},{default:o(({row:t})=>[t.changed?(i(),C(l(G),{key:0,size:"small",type:"warning"},{default:o(()=>a[9]||(a[9]=[c("已修改")])),_:1})):(i(),C(l(G),{key:1,size:"small",type:"info"},{default:o(()=>a[10]||(a[10]=[c("未修改")])),_:1}))]),_:1}),s(l(x),{label:"上次更新时间","min-width":"150"},{default:o(({row:t})=>[c(L(l(xe)(t.updateTime)),1)]),_:1})]),_:1},8,["data"])),[[d,e.loading]]),E.value>0?(i(),B("div",Ue,[s(l(ge),{"current-page":y.value,"onUpdate:currentPage":a[2]||(a[2]=t=>y.value=t),"page-size":k.value,"onUpdate:pageSize":a[3]||(a[3]=t=>k.value=t),"page-sizes":[10,20,50,100],total:E.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:J,onCurrentChange:W},null,8,["current-page","page-size","total"])])):F("",!0),p.value.length===0&&!e.loading?(i(),C(l(ye),{key:1,description:"暂无学生数据"})):F("",!0)]),_:1})),[[d,e.loading]]),s(l(we),{modelValue:_.value,"onUpdate:modelValue":a[5]||(a[5]=t=>_.value=t),title:"导入成绩",width:"500px"},{footer:o(()=>[v("span",De,[s(l(w),{onClick:a[4]||(a[4]=t=>_.value=!1)},{default:o(()=>a[13]||(a[13]=[c("取消")])),_:1}),s(l(w),{disabled:!b.value,type:"primary",onClick:O},{default:o(()=>a[14]||(a[14]=[c(" 确认导入 ")])),_:1},8,["disabled"])])]),default:o(()=>[s(l(Ce),{"auto-upload":!1,limit:1,"on-change":H,accept:".xlsx,.xls,.csv",action:"#",class:"upload-demo"},{trigger:o(()=>[s(l(w),{type:"primary"},{default:o(()=>a[11]||(a[11]=[c("选择文件")])),_:1})]),tip:o(()=>a[12]||(a[12]=[v("div",{class:"el-upload__tip"}," 请上传Excel或CSV格式的成绩单文件。文件格式要求：第一列为学号，之后依次为考勤分、作业分、考试分。 ",-1)])),_:1})]),_:1},8,["modelValue"])])}}}),Ae=Z(Fe,[["__scopeId","data-v-1fbd5a99"]]);export{Ae as default};
