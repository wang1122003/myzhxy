import{_ as $,r as u,a as ue,S as me,b as _e,o as ee,R as E,d as _,e as r,f as a,w as s,j as fe,k as te,T as oe,K as z,L as A,z as k,U as ae,h as n,x as le,v as D,i as ge,P as U,V as q,W,X as j,Y as G,Z as X,$ as Y,a0 as Z,a1 as J,q as pe,A as L,l as ve,g as he,G as ye,a2 as Ce,a3 as be,F as y,D as ke,N as we,u as Pe,c as Te,a4 as Fe}from"./index-gQMZQ2sp.js";/* empty css                   *//* empty css               *//* empty css                  *//* empty css                 */import{T as Ve,E as Ee}from"./style-ssEox-hO.js";import{g as xe,c as Se,a as Q,b as Ie,d as ze,z as Ae,v as De}from"./zh-CN-Dc7yWMX2.js";import{r as Ue}from"./request-DfavLRg_.js";/* empty css                      */import{f as Be}from"./formatDistanceToNow-DX3kz_01.js";import"./api-endpoints-Ctc2JoQP.js";const Ne={name:"CreatePost",components:{Editor:Ee,Toolbar:Ve},emits:["post-created"],setup(N,{emit:o}){const w=u(null),e=ue({title:"",forumId:"",content:"",tags:[]}),P={title:[{required:!0,message:"请输入帖子标题",trigger:"blur"},{min:2,max:100,message:"标题长度在2到100个字符之间",trigger:"blur"}],forumId:[{required:!0,message:"请选择帖子分类",trigger:"change"}],content:[{required:!0,message:"请输入帖子内容",trigger:"blur"},{min:10,message:"内容不能少于10个字符",trigger:"blur"}]},x=u([]),C=u([]),g=u([]),b=u(!1),p=me(),T={excludeKeys:[]},m={placeholder:"请输入帖子内容...",MENU_CONF:{uploadImage:{server:"/api/forum/upload/image",fieldName:"file",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`},maxFileSize:5*1024*1024,maxNumberOfFiles:10,allowedFileTypes:["image/*"],customInsert(i,f){if(i.code===0&&i.data){let c=i.data;c&&!c.startsWith("http")&&(c=`${window.location.origin}/${c.startsWith("/")?c.substring(1):c}`),f(c,"",c)}else U.error(i.message||"图片上传失败")},onError(i,f,c){console.error("图片上传失败:",f,c),U.error(`图片 ${i.name} 上传失败: ${f.message}`)}}}},h=i=>{p.value=i},F=async()=>{try{const i=await xe();x.value=i.data||[]}catch(i){console.error("获取板块失败:",i),U.error("获取板块失败")}},d=async()=>{try{const i=await Ue.get("/forum/tags/popular");i&&i.data&&(C.value=i.data.map(f=>({value:f.id||f.name,label:f.name})))}catch(i){console.error("获取热门标签失败:",i)}},S=async()=>{w.value&&await w.value.validate(async i=>{if(i){b.value=!0;try{const f=p.value.getHtml(),c=p.value.getText(),R={title:e.title,forumId:e.forumId,content:f,summary:c.substring(0,150),tags:g.value.map(B=>({name:B}))},O=await Se(R);U.success("发布成功"),V(),o("post-created",O.data)}catch(f){console.error("发布失败:",f),U.error("发布失败: "+(f.message||"未知错误"))}finally{b.value=!1}}})},V=()=>{w.value&&w.value.resetFields(),e.title="",e.forumId="",e.content="",g.value=[],p.value&&p.value.setHtml("")};return _e(()=>{const i=p.value;i&&i.destroy()}),ee(()=>{F(),d()}),{postFormRef:w,postForm:e,rules:P,forums:x,availableTags:C,selectedTags:g,submitting:b,editorRef:p,toolbarConfig:T,editorConfig:m,handleEditorCreated:h,submitForm:S,resetForm:V}}},Re={class:"create-post-container"},Oe={style:{border:"1px solid #dcdfe6","border-radius":"4px"}};function Le(N,o,w,e,P,x){const C=te,g=fe,b=ae,p=oe,T=E("Toolbar"),m=E("Editor"),h=le,F=ge;return r(),_("div",Re,[a(F,{ref:"postFormRef",model:e.postForm,rules:e.rules,"label-width":"80px"},{default:s(()=>[a(g,{label:"标题",prop:"title"},{default:s(()=>[a(C,{modelValue:e.postForm.title,"onUpdate:modelValue":o[0]||(o[0]=d=>e.postForm.title=d),maxlength:"50",placeholder:"请输入帖子标题（2-50个字符）","show-word-limit":""},null,8,["modelValue"])]),_:1}),a(g,{label:"分类",prop:"forumId"},{default:s(()=>[a(p,{modelValue:e.postForm.forumId,"onUpdate:modelValue":o[1]||(o[1]=d=>e.postForm.forumId=d),placeholder:"请选择分类",style:{width:"100%"}},{default:s(()=>[(r(!0),_(z,null,A(e.forums,d=>(r(),k(b,{key:d.id,label:d.name,value:d.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(g,{label:"标签"},{default:s(()=>[a(p,{modelValue:e.selectedTags,"onUpdate:modelValue":o[2]||(o[2]=d=>e.selectedTags=d),max:5,"max-collapse-tags":3,"allow-create":"","default-first-option":"",filterable:"",multiple:"",placeholder:"请选择或输入标签，最多5个",style:{width:"100%"}},{default:s(()=>[(r(!0),_(z,null,A(e.availableTags,d=>(r(),k(b,{key:d.value,label:d.label,value:d.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(g,{label:"内容",prop:"content"},{default:s(()=>[n("div",Oe,[a(T,{defaultConfig:e.toolbarConfig,editor:e.editorRef,mode:"default",style:{"border-bottom":"1px solid #dcdfe6"}},null,8,["defaultConfig","editor"]),a(m,{modelValue:e.postForm.content,"onUpdate:modelValue":o[3]||(o[3]=d=>e.postForm.content=d),defaultConfig:e.editorConfig,mode:"default",style:{height:"350px","overflow-y":"hidden"},onOnCreated:e.handleEditorCreated},null,8,["modelValue","defaultConfig","onOnCreated"])])]),_:1}),a(g,null,{default:s(()=>[a(h,{loading:e.submitting,type:"primary",onClick:e.submitForm},{default:s(()=>o[4]||(o[4]=[D("发布帖子")])),_:1},8,["loading","onClick"]),a(h,{onClick:e.resetForm},{default:s(()=>o[5]||(o[5]=[D("重置")])),_:1},8,["onClick"])]),_:1})]),_:1},8,["model","rules"])])}const ne=$(Ne,[["render",Le],["__scopeId","data-v-d75fa88e"]]),Ke={name:"ForumPage",components:{CreatePost:ne,EditPen:J,InfoFilled:Z,View:Y,ChatDotRound:X,Star:G,Opportunity:j,Collection:W,Search:q},setup(){const N=Pe(),o=Te(()=>!!localStorage.getItem("token")),w=u([]),e=u(!1),P=u(1),x=u(10),C=u(0),g=u(""),b=u(""),p=u("createTime"),T=u([]),m=u(null),h=u([]),F=u(!1),d=u([]),S=u(!1),V=u(!1),i="/src/assets/default-avatar.png",f=async()=>{try{const l=await Q();l.data&&(T.value=l.data.map(v=>({value:v.id,label:v.name})))}catch(l){console.error("获取分类失败:",l)}},c=async()=>{e.value=!0;try{const l={page:P.value,size:x.value,sortBy:p.value,sortOrder:"desc"};g.value&&(l.category=g.value),b.value&&(l.keyword=b.value),m.value&&(l.tagId=m.value);const v=await Ie(l);w.value=v.data.rows,C.value=v.data.total}catch(l){console.error("获取帖子列表失败:",l),U.error("获取帖子列表失败")}finally{e.value=!1}},R=async()=>{F.value=!0;try{const l=await ze();h.value=l.data.slice(0,10)}catch(l){console.error("获取热门帖子失败:",l)}finally{F.value=!1}},O=async()=>{S.value=!0;try{const l=await Q({limit:15,sortBy:"count"});Array.isArray(l.data)?d.value=l.data.slice(0,15).map(v=>({...v,count:v.count||0})):d.value=[]}catch(l){console.error("获取热门标签失败:",l)}finally{S.value=!1}},B=l=>{x.value=l,c()},K=l=>{P.value=l,c()},M=()=>{P.value=1,c()},H=()=>{P.value=1,c()},t=l=>{m.value===l.id?m.value=null:m.value=l.id,P.value=1,c()},I=async l=>{try{await De(l)}catch(v){console.error("增加浏览量失败:",v)}N.push(`/forum/post/${l}`)},se=l=>{const v=T.value.find(ce=>ce.value===l);return v?v.label:l},re=l=>{try{return Be(new Date(l),{addSuffix:!0,locale:Ae})}catch{return l}},ie=()=>{V.value=!1,c(),U.success("发布成功")},de=()=>{N.push("/login")};return ee(()=>{f(),c(),R(),O()}),{posts:w,loading:e,currentPage:P,pageSize:x,total:C,selectedCategory:g,searchKeyword:b,sortBy:p,categories:T,hotPosts:h,loadingHotPosts:F,popularTags:d,loadingTags:S,selectedTag:m,showPostModal:V,isLoggedIn:o,defaultAvatar:i,fetchPosts:c,handleSizeChange:B,handleCurrentChange:K,handleCategoryChange:M,handleSearch:H,handleTagClick:t,goToPostDetail:I,getCategoryLabel:se,formatTime:re,handlePostCreated:ie,goToLogin:de,Search:q,View:Y,ChatDotRound:X,Star:G,Opportunity:j,Collection:W,EditPen:J,InfoFilled:Z}}},Me={class:"forum-container"},He={class:"forum-header"},qe={class:"filter-bar"},We={class:"search-bar"},je={class:"forum-content"},Ge={class:"main-content"},Xe={class:"post-list-container"},Ye={class:"login-hint"},Ze={class:"post-header"},Je={class:"post-author"},Qe={class:"author-info"},$e={class:"author-name"},et={class:"post-time"},tt={key:0,class:"post-category"},ot={class:"post-title"},at={class:"post-summary"},lt={class:"post-footer"},nt={class:"post-stats"},st={class:"stat-item"},rt={class:"stat-item"},it={class:"stat-item"},dt={key:0,class:"post-tags"},ct={key:0},ut={key:0,class:"pagination-container"},mt={class:"side-content"},_t={class:"side-card-header"},ft={key:1,class:"no-data"},gt={key:2,class:"hot-post-list"},pt=["onClick"],vt={class:"hot-post-title"},ht={class:"hot-post-count"},yt={class:"side-card-header"},Ct={key:1,class:"no-data"},bt={key:2,class:"tag-cloud"};function kt(N,o,w,e,P,x){const C=ae,g=oe,b=te,p=le,T=E("EditPen"),m=ve,h=he,F=E("InfoFilled"),d=ye,S=Fe,V=ke,i=E("View"),f=E("ChatDotRound"),c=E("Star"),R=Ce,O=E("Opportunity"),B=be,K=E("Collection"),M=ne,H=we;return r(),_("div",Me,[o[13]||(o[13]=n("h1",{class:"forum-title"},"校园论坛",-1)),n("div",He,[n("div",qe,[a(g,{modelValue:e.selectedCategory,"onUpdate:modelValue":o[0]||(o[0]=t=>e.selectedCategory=t),clearable:"",placeholder:"选择分类",onChange:e.handleCategoryChange},{default:s(()=>[(r(!0),_(z,null,A(e.categories,t=>(r(),k(C,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onChange"]),a(g,{modelValue:e.sortBy,"onUpdate:modelValue":o[1]||(o[1]=t=>e.sortBy=t),placeholder:"排序方式",onChange:e.fetchPosts},{default:s(()=>[a(C,{label:"最新发布",value:"createTime"}),a(C,{label:"最多浏览",value:"viewCount"}),a(C,{label:"最多点赞",value:"likeCount"})]),_:1},8,["modelValue","onChange"])]),n("div",We,[a(b,{modelValue:e.searchKeyword,"onUpdate:modelValue":o[2]||(o[2]=t=>e.searchKeyword=t),"prefix-icon":e.Search,clearable:"",placeholder:"搜索帖子",onKeyup:pe(e.handleSearch,["enter"])},null,8,["modelValue","prefix-icon","onKeyup"]),a(p,{type:"primary",onClick:e.handleSearch},{default:s(()=>o[7]||(o[7]=[D("搜索")])),_:1},8,["onClick"])])]),n("div",je,[n("div",Ge,[n("div",Xe,[!e.loading&&e.isLoggedIn?(r(),k(h,{key:0,class:"create-post-card"},{default:s(()=>[n("div",{class:"create-post-btn",onClick:o[3]||(o[3]=t=>e.showPostModal=!0)},[a(m,null,{default:s(()=>[a(T)]),_:1}),o[8]||(o[8]=n("span",null,"发布新帖子",-1))])]),_:1})):!e.loading&&!e.isLoggedIn?(r(),k(h,{key:1,class:"login-hint-card"},{default:s(()=>[n("div",Ye,[a(m,null,{default:s(()=>[a(F)]),_:1}),o[10]||(o[10]=n("span",null,"登录后可发布新帖子和参与评论",-1)),a(p,{size:"small",type:"primary",onClick:e.goToLogin},{default:s(()=>o[9]||(o[9]=[D("去登录")])),_:1},8,["onClick"])])]),_:1})):L("",!0),!e.loading&&e.posts.length===0?(r(),k(d,{key:2,description:"暂无相关帖子"})):(r(!0),_(z,{key:3},A(e.posts,t=>(r(),k(h,{key:t.id,class:"post-card",onClick:I=>e.goToPostDetail(t.id)},{default:s(()=>[n("div",Ze,[n("div",Je,[a(S,{size:40,src:t.avatar||e.defaultAvatar},null,8,["src"]),n("div",Qe,[n("div",$e,y(t.authorName),1),n("div",et,y(e.formatTime(t.createTime)),1)])]),t.category?(r(),_("div",tt,[a(V,{size:"small"},{default:s(()=>[D(y(e.getCategoryLabel(t.category)),1)]),_:2},1024)])):L("",!0)]),n("div",ot,y(t.title),1),n("div",at,y(t.summary||t.content.substring(0,100)+"..."),1),n("div",lt,[n("div",nt,[n("div",st,[a(m,null,{default:s(()=>[a(i)]),_:1}),n("span",null,y(t.viewCount),1)]),n("div",rt,[a(m,null,{default:s(()=>[a(f)]),_:1}),n("span",null,y(t.commentCount),1)]),n("div",it,[a(m,null,{default:s(()=>[a(c)]),_:1}),n("span",null,y(t.likeCount),1)])]),Array.isArray(t.tags)&&t.tags.length>0?(r(),_("div",dt,[(r(!0),_(z,null,A(t.tags.slice(0,3),I=>(r(),k(V,{key:I.id,effect:"plain",size:"small"},{default:s(()=>[D(y(I.name),1)]),_:2},1024))),128)),Array.isArray(t.tags)&&t.tags.length>3?(r(),_("span",ct,"...")):L("",!0)])):L("",!0)])]),_:2},1032,["onClick"]))),128))]),e.posts.length>0?(r(),_("div",ut,[a(R,{"current-page":e.currentPage,"onUpdate:currentPage":o[4]||(o[4]=t=>e.currentPage=t),"page-size":e.pageSize,"onUpdate:pageSize":o[5]||(o[5]=t=>e.pageSize=t),"page-sizes":[10,20,50,100],total:e.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:e.handleSizeChange,onCurrentChange:e.handleCurrentChange},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])):L("",!0)]),n("div",mt,[a(h,{class:"hot-post-card"},{header:s(()=>[n("div",_t,[a(m,null,{default:s(()=>[a(O)]),_:1}),o[11]||(o[11]=n("span",null,"热门帖子",-1))])]),default:s(()=>[e.loadingHotPosts?(r(),k(B,{key:0,rows:5,animated:""})):e.hotPosts.length===0?(r(),_("div",ft,"暂无热门帖子")):(r(),_("ul",gt,[(r(!0),_(z,null,A(e.hotPosts,t=>(r(),_("li",{key:t.id,onClick:I=>e.goToPostDetail(t.id)},[n("span",vt,y(t.title),1),n("span",ht,y(t.viewCount)+" 浏览",1)],8,pt))),128))]))]),_:1}),a(h,{class:"tag-cloud-card"},{header:s(()=>[n("div",yt,[a(m,null,{default:s(()=>[a(K)]),_:1}),o[12]||(o[12]=n("span",null,"热门标签",-1))])]),default:s(()=>[e.loadingTags?(r(),k(B,{key:0,rows:3,animated:""})):e.popularTags.length===0?(r(),_("div",Ct,"暂无热门标签")):(r(),_("div",bt,[(r(!0),_(z,null,A(e.popularTags,t=>(r(),k(V,{key:t.id,effect:e.selectedTag===t.id?"dark":"plain",class:"tag-item",onClick:I=>e.handleTagClick(t)},{default:s(()=>[D(y(t.name)+" ("+y(t.count)+") ",1)]),_:2},1032,["effect","onClick"]))),128))]))]),_:1})])]),a(H,{modelValue:e.showPostModal,"onUpdate:modelValue":o[6]||(o[6]=t=>e.showPostModal=t),"close-on-click-modal":!1,title:"发布新帖子",width:"70%"},{default:s(()=>[a(M,{onPostCreated:e.handlePostCreated},null,8,["onPostCreated"])]),_:1},8,["modelValue"])])}const Dt=$(Ke,[["render",kt],["__scopeId","data-v-2e8ae2ef"]]);export{Dt as default};
