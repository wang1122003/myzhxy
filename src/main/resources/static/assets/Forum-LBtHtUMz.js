import{_ as $,r as u,a as ue,S as me,b as _e,o as ee,R as E,d as _,e as r,f as a,w as s,j as fe,k as oe,T as te,K as z,L as R,z as k,U as ae,h as n,x as le,v as A,i as ge,P as D,V as q,W,X as j,Y as G,Z as X,$ as Y,a0 as Z,a1 as J,q as ve,A as L,l as pe,g as he,G as ye,a2 as Ce,a3 as be,F as y,D as ke,N as we,u as Pe,c as Te,a4 as Fe}from"./index-DrN7HJWs.js";/* empty css                   */import{T as Ve,E as Ee}from"./index.esm-DkpRIv3G.js";import"./style-B_IV0DVr.js";import{g as xe,c as Se,a as Q,b as Ie,d as ze,z as Re,v as Ae}from"./zh-CN-BzENR6_-.js";import{r as De}from"./request-BGbcGZqw.js";import{f as Ue}from"./formatDistanceToNow-DPjnvkCL.js";const Be={name:"CreatePost",components:{Editor:Ee,Toolbar:Ve},emits:["post-created"],setup(B,{emit:t}){const w=u(null),e=ue({title:"",forumId:"",content:"",tags:[]}),P={title:[formRules.required,{min:2,max:100,message:"标题长度在2到100个字符之间",trigger:"blur"}],forumId:[formRules.required],content:[formRules.required,{min:10,message:"内容不能少于10个字符",trigger:"blur"}]},x=u([]),C=u([]),g=u([]),b=u(!1),v=me(),T={excludeKeys:[]},m={placeholder:"请输入帖子内容...",MENU_CONF:{uploadImage:{server:"/api/forum/upload/image",fieldName:"file",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`},maxFileSize:5*1024*1024,maxNumberOfFiles:10,allowedFileTypes:["image/*"],customInsert(i,f){if(i.code===0&&i.data){let c=i.data;c&&!c.startsWith("http")&&(c=`${window.location.origin}/${c.startsWith("/")?c.substring(1):c}`),f(c,"",c)}else D.error(i.message||"图片上传失败")},onError(i,f,c){console.error("图片上传失败:",f,c),D.error(`图片 ${i.name} 上传失败: ${f.message}`)}}}},h=i=>{v.value=i},F=async()=>{try{const i=await xe();x.value=i.data||[]}catch(i){console.error("获取板块失败:",i),D.error("获取板块失败")}},d=async()=>{try{const i=await De.get("/forum/tags/popular");i&&i.data&&(C.value=i.data.map(f=>({value:f.id||f.name,label:f.name})))}catch(i){console.error("获取热门标签失败:",i)}},S=async()=>{w.value&&await w.value.validate(async i=>{if(i){b.value=!0;try{const f=v.value.getHtml(),c=v.value.getText(),N={title:e.title,forumId:e.forumId,content:f,summary:c.substring(0,150),tags:g.value.map(U=>({name:U}))},O=await Se(N);D.success("发布成功"),V(),t("post-created",O.data)}catch(f){console.error("发布失败:",f),D.error("发布失败: "+(f.message||"未知错误"))}finally{b.value=!1}}})},V=()=>{w.value&&w.value.resetFields(),e.title="",e.forumId="",e.content="",g.value=[],v.value&&v.value.setHtml("")};return _e(()=>{const i=v.value;i&&i.destroy()}),ee(()=>{F(),d()}),{postFormRef:w,postForm:e,rules:P,forums:x,availableTags:C,selectedTags:g,submitting:b,editorRef:v,toolbarConfig:T,editorConfig:m,handleEditorCreated:h,submitForm:S,resetForm:V}}},Ne={class:"create-post-container"},Oe={style:{border:"1px solid #dcdfe6","border-radius":"4px"}};function Le(B,t,w,e,P,x){const C=oe,g=fe,b=ae,v=te,T=E("Toolbar"),m=E("Editor"),h=le,F=ge;return r(),_("div",Ne,[a(F,{ref:"postFormRef",model:e.postForm,rules:e.rules,"label-width":"80px"},{default:s(()=>[a(g,{label:"标题",prop:"title"},{default:s(()=>[a(C,{modelValue:e.postForm.title,"onUpdate:modelValue":t[0]||(t[0]=d=>e.postForm.title=d),maxlength:"50",placeholder:"请输入帖子标题（2-50个字符）","show-word-limit":""},null,8,["modelValue"])]),_:1}),a(g,{label:"分类",prop:"forumId"},{default:s(()=>[a(v,{modelValue:e.postForm.forumId,"onUpdate:modelValue":t[1]||(t[1]=d=>e.postForm.forumId=d),placeholder:"请选择分类",style:{width:"100%"}},{default:s(()=>[(r(!0),_(z,null,R(e.forums,d=>(r(),k(b,{key:d.id,label:d.name,value:d.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(g,{label:"标签"},{default:s(()=>[a(v,{modelValue:e.selectedTags,"onUpdate:modelValue":t[2]||(t[2]=d=>e.selectedTags=d),max:5,"max-collapse-tags":3,"allow-create":"","default-first-option":"",filterable:"",multiple:"",placeholder:"请选择或输入标签，最多5个",style:{width:"100%"}},{default:s(()=>[(r(!0),_(z,null,R(e.availableTags,d=>(r(),k(b,{key:d.value,label:d.label,value:d.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(g,{label:"内容",prop:"content"},{default:s(()=>[n("div",Oe,[a(T,{defaultConfig:e.toolbarConfig,editor:e.editorRef,mode:"default",style:{"border-bottom":"1px solid #dcdfe6"}},null,8,["defaultConfig","editor"]),a(m,{modelValue:e.postForm.content,"onUpdate:modelValue":t[3]||(t[3]=d=>e.postForm.content=d),defaultConfig:e.editorConfig,mode:"default",style:{height:"350px","overflow-y":"hidden"},onOnCreated:e.handleEditorCreated},null,8,["modelValue","defaultConfig","onOnCreated"])])]),_:1}),a(g,null,{default:s(()=>[a(h,{loading:e.submitting,type:"primary",onClick:e.submitForm},{default:s(()=>t[4]||(t[4]=[A("发布帖子")])),_:1},8,["loading","onClick"]),a(h,{onClick:e.resetForm},{default:s(()=>t[5]||(t[5]=[A("重置")])),_:1},8,["onClick"])]),_:1})]),_:1},8,["model","rules"])])}const ne=$(Be,[["render",Le],["__scopeId","data-v-e8aa1fdd"]]),Ke={name:"ForumPage",components:{CreatePost:ne,EditPen:J,InfoFilled:Z,View:Y,ChatDotRound:X,Star:G,Opportunity:j,Collection:W,Search:q},setup(){const B=Pe(),t=Te(()=>!!localStorage.getItem("token")),w=u([]),e=u(!1),P=u(1),x=u(10),C=u(0),g=u(""),b=u(""),v=u("createTime"),T=u([]),m=u(null),h=u([]),F=u(!1),d=u([]),S=u(!1),V=u(!1),i="/src/assets/default-avatar.png",f=async()=>{try{const l=await Q();l.data&&(T.value=l.data.map(p=>({value:p.id,label:p.name})))}catch(l){console.error("获取分类失败:",l)}},c=async()=>{e.value=!0;try{const l={page:P.value,size:x.value,sortBy:v.value,sortOrder:"desc"};g.value&&(l.category=g.value),b.value&&(l.keyword=b.value),m.value&&(l.tagId=m.value);const p=await Ie(l);w.value=p.data.rows,C.value=p.data.total}catch(l){console.error("获取帖子列表失败:",l),D.error("获取帖子列表失败")}finally{e.value=!1}},N=async()=>{F.value=!0;try{const l=await ze();h.value=l.data.slice(0,10)}catch(l){console.error("获取热门帖子失败:",l)}finally{F.value=!1}},O=async()=>{S.value=!0;try{const l=await Q({limit:15,sortBy:"count"});Array.isArray(l.data)?d.value=l.data.slice(0,15).map(p=>({...p,count:p.count||0})):d.value=[]}catch(l){console.error("获取热门标签失败:",l)}finally{S.value=!1}},U=l=>{x.value=l,c()},K=l=>{P.value=l,c()},M=()=>{P.value=1,c()},H=()=>{P.value=1,c()},o=l=>{m.value===l.id?m.value=null:m.value=l.id,P.value=1,c()},I=async l=>{try{await Ae(l)}catch(p){console.error("增加浏览量失败:",p)}B.push(`/forum/post/${l}`)},se=l=>{const p=T.value.find(ce=>ce.value===l);return p?p.label:l},re=l=>{try{return Ue(new Date(l),{addSuffix:!0,locale:Re})}catch{return l}},ie=()=>{V.value=!1,c(),D.success("发布成功")},de=()=>{B.push("/login")};return ee(()=>{f(),c(),N(),O()}),{posts:w,loading:e,currentPage:P,pageSize:x,total:C,selectedCategory:g,searchKeyword:b,sortBy:v,categories:T,hotPosts:h,loadingHotPosts:F,popularTags:d,loadingTags:S,selectedTag:m,showPostModal:V,isLoggedIn:t,defaultAvatar:i,fetchPosts:c,handleSizeChange:U,handleCurrentChange:K,handleCategoryChange:M,handleSearch:H,handleTagClick:o,goToPostDetail:I,getCategoryLabel:se,formatTime:re,handlePostCreated:ie,goToLogin:de,Search:q,View:Y,ChatDotRound:X,Star:G,Opportunity:j,Collection:W,EditPen:J,InfoFilled:Z}}},Me={class:"forum-container"},He={class:"forum-header"},qe={class:"filter-bar"},We={class:"search-bar"},je={class:"forum-content"},Ge={class:"main-content"},Xe={class:"post-list-container"},Ye={class:"login-hint"},Ze={class:"post-header"},Je={class:"post-author"},Qe={class:"author-info"},$e={class:"author-name"},eo={class:"post-time"},oo={key:0,class:"post-category"},to={class:"post-title"},ao={class:"post-summary"},lo={class:"post-footer"},no={class:"post-stats"},so={class:"stat-item"},ro={class:"stat-item"},io={class:"stat-item"},co={key:0,class:"post-tags"},uo={key:0},mo={key:0,class:"pagination-container"},_o={class:"side-content"},fo={class:"side-card-header"},go={key:1,class:"no-data"},vo={key:2,class:"hot-post-list"},po=["onClick"],ho={class:"hot-post-title"},yo={class:"hot-post-count"},Co={class:"side-card-header"},bo={key:1,class:"no-data"},ko={key:2,class:"tag-cloud"};function wo(B,t,w,e,P,x){const C=ae,g=te,b=oe,v=le,T=E("EditPen"),m=pe,h=he,F=E("InfoFilled"),d=ye,S=Fe,V=ke,i=E("View"),f=E("ChatDotRound"),c=E("Star"),N=Ce,O=E("Opportunity"),U=be,K=E("Collection"),M=ne,H=we;return r(),_("div",Me,[t[13]||(t[13]=n("h1",{class:"forum-title"},"校园论坛",-1)),n("div",He,[n("div",qe,[a(g,{modelValue:e.selectedCategory,"onUpdate:modelValue":t[0]||(t[0]=o=>e.selectedCategory=o),clearable:"",placeholder:"选择分类",onChange:e.handleCategoryChange},{default:s(()=>[(r(!0),_(z,null,R(e.categories,o=>(r(),k(C,{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onChange"]),a(g,{modelValue:e.sortBy,"onUpdate:modelValue":t[1]||(t[1]=o=>e.sortBy=o),placeholder:"排序方式",onChange:e.fetchPosts},{default:s(()=>[a(C,{label:"最新发布",value:"createTime"}),a(C,{label:"最多浏览",value:"viewCount"}),a(C,{label:"最多点赞",value:"likeCount"})]),_:1},8,["modelValue","onChange"])]),n("div",We,[a(b,{modelValue:e.searchKeyword,"onUpdate:modelValue":t[2]||(t[2]=o=>e.searchKeyword=o),"prefix-icon":e.Search,clearable:"",placeholder:"搜索帖子",onKeyup:ve(e.handleSearch,["enter"])},null,8,["modelValue","prefix-icon","onKeyup"]),a(v,{type:"primary",onClick:e.handleSearch},{default:s(()=>t[7]||(t[7]=[A("搜索")])),_:1},8,["onClick"])])]),n("div",je,[n("div",Ge,[n("div",Xe,[!e.loading&&e.isLoggedIn?(r(),k(h,{key:0,class:"create-post-card"},{default:s(()=>[n("div",{class:"create-post-btn",onClick:t[3]||(t[3]=o=>e.showPostModal=!0)},[a(m,null,{default:s(()=>[a(T)]),_:1}),t[8]||(t[8]=n("span",null,"发布新帖子",-1))])]),_:1})):!e.loading&&!e.isLoggedIn?(r(),k(h,{key:1,class:"login-hint-card"},{default:s(()=>[n("div",Ye,[a(m,null,{default:s(()=>[a(F)]),_:1}),t[10]||(t[10]=n("span",null,"登录后可发布新帖子和参与评论",-1)),a(v,{size:"small",type:"primary",onClick:e.goToLogin},{default:s(()=>t[9]||(t[9]=[A("去登录")])),_:1},8,["onClick"])])]),_:1})):L("",!0),!e.loading&&e.posts.length===0?(r(),k(d,{key:2,description:"暂无相关帖子"})):(r(!0),_(z,{key:3},R(e.posts,o=>(r(),k(h,{key:o.id,class:"post-card",onClick:I=>e.goToPostDetail(o.id)},{default:s(()=>[n("div",Ze,[n("div",Je,[a(S,{size:40,src:o.avatar||e.defaultAvatar},null,8,["src"]),n("div",Qe,[n("div",$e,y(o.authorName),1),n("div",eo,y(e.formatTime(o.createTime)),1)])]),o.category?(r(),_("div",oo,[a(V,{size:"small"},{default:s(()=>[A(y(e.getCategoryLabel(o.category)),1)]),_:2},1024)])):L("",!0)]),n("div",to,y(o.title),1),n("div",ao,y(o.summary||o.content.substring(0,100)+"..."),1),n("div",lo,[n("div",no,[n("div",so,[a(m,null,{default:s(()=>[a(i)]),_:1}),n("span",null,y(o.viewCount),1)]),n("div",ro,[a(m,null,{default:s(()=>[a(f)]),_:1}),n("span",null,y(o.commentCount),1)]),n("div",io,[a(m,null,{default:s(()=>[a(c)]),_:1}),n("span",null,y(o.likeCount),1)])]),Array.isArray(o.tags)&&o.tags.length>0?(r(),_("div",co,[(r(!0),_(z,null,R(o.tags.slice(0,3),I=>(r(),k(V,{key:I.id,effect:"plain",size:"small"},{default:s(()=>[A(y(I.name),1)]),_:2},1024))),128)),Array.isArray(o.tags)&&o.tags.length>3?(r(),_("span",uo,"...")):L("",!0)])):L("",!0)])]),_:2},1032,["onClick"]))),128))]),e.posts.length>0?(r(),_("div",mo,[a(N,{"current-page":e.currentPage,"onUpdate:currentPage":t[4]||(t[4]=o=>e.currentPage=o),"page-size":e.pageSize,"onUpdate:pageSize":t[5]||(t[5]=o=>e.pageSize=o),"page-sizes":[10,20,50,100],total:e.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:e.handleSizeChange,onCurrentChange:e.handleCurrentChange},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])):L("",!0)]),n("div",_o,[a(h,{class:"hot-post-card"},{header:s(()=>[n("div",fo,[a(m,null,{default:s(()=>[a(O)]),_:1}),t[11]||(t[11]=n("span",null,"热门帖子",-1))])]),default:s(()=>[e.loadingHotPosts?(r(),k(U,{key:0,rows:5,animated:""})):e.hotPosts.length===0?(r(),_("div",go,"暂无热门帖子")):(r(),_("ul",vo,[(r(!0),_(z,null,R(e.hotPosts,o=>(r(),_("li",{key:o.id,onClick:I=>e.goToPostDetail(o.id)},[n("span",ho,y(o.title),1),n("span",yo,y(o.viewCount)+" 浏览",1)],8,po))),128))]))]),_:1}),a(h,{class:"tag-cloud-card"},{header:s(()=>[n("div",Co,[a(m,null,{default:s(()=>[a(K)]),_:1}),t[12]||(t[12]=n("span",null,"热门标签",-1))])]),default:s(()=>[e.loadingTags?(r(),k(U,{key:0,rows:3,animated:""})):e.popularTags.length===0?(r(),_("div",bo,"暂无热门标签")):(r(),_("div",ko,[(r(!0),_(z,null,R(e.popularTags,o=>(r(),k(V,{key:o.id,effect:e.selectedTag===o.id?"dark":"plain",class:"tag-item",onClick:I=>e.handleTagClick(o)},{default:s(()=>[A(y(o.name)+" ("+y(o.count)+") ",1)]),_:2},1032,["effect","onClick"]))),128))]))]),_:1})])]),a(H,{modelValue:e.showPostModal,"onUpdate:modelValue":t[6]||(t[6]=o=>e.showPostModal=o),"close-on-click-modal":!1,title:"发布新帖子",width:"70%"},{default:s(()=>[a(M,{onPostCreated:e.handlePostCreated},null,8,["onPostCreated"])]),_:1},8,["modelValue"])])}const Io=$(Ke,[["render",wo],["__scopeId","data-v-2ef829df"]]);export{Io as default};
