import{_ as ne,u as le,r as m,a as R,o as se,n as re,c as ie,b as de,d as w,e as f,f as o,w as a,E as ce,g as ue,h as r,i as me,j as pe,k as fe,l as _e,m as U,p as ge,q as he,s as ve,t as we,v as p,x as ye,y as q,z as K,A as I,B as be,C as ke,D as Ee,F as y,G as Ce,H as Te,I as xe,J as Le,K as Ne,L as Ve,M as He,N as Re,O as Ue,P as _}from"./index-gQMZQ2sp.js";/* empty css                   *//* empty css                   *//* empty css                   *//* empty css               *//* empty css                        *//* empty css               *//* empty css                 */import{g as Ie,a as Be}from"./notice-BMWBVm9P.js";import{l as De}from"./user-xlhqAG_R.js";import{d as Fe}from"./file-Ck7nKFvu.js";import{g as $e}from"./common-CbP0GatP.js";import"./request-DfavLRg_.js";import"./api-endpoints-Ctc2JoQP.js";const Me={class:"home-container"},Pe={class:"card-header"},je={key:0},Ae={class:"notice-content"},Oe={class:"notice-info"},ze=["innerHTML"],qe={key:0,class:"notice-attachments"},Ke={class:"dialog-footer"},Se={name:"HomePage"},Ge=Object.assign(Se,{setup(Je){const g=le(),B=m(null),x=m([]),b=m(!1),L=m(!1),N=m(!1),h=m(!1),V=m(!1),k=R({}),D=m([]),S=m("400px"),d=R({id:null,title:"",publisher:"",publishTime:"",content:"",attachments:[]}),s=R({username:"",password:"",remember:!1}),G={username:[{required:!0,message:"请输入用户名",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"}]};se(async()=>{const t=localStorage.getItem("username");t&&(s.username=t,s.remember=!0),await Promise.all([J(),Q()]),re(()=>{H()}),window.addEventListener("resize",H)});const J=async()=>{b.value=!0;try{const t=await Ie();t.code===200&&t.data?x.value=t.data.slice(0,5):console.error("获取最近通知失败:",t.message)}catch(t){console.error("获取最近通知异常:",t)}finally{b.value=!1}},Q=async()=>{L.value=!0;try{const t=await $e();D.value=t.data||[]}catch(t){console.error("获取通知类型失败",t)}finally{L.value=!1}},F=ie(()=>{const t={};return D.value.forEach(e=>{t[e.typeCode]={name:e.typeName,tag:e.tagType||"info"}}),t}),$=()=>{B.value.validate(t=>{t&&(N.value=!0,De(s).then(e=>{const{token:c,user:i}=e.data,l=Ue({token:c,user:i});s.remember?localStorage.setItem("username",s.username):localStorage.removeItem("username"),_.success("登录成功"),console.log("[HomePage] Redirecting based on role from authLogin:",l),l==="admin"?g.push("/admin"):l==="teacher"?g.push("/teacher"):l==="student"?g.push("/student"):(console.error("[HomePage] Login successful, but role from authLogin is unknown/invalid:",l),g.push("/"))}).catch(e=>{var i,l;const c=((l=(i=e==null?void 0:e.response)==null?void 0:i.data)==null?void 0:l.message)||"用户名或密码错误";_.error(c),console.error("登录请求失败:",e)}).finally(()=>{N.value=!1}))})},W=async t=>{V.value=!0,h.value=!0,d.id=null;try{const e=await Be(t.id);Object.assign(d,e.data)}catch(e){console.error("获取通知详情失败",e),_.error("获取通知详情失败"),h.value=!1}finally{V.value=!1}},X=()=>{g.push("/notices")},M=t=>{if(!t)return"";try{return new Date(t).toLocaleString("zh-CN",{hour12:!1})}catch{return t}},Y=async t=>{if(!t||!t.id){_.warning("无效的文件信息");return}k[t.id]=!0;try{const e=await Fe(t.id),c=e.headers["content-disposition"];let i=t.name;if(c){const v=c.match(/filename\*?=UTF-8''(.*)$/i)||c.match(/filename="(.*)"$/i);v&&v[1]&&(i=decodeURIComponent(v[1]))}const l=new Blob([e.data],{type:e.headers["content-type"]}),E=window.URL.createObjectURL(l),u=document.createElement("a");u.href=E,u.setAttribute("download",i),document.body.appendChild(u),u.click(),document.body.removeChild(u),window.URL.revokeObjectURL(E),_.success(`附件 ${i} 下载成功`)}catch(e){console.error("下载附件失败",e),_.error(`下载附件 ${t.name} 失败`)}finally{k[t.id]=!1}},H=()=>{const e=window.innerHeight-300;S.value=e>200?`${e}px`:"200px"};return de(()=>{window.removeEventListener("resize",H)}),(t,e)=>{const c=_e,i=fe,l=pe,E=we,u=ye,v=me,P=ue,j=ce,C=ke,Z=Ee,ee=be,te=Ce,oe=xe,A=Le,ae=Re,O=Te;return f(),w("div",Me,[o(oe,{gutter:20},{default:a(()=>[o(j,{md:8,sm:24,xs:24,class:"login-col"},{default:a(()=>[o(P,{class:"login-card home-card"},{default:a(()=>[e[7]||(e[7]=r("div",{class:"login-header card-header"},[r("h2",null,"用户登录")],-1)),o(v,{ref_key:"loginFormRef",ref:B,model:s,rules:G,"label-width":"0"},{default:a(()=>[o(l,{prop:"username"},{default:a(()=>[o(i,{modelValue:s.username,"onUpdate:modelValue":e[0]||(e[0]=n=>s.username=n),clearable:"",placeholder:"用户名"},{prefix:a(()=>[o(c,null,{default:a(()=>[o(U(ge))]),_:1})]),_:1},8,["modelValue"])]),_:1}),o(l,{prop:"password"},{default:a(()=>[o(i,{modelValue:s.password,"onUpdate:modelValue":e[1]||(e[1]=n=>s.password=n),clearable:"",placeholder:"密码","show-password":"",type:"password",onKeyup:he($,["enter"])},{prefix:a(()=>[o(c,null,{default:a(()=>[o(U(ve))]),_:1})]),_:1},8,["modelValue"])]),_:1}),o(l,null,{default:a(()=>[o(E,{modelValue:s.remember,"onUpdate:modelValue":e[2]||(e[2]=n=>s.remember=n)},{default:a(()=>e[5]||(e[5]=[p(" 记住用户名 ")])),_:1},8,["modelValue"])]),_:1}),o(l,null,{default:a(()=>[o(u,{loading:N.value,style:{width:"100%"},type:"primary",onClick:$},{default:a(()=>e[6]||(e[6]=[p(" 登 录 ")])),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),o(j,{md:16,sm:24,xs:24,class:"notice-col"},{default:a(()=>[q((f(),K(P,{class:"notice-card home-card"},{header:a(()=>[r("div",Pe,[e[9]||(e[9]=r("span",null,"通知公告",-1)),o(u,{link:"",type:"primary",onClick:X},{default:a(()=>e[8]||(e[8]=[p(" 查看全部 ")])),_:1})])]),default:a(()=>[o(ee,{data:x.value,style:{width:"100%"},"empty-text":" "},{default:a(()=>[o(C,{label:"标题",prop:"title","show-overflow-tooltip":""}),o(C,{label:"类型",prop:"type",width:"100"},{default:a(n=>{var T;return[o(Z,{type:((T=F.value[n.row.type])==null?void 0:T.tag)||"info"},{default:a(()=>{var z;return[p(y(((z=F.value[n.row.type])==null?void 0:z.name)||"其他"),1)]}),_:2},1032,["type"])]}),_:1}),o(C,{label:"发布时间",prop:"createTime",width:"180"},{default:a(n=>[p(y(M(n.row.createTime)),1)]),_:1}),o(C,{label:"操作",width:"100"},{default:a(n=>[o(u,{link:"",type:"primary",onClick:T=>W(n.row)},{default:a(()=>e[10]||(e[10]=[p(" 查看 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"]),x.value.length===0&&!b.value?(f(),K(te,{key:0,description:"暂无通知公告"})):I("",!0)]),_:1})),[[O,b.value||L.value]])]),_:1})]),_:1}),o(ae,{modelValue:h.value,"onUpdate:modelValue":e[4]||(e[4]=n=>h.value=n),title:d.title,"append-to-body":"",top:"5vh",width:"60%"},{footer:a(()=>[r("span",Ke,[o(u,{onClick:e[3]||(e[3]=n=>h.value=!1)},{default:a(()=>e[12]||(e[12]=[p("关 闭")])),_:1})])]),default:a(()=>[d.id?q((f(),w("div",je,[r("div",Ae,[r("div",Oe,[r("span",null,"发布人："+y(d.publisher),1),r("span",null,"发布时间："+y(M(d.publishTime)),1)]),o(A),r("div",{class:"notice-text",innerHTML:d.content},null,8,ze),d.attachments&&d.attachments.length?(f(),w("div",qe,[o(A),e[11]||(e[11]=r("h4",null,"附件：",-1)),r("ul",null,[(f(!0),w(Ne,null,Ve(d.attachments,n=>(f(),w("li",{key:n.id},[o(U(He),{disabled:k[n.id],loading:k[n.id],type:"primary",onClick:T=>Y(n)},{default:a(()=>[p(y(n.name),1)]),_:2},1032,["disabled","loading","onClick"])]))),128))])])):I("",!0)])])),[[O,V.value]]):I("",!0)]),_:1},8,["modelValue","title"])])}}}),dt=ne(Ge,[["__scopeId","data-v-19925171"]]);export{dt as default};
