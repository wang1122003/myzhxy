import{_ as le,u as se,r as m,a as R,o as re,n as ie,c as ce,b as de,d as w,e as f,f as o,w as a,E as ue,g as me,h as r,i as pe,j as fe,k as _e,l as ge,m as z,p as ve,q as he,s as ye,t as we,v as p,x as be,y as q,z as K,A as U,B as ke,C as Ee,D as Ce,F as b,G as Te,H as xe,I as Le,J as Ne,K as Ve,L as He,M as Re,N as Ue,O as Ie,P as _}from"./index-DrN7HJWs.js";/* empty css                   *//* empty css                *//* empty css                   *//* empty css               *//* empty css                        */import{g as Be,a as De}from"./notice-CrHf94I4.js";import{l as Fe}from"./user-BjEgjqEk.js";import{d as $e}from"./file-DSgdrnhe.js";import{g as Me}from"./common-CBiGEV7V.js";import"./request-BGbcGZqw.js";const Ae={class:"home-container"},Pe={class:"card-header"},je={key:0},Oe={class:"notice-content"},ze={class:"notice-info"},qe=["innerHTML"],Ke={key:0,class:"notice-attachments"},Se={class:"dialog-footer"},Ge={name:"HomePage"},Je=Object.assign(Ge,{setup(Qe){const g=se(),I=m(null),v=m([]),k=m(!1),L=m(!1),N=m(!1),h=m(!1),V=m(!1),E=R({}),B=m([]),S=m("400px"),c=R({id:null,title:"",publisher:"",publishTime:"",content:"",attachments:[]}),s=R({username:"",password:"",remember:!1}),G={username:[{required:!0,message:"请输入用户名",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"}]};re(async()=>{const t=localStorage.getItem("username");t&&(s.username=t,s.remember=!0),await Promise.all([J(),Q()]),ie(()=>{H()}),window.addEventListener("resize",H)});const J=async()=>{k.value=!0;try{const t=await Be();t.code===200||t.success===!0?v.value=Array.isArray(t.data)?t.data.slice(0,5):[]:(console.error("获取最近通知失败:",t.message),v.value=[])}catch(t){console.error("获取最近通知异常:",t),v.value=[]}finally{k.value=!1}},Q=async()=>{L.value=!0;try{const t=await Me();B.value=t.data||[]}catch(t){console.error("获取通知类型失败",t)}finally{L.value=!1}},D=ce(()=>{const t={};return B.value.forEach(e=>{t[e.typeCode]={name:e.typeName,tag:e.tagType||"info"}}),t}),F=()=>{I.value.validate(t=>{t&&(N.value=!0,Fe(s).then(e=>{const{token:d,user:i}=e.data,l=Ie({token:d,user:i});s.remember?localStorage.setItem("username",s.username):localStorage.removeItem("username"),_.success("登录成功"),console.log("[HomePage] Redirecting based on role from authLogin:",l),l==="admin"?g.push("/admin/notice"):l==="teacher"?g.push("/teacher"):l==="student"?g.push("/student"):(console.error("[HomePage] Login successful, but role from authLogin is unknown/invalid:",l),g.push("/"))}).catch(e=>{var i,l;const d=((l=(i=e==null?void 0:e.response)==null?void 0:i.data)==null?void 0:l.message)||"用户名或密码错误";_.error(d),console.error("登录请求失败:",e)}).finally(()=>{N.value=!1}))})},W=async t=>{V.value=!0,h.value=!0,c.id=null;try{const e=await De(t.id);Object.assign(c,e.data)}catch(e){console.error("获取通知详情失败",e),_.error("获取通知详情失败"),h.value=!1}finally{V.value=!1}},X=()=>{g.push("/notices")},$=t=>{if(!t)return"";try{return new Date(t).toLocaleString("zh-CN",{hour12:!1})}catch{return t}},Y=async t=>{if(!t||!t.id){_.warning("无效的文件信息");return}E[t.id]=!0;try{const e=await $e(t.id),d=e.headers["content-disposition"];let i=t.name;if(d){const y=d.match(/filename\*?=UTF-8''(.*)$/i)||d.match(/filename="(.*)"$/i);y&&y[1]&&(i=decodeURIComponent(y[1]))}const l=new Blob([e.data],{type:e.headers["content-type"]}),C=window.URL.createObjectURL(l),u=document.createElement("a");u.href=C,u.setAttribute("download",i),document.body.appendChild(u),u.click(),document.body.removeChild(u),window.URL.revokeObjectURL(C),_.success(`附件 ${i} 下载成功`)}catch(e){console.error("下载附件失败",e),_.error(`下载附件 ${t.name} 失败`)}finally{E[t.id]=!1}},H=()=>{const e=window.innerHeight-300;S.value=e>200?`${e}px`:"200px"};return de(()=>{window.removeEventListener("resize",H)}),(t,e)=>{const d=ge,i=_e,l=fe,C=we,u=be,y=pe,M=me,A=ue,T=Ee,Z=Ce,ee=ke,te=Te,oe=Le,P=Ne,ae=Re,ne=Ue,j=xe;return f(),w("div",Ae,[o(oe,{gutter:20},{default:a(()=>[o(A,{md:8,sm:24,xs:24,class:"login-col"},{default:a(()=>[o(M,{class:"login-card home-card"},{default:a(()=>[e[7]||(e[7]=r("div",{class:"login-header card-header"},[r("h2",null,"用户登录")],-1)),o(y,{ref_key:"loginFormRef",ref:I,model:s,rules:G,"label-width":"0"},{default:a(()=>[o(l,{prop:"username"},{default:a(()=>[o(i,{modelValue:s.username,"onUpdate:modelValue":e[0]||(e[0]=n=>s.username=n),clearable:"",placeholder:"用户名"},{prefix:a(()=>[o(d,null,{default:a(()=>[o(z(ve))]),_:1})]),_:1},8,["modelValue"])]),_:1}),o(l,{prop:"password"},{default:a(()=>[o(i,{modelValue:s.password,"onUpdate:modelValue":e[1]||(e[1]=n=>s.password=n),clearable:"",placeholder:"密码","show-password":"",type:"password",onKeyup:he(F,["enter"])},{prefix:a(()=>[o(d,null,{default:a(()=>[o(z(ye))]),_:1})]),_:1},8,["modelValue"])]),_:1}),o(l,null,{default:a(()=>[o(C,{modelValue:s.remember,"onUpdate:modelValue":e[2]||(e[2]=n=>s.remember=n)},{default:a(()=>e[5]||(e[5]=[p(" 记住用户名 ")])),_:1},8,["modelValue"])]),_:1}),o(l,null,{default:a(()=>[o(u,{loading:N.value,style:{width:"100%"},type:"primary",onClick:F},{default:a(()=>e[6]||(e[6]=[p(" 登 录 ")])),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),o(A,{md:16,sm:24,xs:24,class:"notice-col"},{default:a(()=>[q((f(),K(M,{class:"notice-card home-card"},{header:a(()=>[r("div",Pe,[e[9]||(e[9]=r("span",null,"通知公告",-1)),o(u,{link:"",type:"primary",onClick:X},{default:a(()=>e[8]||(e[8]=[p(" 查看全部 ")])),_:1})])]),default:a(()=>[o(ee,{data:v.value,style:{width:"100%"},"empty-text":" "},{default:a(()=>[o(T,{label:"标题",prop:"title","show-overflow-tooltip":""}),o(T,{label:"类型",prop:"type",width:"100"},{default:a(n=>{var x;return[o(Z,{type:((x=D.value[n.row.type])==null?void 0:x.tag)||"info"},{default:a(()=>{var O;return[p(b(((O=D.value[n.row.type])==null?void 0:O.name)||"其他"),1)]}),_:2},1032,["type"])]}),_:1}),o(T,{label:"发布时间",prop:"createTime",width:"180"},{default:a(n=>[p(b($(n.row.createTime)),1)]),_:1}),o(T,{label:"操作",width:"100"},{default:a(n=>[o(u,{link:"",type:"primary",onClick:x=>W(n.row)},{default:a(()=>e[10]||(e[10]=[p(" 查看 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"]),v.value.length===0&&!k.value?(f(),K(te,{key:0,description:"暂无通知公告"})):U("",!0)]),_:1})),[[j,k.value||L.value]])]),_:1})]),_:1}),o(ne,{modelValue:h.value,"onUpdate:modelValue":e[4]||(e[4]=n=>h.value=n),title:c.title,"append-to-body":"",top:"5vh",width:"60%"},{footer:a(()=>[r("span",Se,[o(u,{onClick:e[3]||(e[3]=n=>h.value=!1)},{default:a(()=>e[12]||(e[12]=[p("关 闭")])),_:1})])]),default:a(()=>[c.id?q((f(),w("div",je,[r("div",Oe,[r("div",ze,[r("span",null,"发布人："+b(c.publisher),1),r("span",null,"发布时间："+b($(c.publishTime)),1)]),o(P),r("div",{class:"notice-text",innerHTML:c.content},null,8,qe),c.attachments&&c.attachments.length?(f(),w("div",Ke,[o(P),e[11]||(e[11]=r("h4",null,"附件：",-1)),r("ul",null,[(f(!0),w(Ve,null,He(c.attachments,n=>(f(),w("li",{key:n.id},[o(ae,{disabled:E[n.id],loading:E[n.id],type:"primary",onClick:x=>Y(n)},{default:a(()=>[p(b(n.name),1)]),_:2},1032,["disabled","loading","onClick"])]))),128))])])):U("",!0)])])),[[j,V.value]]):U("",!0)]),_:1},8,["modelValue","title"])])}}}),rt=le(Je,[["__scopeId","data-v-69f3685d"]]);export{rt as default};
