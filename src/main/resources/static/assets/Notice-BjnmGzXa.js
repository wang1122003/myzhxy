import{_ as Ve,r as i,a as K,S as ke,aW as P,b as xe,c as Ue,o as ze,d as M,e as p,h as _,f as o,w as n,v as d,m as l,l as Ae,aT as Be,x as y,i as W,aP as Se,j as w,k as J,T as F,K as Q,L as X,z as V,U as k,g as Y,y as Z,A as ee,B as Me,C,D as te,F as x,H as Ie,a2 as $e,az as De,N as Le,P as u,af as ae}from"./index-gQMZQ2sp.js";/* empty css                   */import{T as Pe,E as Fe}from"./style-ssEox-hO.js";import{b as Oe,u as Re,c as He,d as je,e as le,f as oe}from"./notice-BMWBVm9P.js";import{g as qe}from"./common-CbP0GatP.js";import{b as Ge}from"./file-Ck7nKFvu.js";import{F as O}from"./api-endpoints-Ctc2JoQP.js";import"./request-DfavLRg_.js";const Ke={class:"notice-management-container"},We={class:"page-header"},Je={key:0,class:"pagination-container"},Qe={style:{border:"1px solid #ccc"}},Xe={class:"dialog-footer"},Ye={name:"NoticeManagement"},Ze=Object.assign(Ye,{setup(et){const I=i(!1),U=i(!1),$=i([]),z=i([]),A=i(0),T=i(1),B=i(10),f=K({keyword:"",type:"",status:null}),g=i(!1),D=i("发布通知"),N=i(!1),S=i(!1),E=i(!1),m=i(null),r=i({id:null,title:"",type:"",content:"",status:0,attachments:[]}),c=i([]),b=ke(),se={},ne={placeholder:"请输入内容...",MENU_CONF:{uploadImage:{server:O.UPLOAD_IMAGE,fieldName:"file",headers:{Authorization:`Bearer ${P()}`}},uploadAttachment:{server:O.UPLOAD_ATTACHMENT,fieldName:"file",headers:{Authorization:`Bearer ${P()}`}}}},re=a=>{b.value=a};xe(()=>{const a=b.value;a!=null&&a.destroy()});const ue=i(`${O.UPLOAD_DOCUMENT}`),ie=i({Authorization:`Bearer ${P()}`}),de=(a,e,s)=>{if(a.code===200&&a.data)r.value.attachments.push({id:a.data.id,name:a.data.filename||e.name,url:a.data.url,uid:e.uid}),c.value=s,u.success("附件上传成功");else{u.error(a.message||"附件上传失败");const t=s.findIndex(v=>v.uid===e.uid);t>-1&&s.splice(t,1),c.value=s}},ce=async(a,e)=>{const s=r.value.attachments.findIndex(t=>t.uid===a.uid||t.name===a.name);if(s>-1){const t=r.value.attachments[s].id;if(t)try{await Ge(t),u.success("附件已从服务器删除")}catch(v){console.error("删除服务器附件失败",v)}r.value.attachments.splice(s,1),c.value=e}else c.value=e},fe=a=>{const e=r.value.attachments.find(s=>s.uid===a.uid||s.name===a.name);e!=null&&e.url?window.open(e.url,"_blank"):u.warning("无法预览该文件")},me=(a,e,s)=>{console.error("上传错误",a),u.error("附件上传失败"),c.value=s},ve=K({title:[{required:!0,message:"请输入通知标题",trigger:"blur"}],type:[{required:!0,message:"请选择通知类型",trigger:"change"}],content:[{required:!0,message:"请输入通知内容",trigger:"blur"},{validator:(a,e,s)=>{const t=b.value;t&&t.isEmpty()?s(new Error("请输入通知内容")):s()},trigger:"blur"}]}),pe=()=>{m.value&&m.value.resetFields(),r.value={id:null,title:"",type:"",content:"",status:0,attachments:[]},c.value=[],N.value=!1,S.value=!1},ye=()=>{N.value=!1,D.value="发布通知",r.value={id:null,title:"",type:"",content:"",status:0,attachments:[]},c.value=[],m.value&&m.value.clearValidate(),g.value=!0,L()},ge=async a=>{N.value=!0,D.value="编辑通知",S.value=!0,r.value={id:null,title:"",type:"",content:"",status:0,attachments:[]},c.value=[],m.value&&m.value.clearValidate(),g.value=!0,L();try{const e=await He(a.id);r.value={...e.data},c.value=r.value.attachments.map(s=>({name:s.name,url:s.url,id:s.id,uid:s.id||Date.now()+Math.random()})),b.value&&b.value.setHtml(r.value.content||"")}catch(e){console.error("获取通知详情失败",e),u.error("获取通知详情失败"),g.value=!1}finally{S.value=!1}},he=a=>{ae.confirm(`确定要删除通知 "${a.title}" 吗?`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await je(a.id),u.success("删除成功"),h()}catch(e){console.error("删除通知失败",e),u.error("删除通知失败")}}).catch(()=>{u.info("已取消删除")})},we=async a=>{const e=a.status===1?2:1,s=e===1?"发布":"撤回";ae.confirm(`确定要${s}通知 "${a.title}" 吗?`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await Re(a.id,e),u.success(`${s}成功`),h()}catch(t){console.error(`${s}通知失败`,t),u.error(`${s}通知失败`)}}).catch(()=>{u.info("已取消操作")})},be=async()=>{var a,e,s;if(!r.value.title){u.warning("请输入通知标题以保存草稿"),(a=m.value)==null||a.validateField("title");return}E.value=!0;try{const t=R();t.status=0,N.value?(await le(t.id,t),u.success("草稿更新成功")):(await oe(t),u.success("草稿保存成功")),g.value=!1,h()}catch(t){console.error("保存草稿失败",t),u.error(((s=(e=t==null?void 0:t.response)==null?void 0:e.data)==null?void 0:s.message)||"保存草稿失败")}finally{E.value=!1}},Ce=()=>{m.value.validate(async a=>{var e,s;if(a){E.value=!0;try{const t=R();t.status=1,N.value?(await le(t.id,t),u.success("通知更新并发布成功")):(await oe(t),u.success("通知发布成功")),g.value=!1,h()}catch(t){console.error("发布通知失败",t),u.error(((s=(e=t==null?void 0:t.response)==null?void 0:e.data)==null?void 0:s.message)||"发布通知失败")}finally{E.value=!1}}else return console.log("通知表单验证失败"),!1})},R=()=>{const a=b.value;if(!a)throw new Error("编辑器未初始化");const e=a.getHtml(),s=r.value.attachments.map(t=>t.id).filter(t=>t!=null);return{...r.value,content:e,attachmentIds:s,attachments:void 0}},h=async()=>{I.value=!0;try{const a={page:T.value,size:B.value,keyword:f.keyword||null,type:f.type||null,status:f.status},e=await Oe(a);e.data&&e.data.records?($.value=e.data.records,A.value=e.data.total||0):($.value=[],A.value=0)}catch(a){console.error("获取通知列表失败",a),u.error("获取通知列表失败")}finally{I.value=!1}},L=async()=>{U.value=!0;try{const a=await qe();z.value=a.data||[]}catch(a){console.error("获取通知类型失败",a)}finally{U.value=!1}},H=Ue(()=>{const a={};return z.value.forEach(e=>{a[e.typeCode]={name:e.typeName,tag:e.tagType||"info"}}),a}),j=()=>{T.value=1,h()},Te=a=>{B.value=a,T.value=1,h()},Ee=a=>{T.value=a,h()},Ne=a=>{const e={1:"已发布",0:"草稿",2:"已撤回"};return e[a]!==void 0?e[a]:"未知"},_e=a=>({1:"success",0:"info",2:"warning"})[a]||"info",q=a=>{if(!a)return"-";try{return new Date(a).toLocaleString("zh-CN",{hour12:!1})}catch{return a}};return ze(()=>{h(),L()}),(a,e)=>{const s=Ie;return p(),M("div",Ke,[_("div",We,[e[12]||(e[12]=_("h2",null,"通知管理",-1)),o(l(y),{type:"primary",onClick:ye},{default:n(()=>[o(l(Ae),null,{default:n(()=>[o(l(Be))]),_:1}),e[11]||(e[11]=d(" 发布通知 "))]),_:1})]),o(l(Y),{class:"filter-card"},{default:n(()=>[o(l(W),{inline:!0,model:f,onSubmit:Se(j,["prevent"])},{default:n(()=>[o(l(w),{label:"关键词"},{default:n(()=>[o(l(J),{modelValue:f.keyword,"onUpdate:modelValue":e[0]||(e[0]=t=>f.keyword=t),clearable:"",placeholder:"通知标题",style:{width:"250px"}},null,8,["modelValue"])]),_:1}),o(l(w),{label:"类型"},{default:n(()=>[o(l(F),{modelValue:f.type,"onUpdate:modelValue":e[1]||(e[1]=t=>f.type=t),loading:U.value,clearable:"",placeholder:"选择类型",style:{width:"150px"}},{default:n(()=>[(p(!0),M(Q,null,X(z.value,t=>(p(),V(l(k),{key:t.typeCode,label:t.typeName,value:t.typeCode},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1}),o(l(w),{label:"状态"},{default:n(()=>[o(l(F),{modelValue:f.status,"onUpdate:modelValue":e[2]||(e[2]=t=>f.status=t),clearable:"",placeholder:"选择状态",style:{width:"120px"}},{default:n(()=>[o(l(k),{value:1,label:"已发布"}),o(l(k),{value:0,label:"草稿"}),o(l(k),{value:2,label:"已撤回"})]),_:1},8,["modelValue"])]),_:1}),o(l(w),null,{default:n(()=>[o(l(y),{type:"primary",onClick:j},{default:n(()=>e[13]||(e[13]=[d(" 查询 ")])),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),o(l(Y),{class:"notice-list-card"},{default:n(()=>[Z((p(),V(l(Me),{data:$.value,style:{width:"100%"}},{default:n(()=>[o(l(C),{label:"标题","min-width":"300",prop:"title","show-overflow-tooltip":""}),o(l(C),{label:"类型",prop:"type",width:"120"},{default:n(t=>{var v;return[o(l(te),{type:((v=H.value[t.row.type])==null?void 0:v.tag)||"info"},{default:n(()=>{var G;return[d(x(((G=H.value[t.row.type])==null?void 0:G.name)||"其他"),1)]}),_:2},1032,["type"])]}),_:1}),o(l(C),{label:"发布人",prop:"senderRealName",width:"120"}),o(l(C),{label:"发布时间",prop:"sendTime",width:"180"},{default:n(t=>[d(x(q(t.row.sendTime)),1)]),_:1}),o(l(C),{label:"状态",prop:"status",width:"100"},{default:n(t=>[o(l(te),{type:_e(t.row.status)},{default:n(()=>[d(x(Ne(t.row.status)),1)]),_:2},1032,["type"])]),_:1}),o(l(C),{label:"创建时间",prop:"createTime",width:"180"},{default:n(t=>[d(x(q(t.row.createTime)),1)]),_:1}),o(l(C),{fixed:"right",label:"操作",width:"200"},{default:n(t=>[t.row.status===0||t.row.status===1?(p(),V(l(y),{key:0,size:"small",type:"warning",onClick:v=>we(t.row)},{default:n(()=>[d(x(t.row.status===1?"撤回":"发布"),1)]),_:2},1032,["onClick"])):ee("",!0),o(l(y),{size:"small",type:"primary",onClick:v=>ge(t.row)},{default:n(()=>e[14]||(e[14]=[d(" 编辑 ")])),_:2},1032,["onClick"]),o(l(y),{size:"small",type:"danger",onClick:v=>he(t.row)},{default:n(()=>e[15]||(e[15]=[d(" 删除 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[s,I.value]]),A.value>0?(p(),M("div",Je,[o(l($e),{"current-page":T.value,"onUpdate:currentPage":e[3]||(e[3]=t=>T.value=t),"page-size":B.value,"onUpdate:pageSize":e[4]||(e[4]=t=>B.value=t),"page-sizes":[10,20,50,100],total:A.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:Te,onCurrentChange:Ee},null,8,["current-page","page-size","total"])])):ee("",!0)]),_:1}),o(l(Le),{modelValue:g.value,"onUpdate:modelValue":e[10]||(e[10]=t=>g.value=t),"close-on-click-modal":!1,title:D.value,top:"5vh",width:"80%",onClose:pe},{footer:n(()=>[_("span",Xe,[o(l(y),{onClick:e[9]||(e[9]=t=>g.value=!1)},{default:n(()=>e[18]||(e[18]=[d("取消")])),_:1}),o(l(y),{loading:E.value,onClick:be},{default:n(()=>e[19]||(e[19]=[d("存为草稿")])),_:1},8,["loading"]),o(l(y),{loading:E.value,type:"primary",onClick:Ce},{default:n(()=>e[20]||(e[20]=[d("发布")])),_:1},8,["loading"])])]),default:n(()=>[Z((p(),V(l(W),{ref_key:"noticeFormRef",ref:m,model:r.value,rules:ve,"label-width":"80px"},{default:n(()=>[o(l(w),{label:"标题",prop:"title"},{default:n(()=>[o(l(J),{modelValue:r.value.title,"onUpdate:modelValue":e[5]||(e[5]=t=>r.value.title=t),placeholder:"请输入通知标题"},null,8,["modelValue"])]),_:1}),o(l(w),{label:"类型",prop:"type"},{default:n(()=>[o(l(F),{modelValue:r.value.type,"onUpdate:modelValue":e[6]||(e[6]=t=>r.value.type=t),loading:U.value,placeholder:"选择通知类型"},{default:n(()=>[(p(!0),M(Q,null,X(z.value,t=>(p(),V(l(k),{key:t.typeCode,label:t.typeName,value:t.typeCode},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1}),o(l(w),{label:"内容",prop:"content"},{default:n(()=>[_("div",Qe,[o(l(Pe),{"default-config":se,editor:b.value,mode:"default",style:{"border-bottom":"1px solid #ccc"}},null,8,["editor"]),o(l(Fe),{modelValue:r.value.content,"onUpdate:modelValue":e[7]||(e[7]=t=>r.value.content=t),"default-config":ne,mode:"default",style:{height:"400px","overflow-y":"hidden"},onOnCreated:re},null,8,["modelValue"])])]),_:1}),o(l(w),{label:"附件",prop:"attachments"},{default:n(()=>[o(l(De),{"file-list":c.value,"onUpdate:fileList":e[8]||(e[8]=t=>c.value=t),action:ue.value,headers:ie.value,"on-error":me,"on-preview":fe,"on-remove":ce,"on-success":de,"list-type":"text",multiple:""},{tip:n(()=>e[17]||(e[17]=[_("div",{class:"el-upload__tip"}," 单个文件不超过 50MB ",-1)])),default:n(()=>[o(l(y),{type:"primary"},{default:n(()=>e[16]||(e[16]=[d(" 点击上传附件 ")])),_:1})]),_:1},8,["file-list","action","headers"])]),_:1})]),_:1},8,["model","rules"])),[[s,S.value]])]),_:1},8,["modelValue","title"])])}}}),dt=Ve(Ze,[["__scopeId","data-v-0c628db4"]]);export{dt as default};
