import{_ as b,a5 as $,a6 as ee,Z as te,$ as oe,Y as le,a7 as ae,R as z,d as c,e as r,h as l,f as t,w as a,v,l as ne,x as se,z as U,a3 as ie,K as M,A as E,F as u,D as re,a4 as de,a8 as H,L as j,g as ce,a9 as ue,aa as _e,ab as me,k as fe,ac as ve,G as he,ad as ke,u as pe,c as G,ae as ye,r as h,o as ge,P as _,af as Ce}from"./index-DrN7HJWs.js";import{e as we,f as Le,h as Te,z as Ee,i as q,j as Ie,l as Ne,k as Re,m as De,n as ze}from"./zh-CN-BzENR6_-.js";import"./request-BGbcGZqw.js";const xe={name:"PostDetail",components:{ArrowLeft:ae,Star:le,View:oe,ChatDotRound:te,ChatLineRound:ee,MoreFilled:$},setup(){const K=ke(),n=pe(),Y=ye(),e=G(()=>Y.userInfo||{}),C=G(()=>K.params.id),p=G(()=>!!localStorage.getItem("token")),k=h({}),f=h(!0),m=h(!1),P="/src/assets/default-avatar.png",w=h([]),y=h(""),L=h(!1),I=h(null),x=h(null),g=h(""),N=h(""),R=h(!1),D=async()=>{f.value=!0;try{const o=await we(C.value);k.value=o.data}catch(o){console.error("获取帖子详情失败:",o),_.error("获取帖子详情失败"),k.value={}}finally{f.value=!1}},T=async()=>{try{const o=await Le(C.value);w.value=o.data||[],w.value.forEach(d=>{d.likeLoading=!1,d.replies&&d.replies.forEach(X=>{X.likeLoading=!1})})}catch(o){console.error("获取评论失败:",o),_.error("获取评论失败"),w.value=[]}},A=()=>{n.push("/login")},B=async()=>{if(!p.value){_.warning("请先登录");return}m.value=!0;try{k.value.liked?(await De(C.value),k.value.liked=!1,k.value.likeCount--):(await ze(C.value),k.value.liked=!0,k.value.likeCount++)}catch(o){console.error("点赞操作失败:",o),_.error("操作失败")}finally{m.value=!1}},S=async o=>{if(!p.value){_.warning("请先登录");return}o.likeLoading=!0;try{o.liked?(await Ie(o.id),o.liked=!1,o.likeCount--):(await Ne(o.id),o.liked=!0,o.likeCount++)}catch(d){console.error("点赞评论操作失败:",d),_.error("操作失败")}finally{o.likeLoading=!1}},F=async o=>{if(!Z(o)){_.warning("您没有权限删除此评论");return}try{await Ce.confirm("确定要删除这条评论吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Re(o.id),_.success("评论已删除"),T()}catch(d){d!=="cancel"&&(console.error("删除评论失败:",d),_.error("删除评论失败"))}},s=async()=>{if(!p.value){_.warning("请先登录");return}if(!y.value.trim()){_.warning("评论内容不能为空");return}L.value=!0;try{await q({postId:C.value,content:y.value.trim()}),_.success("评论发表成功"),y.value="",T(),D()}catch(o){console.error("发表评论失败:",o),_.error("发表评论失败")}finally{L.value=!1}},i=(o,d=null)=>{if(!p.value){_.warning("请先登录");return}I.value=o.id,x.value=d||o,N.value=d?d.author?d.author.realName||d.author.username:d.authorName||"":o.author?o.author.realName||o.author.username:o.authorName||"",g.value=""},V=()=>{I.value=null,x.value=null,N.value="",g.value=""},J=async()=>{if(!p.value){_.warning("请先登录");return}if(!g.value.trim()){_.warning("回复内容不能为空");return}R.value=!0;try{await q({postId:C.value,parentId:I.value,replyToId:x.value.id,content:g.value.trim()}),_.success("回复发表成功"),V(),T(),D()}catch(o){console.error("发表回复失败:",o),_.error("发表回复失败")}finally{R.value=!1}},Z=o=>p.value&&(o.authorId===e.value.id||e.value.role==="admin"),O=o=>{if(!o)return"-";try{const d=new Date(o);return Te(d,new Date,{addSuffix:!0,locale:Ee})}catch{return o}},Q=()=>{n.push("/forum")},W=()=>{const o=document.getElementById("comments-section");o&&o.scrollIntoView({behavior:"smooth",block:"start"})};return ge(()=>{D(),T()}),{post:k,loading:f,likeLoading:m,comments:w,commentContent:y,submittingComment:L,replyingTo:I,replyContent:g,replyingToName:N,submittingReply:R,userInfo:e,isLoggedIn:p,defaultAvatar:P,goBack:Q,scrollToComments:W,handleLike:B,submitComment:s,canEditComment:Z,handleDeleteComment:F,handleLikeComment:S,handleReply:i,cancelReply:V,submitReply:J,formatTime:O,goToLogin:A}}},Ve={class:"post-detail-container"},Ae={class:"page-header"},Be={class:"post-detail-content"},Me={class:"post-header"},Pe={class:"post-title"},Se={key:0,class:"post-category"},Fe={class:"post-meta"},Ue={class:"post-author"},He={class:"author-info"},je={class:"author-name"},Ge={class:"post-time"},Ke={class:"post-actions"},Ye=["innerHTML"],Ze={key:0,class:"post-tags"},qe={class:"card-header"},Je={key:0,class:"no-comments"},Oe={key:1,class:"comment-list"},Qe={class:"comment-header"},We={class:"comment-author"},Xe={class:"author-info"},be={class:"author-name"},$e={class:"comment-time"},et={key:0,class:"comment-actions"},tt={class:"comment-content"},ot={class:"comment-footer"},lt={key:0,class:"sub-comments"},at={class:"comment-header"},nt={class:"comment-author"},st={class:"author-info"},it={class:"author-name"},rt={key:0,class:"reply-to"},dt={class:"comment-time"},ct={key:0,class:"comment-actions"},ut={class:"comment-content"},_t={class:"comment-footer"},mt={key:1,class:"reply-box"},ft={class:"reply-actions"},vt={key:2,class:"comment-form"},ht={class:"comment-submit"},kt={key:3,class:"login-hint"},pt={class:"login-action"};function yt(K,n,Y,e,C,p){const k=z("ArrowLeft"),f=ne,m=se,P=ie,w=re,y=de,L=z("Star"),I=z("View"),x=z("ChatDotRound"),g=ce,N=z("MoreFilled"),R=me,D=_e,T=ue,A=z("ChatLineRound"),B=fe,S=ve,F=he;return r(),c("div",Ve,[l("div",Ae,[t(m,{link:"",onClick:e.goBack},{default:a(()=>[t(f,null,{default:a(()=>[t(k)]),_:1}),n[2]||(n[2]=v(" 返回论坛 "))]),_:1},8,["onClick"])]),l("div",Be,[e.loading?(r(),U(P,{key:0,rows:15,animated:""})):e.post.id?(r(),c(M,{key:1},[t(g,{class:"post-card"},{default:a(()=>[l("div",Me,[l("div",Pe,[l("h1",null,u(e.post.title),1),e.post.category?(r(),c("div",Se,[t(w,{size:"small"},{default:a(()=>[v(u(e.post.category),1)]),_:1})])):E("",!0)]),l("div",Fe,[l("div",Ue,[t(y,{size:40,src:e.post.avatar||e.defaultAvatar},null,8,["src"]),l("div",He,[l("div",je,u(e.post.author?e.post.author.realName||e.post.author.username:e.post.authorName),1),l("div",Ge,u(e.formatTime(e.post.createTime)),1)])]),l("div",Ke,[t(m,{class:H({"active-like":e.post.liked}),loading:e.likeLoading,link:"",onClick:e.handleLike},{default:a(()=>[t(f,null,{default:a(()=>[t(L)]),_:1}),l("span",null,u(e.post.likeCount||0),1)]),_:1},8,["class","loading","onClick"]),t(m,{link:""},{default:a(()=>[t(f,null,{default:a(()=>[t(I)]),_:1}),l("span",null,u(e.post.viewCount||0),1)]),_:1}),t(m,{link:"",onClick:e.scrollToComments},{default:a(()=>[t(f,null,{default:a(()=>[t(x)]),_:1}),l("span",null,u(e.post.commentCount||0),1)]),_:1},8,["onClick"])])])]),n[4]||(n[4]=l("div",{class:"post-divider"},null,-1)),l("div",{class:"post-content",innerHTML:e.post.content},null,8,Ye),e.post.tags&&e.post.tags.length>0?(r(),c("div",Ze,[n[3]||(n[3]=l("span",{class:"tag-label"},"标签:",-1)),(r(!0),c(M,null,j(e.post.tags,s=>(r(),U(w,{key:s.id,class:"tag-item",effect:"plain",size:"small"},{default:a(()=>[v(u(s.name),1)]),_:2},1024))),128))])):E("",!0)]),_:1}),t(g,{id:"comments-section",class:"comments-card"},{header:a(()=>[l("div",qe,[l("h3",null,"评论 ("+u(e.comments.length)+")",1)])]),default:a(()=>[e.comments.length===0?(r(),c("div",Je," 暂无评论，快来发表第一条评论吧 ")):(r(),c("div",Oe,[(r(!0),c(M,null,j(e.comments,s=>(r(),c("div",{key:s.id,class:"comment-item"},[l("div",Qe,[l("div",We,[t(y,{size:32,src:s.avatar||e.defaultAvatar},null,8,["src"]),l("div",Xe,[l("div",be,u(s.author?s.author.realName||s.author.username:s.authorName),1),l("div",$e,u(e.formatTime(s.createTime)),1)])]),e.canEditComment(s)?(r(),c("div",et,[t(T,null,{dropdown:a(()=>[t(D,null,{default:a(()=>[t(R,{onClick:i=>e.handleDeleteComment(s)},{default:a(()=>n[5]||(n[5]=[v("删除")])),_:2},1032,["onClick"])]),_:2},1024)]),default:a(()=>[t(f,null,{default:a(()=>[t(N)]),_:1})]),_:2},1024)])):E("",!0)]),l("div",tt,u(s.content),1),l("div",ot,[t(m,{class:H({"active-like":s.liked}),loading:s.likeLoading,link:"",size:"small",onClick:i=>e.handleLikeComment(s)},{default:a(()=>[t(f,null,{default:a(()=>[t(L)]),_:1}),l("span",null,u(s.likeCount||0),1)]),_:2},1032,["class","loading","onClick"]),t(m,{link:"",size:"small",onClick:i=>e.handleReply(s)},{default:a(()=>[t(f,null,{default:a(()=>[t(A)]),_:1}),n[6]||(n[6]=l("span",null,"回复",-1))]),_:2},1032,["onClick"])]),s.replies&&s.replies.length>0?(r(),c("div",lt,[(r(!0),c(M,null,j(s.replies,i=>(r(),c("div",{key:i.id,class:"sub-comment-item"},[l("div",at,[l("div",nt,[t(y,{size:28,src:i.avatar||e.defaultAvatar},null,8,["src"]),l("div",st,[l("div",it,[v(u(i.author?i.author.realName||i.author.username:"")+" ",1),i.replyToAuthor?(r(),c("span",rt," 回复 "+u(i.replyToAuthor.realName||i.replyToAuthor.username),1)):E("",!0)]),l("div",dt,u(e.formatTime(i.createTime)),1)])]),e.canEditComment(i)?(r(),c("div",ct,[t(T,null,{dropdown:a(()=>[t(D,null,{default:a(()=>[t(R,{onClick:V=>e.handleDeleteComment(i)},{default:a(()=>n[7]||(n[7]=[v("删除")])),_:2},1032,["onClick"])]),_:2},1024)]),default:a(()=>[t(f,null,{default:a(()=>[t(N)]),_:1})]),_:2},1024)])):E("",!0)]),l("div",ut,u(i.content),1),l("div",_t,[t(m,{class:H({"active-like":i.liked}),loading:i.likeLoading,link:"",size:"small",onClick:V=>e.handleLikeComment(i)},{default:a(()=>[t(f,null,{default:a(()=>[t(L)]),_:1}),l("span",null,u(i.likeCount||0),1)]),_:2},1032,["class","loading","onClick"]),t(m,{link:"",size:"small",onClick:V=>e.handleReply(s,i)},{default:a(()=>[t(f,null,{default:a(()=>[t(A)]),_:1}),n[8]||(n[8]=l("span",null,"回复",-1))]),_:2},1032,["onClick"])])]))),128))])):E("",!0),e.replyingTo===s.id?(r(),c("div",mt,[t(B,{modelValue:e.replyContent,"onUpdate:modelValue":n[0]||(n[0]=i=>e.replyContent=i),placeholder:e.replyingToName?`回复 ${e.replyingToName}`:"回复评论",rows:2,maxlength:"500","show-word-limit":"",type:"textarea"},null,8,["modelValue","placeholder"]),l("div",ft,[t(m,{size:"small",onClick:e.cancelReply},{default:a(()=>n[9]||(n[9]=[v("取消")])),_:1},8,["onClick"]),t(m,{loading:e.submittingReply,size:"small",type:"primary",onClick:e.submitReply},{default:a(()=>n[10]||(n[10]=[v(" 回复 ")])),_:1},8,["loading","onClick"])])])):E("",!0)]))),128))])),e.isLoggedIn?(r(),c("div",vt,[n[12]||(n[12]=l("h4",{class:"comment-form-title"},"发表评论",-1)),t(B,{modelValue:e.commentContent,"onUpdate:modelValue":n[1]||(n[1]=s=>e.commentContent=s),rows:3,maxlength:"500",placeholder:"请输入评论内容...","show-word-limit":"",type:"textarea"},null,8,["modelValue"]),l("div",ht,[t(m,{disabled:!e.commentContent.trim(),loading:e.submittingComment,type:"primary",onClick:e.submitComment},{default:a(()=>n[11]||(n[11]=[v(" 发表评论 ")])),_:1},8,["disabled","loading","onClick"])])])):(r(),c("div",kt,[t(S,{closable:!1,"show-icon":"",title:"请登录后参与评论",type:"info"},{default:a(()=>[l("div",pt,[t(m,{size:"small",type:"primary",onClick:e.goToLogin},{default:a(()=>n[13]||(n[13]=[v("去登录")])),_:1},8,["onClick"])])]),_:1})]))]),_:1})],64)):(r(),U(F,{key:2,description:"帖子不存在或已被删除"},{default:a(()=>[t(m,{type:"primary",onClick:e.goBack},{default:a(()=>n[14]||(n[14]=[v("返回论坛")])),_:1},8,["onClick"])]),_:1}))])])}const Lt=b(xe,[["render",yt],["__scopeId","data-v-965228fc"]]);export{Lt as default};
