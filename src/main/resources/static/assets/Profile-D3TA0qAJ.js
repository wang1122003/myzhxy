import{_ as w,ay as D,R,d as j,e as z,h as _,f as a,w as r,v as s,x as B,a4 as M,F as u,az as F,l as J,aA as L,aB as T,g as q,i as O,j as H,k as K,aC as Q,aD as W,N as X,u as Y,r as c,o as Z,am as $,aE as b,aF as S,P as d,an as ee}from"./index-DrN7HJWs.js";/* empty css                   *//* empty css                       *//* empty css                 *//* empty css                             *//* empty css                    */import{g as ae,u as oe}from"./user-BjEgjqEk.js";import"./request-BGbcGZqw.js";const le={name:"StudentProfile",components:{Upload:D},setup(){const k=Y(),o=c(!1),V=c(null),e=c(!1),g=c({}),U=c(!1),p=c(!1),E=c("/api/upload/avatar"),I=c({Authorization:localStorage.getItem("Authorization-Token")||""}),y={email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:["blur","change"]}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号格式",trigger:["blur","change"]}]};Z(async()=>{var t;U.value=!0;try{const n=await ae();n.code===200&&n.data?(g.value={...n.data},S(n.data)):(d.error(n.message||"获取用户信息失败"),n.code===401&&await v())}catch(n){console.error("获取用户信息异常:",n),d.error("获取用户信息异常"),((t=n==null?void 0:n.response)==null?void 0:t.status)===401&&await v()}finally{U.value=!1}});const i=()=>{p.value=!0,b.value&&(g.value={...b.value})},A=()=>{V.value.validate(t=>{if(t){const n={...g.value};oe(n).then(l=>{l.code===0||l.code===200?(d.success("更新成功"),o.value=!1,S(l.data||n)):d.error(l.message||"更新失败")}).catch(l=>{var x,G;console.error("更新用户信息失败",l);const N=((G=(x=l.response)==null?void 0:x.data)==null?void 0:G.message)||l.message||"更新用户信息失败";d.error(N)})}})},h=(t,n)=>{if(e.value=!1,t.code===0||t.code===200)if(t.data&&t.data.url){d.success("头像上传成功");const l={...b.value,avatarUrl:t.data.url};S(l)}else d.error(t.message||"头像上传成功但未返回URL");else d.error(t.message||"头像上传失败")},f=t=>{e.value=!1;let n="头像上传失败";try{n=JSON.parse(t.message||"{}").message||n}catch{}d.error(n),console.error("头像上传错误:",t)},m=t=>{const n=t.type==="image/jpeg",l=t.type==="image/png",N=t.size/1024/1024<2;return!n&&!l?(d.error("头像图片只能是 JPG 或 PNG 格式!"),!1):N?(e.value=!0,!0):(d.error("头像图片大小不能超过 2MB!"),!1)},v=async()=>{try{await ee()}catch(t){console.error("登出失败:",t)}finally{localStorage.removeItem("token"),localStorage.removeItem("user"),localStorage.removeItem("role"),k.push("/"),d.info("请重新登录")}};return{userInfo:b,userAvatar:$,dialogVisible:o,formRef:V,form:g,rules:y,handleEdit:i,handleSubmit:A,uploadAvatarUrl:E,headers:I,handleAvatarSuccess:h,handleAvatarError:f,beforeAvatarUpload:m,uploadingAvatar:e,formatGender:t=>t===1?"男":t===0?"女":"未知"}}},re={class:"profile-container"},te={class:"page-header"},ne={class:"profile-info"},se={class:"avatar-container"},de={class:"info-container"},ie={class:"dialog-footer"};function me(k,o,V,e,g,U){const p=B,E=M,I=R("Upload"),y=J,C=F,i=T,A=L,h=q,f=K,m=H,v=W,P=Q,t=O,n=X;return z(),j("div",re,[_("div",te,[o[10]||(o[10]=_("h2",null,"个人信息",-1)),a(p,{type:"primary",onClick:e.handleEdit},{default:r(()=>o[9]||(o[9]=[s(" 编辑信息 ")])),_:1},8,["onClick"])]),a(h,{class:"profile-card"},{default:r(()=>[_("div",ne,[_("div",se,[a(E,{size:100,src:e.userAvatar},{default:r(()=>{var l;return[s(u((l=e.userInfo.name)==null?void 0:l.substring(0,1)),1)]}),_:1},8,["src"]),a(C,{action:e.uploadAvatarUrl,disabled:e.uploadingAvatar,"before-upload":e.beforeAvatarUpload,"on-success":e.handleAvatarSuccess,headers:e.headers,"show-file-list":!1,class:"avatar-uploader","on-error":e.handleAvatarError},{default:r(()=>[a(p,{loading:e.uploadingAvatar,size:"small",type:"primary"},{default:r(()=>[a(y,null,{default:r(()=>[a(I)]),_:1}),o[11]||(o[11]=s(" 更换头像 "))]),_:1},8,["loading"])]),_:1},8,["action","disabled","before-upload","on-success","headers","on-error"])]),_("div",de,[a(A,{column:2,border:"",title:"基本信息"},{default:r(()=>[a(i,{label:"学号"},{default:r(()=>[s(u(e.userInfo.username),1)]),_:1}),a(i,{label:"姓名"},{default:r(()=>[s(u(e.userInfo.name),1)]),_:1}),a(i,{label:"性别"},{default:r(()=>[s(u(e.formatGender(e.userInfo.gender)),1)]),_:1}),a(i,{label:"院系"},{default:r(()=>[s(u(e.userInfo.department),1)]),_:1}),a(i,{label:"专业"},{default:r(()=>[s(u(e.userInfo.major),1)]),_:1}),a(i,{label:"班级"},{default:r(()=>[s(u(e.userInfo.className),1)]),_:1}),a(i,{label:"邮箱"},{default:r(()=>[s(u(e.userInfo.email),1)]),_:1}),a(i,{label:"手机"},{default:r(()=>[s(u(e.userInfo.phone),1)]),_:1})]),_:1})])])]),_:1}),a(n,{modelValue:e.dialogVisible,"onUpdate:modelValue":o[8]||(o[8]=l=>e.dialogVisible=l),title:"编辑个人信息",width:"500px"},{footer:r(()=>[_("span",ie,[a(p,{onClick:o[7]||(o[7]=l=>e.dialogVisible=!1)},{default:r(()=>o[14]||(o[14]=[s("取消")])),_:1}),a(p,{type:"primary",onClick:e.handleSubmit},{default:r(()=>o[15]||(o[15]=[s("保存")])),_:1},8,["onClick"])])]),default:r(()=>[a(t,{ref:"formRef",model:e.form,rules:e.rules,"label-width":"100px"},{default:r(()=>[a(m,{label:"姓名",prop:"name"},{default:r(()=>[a(f,{modelValue:e.form.name,"onUpdate:modelValue":o[0]||(o[0]=l=>e.form.name=l),disabled:!0},null,8,["modelValue"])]),_:1}),a(m,{label:"性别",prop:"gender"},{default:r(()=>[a(P,{modelValue:e.form.gender,"onUpdate:modelValue":o[1]||(o[1]=l=>e.form.gender=l)},{default:r(()=>[a(v,{value:"male"},{default:r(()=>o[12]||(o[12]=[s(" 男 ")])),_:1}),a(v,{value:"female"},{default:r(()=>o[13]||(o[13]=[s(" 女 ")])),_:1})]),_:1},8,["modelValue"])]),_:1}),a(m,{label:"院系",prop:"department"},{default:r(()=>[a(f,{modelValue:e.form.department,"onUpdate:modelValue":o[2]||(o[2]=l=>e.form.department=l),disabled:!0},null,8,["modelValue"])]),_:1}),a(m,{label:"专业",prop:"major"},{default:r(()=>[a(f,{modelValue:e.form.major,"onUpdate:modelValue":o[3]||(o[3]=l=>e.form.major=l),disabled:!0},null,8,["modelValue"])]),_:1}),a(m,{label:"班级",prop:"className"},{default:r(()=>[a(f,{modelValue:e.form.className,"onUpdate:modelValue":o[4]||(o[4]=l=>e.form.className=l),disabled:!0},null,8,["modelValue"])]),_:1}),a(m,{label:"邮箱",prop:"email"},{default:r(()=>[a(f,{modelValue:e.form.email,"onUpdate:modelValue":o[5]||(o[5]=l=>e.form.email=l)},null,8,["modelValue"])]),_:1}),a(m,{label:"手机",prop:"phone"},{default:r(()=>[a(f,{modelValue:e.form.phone,"onUpdate:modelValue":o[6]||(o[6]=l=>e.form.phone=l)},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])])}const Ve=w(le,[["render",me],["__scopeId","data-v-a8966f41"]]);export{Ve as default};
