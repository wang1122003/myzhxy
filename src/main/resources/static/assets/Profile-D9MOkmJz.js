import{_ as j,ay as w,R as z,d as B,e as M,h as _,f as a,w as t,v as n,x as F,a4 as J,F as u,az as L,l as T,aA as q,aB as O,g as H,i as K,j as Q,k as W,aC as X,aD as Y,N as Z,u as $,r as c,o as ee,am as ae,aE as b,aF as D,P as s,aG as S,an as R}from"./index-gQMZQ2sp.js";/* empty css                   *//* empty css                       *//* empty css                 *//* empty css                 *//* empty css                             *//* empty css                    */import{g as oe,u as le}from"./user-xlhqAG_R.js";import"./request-DfavLRg_.js";import"./api-endpoints-Ctc2JoQP.js";const re={name:"StudentProfile",components:{Upload:w},setup(){const V=$(),o=c(!1),U=c(null),e=c(!1),g=c({}),E=c(!1),p=c(!1),I=c("/api/upload/avatar"),y=c({Authorization:localStorage.getItem("Authorization-Token")||""}),A={email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:["blur","change"]}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号格式",trigger:["blur","change"]}]};ee(async()=>{E.value=!0;try{if(!D.value){s.error("无法获取用户ID，请重新登录"),await v();return}const r=await oe(D.value);r.code===200&&r.data?g.value={...r.data}:s.error(r.message||"获取用户信息失败")}catch(r){console.error("获取用户信息异常:",r),s.error("获取用户信息异常")}finally{E.value=!1}});const i=()=>{p.value=!0,b.value&&(g.value={...b.value})},h=()=>{U.value.validate(r=>{if(r){const d={...g.value};le(d).then(l=>{l.code===0||l.code===200?(s.success("更新成功"),o.value=!1,S(l.data||d)):s.error(l.message||"更新失败")}).catch(l=>{var G,x;console.error("更新用户信息失败",l);const P=((x=(G=l.response)==null?void 0:G.data)==null?void 0:x.message)||l.message||"更新用户信息失败";s.error(P)})}})},N=(r,d)=>{if(e.value=!1,r.code===0||r.code===200)if(r.data&&r.data.url){s.success("头像上传成功");const l={...b.value,avatarUrl:r.data.url};S(l)}else s.error(r.message||"头像上传成功但未返回URL");else s.error(r.message||"头像上传失败")},f=r=>{e.value=!1;let d="头像上传失败";try{d=JSON.parse(r.message||"{}").message||d}catch{}s.error(d),console.error("头像上传错误:",r)},m=r=>{const d=r.type==="image/jpeg",l=r.type==="image/png",P=r.size/1024/1024<2;return!d&&!l?(s.error("头像图片只能是 JPG 或 PNG 格式!"),!1):P?(e.value=!0,!0):(s.error("头像图片大小不能超过 2MB!"),!1)},v=async()=>{try{await R(),V.push("/login")}catch(r){console.error("登出时出错:",r),R(),V.push("/login")}};return{userInfo:b,userAvatar:ae,dialogVisible:o,formRef:U,form:g,rules:A,handleEdit:i,handleSubmit:h,uploadAvatarUrl:I,headers:y,handleAvatarSuccess:N,handleAvatarError:f,beforeAvatarUpload:m,uploadingAvatar:e,formatGender:r=>r===1?"男":r===0?"女":"未知"}}},te={class:"profile-container"},ne={class:"page-header"},se={class:"profile-info"},de={class:"avatar-container"},ie={class:"info-container"},me={class:"dialog-footer"};function ue(V,o,U,e,g,E){const p=F,I=J,y=z("Upload"),A=T,k=L,i=O,h=q,N=H,f=W,m=Q,v=Y,C=X,r=K,d=Z;return M(),B("div",te,[_("div",ne,[o[10]||(o[10]=_("h2",null,"个人信息",-1)),a(p,{type:"primary",onClick:e.handleEdit},{default:t(()=>o[9]||(o[9]=[n(" 编辑信息 ")])),_:1},8,["onClick"])]),a(N,{class:"profile-card"},{default:t(()=>[_("div",se,[_("div",de,[a(I,{size:100,src:e.userAvatar},{default:t(()=>{var l;return[n(u((l=e.userInfo.name)==null?void 0:l.substring(0,1)),1)]}),_:1},8,["src"]),a(k,{action:e.uploadAvatarUrl,disabled:e.uploadingAvatar,"before-upload":e.beforeAvatarUpload,"on-success":e.handleAvatarSuccess,headers:e.headers,"show-file-list":!1,class:"avatar-uploader","on-error":e.handleAvatarError},{default:t(()=>[a(p,{loading:e.uploadingAvatar,size:"small",type:"primary"},{default:t(()=>[a(A,null,{default:t(()=>[a(y)]),_:1}),o[11]||(o[11]=n(" 更换头像 "))]),_:1},8,["loading"])]),_:1},8,["action","disabled","before-upload","on-success","headers","on-error"])]),_("div",ie,[a(h,{column:2,border:"",title:"基本信息"},{default:t(()=>[a(i,{label:"学号"},{default:t(()=>[n(u(e.userInfo.username),1)]),_:1}),a(i,{label:"姓名"},{default:t(()=>[n(u(e.userInfo.name),1)]),_:1}),a(i,{label:"性别"},{default:t(()=>[n(u(e.formatGender(e.userInfo.gender)),1)]),_:1}),a(i,{label:"院系"},{default:t(()=>[n(u(e.userInfo.department),1)]),_:1}),a(i,{label:"专业"},{default:t(()=>[n(u(e.userInfo.major),1)]),_:1}),a(i,{label:"班级"},{default:t(()=>[n(u(e.userInfo.className),1)]),_:1}),a(i,{label:"邮箱"},{default:t(()=>[n(u(e.userInfo.email),1)]),_:1}),a(i,{label:"手机"},{default:t(()=>[n(u(e.userInfo.phone),1)]),_:1})]),_:1})])])]),_:1}),a(d,{modelValue:e.dialogVisible,"onUpdate:modelValue":o[8]||(o[8]=l=>e.dialogVisible=l),title:"编辑个人信息",width:"500px"},{footer:t(()=>[_("span",me,[a(p,{onClick:o[7]||(o[7]=l=>e.dialogVisible=!1)},{default:t(()=>o[14]||(o[14]=[n("取消")])),_:1}),a(p,{type:"primary",onClick:e.handleSubmit},{default:t(()=>o[15]||(o[15]=[n("保存")])),_:1},8,["onClick"])])]),default:t(()=>[a(r,{ref:"formRef",model:e.form,rules:e.rules,"label-width":"100px"},{default:t(()=>[a(m,{label:"姓名",prop:"name"},{default:t(()=>[a(f,{modelValue:e.form.name,"onUpdate:modelValue":o[0]||(o[0]=l=>e.form.name=l),disabled:!0},null,8,["modelValue"])]),_:1}),a(m,{label:"性别",prop:"gender"},{default:t(()=>[a(C,{modelValue:e.form.gender,"onUpdate:modelValue":o[1]||(o[1]=l=>e.form.gender=l)},{default:t(()=>[a(v,{value:"male"},{default:t(()=>o[12]||(o[12]=[n(" 男 ")])),_:1}),a(v,{value:"female"},{default:t(()=>o[13]||(o[13]=[n(" 女 ")])),_:1})]),_:1},8,["modelValue"])]),_:1}),a(m,{label:"院系",prop:"department"},{default:t(()=>[a(f,{modelValue:e.form.department,"onUpdate:modelValue":o[2]||(o[2]=l=>e.form.department=l),disabled:!0},null,8,["modelValue"])]),_:1}),a(m,{label:"专业",prop:"major"},{default:t(()=>[a(f,{modelValue:e.form.major,"onUpdate:modelValue":o[3]||(o[3]=l=>e.form.major=l),disabled:!0},null,8,["modelValue"])]),_:1}),a(m,{label:"班级",prop:"className"},{default:t(()=>[a(f,{modelValue:e.form.className,"onUpdate:modelValue":o[4]||(o[4]=l=>e.form.className=l),disabled:!0},null,8,["modelValue"])]),_:1}),a(m,{label:"邮箱",prop:"email"},{default:t(()=>[a(f,{modelValue:e.form.email,"onUpdate:modelValue":o[5]||(o[5]=l=>e.form.email=l)},null,8,["modelValue"])]),_:1}),a(m,{label:"手机",prop:"phone"},{default:t(()=>[a(f,{modelValue:e.form.phone,"onUpdate:modelValue":o[6]||(o[6]=l=>e.form.phone=l)},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])])}const Ie=j(re,[["render",ue],["__scopeId","data-v-e6139c2b"]]);export{Ie as default};
