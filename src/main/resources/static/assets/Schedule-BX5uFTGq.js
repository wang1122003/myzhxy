import{_ as _e,r as o,a as se,c as Te,o as Ce,d as f,e as n,h as E,f as t,y as ue,w as r,v as k,m as a,x as T,i as oe,aK as Se,j as m,T as I,K as h,L as V,z as p,U as w,k as Ee,q as Ne,l as xe,V as de,aN as We,g as ne,H as De,A as Ue,B as Fe,C as qe,F as Re,a2 as ze,I as N,E as g,a$ as ie,aP as me,N as $e,P as c,af as Be}from"./index-D-KotFfR.js";/* empty css                        */import{b as Pe,c as Oe,d as Ae,u as Me,e as Le}from"./schedule-tIwhwmaf.js";import{a as He,c as ce,e as Ke}from"./common-BBGhIV1Q.js";import{h as je}from"./course-DKE-dNb-.js";import{h as Ge}from"./user-CzFfBPdz.js";import{b as Je}from"./classroom-DTme6bOx.js";import{g as Qe}from"./term-QB43cPel.js";import"./request-D0VF7A5d.js";const Xe={class:"schedule-management-container"},Ye={class:"page-header"},Ze={class:"list-view"},el={key:0,class:"pagination-container"},ll={class:"dialog-footer"},al={name:"ScheduleManagement"},tl=Object.assign(al,{setup(rl){const $=o(!1),J=o(!1),S=o(!1),x=o([]),W=o([]),B=o([]),D=o(0),C=o(1),U=o(10),v=se({termId:null,teacherName:"",courseName:"",className:"",weekDay:null,keyword:""}),_=o(!1),P=o("添加课表项"),O=o(!1),A=o(!1),F=o(!1),q=o(null),u=o({id:null,termId:null,courseId:null,teacherId:null,classId:null,classroomId:null,weekDay:null,startTime:null,endTime:null,startWeek:1,endWeek:16}),b={required:{required:!0,message:"该字段为必填项",trigger:"blur"}},ve=se({termId:[b.required],courseId:[b.required],teacherId:[b.required],classId:[b.required],classroomId:[b.required],weekDay:[b.required],startTime:[b.required],endTime:[b.required,{validator:(s,e,d)=>{u.value.startTime&&e<=u.value.startTime?d(new Error("结束时间必须晚于开始时间")):d()},trigger:"change"}],startWeek:[b.required],endWeek:[{required:!0,message:"请输入结束周",trigger:"blur"},{validator:(s,e,d)=>{u.value.startWeek&&e<u.value.startWeek?d(new Error("结束周不能小于开始周")):d()},trigger:"blur"}]}),Q=o([]),X=o([]),Y=o([]),Z=o([]),M=o(!1),L=o(!1),H=o(!1),K=o(!1),ee=o([]),R=o([]),fe=async()=>{J.value=!0,S.value=!0;try{const[s,e]=await Promise.all([He(),ce()]);W.value=s.data||[],B.value=e.data||[],W.value.length>0&&!v.termId&&(v.termId=W.value[0].value,await y())}catch(s){console.error("获取初始数据失败",s),c.error("获取学期/星期数据失败")}finally{J.value=!1,S.value=!1}},y=async()=>{if(!v.termId){c.warning("请先选择学期");return}$.value=!0;try{const s={page:C.value,size:U.value,...v},e=await Pe(s);x.value=e.data.records||[],D.value=e.data.total||0}catch(s){console.error("获取课表失败",s),c.error("获取课表失败"),x.value=[],D.value=0}finally{$.value=!1}},pe=Te(()=>{const s={};return B.value.forEach(e=>{s[e.value]=e.label}),s}),le=s=>pe.value[s]||"",ge=s=>{U.value=s,C.value=1,y()},be=s=>{C.value=s,y()},ae=()=>{j(),P.value="手动添加课表项",_.value=!0,te()},ye=async s=>{j(),P.value="编辑课表项",F.value=!0,O.value=!0,_.value=!0,te();try{const d={...(await Oe(s.id)).data};d.startTime&&d.startTime.includes(":")&&(d.startTime=d.startTime.substring(0,5)),d.endTime&&d.endTime.includes(":")&&(d.endTime=d.endTime.substring(0,5)),u.value=d}catch(e){console.error("获取课表详情失败",e),c.error("获取课表详情失败"),_.value=!1}finally{O.value=!1}},ke=s=>{Be.confirm(`确定要删除 ${s.courseName} (星期${le(s.weekday)} ${s.startTime}-${s.endTime}) 这条课表记录吗?`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await Ae(s.id),c.success("删除成功"),y()}catch(e){console.error("删除课表项失败",e),c.error("删除课表项失败")}}).catch(()=>{})},te=async()=>{var s;M.value=!0,L.value=!0,H.value=!0,K.value=!0;try{const[e,d,i,G]=await Promise.all([je(),Ge(),Ke(),Je()]);Q.value=e.data||[],X.value=((s=d.data)==null?void 0:s.list)||d.data||[],Y.value=i.data||[],Z.value=G.data||[]}catch(e){console.error("获取下拉选项失败",e),c.error("获取课程/教师/班级/教室列表失败")}finally{M.value=!1,L.value=!1,H.value=!1,K.value=!1}},j=()=>{q.value&&q.value.resetFields(),u.value={id:null,termId:v.termId,courseId:null,teacherId:null,classId:null,classroomId:null,weekDay:null,startTime:null,endTime:null,startWeek:1,endWeek:16},F.value=!1},Ie=()=>{q.value.validate(async s=>{var e,d;if(s){A.value=!0;try{const i={...u.value};F.value?(await Me(i.id,i),c.success("更新成功")):(await Le(i),c.success("添加成功")),_.value=!1,y()}catch(i){console.error("提交课表项失败",i),c.error(((d=(e=i==null?void 0:i.response)==null?void 0:e.data)==null?void 0:d.message)||"提交失败，可能存在时间冲突")}finally{A.value=!1}}else return console.log("课表表单验证失败"),!1})},he=async()=>{try{const s=await Qe({sortByCreateDesc:!0});if(s.code===200&&s.data){ee.value=s.data;const e=s.data.find(d=>d.current===1);e&&(v.termId=e.id,y())}else c.error(s.message||"获取学期列表失败")}catch(s){console.error("获取学期列表失败",s),c.error("获取学期列表时发生错误")}},z=()=>{C.value=1,y()},Ve=async()=>{S.value=!0;try{const s=await ce();s.success&&Array.isArray(s.data)?R.value=s.data.map(e=>({label:e.label,value:e.value})):(c.error(s.message||"获取星期列表失败"),R.value=[])}catch(s){console.error("获取星期列表失败:",s),c.error("获取星期列表失败"),R.value=[]}finally{S.value=!1}};return Ce(()=>{fe(),he(),Ve()}),(s,e)=>{const d=xe,i=qe,G=Fe,re=De;return n(),f("div",Xe,[E("div",Ye,[e[18]||(e[18]=E("h2",null,"课表管理",-1)),E("div",null,[t(a(T),{type:"primary",onClick:ae},{default:r(()=>e[17]||(e[17]=[k(" 手动添加 ")])),_:1})])]),t(a(ne),{class:"filter-card"},{default:r(()=>[t(a(oe),{inline:!0,model:v,onSubmit:Se(y,["prevent"])},{default:r(()=>[t(a(m),{label:"学期"},{default:r(()=>[t(a(I),{modelValue:v.termId,"onUpdate:modelValue":e[0]||(e[0]=l=>v.termId=l),placeholder:"选择学期",clearable:"",filterable:"",onChange:z,style:{width:"200px"}},{default:r(()=>[(n(!0),f(h,null,V(ee.value,l=>(n(),p(a(w),{key:l.id,label:l.termName,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(a(m),{label:"星期"},{default:r(()=>[t(a(I),{modelValue:v.weekDay,"onUpdate:modelValue":e[1]||(e[1]=l=>v.weekDay=l),placeholder:"选择星期",clearable:"",onChange:z,style:{width:"150px"}},{default:r(()=>[(n(!0),f(h,null,V(R.value,l=>(n(),p(a(w),{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(a(m),{label:"关键词"},{default:r(()=>[t(a(Ee),{modelValue:v.keyword,"onUpdate:modelValue":e[2]||(e[2]=l=>v.keyword=l),placeholder:"搜索课程/教师/教室",clearable:"",style:{width:"240px"},onKeyup:Ne(z,["enter"])},{prefix:r(()=>[t(d,null,{default:r(()=>[t(a(de))]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(a(m),null,{default:r(()=>[t(a(T),{type:"primary",onClick:z,icon:a(de)},{default:r(()=>e[19]||(e[19]=[k("查询")])),_:1},8,["icon"]),t(a(T),{icon:a(We),onClick:ae},{default:r(()=>e[20]||(e[20]=[k("添加排课")])),_:1},8,["icon"])]),_:1})]),_:1},8,["model"])]),_:1}),ue((n(),p(a(ne),{class:"schedule-card"},{default:r(()=>[E("div",Ze,[t(G,{"table-data":x.value,data:x.value,border:"",style:{width:"100%"}},{default:r(()=>[t(i,{label:"课程名称",prop:"courseName"}),t(i,{label:"授课教师",prop:"teacherName"}),t(i,{label:"班级",prop:"className"}),t(i,{label:"星期",prop:"weekday"},{default:r(l=>[k(Re(le(l.row.weekday)),1)]),_:1}),t(i,{label:"开始时间",prop:"startTime"}),t(i,{label:"结束时间",prop:"endTime"}),t(i,{label:"教室",prop:"classroomName"}),t(i,{label:"操作",width:"150"},{default:r(l=>[t(a(T),{size:"small",type:"primary",onClick:we=>ye(l.row)},{default:r(()=>e[21]||(e[21]=[k(" 编辑 ")])),_:2},1032,["onClick"]),t(a(T),{size:"small",type:"danger",onClick:we=>ke(l.row)},{default:r(()=>e[22]||(e[22]=[k(" 删除 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["table-data","data"])]),D.value>0?(n(),f("div",el,[t(a(ze),{"current-page":C.value,"onUpdate:currentPage":e[3]||(e[3]=l=>C.value=l),"page-size":U.value,"onUpdate:pageSize":e[4]||(e[4]=l=>U.value=l),"page-sizes":[10,20,50,100],total:D.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ge,onCurrentChange:be},null,8,["current-page","page-size","total"])])):Ue("",!0)]),_:1})),[[re,$.value||S.value]]),t(a($e),{modelValue:_.value,"onUpdate:modelValue":e[16]||(e[16]=l=>_.value=l),title:P.value,width:"700px",onClose:j},{footer:r(()=>[E("span",ll,[t(a(T),{onClick:e[15]||(e[15]=l=>_.value=!1)},{default:r(()=>e[23]||(e[23]=[k("取消")])),_:1}),t(a(T),{loading:A.value,type:"primary",onClick:Ie},{default:r(()=>e[24]||(e[24]=[k("确定")])),_:1},8,["loading"])])]),default:r(()=>[ue((n(),p(a(oe),{ref_key:"scheduleFormRef",ref:q,model:u.value,rules:ve,"label-width":"100px"},{default:r(()=>[t(a(N),{gutter:20},{default:r(()=>[t(a(g),{span:12},{default:r(()=>[t(a(m),{label:"学期",prop:"termId"},{default:r(()=>[t(a(I),{modelValue:u.value.termId,"onUpdate:modelValue":e[5]||(e[5]=l=>u.value.termId=l),disabled:F.value,filterable:"",placeholder:"选择学期"},{default:r(()=>[(n(!0),f(h,null,V(W.value,l=>(n(),p(a(w),{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1}),t(a(g),{span:12},{default:r(()=>[t(a(m),{label:"课程",prop:"courseId"},{default:r(()=>[t(a(I),{modelValue:u.value.courseId,"onUpdate:modelValue":e[6]||(e[6]=l=>u.value.courseId=l),loading:M.value,filterable:"",placeholder:"选择课程"},{default:r(()=>[(n(!0),f(h,null,V(Q.value,l=>(n(),p(a(w),{key:l.id,label:`${l.courseNo} - ${l.courseName}`,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1})]),_:1}),t(a(N),{gutter:20},{default:r(()=>[t(a(g),{span:12},{default:r(()=>[t(a(m),{label:"教师",prop:"teacherId"},{default:r(()=>[t(a(I),{modelValue:u.value.teacherId,"onUpdate:modelValue":e[7]||(e[7]=l=>u.value.teacherId=l),loading:L.value,filterable:"",placeholder:"选择教师"},{default:r(()=>[(n(!0),f(h,null,V(X.value,l=>(n(),p(a(w),{key:l.id,label:l.realName||l.username,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1}),t(a(g),{span:12},{default:r(()=>[t(a(m),{label:"班级",prop:"classId"},{default:r(()=>[t(a(I),{modelValue:u.value.classId,"onUpdate:modelValue":e[8]||(e[8]=l=>u.value.classId=l),loading:H.value,filterable:"",placeholder:"选择班级"},{default:r(()=>[(n(!0),f(h,null,V(Y.value,l=>(n(),p(a(w),{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1})]),_:1}),t(a(N),{gutter:20},{default:r(()=>[t(a(g),{span:12},{default:r(()=>[t(a(m),{label:"教室",prop:"classroomId"},{default:r(()=>[t(a(I),{modelValue:u.value.classroomId,"onUpdate:modelValue":e[9]||(e[9]=l=>u.value.classroomId=l),loading:K.value,filterable:"",placeholder:"选择教室"},{default:r(()=>[(n(!0),f(h,null,V(Z.value,l=>(n(),p(a(w),{key:l.id,label:`${l.building} - ${l.name}`,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1}),t(a(g),{span:12},{default:r(()=>[t(a(m),{label:"星期",prop:"weekDay"},{default:r(()=>[t(a(I),{modelValue:u.value.weekDay,"onUpdate:modelValue":e[10]||(e[10]=l=>u.value.weekDay=l),placeholder:"选择星期"},{default:r(()=>[(n(!0),f(h,null,V(B.value,l=>(n(),p(a(w),{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(a(N),{gutter:20},{default:r(()=>[t(a(g),{span:12},{default:r(()=>[t(a(m),{label:"开始时间段",prop:"startTime"},{default:r(()=>[t(a(ie),{modelValue:u.value.startTime,"onUpdate:modelValue":e[11]||(e[11]=l=>u.value.startTime=l),end:"22:00",format:"HH:mm",start:"07:00",placeholder:"选择开始时间",step:"00:15"},null,8,["modelValue"])]),_:1})]),_:1}),t(a(g),{span:12},{default:r(()=>[t(a(m),{label:"结束时间段",prop:"endTime"},{default:r(()=>[t(a(ie),{modelValue:u.value.endTime,"onUpdate:modelValue":e[12]||(e[12]=l=>u.value.endTime=l),end:"22:00",format:"HH:mm",start:"07:00",placeholder:"选择结束时间",step:"00:15"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(a(N),{gutter:20},{default:r(()=>[t(a(g),{span:12},{default:r(()=>[t(a(m),{label:"开始周",prop:"startWeek"},{default:r(()=>[t(a(me),{modelValue:u.value.startWeek,"onUpdate:modelValue":e[13]||(e[13]=l=>u.value.startWeek=l),max:25,min:1,placeholder:"起始周"},null,8,["modelValue"])]),_:1})]),_:1}),t(a(g),{span:12},{default:r(()=>[t(a(m),{label:"结束周",prop:"endWeek"},{default:r(()=>[t(a(me),{modelValue:u.value.endWeek,"onUpdate:modelValue":e[14]||(e[14]=l=>u.value.endWeek=l),max:25,min:1,placeholder:"结束周"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","rules"])),[[re,O.value]])]),_:1},8,["modelValue","title"])])}}}),fl=_e(tl,[["__scopeId","data-v-31dba57c"]]);export{fl as default};
