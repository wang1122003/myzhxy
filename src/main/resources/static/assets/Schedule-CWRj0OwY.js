import{_ as ke,r as d,a as le,c as he,o as Ie,d as f,e as n,h as E,f as t,y as ae,w as r,v as y,m as l,x as _,i as te,aP as Ve,j as m,T as k,K as h,L as I,z as p,U as V,k as we,q as Te,l as _e,V as re,aT as Ce,g as se,H as Se,A as Ee,B as Ne,C as w,F as Ue,a2 as We,I as N,E as g,aV as ue,aR as oe,N as xe,P as v,af as De}from"./index-gQMZQ2sp.js";/* empty css                   */import{b as Fe,c as Re,d as ze,u as qe,e as $e}from"./schedule-_r-PKiUu.js";import{a as Be,c as Oe,d as Le}from"./common-CbP0GatP.js";import{f as Pe}from"./course-DXTLIjhn.js";import{i as Me}from"./user-xlhqAG_R.js";import{b as Ae}from"./classroom-CzAab-Ht.js";import{g as He}from"./term-BwK5SD_a.js";import"./request-DfavLRg_.js";import"./api-endpoints-Ctc2JoQP.js";const je={class:"schedule-management-container"},Ke={class:"page-header"},Ge={class:"list-view"},Je={key:0,class:"pagination-container"},Qe={class:"dialog-footer"},Xe={name:"ScheduleManagement"},Ye=Object.assign(Xe,{setup(Ze){const z=d(!1),K=d(!1),q=d(!1),U=d([]),W=d([]),$=d([]),S=d(0),C=d(1),x=d(10),i=le({termId:null,teacherName:"",courseName:"",className:"",weekDay:null,keyword:""}),T=d(!1),B=d("添加课表项"),O=d(!1),L=d(!1),D=d(!1),F=d(null),u=d({id:null,termId:null,courseId:null,teacherId:null,classId:null,classroomId:null,weekDay:null,startTime:null,endTime:null,startWeek:1,endWeek:16}),de=le({termId:[{required:!0,message:"请选择学期",trigger:"change"}],courseId:[{required:!0,message:"请选择课程",trigger:"change"}],teacherId:[{required:!0,message:"请选择教师",trigger:"change"}],classId:[{required:!0,message:"请选择班级",trigger:"change"}],classroomId:[{required:!0,message:"请选择教室",trigger:"change"}],weekDay:[{required:!0,message:"请选择星期",trigger:"change"}],startTime:[{required:!0,message:"请选择开始时间",trigger:"change"}],endTime:[{required:!0,message:"请选择结束时间",trigger:"change"},{validator:(s,e,o)=>{u.value.startTime&&e<=u.value.startTime?o(new Error("结束时间必须晚于开始时间")):o()},trigger:"change"}],startWeek:[{required:!0,message:"请输入开始周",trigger:"blur"}],endWeek:[{required:!0,message:"请输入结束周",trigger:"blur"},{validator:(s,e,o)=>{u.value.startWeek&&e<u.value.startWeek?o(new Error("结束周不能小于开始周")):o()},trigger:"blur"}]}),G=d([]),J=d([]),Q=d([]),X=d([]),P=d(!1),M=d(!1),A=d(!1),H=d(!1),Y=d([]),ne=async()=>{K.value=!0,q.value=!0;try{const[s,e]=await Promise.all([Be(),Oe()]);W.value=s.data||[],$.value=e.data||[],W.value.length>0&&!i.termId&&(i.termId=W.value[0].value,await b())}catch(s){console.error("获取初始数据失败",s),v.error("获取学期/星期数据失败")}finally{K.value=!1,q.value=!1}},b=async()=>{if(!i.termId){v.warning("请先选择学期");return}z.value=!0;try{const s={termId:i.termId,teacherName:i.teacherName||null,courseName:i.courseName||null,className:i.className||null,page:C.value,size:x.value};Object.keys(s).forEach(o=>s[o]==null&&delete s[o]);const e=await Fe(s);e.data&&e.data.records?(U.value=e.data.records,S.value=e.data.total||0):(U.value=[],S.value=0)}catch(s){console.error("获取课表失败",s),v.error("获取课表失败"),U.value=[],S.value=0}finally{z.value=!1}},ie=he(()=>{const s={};return $.value.forEach(e=>{s[e.value]=e.label}),s}),Z=s=>ie.value[s]||"",me=s=>{x.value=s,C.value=1,b()},ce=s=>{C.value=s,b()},ve=()=>{j(),B.value="手动添加课表项",T.value=!0,ee()},fe=async s=>{j(),B.value="编辑课表项",D.value=!0,O.value=!0,T.value=!0,ee();try{const o={...(await Re(s.id)).data};o.startTime&&o.startTime.includes(":")&&(o.startTime=o.startTime.substring(0,5)),o.endTime&&o.endTime.includes(":")&&(o.endTime=o.endTime.substring(0,5)),u.value=o}catch(e){console.error("获取课表详情失败",e),v.error("获取课表详情失败"),T.value=!1}finally{O.value=!1}},pe=s=>{De.confirm(`确定要删除 ${s.courseName} (星期${Z(s.weekday)} ${s.startTime}-${s.endTime}) 这条课表记录吗?`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await ze(s.id),v.success("删除成功"),b()}catch(e){console.error("删除课表项失败",e),v.error("删除课表项失败")}}).catch(()=>{})},ee=async()=>{var s;P.value=!0,M.value=!0,A.value=!0,H.value=!0;try{const[e,o,c,a]=await Promise.all([Pe(),Me(),Le(),Ae()]);G.value=e.data||[],J.value=((s=o.data)==null?void 0:s.list)||o.data||[],Q.value=c.data||[],X.value=a.data||[]}catch(e){console.error("获取下拉选项失败",e),v.error("获取课程/教师/班级/教室列表失败")}finally{P.value=!1,M.value=!1,A.value=!1,H.value=!1}},j=()=>{F.value&&F.value.resetFields(),u.value={id:null,termId:i.termId,courseId:null,teacherId:null,classId:null,classroomId:null,weekDay:null,startTime:null,endTime:null,startWeek:1,endWeek:16},D.value=!1},ge=()=>{F.value.validate(async s=>{var e,o;if(s){L.value=!0;try{const c={...u.value};D.value?(await qe(c.id,c),v.success("更新成功")):(await $e(c),v.success("添加成功")),T.value=!1,b()}catch(c){console.error("提交课表项失败",c),v.error(((o=(e=c==null?void 0:c.response)==null?void 0:e.data)==null?void 0:o.message)||"提交失败，可能存在时间冲突")}finally{L.value=!1}}else return console.log("课表表单验证失败"),!1})},be=async()=>{try{const s=await He();if(s.code===200&&s.data){Y.value=s.data;const e=s.data.find(o=>o.current===1);e&&(i.termId=e.id,b())}else v.error(s.message||"获取学期列表失败")}catch(s){console.error("获取学期列表失败",s),v.error("获取学期列表时发生错误")}},R=()=>{C.value=1,b()};return Ie(()=>{ne(),be()}),(s,e)=>{const o=_e,c=Se;return n(),f("div",je,[E("div",Ke,[e[18]||(e[18]=E("h2",null,"课表管理",-1)),E("div",null,[t(l(_),{type:"primary",onClick:ve},{default:r(()=>e[17]||(e[17]=[y(" 手动添加 ")])),_:1})])]),t(l(se),{class:"filter-card"},{default:r(()=>[t(l(te),{inline:!0,model:i,onSubmit:Ve(b,["prevent"])},{default:r(()=>[t(l(m),{label:"学期"},{default:r(()=>[t(l(k),{modelValue:i.termId,"onUpdate:modelValue":e[0]||(e[0]=a=>i.termId=a),placeholder:"选择学期",clearable:"",filterable:"",onChange:R,style:{width:"200px"}},{default:r(()=>[(n(!0),f(h,null,I(Y.value,a=>(n(),p(l(V),{key:a.id,label:a.termName,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(l(m),{label:"星期"},{default:r(()=>[t(l(k),{modelValue:i.weekDay,"onUpdate:modelValue":e[1]||(e[1]=a=>i.weekDay=a),placeholder:"选择星期",clearable:"",onChange:R,style:{width:"150px"}},{default:r(()=>[(n(!0),f(h,null,I(s.weekDayOptions,a=>(n(),p(l(V),{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(l(m),{label:"关键词"},{default:r(()=>[t(l(we),{modelValue:i.keyword,"onUpdate:modelValue":e[2]||(e[2]=a=>i.keyword=a),placeholder:"搜索课程/教师/教室",clearable:"",style:{width:"240px"},onKeyup:Te(R,["enter"])},{prefix:r(()=>[t(o,null,{default:r(()=>[t(l(re))]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(l(m),null,{default:r(()=>[t(l(_),{type:"primary",onClick:R,icon:l(re)},{default:r(()=>e[19]||(e[19]=[y("查询")])),_:1},8,["icon"]),t(l(_),{icon:l(Ce),onClick:s.handleAddSchedule},{default:r(()=>e[20]||(e[20]=[y("添加排课")])),_:1},8,["icon","onClick"])]),_:1})]),_:1},8,["model"])]),_:1}),ae((n(),p(l(se),{class:"schedule-card"},{default:r(()=>[E("div",Ge,[t(l(Ne),{data:U.value,border:"",style:{width:"100%"}},{default:r(()=>[t(l(w),{label:"课程名称",prop:"courseName"}),t(l(w),{label:"授课教师",prop:"teacherName"}),t(l(w),{label:"班级",prop:"className"}),t(l(w),{label:"星期",prop:"weekday"},{default:r(a=>[y(Ue(Z(a.row.weekday)),1)]),_:1}),t(l(w),{label:"开始时间",prop:"startTime"}),t(l(w),{label:"结束时间",prop:"endTime"}),t(l(w),{label:"教室",prop:"classroomName"}),t(l(w),{label:"操作",width:"150"},{default:r(a=>[t(l(_),{size:"small",type:"primary",onClick:ye=>fe(a.row)},{default:r(()=>e[21]||(e[21]=[y(" 编辑 ")])),_:2},1032,["onClick"]),t(l(_),{size:"small",type:"danger",onClick:ye=>pe(a.row)},{default:r(()=>e[22]||(e[22]=[y(" 删除 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),S.value>0?(n(),f("div",Je,[t(l(We),{"current-page":C.value,"onUpdate:currentPage":e[3]||(e[3]=a=>C.value=a),"page-size":x.value,"onUpdate:pageSize":e[4]||(e[4]=a=>x.value=a),"page-sizes":[10,20,50,100],total:S.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:me,onCurrentChange:ce},null,8,["current-page","page-size","total"])])):Ee("",!0)]),_:1})),[[c,z.value||q.value]]),t(l(xe),{modelValue:T.value,"onUpdate:modelValue":e[16]||(e[16]=a=>T.value=a),title:B.value,width:"700px",onClose:j},{footer:r(()=>[E("span",Qe,[t(l(_),{onClick:e[15]||(e[15]=a=>T.value=!1)},{default:r(()=>e[23]||(e[23]=[y("取消")])),_:1}),t(l(_),{loading:L.value,type:"primary",onClick:ge},{default:r(()=>e[24]||(e[24]=[y("确定")])),_:1},8,["loading"])])]),default:r(()=>[ae((n(),p(l(te),{ref_key:"scheduleFormRef",ref:F,model:u.value,rules:de,"label-width":"100px"},{default:r(()=>[t(l(N),{gutter:20},{default:r(()=>[t(l(g),{span:12},{default:r(()=>[t(l(m),{label:"学期",prop:"termId"},{default:r(()=>[t(l(k),{modelValue:u.value.termId,"onUpdate:modelValue":e[5]||(e[5]=a=>u.value.termId=a),disabled:D.value,filterable:"",placeholder:"选择学期"},{default:r(()=>[(n(!0),f(h,null,I(W.value,a=>(n(),p(l(V),{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1}),t(l(g),{span:12},{default:r(()=>[t(l(m),{label:"课程",prop:"courseId"},{default:r(()=>[t(l(k),{modelValue:u.value.courseId,"onUpdate:modelValue":e[6]||(e[6]=a=>u.value.courseId=a),loading:P.value,filterable:"",placeholder:"选择课程"},{default:r(()=>[(n(!0),f(h,null,I(G.value,a=>(n(),p(l(V),{key:a.id,label:`${a.courseNo} - ${a.courseName}`,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1})]),_:1}),t(l(N),{gutter:20},{default:r(()=>[t(l(g),{span:12},{default:r(()=>[t(l(m),{label:"教师",prop:"teacherId"},{default:r(()=>[t(l(k),{modelValue:u.value.teacherId,"onUpdate:modelValue":e[7]||(e[7]=a=>u.value.teacherId=a),loading:M.value,filterable:"",placeholder:"选择教师"},{default:r(()=>[(n(!0),f(h,null,I(J.value,a=>(n(),p(l(V),{key:a.id,label:a.realName||a.username,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1}),t(l(g),{span:12},{default:r(()=>[t(l(m),{label:"班级",prop:"classId"},{default:r(()=>[t(l(k),{modelValue:u.value.classId,"onUpdate:modelValue":e[8]||(e[8]=a=>u.value.classId=a),loading:A.value,filterable:"",placeholder:"选择班级"},{default:r(()=>[(n(!0),f(h,null,I(Q.value,a=>(n(),p(l(V),{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1})]),_:1}),t(l(N),{gutter:20},{default:r(()=>[t(l(g),{span:12},{default:r(()=>[t(l(m),{label:"教室",prop:"classroomId"},{default:r(()=>[t(l(k),{modelValue:u.value.classroomId,"onUpdate:modelValue":e[9]||(e[9]=a=>u.value.classroomId=a),loading:H.value,filterable:"",placeholder:"选择教室"},{default:r(()=>[(n(!0),f(h,null,I(X.value,a=>(n(),p(l(V),{key:a.id,label:`${a.building} - ${a.name}`,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1}),t(l(g),{span:12},{default:r(()=>[t(l(m),{label:"星期",prop:"weekDay"},{default:r(()=>[t(l(k),{modelValue:u.value.weekDay,"onUpdate:modelValue":e[10]||(e[10]=a=>u.value.weekDay=a),placeholder:"选择星期"},{default:r(()=>[(n(!0),f(h,null,I($.value,a=>(n(),p(l(V),{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(l(N),{gutter:20},{default:r(()=>[t(l(g),{span:12},{default:r(()=>[t(l(m),{label:"开始时间段",prop:"startTime"},{default:r(()=>[t(l(ue),{modelValue:u.value.startTime,"onUpdate:modelValue":e[11]||(e[11]=a=>u.value.startTime=a),end:"22:00",format:"HH:mm",start:"07:00",placeholder:"选择开始时间",step:"00:15"},null,8,["modelValue"])]),_:1})]),_:1}),t(l(g),{span:12},{default:r(()=>[t(l(m),{label:"结束时间段",prop:"endTime"},{default:r(()=>[t(l(ue),{modelValue:u.value.endTime,"onUpdate:modelValue":e[12]||(e[12]=a=>u.value.endTime=a),end:"22:00",format:"HH:mm",start:"07:00",placeholder:"选择结束时间",step:"00:15"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(l(N),{gutter:20},{default:r(()=>[t(l(g),{span:12},{default:r(()=>[t(l(m),{label:"开始周",prop:"startWeek"},{default:r(()=>[t(l(oe),{modelValue:u.value.startWeek,"onUpdate:modelValue":e[13]||(e[13]=a=>u.value.startWeek=a),max:25,min:1,placeholder:"起始周"},null,8,["modelValue"])]),_:1})]),_:1}),t(l(g),{span:12},{default:r(()=>[t(l(m),{label:"结束周",prop:"endWeek"},{default:r(()=>[t(l(oe),{modelValue:u.value.endWeek,"onUpdate:modelValue":e[14]||(e[14]=a=>u.value.endWeek=a),max:25,min:1,placeholder:"结束周"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","rules"])),[[c,O.value]])]),_:1},8,["modelValue","title"])])}}}),il=ke(Ye,[["__scopeId","data-v-f1608d97"]]);export{il as default};
