<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件管理 - 校园管理系统</title>
    <link rel="stylesheet" href="../../static/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../static/css/bootstrap-icons.css">
    <link rel="stylesheet" href="../../static/css/admin.css">
</head>
<body>
    <!-- 加载遮罩 -->
    <div id="loading-mask">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
    </div>

    <!-- 侧边栏容器 -->
    <div id="sidebar-container"></div>

    <!-- 主要内容区域 -->
    <div class="main-content">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>文件管理</h2>
                <div>
                    <button class="btn btn-primary me-2" id="btn-upload">
                        <i class="bi bi-upload"></i> 上传文件
                    </button>
                    <button class="btn btn-success" id="btn-create-folder">
                        <i class="bi bi-folder-plus"></i> 新建文件夹
                    </button>
                </div>
            </div>

            <!-- 面包屑导航 -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb" id="path-breadcrumb">
                    <li class="breadcrumb-item"><a href="#" data-path="/">根目录</a></li>
                </ol>
            </nav>

            <!-- 搜索和筛选 -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" id="search-input" placeholder="搜索文件名...">
                                <button class="btn btn-outline-secondary" type="button" id="btn-search">
                                    <i class="bi bi-search"></i> 搜索
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-primary active" id="btn-filter-all">全部</button>
                                <button type="button" class="btn btn-outline-primary" id="btn-filter-folder">文件夹</button>
                                <button type="button" class="btn btn-outline-primary" id="btn-filter-file">文件</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 文件列表 -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 40px">
                                        <input type="checkbox" class="form-check-input" id="select-all">
                                    </th>
                                    <th>名称</th>
                                    <th>大小</th>
                                    <th>类型</th>
                                    <th>上传时间</th>
                                    <th>上传者</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="file-list">
                                <!-- 文件列表将通过JavaScript动态加载 -->
                            </tbody>
                        </table>
                    </div>

                    <!-- 分页 -->
                    <nav aria-label="文件列表分页">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- 分页将通过JavaScript动态加载 -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- 上传文件模态框 -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">上传文件</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="upload-form">
                        <div class="mb-3">
                            <label for="upload-path" class="form-label">上传路径</label>
                            <input type="text" class="form-control" id="upload-path" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="upload-files" class="form-label">选择文件</label>
                            <input type="file" class="form-control" id="upload-files" multiple>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">上传进度</label>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div id="upload-list" class="mb-3">
                            <!-- 上传文件列表将通过JavaScript动态加载 -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="btn-start-upload">开始上传</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新建文件夹模态框 -->
    <div class="modal fade" id="folderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新建文件夹</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="folder-form">
                        <div class="mb-3">
                            <label for="folder-path" class="form-label">路径</label>
                            <input type="text" class="form-control" id="folder-path" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="folder-name" class="form-label">文件夹名称</label>
                            <input type="text" class="form-control" id="folder-name" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="btn-create-folder-confirm">创建</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 重命名模态框 -->
    <div class="modal fade" id="renameModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">重命名</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="rename-form">
                        <input type="hidden" id="rename-id">
                        <div class="mb-3">
                            <label for="rename-name" class="form-label">新名称</label>
                            <input type="text" class="form-control" id="rename-name" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="btn-rename-confirm">重命名</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 移动文件模态框 -->
    <div class="modal fade" id="moveModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">移动文件</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="move-form">
                        <input type="hidden" id="move-ids">
                        <div class="mb-3">
                            <label for="move-path" class="form-label">目标路径</label>
                            <select class="form-select" id="move-path" required>
                                <option value="/">根目录</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="btn-move-confirm">移动</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">确认删除</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>确定要删除选中的文件/文件夹吗？此操作不可恢复。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="btn-confirm-delete">确认删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 文件预览模态框 -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="preview-title"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="preview-content"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="btn-download">下载</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../../static/js/jquery.min.js"></script>
    <script src="../../static/js/bootstrap.bundle.min.js"></script>
    <script src="../../static/js/api.js"></script>
    <script src="../../static/js/ui.js"></script>
    <script>
        // 当前路径、页码和每页显示数量
        let currentPath = '/';
        let currentPage = 1;
        const pageSize = 20;
        let totalPages = 1;
        let currentFilter = 'all';
        let currentKeyword = '';
        let selectedFiles = new Set(); // 当前选中的文件ID集合

        // 初始化文件管理模块
        function initFileModule() {
            // 加载文件列表
            loadFileList();
            
            // 绑定事件处理器
            bindEventHandlers();
        }

        // 加载文件列表
        function loadFileList() {
            // 显示加载中
            $('#file-list').html('<tr><td colspan="7" class="text-center">加载中...</td></tr>');
            
            // 构建查询参数
            const params = {
                path: currentPath,
                page: currentPage,
                size: pageSize,
                keyword: currentKeyword
            };
            
            // 根据筛选条件添加类型
            if (currentFilter !== 'all') {
                params.type = currentFilter === 'folder' ? 'folder' : 'file';
            }
            
            // 调用API获取文件列表
            API.file.getFileList(params)
                .then(response => {
                    if (response.success) {
                        renderFileList(response.data.list);
                        renderPagination(response.data.total, response.data.pages);
                        updateBreadcrumb();
                    } else {
                        $('#file-list').html('<tr><td colspan="7" class="text-center text-danger">加载失败: ' + response.message + '</td></tr>');
                    }
                })
                .catch(error => {
                    console.error('加载文件列表失败:', error);
                    $('#file-list').html('<tr><td colspan="7" class="text-center text-danger">加载失败，请稍后重试</td></tr>');
                });
        }

        // 渲染文件列表
        function renderFileList(files) {
            if (!files || files.length === 0) {
                $('#file-list').html('<tr><td colspan="7" class="text-center">当前目录为空</td></tr>');
                return;
            }
            
            let html = '';
            files.forEach(file => {
                const isSelected = selectedFiles.has(file.id);
                const icon = file.type === 'folder' ? 'bi-folder' : getFileIcon(file.name);
                
                html += `
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input file-checkbox" 
                                data-id="${file.id}" ${isSelected ? 'checked' : ''}>
                        </td>
                        <td>
                            <i class="bi ${icon} me-2"></i>
                            ${file.type === 'folder' 
                                ? `<a href="#" class="folder-link" data-path="${file.path}">${file.name}</a>`
                                : `<a href="#" class="file-link" data-id="${file.id}">${file.name}</a>`
                            }
                        </td>
                        <td>${formatFileSize(file.size)}</td>
                        <td>${getFileType(file.name)}</td>
                        <td>${formatDateTime(file.uploadTime)}</td>
                        <td>${file.uploaderName}</td>
                        <td>
                            ${file.type === 'folder' 
                                ? `<button class="btn btn-sm btn-primary rename-folder" data-id="${file.id}">
                                        <i class="bi bi-pencil"></i> 重命名
                                    </button>`
                                : `<button class="btn btn-sm btn-info preview-file" data-id="${file.id}">
                                        <i class="bi bi-eye"></i> 预览
                                    </button>
                                    <button class="btn btn-sm btn-primary rename-file" data-id="${file.id}">
                                        <i class="bi bi-pencil"></i> 重命名
                                    </button>`
                            }
                            <button class="btn btn-sm btn-danger delete-file" data-id="${file.id}">
                                <i class="bi bi-trash"></i> 删除
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            $('#file-list').html(html);
        }

        // 获取文件图标
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            switch (ext) {
                case 'pdf':
                    return 'bi-file-pdf';
                case 'doc':
                case 'docx':
                    return 'bi-file-word';
                case 'xls':
                case 'xlsx':
                    return 'bi-file-excel';
                case 'ppt':
                case 'pptx':
                    return 'bi-file-slides';
                case 'jpg':
                case 'jpeg':
                case 'png':
                case 'gif':
                    return 'bi-file-image';
                case 'txt':
                    return 'bi-file-text';
                default:
                    return 'bi-file';
            }
        }

        // 获取文件类型
        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            switch (ext) {
                case 'pdf':
                    return 'PDF文档';
                case 'doc':
                case 'docx':
                    return 'Word文档';
                case 'xls':
                case 'xlsx':
                    return 'Excel表格';
                case 'ppt':
                case 'pptx':
                    return 'PowerPoint演示文稿';
                case 'jpg':
                case 'jpeg':
                case 'png':
                case 'gif':
                    return '图片';
                case 'txt':
                    return '文本文件';
                default:
                    return '未知类型';
            }
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 格式化日期时间
        function formatDateTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 渲染分页
        function renderPagination(total, pages) {
            totalPages = pages;
            
            if (pages <= 1) {
                $('#pagination').html('');
                return;
            }
            
            let html = '';
            
            // 上一页
            html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}">上一页</a>
                </li>
            `;
            
            // 页码
            for (let i = 1; i <= pages; i++) {
                if (
                    i === 1 || 
                    i === pages || 
                    (i >= currentPage - 2 && i <= currentPage + 2)
                ) {
                    html += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" data-page="${i}">${i}</a>
                        </li>
                    `;
                } else if (
                    i === currentPage - 3 || 
                    i === currentPage + 3
                ) {
                    html += `
                        <li class="page-item disabled">
                            <a class="page-link" href="#">...</a>
                        </li>
                    `;
                }
            }
            
            // 下一页
            html += `
                <li class="page-item ${currentPage === pages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}">下一页</a>
                </li>
            `;
            
            $('#pagination').html(html);
        }

        // 更新面包屑导航
        function updateBreadcrumb() {
            const paths = currentPath.split('/').filter(p => p);
            let html = '<li class="breadcrumb-item"><a href="#" data-path="/">根目录</a></li>';
            
            let currentPathBuilder = '';
            paths.forEach(path => {
                currentPathBuilder += '/' + path;
                html += `
                    <li class="breadcrumb-item">
                        <a href="#" data-path="${currentPathBuilder}">${path}</a>
                    </li>
                `;
            });
            
            $('#path-breadcrumb').html(html);
        }

        // 绑定事件处理器
        function bindEventHandlers() {
            // 上传文件按钮
            $('#btn-upload').on('click', function() {
                openUploadModal();
            });
            
            // 新建文件夹按钮
            $('#btn-create-folder').on('click', function() {
                openFolderModal();
            });
            
            // 搜索按钮
            $('#btn-search').on('click', function() {
                currentKeyword = $('#search-input').val().trim();
                currentPage = 1;
                loadFileList();
            });
            
            // 搜索输入框回车事件
            $('#search-input').on('keypress', function(e) {
                if (e.which === 13) {
                    currentKeyword = $(this).val().trim();
                    currentPage = 1;
                    loadFileList();
                }
            });
            
            // 筛选按钮
            $('.btn-group .btn').on('click', function() {
                $('.btn-group .btn').removeClass('active');
                $(this).addClass('active');
                
                const filter = $(this).attr('id').replace('btn-filter-', '');
                currentFilter = filter;
                currentPage = 1;
                loadFileList();
            });
            
            // 分页点击事件
            $('#pagination').on('click', '.page-link', function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                if (page && page !== currentPage && page >= 1 && page <= totalPages) {
                    currentPage = page;
                    loadFileList();
                }
            });
            
            // 面包屑导航点击事件
            $('#path-breadcrumb').on('click', '.breadcrumb-item a', function(e) {
                e.preventDefault();
                const path = $(this).data('path');
                currentPath = path;
                currentPage = 1;
                loadFileList();
            });
            
            // 文件夹链接点击事件
            $(document).on('click', '.folder-link', function(e) {
                e.preventDefault();
                const path = $(this).data('path');
                currentPath = path;
                currentPage = 1;
                loadFileList();
            });
            
            // 文件链接点击事件
            $(document).on('click', '.file-link', function(e) {
                e.preventDefault();
                const fileId = $(this).data('id');
                previewFile(fileId);
            });
            
            // 全选复选框
            $('#select-all').on('change', function() {
                const checked = $(this).prop('checked');
                $('.file-checkbox').prop('checked', checked);
                if (checked) {
                    $('.file-checkbox').each(function() {
                        selectedFiles.add($(this).data('id'));
                    });
                } else {
                    selectedFiles.clear();
                }
                updateMoveButton();
            });
            
            // 文件复选框
            $(document).on('change', '.file-checkbox', function() {
                const fileId = $(this).data('id');
                if ($(this).prop('checked')) {
                    selectedFiles.add(fileId);
                } else {
                    selectedFiles.delete(fileId);
                }
                updateMoveButton();
            });
            
            // 重命名文件夹按钮
            $(document).on('click', '.rename-folder', function() {
                const folderId = $(this).data('id');
                openRenameModal(folderId);
            });
            
            // 重命名文件按钮
            $(document).on('click', '.rename-file', function() {
                const fileId = $(this).data('id');
                openRenameModal(fileId);
            });
            
            // 删除文件按钮
            $(document).on('click', '.delete-file', function() {
                const fileId = $(this).data('id');
                selectedFiles.clear();
                selectedFiles.add(fileId);
                $('#deleteModal').modal('show');
            });
            
            // 预览文件按钮
            $(document).on('click', '.preview-file', function() {
                const fileId = $(this).data('id');
                previewFile(fileId);
            });
            
            // 开始上传按钮
            $('#btn-start-upload').on('click', function() {
                startUpload();
            });
            
            // 创建文件夹确认按钮
            $('#btn-create-folder-confirm').on('click', function() {
                createFolder();
            });
            
            // 重命名确认按钮
            $('#btn-rename-confirm').on('click', function() {
                renameFile();
            });
            
            // 移动确认按钮
            $('#btn-move-confirm').on('click', function() {
                moveFiles();
            });
            
            // 确认删除按钮
            $('#btn-confirm-delete').on('click', function() {
                deleteFiles();
            });
            
            // 下载按钮
            $('#btn-download').on('click', function() {
                const fileId = $('#preview-title').data('id');
                if (fileId) {
                    downloadFile(fileId);
                }
            });
        }

        // 打开上传模态框
        function openUploadModal() {
            // 重置表单
            $('#upload-form')[0].reset();
            $('#upload-path').val(currentPath);
            $('#upload-list').empty();
            $('.progress-bar').css('width', '0%');
            
            // 显示模态框
            $('#uploadModal').modal('show');
        }

        // 开始上传文件
        function startUpload() {
            const files = $('#upload-files')[0].files;
            if (!files || files.length === 0) {
                alert('请选择要上传的文件');
                return;
            }
            
            const formData = new FormData();
            formData.append('path', currentPath);
            
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }
            
            // 显示上传进度
            const progressBar = $('.progress-bar');
            progressBar.css('width', '0%');
            
            // 调用API上传文件
            API.file.uploadFiles(formData, {
                onUploadProgress: progressEvent => {
                    const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                    progressBar.css('width', percentCompleted + '%');
                }
            })
                .then(response => {
                    if (response.success) {
                        // 上传成功，关闭模态框并刷新列表
                        $('#uploadModal').modal('hide');
                        loadFileList();
                        alert('文件上传成功');
                    } else {
                        alert('上传失败: ' + response.message);
                    }
                })
                .catch(error => {
                    console.error('上传文件失败:', error);
                    alert('上传失败，请稍后重试');
                });
        }

        // 打开新建文件夹模态框
        function openFolderModal() {
            // 重置表单
            $('#folder-form')[0].reset();
            $('#folder-path').val(currentPath);
            
            // 显示模态框
            $('#folderModal').modal('show');
        }

        // 创建文件夹
        function createFolder() {
            const name = $('#folder-name').val().trim();
            if (!name) {
                alert('请输入文件夹名称');
                return;
            }
            
            // 调用API创建文件夹
            API.file.createFolder({
                path: currentPath,
                name: name
            })
                .then(response => {
                    if (response.success) {
                        // 创建成功，关闭模态框并刷新列表
                        $('#folderModal').modal('hide');
                        loadFileList();
                        alert('文件夹创建成功');
                    } else {
                        alert('创建失败: ' + response.message);
                    }
                })
                .catch(error => {
                    console.error('创建文件夹失败:', error);
                    alert('创建失败，请稍后重试');
                });
        }

        // 打开重命名模态框
        function openRenameModal(fileId) {
            // 调用API获取文件信息
            API.file.getFileInfo(fileId)
                .then(response => {
                    if (response.success) {
                        const file = response.data;
                        
                        // 填充表单
                        $('#rename-id').val(fileId);
                        $('#rename-name').val(file.name);
                        
                        // 显示模态框
                        $('#renameModal').modal('show');
                    } else {
                        alert('加载文件信息失败: ' + response.message);
                    }
                })
                .catch(error => {
                    console.error('加载文件信息失败:', error);
                    alert('加载文件信息失败，请稍后重试');
                });
        }

        // 重命名文件
        function renameFile() {
            const fileId = $('#rename-id').val();
            const newName = $('#rename-name').val().trim();
            
            if (!newName) {
                alert('请输入新名称');
                return;
            }
            
            // 调用API重命名文件
            API.file.renameFile(fileId, newName)
                .then(response => {
                    if (response.success) {
                        // 重命名成功，关闭模态框并刷新列表
                        $('#renameModal').modal('hide');
                        loadFileList();
                        alert('重命名成功');
                    } else {
                        alert('重命名失败: ' + response.message);
                    }
                })
                .catch(error => {
                    console.error('重命名文件失败:', error);
                    alert('重命名失败，请稍后重试');
                });
        }

        // 移动文件
        function moveFiles() {
            if (selectedFiles.size === 0) {
                alert('请选择要移动的文件');
                return;
            }
            
            const targetPath = $('#move-path').val();
            
            // 调用API移动文件
            API.file.moveFiles(Array.from(selectedFiles), targetPath)
                .then(response => {
                    if (response.success) {
                        // 移动成功，关闭模态框并刷新列表
                        $('#moveModal').modal('hide');
                        loadFileList();
                        alert('文件移动成功');
                    } else {
                        alert('移动失败: ' + response.message);
                    }
                })
                .catch(error => {
                    console.error('移动文件失败:', error);
                    alert('移动失败，请稍后重试');
                });
        }

        // 删除文件
        function deleteFiles() {
            if (selectedFiles.size === 0) {
                alert('请选择要删除的文件');
                return;
            }
            
            // 调用API删除文件
            API.file.deleteFiles(Array.from(selectedFiles))
                .then(response => {
                    if (response.success) {
                        // 删除成功，关闭模态框并刷新列表
                        $('#deleteModal').modal('hide');
                        loadFileList();
                        alert('文件删除成功');
                    } else {
                        alert('删除失败: ' + response.message);
                    }
                })
                .catch(error => {
                    console.error('删除文件失败:', error);
                    alert('删除失败，请稍后重试');
                });
        }

        // 预览文件
        function previewFile(fileId) {
            // 调用API获取文件信息
            API.file.getFileInfo(fileId)
                .then(response => {
                    if (response.success) {
                        const file = response.data;
                        
                        // 填充预览内容
                        $('#preview-title').text(file.name).data('id', fileId);
                        
                        // 根据文件类型显示不同的预览内容
                        const ext = file.name.split('.').pop().toLowerCase();
                        if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
                            // 图片预览
                            $('#preview-content').html(`
                                <img src="${API.file.getFileUrl(fileId)}" class="img-fluid" alt="${file.name}">
                            `);
                        } else if (ext === 'pdf') {
                            // PDF预览
                            $('#preview-content').html(`
                                <embed src="${API.file.getFileUrl(fileId)}" type="application/pdf" width="100%" height="600px">
                            `);
                        } else if (['txt', 'md'].includes(ext)) {
                            // 文本预览
                            API.file.getFileContent(fileId)
                                .then(response => {
                                    if (response.success) {
                                        $('#preview-content').html(`
                                            <pre class="bg-light p-3">${response.data}</pre>
                                        `);
                                    } else {
                                        $('#preview-content').html(`
                                            <div class="alert alert-danger">
                                                加载文件内容失败: ${response.message}
                                            </div>
                                        `);
                                    }
                                })
                                .catch(error => {
                                    console.error('加载文件内容失败:', error);
                                    $('#preview-content').html(`
                                        <div class="alert alert-danger">
                                            加载文件内容失败，请稍后重试
                                        </div>
                                    `);
                                });
                        } else {
                            // 其他文件类型
                            $('#preview-content').html(`
                                <div class="alert alert-info">
                                    此文件类型暂不支持预览，请下载后查看
                                </div>
                            `);
                        }
                        
                        // 显示模态框
                        $('#previewModal').modal('show');
                    } else {
                        alert('加载文件信息失败: ' + response.message);
                    }
                })
                .catch(error => {
                    console.error('加载文件信息失败:', error);
                    alert('加载文件信息失败，请稍后重试');
                });
        }

        // 下载文件
        function downloadFile(fileId) {
            // 调用API获取文件信息
            API.file.getFileInfo(fileId)
                .then(response => {
                    if (response.success) {
                        const file = response.data;
                        
                        // 创建下载链接
                        const link = document.createElement('a');
                        link.href = API.file.getFileUrl(fileId);
                        link.download = file.name;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } else {
                        alert('加载文件信息失败: ' + response.message);
                    }
                })
                .catch(error => {
                    console.error('加载文件信息失败:', error);
                    alert('加载文件信息失败，请稍后重试');
                });
        }

        // 更新移动按钮状态
        function updateMoveButton() {
            const hasSelection = selectedFiles.size > 0;
            $('#btn-move').prop('disabled', !hasSelection);
        }

        // 页面加载完成后初始化
        $(document).ready(function() {
            // 加载侧边栏
            $('#sidebar-container').load('../../admin/template.html #sidebar', function() {
                // 侧边栏加载完成后初始化文件管理模块
                initFileModule();
                
                // 隐藏加载遮罩
                $('#loading-mask').fadeOut();
            });
        });
    </script>
</body>
</html> 