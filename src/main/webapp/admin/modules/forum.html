<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>论坛管理 - 智慧校园服务系统</title>
    <link rel="stylesheet" href="../../../static/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../../../static/css/admin.css">
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <!-- 加载遮罩 -->
    <div id="loading-mask">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏将通过JavaScript加载 -->
            <div id="sidebar-container"></div>

            <!-- 主内容区 -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2" id="page-title">论坛管理</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button type="button" class="btn btn-sm btn-primary me-2" id="btn-add-category">
                            <i class="bi bi-folder-plus"></i> 添加分类
                        </button>
                        <button type="button" class="btn btn-sm btn-primary" id="btn-add-post">
                            <i class="bi bi-plus-circle"></i> 发布帖子
                        </button>
                    </div>
                </div>

                <!-- 搜索栏 -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="search-input" placeholder="搜索帖子标题、内容...">
                            <button class="btn btn-outline-secondary" type="button" id="btn-search">
                                <i class="bi bi-search"></i> 搜索
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="btn-group float-end" role="group">
                            <button type="button" class="btn btn-outline-secondary active" id="btn-filter-all">全部</button>
                            <button type="button" class="btn btn-outline-secondary" id="btn-filter-hot">热门</button>
                            <button type="button" class="btn btn-outline-secondary" id="btn-filter-new">最新</button>
                            <button type="button" class="btn btn-outline-secondary" id="btn-filter-reported">被举报</button>
                        </div>
                    </div>
                </div>

                <!-- 分类列表 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">论坛分类</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">分类名称</th>
                                        <th scope="col">描述</th>
                                        <th scope="col">帖子数量</th>
                                        <th scope="col">状态</th>
                                        <th scope="col">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="category-list">
                                    <!-- 分类数据将通过JavaScript动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 帖子列表 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">帖子列表</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">标题</th>
                                        <th scope="col">分类</th>
                                        <th scope="col">作者</th>
                                        <th scope="col">发布时间</th>
                                        <th scope="col">回复数</th>
                                        <th scope="col">状态</th>
                                        <th scope="col">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="post-list">
                                    <!-- 帖子数据将通过JavaScript动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 分页 -->
                <nav aria-label="Page navigation" class="mt-3">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- 分页按钮将通过JavaScript动态加载 -->
                    </ul>
                </nav>
            </main>
        </div>
    </div>

    <!-- 添加/编辑分类模态框 -->
    <div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalLabel">添加分类</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="category-form">
                        <input type="hidden" id="category-id">
                        <div class="mb-3">
                            <label for="category-name" class="form-label">分类名称</label>
                            <input type="text" class="form-control" id="category-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="category-description" class="form-label">分类描述</label>
                            <textarea class="form-control" id="category-description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="category-status" class="form-label">状态</label>
                            <select class="form-select" id="category-status" required>
                                <option value="1">启用</option>
                                <option value="0">禁用</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="btn-save-category">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑帖子模态框 -->
    <div class="modal fade" id="postModal" tabindex="-1" aria-labelledby="postModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="postModalLabel">发布帖子</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="post-form">
                        <input type="hidden" id="post-id">
                        <div class="mb-3">
                            <label for="post-title" class="form-label">标题</label>
                            <input type="text" class="form-control" id="post-title" required>
                        </div>
                        <div class="mb-3">
                            <label for="post-category" class="form-label">分类</label>
                            <select class="form-select" id="post-category" required>
                                <!-- 分类选项将通过JavaScript动态加载 -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="post-content" class="form-label">内容</label>
                            <textarea class="form-control" id="post-content" rows="10" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="post-status" class="form-label">状态</label>
                            <select class="form-select" id="post-status" required>
                                <option value="1">正常</option>
                                <option value="0">隐藏</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="btn-save-post">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 查看评论模态框 -->
    <div class="modal fade" id="commentsModal" tabindex="-1" aria-labelledby="commentsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="commentsModalLabel">帖子评论</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">评论者</th>
                                    <th scope="col">评论内容</th>
                                    <th scope="col">评论时间</th>
                                    <th scope="col">状态</th>
                                    <th scope="col">操作</th>
                                </tr>
                            </thead>
                            <tbody id="comments-list">
                                <!-- 评论数据将通过JavaScript动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 确认删除模态框 -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">确认删除</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>确定要删除此项吗？此操作不可恢复。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="btn-confirm-delete">删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 脚本 -->
    <script src="../../../static/js/jquery.min.js"></script>
    <script src="../../../static/js/bootstrap.bundle.min.js"></script>
    <script src="../../../static/js/api.js"></script>
    <script src="../../../static/js/ui.js"></script>
    <script>
        // 当前页码和每页显示数量
        let currentPage = 1;
        const pageSize = 10;
        let totalPages = 1;
        let currentFilter = 'all';
        let currentKeyword = '';
        let itemToDelete = null; // 当前待删除的项目ID
        let currentPostId = null; // 当前查看评论的帖子ID

        // 页面加载完成后执行
        $(document).ready(function() {
            // 加载侧边栏
            $('#sidebar-container').load('../../sidebar.html', function() {
                // 设置当前页面的导航项为激活状态
                $('.nav-link[href="../forum.html"]').addClass('active');
            });
            
            // 检查登录状态
            checkLogin();
            
            // 加载分类列表
            loadCategoryList();
            
            // 加载帖子列表
            loadPostList();
            
            // 绑定事件处理器
            bindEventHandlers();
        });
        
        // 检查用户是否已登录
        function checkLogin() {
            API.checkToken(function(success) {
                if (!success) {
                    // 未登录，跳转到登录页
                    window.location.href = '../../../index.html';
                } else {
                    // 检查权限
                    API.checkPermission('forum_manage', function(hasPermission) {
                        if (!hasPermission) {
                            alert('您没有论坛管理权限');
                            window.location.href = '../../index.html';
                        } else {
                            // 已登录且有权限，显示内容
                            $('#loading-mask').hide();
                        }
                    });
                }
            });
        }
        
        // 绑定各种事件处理器
        function bindEventHandlers() {
            // 添加分类按钮
            $('#btn-add-category').on('click', function() {
                openCategoryModal();
            });
            
            // 添加帖子按钮
            $('#btn-add-post').on('click', function() {
                openPostModal();
            });
            
            // 保存分类按钮
            $('#btn-save-category').on('click', function() {
                saveCategory();
            });
            
            // 保存帖子按钮
            $('#btn-save-post').on('click', function() {
                savePost();
            });
            
            // 搜索按钮
            $('#btn-search').on('click', function() {
                currentKeyword = $('#search-input').val().trim();
                currentPage = 1;
                loadPostList();
            });
            
            // 回车键搜索
            $('#search-input').on('keypress', function(e) {
                if (e.which === 13) {
                    $('#btn-search').click();
                }
            });
            
            // 筛选按钮
            $('#btn-filter-all').on('click', function() {
                currentFilter = 'all';
                updateFilterButtons();
                currentPage = 1;
                loadPostList();
            });
            
            $('#btn-filter-hot').on('click', function() {
                currentFilter = 'hot';
                updateFilterButtons();
                currentPage = 1;
                loadPostList();
            });
            
            $('#btn-filter-new').on('click', function() {
                currentFilter = 'new';
                updateFilterButtons();
                currentPage = 1;
                loadPostList();
            });
            
            $('#btn-filter-reported').on('click', function() {
                currentFilter = 'reported';
                updateFilterButtons();
                currentPage = 1;
                loadPostList();
            });
            
            // 确认删除按钮
            $('#btn-confirm-delete').on('click', function() {
                if (itemToDelete) {
                    deleteItem();
                }
            });
        }
        
        // 更新筛选按钮状态
        function updateFilterButtons() {
            $('.btn-group .btn').removeClass('active');
            switch (currentFilter) {
                case 'hot':
                    $('#btn-filter-hot').addClass('active');
                    break;
                case 'new':
                    $('#btn-filter-new').addClass('active');
                    break;
                case 'reported':
                    $('#btn-filter-reported').addClass('active');
                    break;
                default:
                    $('#btn-filter-all').addClass('active');
                    break;
            }
        }
        
        // 加载分类列表
        function loadCategoryList() {
            $('#loading-mask').show();
            
            API.getForumCategories(function(result) {
                $('#loading-mask').hide();
                
                if (result.success) {
                    renderCategoryList(result.data);
                } else {
                    UI.showError('加载分类列表失败：' + result.message);
                }
            });
        }
        
        // 渲染分类列表
        function renderCategoryList(categories) {
            const $categoryList = $('#category-list');
            $categoryList.empty();
            
            if (categories.length === 0) {
                $categoryList.append('<tr><td colspan="6" class="text-center">暂无分类</td></tr>');
                return;
            }
            
            categories.forEach(function(category, index) {
                const statusText = getCategoryStatusText(category.status);
                
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${category.name}</td>
                        <td>${category.description || '-'}</td>
                        <td>${category.postCount || 0}</td>
                        <td>${statusText}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary btn-edit-category" data-id="${category.id}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-delete-category" data-id="${category.id}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                
                $categoryList.append(row);
            });
            
            // 编辑分类按钮点击事件
            $('.btn-edit-category').on('click', function() {
                const categoryId = $(this).data('id');
                openCategoryModal(categoryId);
            });
            
            // 删除分类按钮点击事件
            $('.btn-delete-category').on('click', function() {
                const categoryId = $(this).data('id');
                itemToDelete = {
                    type: 'category',
                    id: categoryId
                };
                $('#deleteModal').modal('show');
            });
        }
        
        // 加载帖子列表
        function loadPostList() {
            $('#loading-mask').show();
            
            // 根据筛选条件设置参数
            let params = {
                page: currentPage,
                pageSize: pageSize,
                keyword: currentKeyword
            };
            
            if (currentFilter === 'hot') {
                params.sortBy = 'hot';
            } else if (currentFilter === 'new') {
                params.sortBy = 'new';
            } else if (currentFilter === 'reported') {
                params.reported = true;
            }
            
            API.getForumPosts(params, function(result) {
                $('#loading-mask').hide();
                
                if (result.success) {
                    renderPostList(result.data.posts);
                    
                    // 更新分页
                    totalPages = Math.ceil(result.data.total / pageSize);
                    renderPagination();
                } else {
                    UI.showError('加载帖子列表失败：' + result.message);
                }
            });
        }
        
        // 渲染帖子列表
        function renderPostList(posts) {
            const $postList = $('#post-list');
            $postList.empty();
            
            if (posts.length === 0) {
                $postList.append('<tr><td colspan="8" class="text-center">没有找到匹配的帖子</td></tr>');
                return;
            }
            
            posts.forEach(function(post, index) {
                const statusText = getPostStatusText(post.status);
                
                const row = `
                    <tr>
                        <td>${(currentPage - 1) * pageSize + index + 1}</td>
                        <td>${post.title}</td>
                        <td>${post.categoryName}</td>
                        <td>${post.authorName}</td>
                        <td>${formatDateTime(post.createTime)}</td>
                        <td>${post.commentCount || 0}</td>
                        <td>${statusText}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-info btn-comments" data-id="${post.id}">
                                <i class="bi bi-chat"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary btn-edit-post" data-id="${post.id}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-delete-post" data-id="${post.id}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                
                $postList.append(row);
            });
            
            // 编辑帖子按钮点击事件
            $('.btn-edit-post').on('click', function() {
                const postId = $(this).data('id');
                openPostModal(postId);
            });
            
            // 删除帖子按钮点击事件
            $('.btn-delete-post').on('click', function() {
                const postId = $(this).data('id');
                itemToDelete = {
                    type: 'post',
                    id: postId
                };
                $('#deleteModal').modal('show');
            });
            
            // 查看评论按钮点击事件
            $('.btn-comments').on('click', function() {
                const postId = $(this).data('id');
                openCommentsModal(postId);
            });
        }
        
        // 渲染分页
        function renderPagination() {
            const $pagination = $('#pagination');
            $pagination.empty();
            
            if (totalPages <= 1) {
                return;
            }
            
            // 上一页
            $pagination.append(`
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            `);
            
            // 页码
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    $pagination.append(`
                        <li class="page-item active"><a class="page-link" href="#" data-page="${i}">${i}</a></li>
                    `);
                } else {
                    // 只显示当前页附近的页码
                    if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                        $pagination.append(`
                            <li class="page-item"><a class="page-link" href="#" data-page="${i}">${i}</a></li>
                        `);
                    } else if (i === currentPage - 3 || i === currentPage + 3) {
                        $pagination.append(`
                            <li class="page-item disabled"><a class="page-link" href="#">...</a></li>
                        `);
                    }
                }
            }
            
            // 下一页
            $pagination.append(`
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            `);
            
            // 页码点击事件
            $('.page-link').on('click', function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                if (page && page !== currentPage && page > 0 && page <= totalPages) {
                    currentPage = page;
                    loadPostList();
                }
            });
        }
        
        // 打开分类模态框
        function openCategoryModal(categoryId) {
            // 重置表单
            $('#category-form')[0].reset();
            $('#category-id').val('');
            
            if (categoryId) {
                // 编辑分类
                $('#categoryModalLabel').text('编辑分类');
                
                // 加载分类信息
                $('#loading-mask').show();
                API.getForumCategoryById(categoryId, function(result) {
                    $('#loading-mask').hide();
                    
                    if (result.success) {
                        const category = result.data;
                        $('#category-id').val(category.id);
                        $('#category-name').val(category.name);
                        $('#category-description').val(category.description);
                        $('#category-status').val(category.status);
                        
                        $('#categoryModal').modal('show');
                    } else {
                        UI.showError('加载分类信息失败：' + result.message);
                    }
                });
            } else {
                // 添加分类
                $('#categoryModalLabel').text('添加分类');
                $('#categoryModal').modal('show');
            }
        }
        
        // 打开帖子模态框
        function openPostModal(postId) {
            // 重置表单
            $('#post-form')[0].reset();
            $('#post-id').val('');
            
            // 加载分类选项
            loadCategoryOptions();
            
            if (postId) {
                // 编辑帖子
                $('#postModalLabel').text('编辑帖子');
                
                // 加载帖子信息
                $('#loading-mask').show();
                API.getForumPostById(postId, function(result) {
                    $('#loading-mask').hide();
                    
                    if (result.success) {
                        const post = result.data;
                        $('#post-id').val(post.id);
                        $('#post-title').val(post.title);
                        $('#post-category').val(post.categoryId);
                        $('#post-content').val(post.content);
                        $('#post-status').val(post.status);
                        
                        $('#postModal').modal('show');
                    } else {
                        UI.showError('加载帖子信息失败：' + result.message);
                    }
                });
            } else {
                // 添加帖子
                $('#postModalLabel').text('发布帖子');
                $('#postModal').modal('show');
            }
        }
        
        // 加载分类选项
        function loadCategoryOptions() {
            API.getForumCategories(function(result) {
                if (result.success) {
                    const $categorySelect = $('#post-category');
                    $categorySelect.empty();
                    
                    result.data.forEach(function(category) {
                        if (category.status === 1) {
                            $categorySelect.append(`
                                <option value="${category.id}">${category.name}</option>
                            `);
                        }
                    });
                }
            });
        }
        
        // 保存分类
        function saveCategory() {
            const categoryId = $('#category-id').val();
            const name = $('#category-name').val();
            const description = $('#category-description').val();
            const status = $('#category-status').val();
            
            // 表单验证
            if (!name) {
                UI.showError('请填写分类名称');
                return;
            }
            
            const categoryData = {
                name: name,
                description: description,
                status: parseInt(status)
            };
            
            $('#loading-mask').show();
            
            if (categoryId) {
                // 编辑分类
                categoryData.id = parseInt(categoryId);
                API.updateForumCategory(categoryData, function(result) {
                    $('#loading-mask').hide();
                    
                    if (result.success) {
                        $('#categoryModal').modal('hide');
                        UI.showSuccess('分类更新成功');
                        loadCategoryList();
                    } else {
                        UI.showError('分类更新失败：' + result.message);
                    }
                });
            } else {
                // 添加分类
                API.addForumCategory(categoryData, function(result) {
                    $('#loading-mask').hide();
                    
                    if (result.success) {
                        $('#categoryModal').modal('hide');
                        UI.showSuccess('分类添加成功');
                        loadCategoryList();
                    } else {
                        UI.showError('分类添加失败：' + result.message);
                    }
                });
            }
        }
        
        // 保存帖子
        function savePost() {
            const postId = $('#post-id').val();
            const title = $('#post-title').val();
            const categoryId = $('#post-category').val();
            const content = $('#post-content').val();
            const status = $('#post-status').val();
            
            // 表单验证
            if (!title || !categoryId || !content) {
                UI.showError('请填写必填字段');
                return;
            }
            
            const postData = {
                title: title,
                categoryId: parseInt(categoryId),
                content: content,
                status: parseInt(status)
            };
            
            $('#loading-mask').show();
            
            if (postId) {
                // 编辑帖子
                postData.id = parseInt(postId);
                API.updateForumPost(postData, function(result) {
                    $('#loading-mask').hide();
                    
                    if (result.success) {
                        $('#postModal').modal('hide');
                        UI.showSuccess('帖子更新成功');
                        loadPostList();
                    } else {
                        UI.showError('帖子更新失败：' + result.message);
                    }
                });
            } else {
                // 添加帖子
                API.addForumPost(postData, function(result) {
                    $('#loading-mask').hide();
                    
                    if (result.success) {
                        $('#postModal').modal('hide');
                        UI.showSuccess('帖子发布成功');
                        loadPostList();
                    } else {
                        UI.showError('帖子发布失败：' + result.message);
                    }
                });
            }
        }
        
        // 删除项目
        function deleteItem() {
            if (!itemToDelete) return;
            
            $('#loading-mask').show();
            
            if (itemToDelete.type === 'category') {
                API.deleteForumCategory(itemToDelete.id, function(result) {
                    $('#loading-mask').hide();
                    $('#deleteModal').modal('hide');
                    
                    if (result.success) {
                        UI.showSuccess('分类删除成功');
                        loadCategoryList();
                    } else {
                        UI.showError('分类删除失败：' + result.message);
                    }
                });
            } else if (itemToDelete.type === 'post') {
                API.deleteForumPost(itemToDelete.id, function(result) {
                    $('#loading-mask').hide();
                    $('#deleteModal').modal('hide');
                    
                    if (result.success) {
                        UI.showSuccess('帖子删除成功');
                        loadPostList();
                    } else {
                        UI.showError('帖子删除失败：' + result.message);
                    }
                });
            }
            
            itemToDelete = null;
        }
        
        // 打开评论模态框
        function openCommentsModal(postId) {
            currentPostId = postId;
            
            // 加载帖子信息
            $('#loading-mask').show();
            API.getForumPostById(postId, function(result) {
                if (result.success) {
                    const post = result.data;
                    $('#commentsModalLabel').text(`帖子评论 - ${post.title}`);
                    
                    // 加载评论列表
                    loadCommentsList(postId);
                } else {
                    $('#loading-mask').hide();
                    UI.showError('加载帖子信息失败：' + result.message);
                }
            });
            
            $('#commentsModal').modal('show');
        }
        
        // 加载评论列表
        function loadCommentsList(postId) {
            API.getForumComments(postId, function(result) {
                $('#loading-mask').hide();
                
                if (result.success) {
                    renderCommentsList(result.data);
                } else {
                    UI.showError('加载评论列表失败：' + result.message);
                }
            });
        }
        
        // 渲染评论列表
        function renderCommentsList(comments) {
            const $commentsList = $('#comments-list');
            $commentsList.empty();
            
            if (comments.length === 0) {
                $commentsList.append('<tr><td colspan="6" class="text-center">暂无评论</td></tr>');
                return;
            }
            
            comments.forEach(function(comment, index) {
                const statusText = getCommentStatusText(comment.status);
                
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${comment.authorName}</td>
                        <td>${comment.content}</td>
                        <td>${formatDateTime(comment.createTime)}</td>
                        <td>${statusText}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger btn-delete-comment" data-id="${comment.id}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                
                $commentsList.append(row);
            });
            
            // 删除评论按钮点击事件
            $('.btn-delete-comment').on('click', function() {
                const commentId = $(this).data('id');
                if (confirm('确定要删除此评论吗？')) {
                    deleteComment(commentId);
                }
            });
        }
        
        // 删除评论
        function deleteComment(commentId) {
            $('#loading-mask').show();
            
            API.deleteForumComment(commentId, function(result) {
                $('#loading-mask').hide();
                
                if (result.success) {
                    UI.showSuccess('评论删除成功');
                    loadCommentsList(currentPostId);
                } else {
                    UI.showError('评论删除失败：' + result.message);
                }
            });
        }
        
        // 获取分类状态文本
        function getCategoryStatusText(status) {
            switch (parseInt(status)) {
                case 1: return '<span class="badge bg-success">启用</span>';
                case 0: return '<span class="badge bg-danger">禁用</span>';
                default: return '<span class="badge bg-secondary">未知</span>';
            }
        }
        
        // 获取帖子状态文本
        function getPostStatusText(status) {
            switch (parseInt(status)) {
                case 1: return '<span class="badge bg-success">正常</span>';
                case 0: return '<span class="badge bg-danger">隐藏</span>';
                default: return '<span class="badge bg-secondary">未知</span>';
            }
        }
        
        // 获取评论状态文本
        function getCommentStatusText(status) {
            switch (parseInt(status)) {
                case 1: return '<span class="badge bg-success">正常</span>';
                case 0: return '<span class="badge bg-danger">隐藏</span>';
                default: return '<span class="badge bg-secondary">未知</span>';
            }
        }
        
        // 格式化日期时间
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '';
            const date = new Date(dateTimeStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html> 