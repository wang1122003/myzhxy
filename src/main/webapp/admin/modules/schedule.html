<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>排课管理 - 智慧校园服务系统</title>
    <link rel="stylesheet" href="../../../static/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../../../static/css/admin.css">
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <!-- 加载遮罩 -->
    <div id="loading-mask">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏将通过JavaScript加载 -->
            <div id="sidebar-container"></div>

            <!-- 主内容区 -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2" id="page-title">排课管理</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button type="button" class="btn btn-sm btn-primary" id="btn-add-schedule">
                            <i class="bi bi-plus-circle"></i> 添加排课
                        </button>
                    </div>
                </div>

                <!-- 筛选条件 -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="semester-select" class="form-label">学期</label>
                                <select class="form-select" id="semester-select">
                                    <option value="">全部学期</option>
                                    <!-- 学期选项将通过JavaScript动态加载 -->
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="course-select" class="form-label">课程</label>
                                <select class="form-select" id="course-select">
                                    <option value="">全部课程</option>
                                    <!-- 课程选项将通过JavaScript动态加载 -->
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="teacher-select" class="form-label">教师</label>
                                <select class="form-select" id="teacher-select">
                                    <option value="">全部教师</option>
                                    <!-- 教师选项将通过JavaScript动态加载 -->
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="classroom-select" class="form-label">教室</label>
                                <select class="form-select" id="classroom-select">
                                    <option value="">全部教室</option>
                                    <!-- 教室选项将通过JavaScript动态加载 -->
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="weekday-select" class="form-label">星期</label>
                                <select class="form-select" id="weekday-select">
                                    <option value="">全部</option>
                                    <option value="1">星期一</option>
                                    <option value="2">星期二</option>
                                    <option value="3">星期三</option>
                                    <option value="4">星期四</option>
                                    <option value="5">星期五</option>
                                    <option value="6">星期六</option>
                                    <option value="7">星期日</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="time-slot-select" class="form-label">时间段</label>
                                <select class="form-select" id="time-slot-select">
                                    <option value="">全部</option>
                                    <option value="1">第1-2节 (8:00-9:40)</option>
                                    <option value="2">第3-4节 (10:00-11:40)</option>
                                    <option value="3">第5-6节 (14:00-15:40)</option>
                                    <option value="4">第7-8节 (16:00-17:40)</option>
                                    <option value="5">第9-10节 (19:00-20:40)</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3 d-flex align-items-end">
                                <button type="button" class="btn btn-primary" id="btn-filter">
                                    <i class="bi bi-search"></i> 查询
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" id="btn-reset">
                                    <i class="bi bi-arrow-counterclockwise"></i> 重置
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 排课列表 -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">学期</th>
                                <th scope="col">课程</th>
                                <th scope="col">教师</th>
                                <th scope="col">教室</th>
                                <th scope="col">星期</th>
                                <th scope="col">时间段</th>
                                <th scope="col">操作</th>
                            </tr>
                        </thead>
                        <tbody id="schedule-list">
                            <!-- 排课数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <nav aria-label="Page navigation" class="mt-3">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- 分页按钮将通过JavaScript动态加载 -->
                    </ul>
                </nav>
            </main>
        </div>
    </div>

    <!-- 添加/编辑排课模态框 -->
    <div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scheduleModalLabel">添加排课</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="schedule-form">
                        <input type="hidden" id="schedule-id">
                        <div class="mb-3">
                            <label for="semester" class="form-label">学期</label>
                            <select class="form-select" id="semester" required>
                                <!-- 学期选项将通过JavaScript动态加载 -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="course" class="form-label">课程</label>
                            <select class="form-select" id="course" required>
                                <!-- 课程选项将通过JavaScript动态加载 -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="teacher" class="form-label">教师</label>
                            <select class="form-select" id="teacher" required>
                                <!-- 教师选项将通过JavaScript动态加载 -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="classroom" class="form-label">教室</label>
                            <select class="form-select" id="classroom" required>
                                <!-- 教室选项将通过JavaScript动态加载 -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="weekday" class="form-label">星期</label>
                            <select class="form-select" id="weekday" required>
                                <option value="1">星期一</option>
                                <option value="2">星期二</option>
                                <option value="3">星期三</option>
                                <option value="4">星期四</option>
                                <option value="5">星期五</option>
                                <option value="6">星期六</option>
                                <option value="7">星期日</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="time-slot" class="form-label">时间段</label>
                            <select class="form-select" id="time-slot" required>
                                <option value="1">第1-2节 (8:00-9:40)</option>
                                <option value="2">第3-4节 (10:00-11:40)</option>
                                <option value="3">第5-6节 (14:00-15:40)</option>
                                <option value="4">第7-8节 (16:00-17:40)</option>
                                <option value="5">第9-10节 (19:00-20:40)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="start-week" class="form-label">起始周</label>
                            <input type="number" class="form-control" id="start-week" min="1" max="20" required>
                        </div>
                        <div class="mb-3">
                            <label for="end-week" class="form-label">结束周</label>
                            <input type="number" class="form-control" id="end-week" min="1" max="20" required>
                        </div>
                        <div class="mb-3">
                            <label for="remark" class="form-label">备注</label>
                            <textarea class="form-control" id="remark" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="btn-save-schedule">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 确认删除模态框 -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">确认删除</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>确定要删除此排课记录吗？此操作不可恢复。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="btn-confirm-delete">删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 脚本 -->
    <script src="../../../static/js/jquery.min.js"></script>
    <script src="../../../static/js/bootstrap.bundle.min.js"></script>
    <script src="../../../static/js/api.js"></script>
    <script src="../../../static/js/ui.js"></script>
    <script>
        // 当前页码和每页显示数量
        let currentPage = 1;
        const pageSize = 10;
        let totalPages = 1;
        let scheduleToDelete = null; // 当前待删除的排课ID

        // 页面加载完成后执行
        $(document).ready(function() {
            // 加载侧边栏
            $('#sidebar-container').load('../../sidebar.html', function() {
                // 设置当前页面的导航项为激活状态
                $('.nav-link[href*="modules/schedule/index.html"]').addClass('active');
            });
            
            // 检查登录状态
            checkLogin();
            
            // 加载下拉选项数据
            loadSelectOptions();
            
            // 加载排课列表
            loadScheduleList();
            
            // 绑定事件处理器
            bindEventHandlers();
        });
        
        // 检查用户是否已登录
        function checkLogin() {
            API.checkToken(function(success) {
                if (!success) {
                    // 未登录，跳转到登录页
                    window.location.href = '../../../index.html';
                } else {
                    // 检查权限
                    API.checkPermission('schedule_manage', function(hasPermission) {
                        if (!hasPermission) {
                            alert('您没有排课管理权限');
                            window.location.href = '../../index.html';
                        } else {
                            // 已登录且有权限，显示内容
                            $('#loading-mask').hide();
                        }
                    });
                }
            });
        }
        
        // 加载下拉选项数据
        function loadSelectOptions() {
            // 加载学期选项
            API.getSemesterList(function(result) {
                if (result.success) {
                    const semesters = result.data;
                    const $semesterSelect = $('#semester-select');
                    const $semesterFormSelect = $('#semester');
                    
                    semesters.forEach(function(semester) {
                        const option = `<option value="${semester.id}">${semester.name}</option>`;
                        $semesterSelect.append(option);
                        $semesterFormSelect.append(option);
                    });
                }
            });
            
            // 加载课程选项
            API.getCourseList(1, 100, '', null, function(result) {
                if (result.success) {
                    const courses = result.data.courses;
                    const $courseSelect = $('#course-select');
                    const $courseFormSelect = $('#course');
                    
                    courses.forEach(function(course) {
                        const option = `<option value="${course.id}">${course.courseName} (${course.courseCode})</option>`;
                        $courseSelect.append(option);
                        $courseFormSelect.append(option);
                    });
                }
            });
            
            // 加载教师选项
            API.getTeacherList(function(result) {
                if (result.success) {
                    const teachers = result.data;
                    const $teacherSelect = $('#teacher-select');
                    const $teacherFormSelect = $('#teacher');
                    
                    teachers.forEach(function(teacher) {
                        const option = `<option value="${teacher.id}">${teacher.realName}</option>`;
                        $teacherSelect.append(option);
                        $teacherFormSelect.append(option);
                    });
                }
            });
            
            // 加载教室选项
            API.getClassroomList(1, 100, '', null, function(result) {
                if (result.success) {
                    const classrooms = result.data.classrooms;
                    const $classroomSelect = $('#classroom-select');
                    const $classroomFormSelect = $('#classroom');
                    
                    classrooms.forEach(function(classroom) {
                        const option = `<option value="${classroom.id}">${classroom.classroomName} (${classroom.classroomCode})</option>`;
                        $classroomSelect.append(option);
                        $classroomFormSelect.append(option);
                    });
                }
            });
        }
        
        // 绑定各种事件处理器
        function bindEventHandlers() {
            // 添加排课按钮
            $('#btn-add-schedule').on('click', function() {
                openScheduleModal();
            });
            
            // 保存排课按钮
            $('#btn-save-schedule').on('click', function() {
                saveSchedule();
            });
            
            // 查询按钮
            $('#btn-filter').on('click', function() {
                currentPage = 1;
                loadScheduleList();
            });
            
            // 重置按钮
            $('#btn-reset').on('click', function() {
                $('#semester-select').val('');
                $('#course-select').val('');
                $('#teacher-select').val('');
                $('#classroom-select').val('');
                $('#weekday-select').val('');
                $('#time-slot-select').val('');
                currentPage = 1;
                loadScheduleList();
            });
            
            // 确认删除按钮
            $('#btn-confirm-delete').on('click', function() {
                if (scheduleToDelete) {
                    deleteSchedule(scheduleToDelete);
                }
            });
        }
        
        // 加载排课列表
        function loadScheduleList() {
            $('#loading-mask').show();
            
            const filters = {
                semesterId: $('#semester-select').val(),
                courseId: $('#course-select').val(),
                teacherId: $('#teacher-select').val(),
                classroomId: $('#classroom-select').val(),
                weekday: $('#weekday-select').val(),
                timeSlot: $('#time-slot-select').val(),
                page: currentPage,
                pageSize: pageSize
            };
            
            API.getScheduleList(filters, function(result) {
                $('#loading-mask').hide();
                
                if (result.success) {
                    // 渲染排课列表
                    renderScheduleList(result.data.schedules);
                    
                    // 更新分页
                    totalPages = Math.ceil(result.data.total / pageSize);
                    renderPagination();
                } else {
                    UI.showError('加载排课列表失败：' + result.message);
                }
            });
        }
        
        // 渲染排课列表
        function renderScheduleList(schedules) {
            const $scheduleList = $('#schedule-list');
            $scheduleList.empty();
            
            if (schedules.length === 0) {
                $scheduleList.append('<tr><td colspan="8" class="text-center">没有找到匹配的排课记录</td></tr>');
                return;
            }
            
            schedules.forEach(function(schedule, index) {
                const weekdayText = getWeekdayText(schedule.weekday);
                const timeSlotText = getTimeSlotText(schedule.timeSlot);
                
                const row = `
                    <tr>
                        <td>${(currentPage - 1) * pageSize + index + 1}</td>
                        <td>${schedule.semesterName}</td>
                        <td>${schedule.courseName}</td>
                        <td>${schedule.teacherName}</td>
                        <td>${schedule.classroomName}</td>
                        <td>${weekdayText}</td>
                        <td>${timeSlotText}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary btn-edit" data-id="${schedule.id}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${schedule.id}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                
                $scheduleList.append(row);
            });
            
            // 编辑按钮点击事件
            $('.btn-edit').on('click', function() {
                const scheduleId = $(this).data('id');
                openScheduleModal(scheduleId);
            });
            
            // 删除按钮点击事件
            $('.btn-delete').on('click', function() {
                const scheduleId = $(this).data('id');
                scheduleToDelete = scheduleId;
                $('#deleteModal').modal('show');
            });
        }
        
        // 渲染分页
        function renderPagination() {
            const $pagination = $('#pagination');
            $pagination.empty();
            
            if (totalPages <= 1) {
                return;
            }
            
            // 上一页
            $pagination.append(`
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            `);
            
            // 页码
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    $pagination.append(`
                        <li class="page-item active"><a class="page-link" href="#" data-page="${i}">${i}</a></li>
                    `);
                } else {
                    // 只显示当前页附近的页码
                    if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                        $pagination.append(`
                            <li class="page-item"><a class="page-link" href="#" data-page="${i}">${i}</a></li>
                        `);
                    } else if (i === currentPage - 3 || i === currentPage + 3) {
                        $pagination.append(`
                            <li class="page-item disabled"><a class="page-link" href="#">...</a></li>
                        `);
                    }
                }
            }
            
            // 下一页
            $pagination.append(`
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            `);
            
            // 页码点击事件
            $('.page-link').on('click', function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                if (page && page !== currentPage && page > 0 && page <= totalPages) {
                    currentPage = page;
                    loadScheduleList();
                }
            });
        }
        
        // 打开排课模态框
        function openScheduleModal(scheduleId) {
            // 重置表单
            $('#schedule-form')[0].reset();
            $('#schedule-id').val('');
            
            if (scheduleId) {
                // 编辑排课
                $('#scheduleModalLabel').text('编辑排课');
                
                // 加载排课信息
                $('#loading-mask').show();
                API.getScheduleById(scheduleId, function(result) {
                    $('#loading-mask').hide();
                    
                    if (result.success) {
                        const schedule = result.data;
                        $('#schedule-id').val(schedule.id);
                        $('#semester').val(schedule.semesterId);
                        $('#course').val(schedule.courseId);
                        $('#teacher').val(schedule.teacherId);
                        $('#classroom').val(schedule.classroomId);
                        $('#weekday').val(schedule.weekday);
                        $('#time-slot').val(schedule.timeSlot);
                        $('#start-week').val(schedule.startWeek);
                        $('#end-week').val(schedule.endWeek);
                        $('#remark').val(schedule.remark);
                        
                        $('#scheduleModal').modal('show');
                    } else {
                        UI.showError('加载排课信息失败：' + result.message);
                    }
                });
            } else {
                // 添加排课
                $('#scheduleModalLabel').text('添加排课');
                $('#scheduleModal').modal('show');
            }
        }
        
        // 保存排课
        function saveSchedule() {
            const scheduleId = $('#schedule-id').val();
            const semesterId = $('#semester').val();
            const courseId = $('#course').val();
            const teacherId = $('#teacher').val();
            const classroomId = $('#classroom').val();
            const weekday = $('#weekday').val();
            const timeSlot = $('#time-slot').val();
            const startWeek = $('#start-week').val();
            const endWeek = $('#end-week').val();
            const remark = $('#remark').val();
            
            // 表单验证
            if (!semesterId || !courseId || !teacherId || !classroomId || !weekday || !timeSlot || !startWeek || !endWeek) {
                UI.showError('请填写必填字段');
                return;
            }
            
            if (parseInt(startWeek) > parseInt(endWeek)) {
                UI.showError('起始周不能大于结束周');
                return;
            }
            
            const scheduleData = {
                semesterId: parseInt(semesterId),
                courseId: parseInt(courseId),
                teacherId: parseInt(teacherId),
                classroomId: parseInt(classroomId),
                weekday: parseInt(weekday),
                timeSlot: parseInt(timeSlot),
                startWeek: parseInt(startWeek),
                endWeek: parseInt(endWeek),
                remark: remark
            };
            
            $('#loading-mask').show();
            
            if (scheduleId) {
                // 编辑排课
                scheduleData.id = parseInt(scheduleId);
                API.updateSchedule(scheduleData, function(result) {
                    $('#loading-mask').hide();
                    
                    if (result.success) {
                        $('#scheduleModal').modal('hide');
                        UI.showSuccess('排课更新成功');
                        loadScheduleList();
                    } else {
                        UI.showError('排课更新失败：' + result.message);
                    }
                });
            } else {
                // 添加排课
                API.addSchedule(scheduleData, function(result) {
                    $('#loading-mask').hide();
                    
                    if (result.success) {
                        $('#scheduleModal').modal('hide');
                        UI.showSuccess('排课添加成功');
                        loadScheduleList();
                    } else {
                        UI.showError('排课添加失败：' + result.message);
                    }
                });
            }
        }
        
        // 删除排课
        function deleteSchedule(scheduleId) {
            $('#loading-mask').show();
            
            API.deleteSchedule(scheduleId, function(result) {
                $('#loading-mask').hide();
                $('#deleteModal').modal('hide');
                
                if (result.success) {
                    UI.showSuccess('排课删除成功');
                    loadScheduleList();
                } else {
                    UI.showError('排课删除失败：' + result.message);
                }
            });
        }
        
        // 获取星期文本
        function getWeekdayText(weekday) {
            switch (parseInt(weekday)) {
                case 1: return '星期一';
                case 2: return '星期二';
                case 3: return '星期三';
                case 4: return '星期四';
                case 5: return '星期五';
                case 6: return '星期六';
                case 7: return '星期日';
                default: return '未知';
            }
        }
        
        // 获取时间段文本
        function getTimeSlotText(timeSlot) {
            switch (parseInt(timeSlot)) {
                case 1: return '第1-2节 (8:00-9:40)';
                case 2: return '第3-4节 (10:00-11:40)';
                case 3: return '第5-6节 (14:00-15:40)';
                case 4: return '第7-8节 (16:00-17:40)';
                case 5: return '第9-10节 (19:00-20:40)';
                default: return '未知';
            }
        }
    </script>
</body>
</html> 