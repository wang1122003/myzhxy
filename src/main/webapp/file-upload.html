<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件上传 - 智慧校园服务系统</title>
    <link rel="stylesheet" href="static/css/style.css">
    <link rel="stylesheet" href="static/css/bootstrap-icons.css">
    <script src="static/js/api.js"></script>
    <script src="static/js/ui.js"></script>
    <style>
        .upload-container {
            max-width: 960px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .upload-tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 1px solid #ddd;
            margin-bottom: 1.5rem;
        }
        
        .upload-tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            margin-right: 0.5rem;
            border-radius: 4px 4px 0 0;
        }
        
        .upload-tab:hover {
            background-color: #f8f9fa;
        }
        
        .upload-tab.active {
            background-color: #3a7bd5;
            color: #fff;
            font-weight: 500;
        }
        
        .upload-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .upload-content.active {
            display: block;
        }
        
        .card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .upload-area:hover {
            border-color: #3a7bd5;
        }
        
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #3a7bd5;
        }
        
        .upload-input {
            display: none;
        }
        
        .upload-btn {
            background-color: #3a7bd5;
            color: #fff;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }
        
        .upload-btn:hover {
            background-color: #2c61b5;
        }
        
        .upload-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .upload-instructions {
            margin-top: 1.5rem;
            color: #666;
        }
        
        .file-list {
            margin-top: 1.5rem;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        
        .file-icon {
            font-size: 1.5rem;
            margin-right: 1rem;
        }
        
        .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .file-size {
            color: #999;
            margin-right: 1rem;
        }
        
        .file-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .file-action-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
            transition: color 0.3s;
        }
        
        .file-action-btn:hover {
            color: #3a7bd5;
        }
        
        .file-action-btn.delete:hover {
            color: #dc3545;
        }
        
        .progress-container {
            height: 8px;
            background-color: #f5f5f5;
            border-radius: 4px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #3a7bd5;
            width: 0;
            transition: width 0.3s;
        }
        
        .alert {
            padding: 0.75rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .upload-tab {
                padding: 0.5rem 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- 加载中提示 -->
    <div id="loading" class="loading-container">
        <div class="loading-spinner"></div>
        <div class="loading-text">加载中...</div>
    </div>
    
    <!-- 头部导航 -->
    <header class="header">
        <div class="container header-container">
            <div class="logo">
                <h1>智慧校园</h1>
            </div>
            <ul class="nav-links">
                <li><a href="/campus/index.html">首页</a></li>
                <li><a href="/campus/forum/">校园论坛</a></li>
                <li><a href="/campus/file-upload.html" class="active">文件上传</a></li>
                <li id="userSpaceNavItem" style="display: none;"><a href="#" id="userSpaceLink">个人空间</a></li>
                <li id="logoutNavItem" style="display: none;"><a href="#" id="logoutBtn">退出登录</a></li>
            </ul>
        </div>
    </header>

    <!-- 主内容区域 -->
    <div class="upload-container">
        <h1 class="page-title">文件上传管理</h1>
        
        <div id="uploadAlert" class="alert" style="display: none;"></div>
        
        <div class="upload-tabs">
            <div class="upload-tab active" data-target="image-upload">图片上传</div>
            <div class="upload-tab" data-target="document-upload">文档上传</div>
            <div class="upload-tab" data-target="avatar-upload">用户头像</div>
            <div class="upload-tab" data-target="poster-upload">活动海报</div>
            <div class="upload-tab" data-target="course-upload">课程材料</div>
        </div>
        
        <!-- 图片上传 -->
        <div class="upload-content active" id="image-upload">
            <div class="card">
                <h2>上传图片</h2>
                <p>支持JPG、JPEG、PNG、GIF、BMP、WEBP格式，单个文件不超过10MB</p>
                
                <div class="upload-area" id="imageUploadArea">
                    <div class="upload-icon">
                        <i class="bi bi-image"></i>
                    </div>
                    <div class="upload-text">点击选择或拖拽图片到此处</div>
                    <input type="file" class="upload-input" id="imageUploadInput" accept="image/*">
                </div>
                
                <button class="upload-btn" id="imageUploadBtn" disabled>开始上传</button>
                
                <div class="upload-instructions">
                    <h3>图片上传说明</h3>
                    <ul>
                        <li>支持JPG、JPEG、PNG、GIF、BMP、WEBP等常见图片格式</li>
                        <li>单个文件大小不超过10MB</li>
                        <li>上传的图片将用于系统各处需要图片的地方</li>
                    </ul>
                </div>
            </div>
            
            <div class="file-list" id="imageFileList"></div>
        </div>
        
        <!-- 文档上传 -->
        <div class="upload-content" id="document-upload">
            <div class="card">
                <h2>上传文档</h2>
                <p>支持DOC、DOCX、PDF、XLS、XLSX、PPT、PPTX、TXT格式，单个文件不超过50MB</p>
                
                <div class="upload-area" id="documentUploadArea">
                    <div class="upload-icon">
                        <i class="bi bi-file-earmark-text"></i>
                    </div>
                    <div class="upload-text">点击选择或拖拽文档到此处</div>
                    <input type="file" class="upload-input" id="documentUploadInput" accept=".doc,.docx,.pdf,.xls,.xlsx,.ppt,.pptx,.txt">
                </div>
                
                <button class="upload-btn" id="documentUploadBtn" disabled>开始上传</button>
                
                <div class="upload-instructions">
                    <h3>文档上传说明</h3>
                    <ul>
                        <li>支持Word文档、Excel表格、PowerPoint演示文稿、PDF文档和纯文本文件</li>
                        <li>单个文件大小不超过50MB</li>
                        <li>上传的文档可用于共享资料、课程材料等</li>
                    </ul>
                </div>
            </div>
            
            <div class="file-list" id="documentFileList"></div>
        </div>
        
        <!-- 用户头像上传 -->
        <div class="upload-content" id="avatar-upload">
            <div class="card">
                <h2>上传用户头像</h2>
                <p>支持JPG、JPEG、PNG格式，推荐尺寸200×200像素，单个文件不超过2MB</p>
                
                <div class="upload-area" id="avatarUploadArea">
                    <div class="upload-icon">
                        <i class="bi bi-person-square"></i>
                    </div>
                    <div class="upload-text">点击选择或拖拽头像到此处</div>
                    <input type="file" class="upload-input" id="avatarUploadInput" accept="image/jpeg,image/png">
                </div>
                
                <div class="form-group">
                    <label for="userId">用户ID：</label>
                    <input type="number" id="userId" class="form-control" placeholder="请输入用户ID" min="1">
                </div>
                
                <button class="upload-btn" id="avatarUploadBtn" disabled>开始上传</button>
                
                <div class="upload-instructions">
                    <h3>头像上传说明</h3>
                    <ul>
                        <li>支持JPG、JPEG、PNG格式</li>
                        <li>推荐尺寸200×200像素，宽高比为1:1</li>
                        <li>单个文件大小不超过2MB</li>
                        <li>上传时需指定用户ID，头像将与该用户关联</li>
                    </ul>
                </div>
            </div>
            
            <div class="file-list" id="avatarFileList"></div>
        </div>
        
        <!-- 活动海报上传 -->
        <div class="upload-content" id="poster-upload">
            <div class="card">
                <h2>上传活动海报</h2>
                <p>支持JPG、JPEG、PNG格式，推荐尺寸800×500像素，单个文件不超过5MB</p>
                
                <div class="upload-area" id="posterUploadArea">
                    <div class="upload-icon">
                        <i class="bi bi-card-image"></i>
                    </div>
                    <div class="upload-text">点击选择或拖拽海报到此处</div>
                    <input type="file" class="upload-input" id="posterUploadInput" accept="image/jpeg,image/png">
                </div>
                
                <button class="upload-btn" id="posterUploadBtn" disabled>开始上传</button>
                
                <div class="upload-instructions">
                    <h3>海报上传说明</h3>
                    <ul>
                        <li>支持JPG、JPEG、PNG格式</li>
                        <li>推荐尺寸800×500像素，宽高比为16:10</li>
                        <li>单个文件大小不超过5MB</li>
                        <li>上传的海报将用于校园活动宣传</li>
                    </ul>
                </div>
            </div>
            
            <div class="file-list" id="posterFileList"></div>
        </div>
        
        <!-- 课程材料上传 -->
        <div class="upload-content" id="course-upload">
            <div class="card">
                <h2>上传课程材料</h2>
                <p>支持多种文件格式，单个文件不超过100MB</p>
                
                <div class="upload-area" id="courseUploadArea">
                    <div class="upload-icon">
                        <i class="bi bi-book"></i>
                    </div>
                    <div class="upload-text">点击选择或拖拽课程材料到此处</div>
                    <input type="file" class="upload-input" id="courseUploadInput">
                </div>
                
                <div class="form-group">
                    <label for="courseId">课程ID：</label>
                    <input type="number" id="courseId" class="form-control" placeholder="请输入课程ID" min="1">
                </div>
                
                <button class="upload-btn" id="courseUploadBtn" disabled>开始上传</button>
                
                <div class="upload-instructions">
                    <h3>课程材料上传说明</h3>
                    <ul>
                        <li>支持各种常见文件格式，包括文档、图片、压缩包等</li>
                        <li>单个文件大小不超过100MB</li>
                        <li>上传时需指定课程ID，材料将与该课程关联</li>
                        <li>上传的课程材料可用于教学资源分享</li>
                    </ul>
                </div>
            </div>
            
            <div class="file-list" id="courseFileList"></div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="footer">
        <div class="container">
            <p>© 2024 智慧校园服务系统 版权所有</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化API
            API.init();
            
            // 初始化UI
            UI.init();
            
            // 检查登录状态
            UI.auth.checkLoginStatus(function(isLoggedIn) {
                if (isLoggedIn) {
                    document.getElementById('userSpaceNavItem').style.display = 'block';
                    document.getElementById('logoutNavItem').style.display = 'block';
                    document.getElementById('userSpaceLink').href = API.getUserSpaceUrl();
                } else {
                    // 未登录则跳转到登录页
                    window.location.href = '/campus/index.html';
                }
            });
            
            // 顶部导航的退出登录按钮
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                API.logout();
                UI.showMessage('已安全退出登录', 'info');
                window.location.href = '/campus/index.html';
            });
            
            // 初始化上传标签
            initUploadTabs();
            
            // 初始化各个上传区域
            initUploadArea('image', '/api/file/upload/image', acceptImage);
            initUploadArea('document', '/api/file/upload/document', acceptDocument);
            initUploadArea('avatar', '/api/file/upload/avatar/{userId}', acceptImage, validateUserId);
            initUploadArea('poster', '/api/file/upload/activity/poster', acceptImage);
            initUploadArea('course', '/api/file/upload/course/material/{courseId}', acceptAll, validateCourseId);
            
            // 加载已上传文件列表
            // loadFileList();
            
            // 移除加载遮罩
            document.getElementById('loading').style.display = 'none';
        });
        
        // 初始化上传标签切换
        function initUploadTabs() {
            const tabs = document.querySelectorAll('.upload-tab');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有标签和内容的active类
                    document.querySelectorAll('.upload-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.upload-content').forEach(c => c.classList.remove('active'));
                    
                    // 给当前标签和对应内容添加active类
                    this.classList.add('active');
                    const target = this.getAttribute('data-target');
                    document.getElementById(target).classList.add('active');
                });
            });
        }
        
        // 初始化上传区域
        function initUploadArea(type, apiUrl, acceptCallback, validateCallback) {
            const uploadArea = document.getElementById(type + 'UploadArea');
            const uploadInput = document.getElementById(type + 'UploadInput');
            const uploadBtn = document.getElementById(type + 'UploadBtn');
            const fileList = document.getElementById(type + 'FileList');
            
            // 点击上传区域选择文件
            uploadArea.addEventListener('click', function() {
                uploadInput.click();
            });
            
            // 拖拽文件到上传区域
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = '#3a7bd5';
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = '#ccc';
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = '#ccc';
                
                if (e.dataTransfer.files.length > 0) {
                    uploadInput.files = e.dataTransfer.files;
                    handleFileSelected();
                }
            });
            
            // 文件选择完成
            uploadInput.addEventListener('change', handleFileSelected);
            
            function handleFileSelected() {
                if (uploadInput.files.length > 0) {
                    const file = uploadInput.files[0];
                    
                    // 检查文件类型
                    if (!acceptCallback(file)) {
                        showAlert('文件类型不支持', 'danger');
                        uploadInput.value = '';
                        uploadBtn.disabled = true;
                        return;
                    }
                    
                    // 检查文件大小
                    if (!checkFileSize(file, type)) {
                        uploadInput.value = '';
                        uploadBtn.disabled = true;
                        return;
                    }
                    
                    // 更新上传按钮状态
                    uploadBtn.disabled = false;
                    
                    // 显示选择的文件名
                    uploadArea.querySelector('.upload-text').textContent = file.name;
                } else {
                    uploadBtn.disabled = true;
                    uploadArea.querySelector('.upload-text').textContent = '点击选择或拖拽文件到此处';
                }
            }
            
            // 上传按钮点击事件
            uploadBtn.addEventListener('click', function() {
                if (uploadInput.files.length === 0) {
                    showAlert('请先选择文件', 'danger');
                    return;
                }
                
                // 额外的验证
                if (validateCallback && !validateCallback()) {
                    return;
                }
                
                const file = uploadInput.files[0];
                const formData = new FormData();
                formData.append('file', file);
                
                // 处理API URL参数
                let url = apiUrl;
                if (type === 'avatar') {
                    const userId = document.getElementById('userId').value;
                    url = url.replace('{userId}', userId);
                } else if (type === 'course') {
                    const courseId = document.getElementById('courseId').value;
                    url = url.replace('{courseId}', courseId);
                }
                
                // 显示上传进度
                const progressItem = createProgressItem(file.name);
                fileList.insertBefore(progressItem, fileList.firstChild);
                
                // 上传文件
                uploadFile(formData, url, progressItem);
            });
        }
        
        // 文件大小检查
        function checkFileSize(file, type) {
            let maxSize = 10 * 1024 * 1024; // 默认10MB
            
            switch (type) {
                case 'image':
                    maxSize = 10 * 1024 * 1024; // 10MB
                    break;
                case 'document':
                    maxSize = 50 * 1024 * 1024; // 50MB
                    break;
                case 'avatar':
                    maxSize = 2 * 1024 * 1024; // 2MB
                    break;
                case 'poster':
                    maxSize = 5 * 1024 * 1024; // 5MB
                    break;
                case 'course':
                    maxSize = 100 * 1024 * 1024; // 100MB
                    break;
            }
            
            if (file.size > maxSize) {
                const sizeMB = Math.round(maxSize / 1024 / 1024);
                showAlert(`文件过大，不能超过${sizeMB}MB`, 'danger');
                return false;
            }
            
            return true;
        }
        
        // 文件类型检查回调
        function acceptImage(file) {
            return file.type.startsWith('image/');
        }
        
        function acceptDocument(file) {
            const docTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                             'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                             'application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                             'text/plain'];
            return docTypes.includes(file.type);
        }
        
        function acceptAll() {
            return true;
        }
        
        // 验证回调
        function validateUserId() {
            const userId = document.getElementById('userId').value;
            if (!userId || userId < 1) {
                showAlert('请输入有效的用户ID', 'danger');
                return false;
            }
            return true;
        }
        
        function validateCourseId() {
            const courseId = document.getElementById('courseId').value;
            if (!courseId || courseId < 1) {
                showAlert('请输入有效的课程ID', 'danger');
                return false;
            }
            return true;
        }
        
        // 创建上传进度项
        function createProgressItem(fileName) {
            const item = document.createElement('div');
            item.className = 'file-item';
            item.innerHTML = `
                <div class="file-icon"><i class="bi bi-file-earmark"></i></div>
                <div class="file-name">${fileName}</div>
                <div class="file-size">上传中...</div>
                <div class="progress-container">
                    <div class="progress-bar" style="width: 0%"></div>
                </div>
            `;
            return item;
        }
        
        // 显示警告消息
        function showAlert(message, type) {
            const alert = document.getElementById('uploadAlert');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
        
        // 上传文件
        function uploadFile(formData, url, progressItem) {
            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    progressItem.querySelector('.progress-bar').style.width = percentComplete + '%';
                    progressItem.querySelector('.file-size').textContent = `${percentComplete}%`;
                }
            });
            
            xhr.addEventListener('load', function() {
                if (xhr.status >= 200 && xhr.status < 300) {
                    const response = JSON.parse(xhr.responseText);
                    
                    if (response.success) {
                        // 上传成功
                        progressItem.querySelector('.file-size').textContent = '上传成功';
                        progressItem.querySelector('.progress-container').remove();
                        
                        // 添加操作按钮
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'file-actions';
                        
                        // 下载按钮
                        const downloadBtn = document.createElement('button');
                        downloadBtn.className = 'file-action-btn';
                        downloadBtn.innerHTML = '<i class="bi bi-download"></i>';
                        downloadBtn.title = '下载';
                        downloadBtn.addEventListener('click', function() {
                            window.open(`/api/file/download?filePath=${response.data}`, '_blank');
                        });
                        
                        // 删除按钮
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'file-action-btn delete';
                        deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
                        deleteBtn.title = '删除';
                        deleteBtn.addEventListener('click', function() {
                            if (confirm('确定要删除这个文件吗？')) {
                                deleteFile(response.data, progressItem);
                            }
                        });
                        
                        actionsDiv.appendChild(downloadBtn);
                        actionsDiv.appendChild(deleteBtn);
                        
                        progressItem.appendChild(actionsDiv);
                        
                        showAlert('文件上传成功', 'success');
                        
                        // 重置上传区域
                        resetUploadArea();
                    } else {
                        // 上传失败
                        progressItem.querySelector('.file-size').textContent = '上传失败';
                        progressItem.querySelector('.progress-bar').style.backgroundColor = '#dc3545';
                        
                        showAlert(response.message || '文件上传失败', 'danger');
                    }
                } else {
                    // 请求错误
                    progressItem.querySelector('.file-size').textContent = '上传失败';
                    progressItem.querySelector('.progress-bar').style.backgroundColor = '#dc3545';
                    
                    showAlert('文件上传失败，服务器错误', 'danger');
                }
            });
            
            xhr.addEventListener('error', function() {
                progressItem.querySelector('.file-size').textContent = '上传失败';
                progressItem.querySelector('.progress-bar').style.backgroundColor = '#dc3545';
                
                showAlert('网络错误，上传失败', 'danger');
            });
            
            xhr.open('POST', url);
            xhr.send(formData);
        }
        
        // 删除文件
        function deleteFile(filePath, fileItem) {
            fetch(`/api/file/delete?filePath=${filePath}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    fileItem.remove();
                    showAlert('文件删除成功', 'success');
                } else {
                    showAlert(data.message || '文件删除失败', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('网络错误，删除失败', 'danger');
            });
        }
        
        // 重置上传区域
        function resetUploadArea() {
            const activeTabId = document.querySelector('.upload-tab.active').getAttribute('data-target');
            const activeTab = document.getElementById(activeTabId);
            
            const uploadInput = activeTab.querySelector('.upload-input');
            const uploadArea = activeTab.querySelector('.upload-area');
            const uploadBtn = activeTab.querySelector('.upload-btn');
            
            uploadInput.value = '';
            uploadArea.querySelector('.upload-text').textContent = '点击选择或拖拽文件到此处';
            uploadBtn.disabled = true;
        }
    </script>
</body>
</html> 