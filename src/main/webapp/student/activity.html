<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校园活动 - 智慧校园服务系统</title>
    <link rel="stylesheet" href="../static/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/css/bootstrap-icons.css">
    <link rel="stylesheet" href="../static/css/style.css">
    <style>
        .activity-card {
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            height: 100%;
        }
        .activity-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .activity-card .card-img-top {
            height: 180px;
            object-fit: cover;
        }
        .activity-badge {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .activity-category {
            position: absolute;
            top: 10px;
            left: 10px;
        }
        .search-box {
            position: relative;
        }
        .search-box .form-control {
            padding-right: 40px;
            border-radius: 20px;
        }
        .search-box .search-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6c757d;
        }
        .filter-btn.active {
            background-color: #007bff;
            color: white;
        }
        .activity-date {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .progress-sm {
            height: 5px;
        }
        .tab-content {
            padding-top: 20px;
        }
    </style>
</head>
<body>
    <!-- 加载遮罩 -->
    <div id="loading-mask" class="loading-mask">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
    </div>

    <!-- 页面头部 -->
    <header class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <img src="../static/img/logo.png" alt="智慧校园" height="30">
                <span class="ms-2">智慧校园服务系统</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">主页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="courses.html">课程</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="activity.html">活动</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../forum.html">论坛</a>
                    </li>
                </ul>
                <div class="ms-auto d-flex align-items-center">
                    <div class="dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" id="userDropdown" data-bs-toggle="dropdown">
                            <img src="../static/img/avatar-placeholder.jpg" class="rounded-circle" width="32" height="32" alt="用户头像">
                            <span class="ms-2" id="username">加载中...</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person me-2"></i>个人信息</a></li>
                            <li><a class="dropdown-item" href="settings.html"><i class="bi bi-gear me-2"></i>设置</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logout-btn"><i class="bi bi-box-arrow-right me-2"></i>退出登录</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container py-4">
        <h2 class="mb-4"><i class="bi bi-calendar-event me-2"></i>校园活动</h2>
        
        <!-- 导航标签页 -->
        <ul class="nav nav-tabs" id="activityTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab">全部活动</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ongoing-tab" data-bs-toggle="tab" data-bs-target="#ongoing" type="button" role="tab">进行中</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="upcoming-tab" data-bs-toggle="tab" data-bs-target="#upcoming" type="button" role="tab">即将开始</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="my-tab" data-bs-toggle="tab" data-bs-target="#my" type="button" role="tab">我的活动</button>
            </li>
        </ul>
        
        <!-- 搜索和筛选区 -->
        <div class="row mt-4 mb-3 align-items-center">
            <div class="col-md-4">
                <div class="search-box">
                    <input type="text" class="form-control" id="activity-search" placeholder="搜索活动...">
                    <button class="search-btn" id="search-btn"><i class="bi bi-search"></i></button>
                </div>
            </div>
            <div class="col-md-8">
                <div class="d-flex flex-wrap justify-content-md-end gap-2 mt-3 mt-md-0">
                    <button class="btn btn-sm btn-outline-primary filter-btn active" data-filter="all">全部</button>
                    <button class="btn btn-sm btn-outline-primary filter-btn" data-filter="academic">学术讲座</button>
                    <button class="btn btn-sm btn-outline-primary filter-btn" data-filter="cultural">文化活动</button>
                    <button class="btn btn-sm btn-outline-primary filter-btn" data-filter="sports">体育赛事</button>
                    <button class="btn btn-sm btn-outline-primary filter-btn" data-filter="volunteer">志愿服务</button>
                    <button class="btn btn-sm btn-outline-primary filter-btn" data-filter="career">就业招聘</button>
                </div>
            </div>
        </div>
        
        <!-- 标签页内容 -->
        <div class="tab-content" id="activityTabsContent">
            <!-- 全部活动选项卡 -->
            <div class="tab-pane fade show active" id="all" role="tabpanel">
                <div id="all-activities-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                    <!-- 活动卡片将动态插入 -->
                    <div class="col placeholder-glow">
                        <div class="card activity-card">
                            <div class="bg-light placeholder" style="height: 180px;"></div>
                            <div class="card-body">
                                <h5 class="card-title placeholder"></h5>
                                <p class="card-text placeholder"></p>
                                <div class="placeholder"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col placeholder-glow">
                        <div class="card activity-card">
                            <div class="bg-light placeholder" style="height: 180px;"></div>
                            <div class="card-body">
                                <h5 class="card-title placeholder"></h5>
                                <p class="card-text placeholder"></p>
                                <div class="placeholder"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col placeholder-glow">
                        <div class="card activity-card">
                            <div class="bg-light placeholder" style="height: 180px;"></div>
                            <div class="card-body">
                                <h5 class="card-title placeholder"></h5>
                                <p class="card-text placeholder"></p>
                                <div class="placeholder"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="all-empty-message" class="alert alert-info text-center my-4 d-none">
                    <i class="bi bi-info-circle me-2"></i>暂无活动
                </div>
                <div class="d-flex justify-content-center mt-4">
                    <nav aria-label="活动分页">
                        <ul class="pagination" id="all-pagination">
                            <!-- 分页将动态生成 -->
                        </ul>
                    </nav>
                </div>
            </div>
            
            <!-- 进行中选项卡 -->
            <div class="tab-pane fade" id="ongoing" role="tabpanel">
                <div id="ongoing-activities-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                    <!-- 活动卡片将动态插入 -->
                </div>
                <div id="ongoing-empty-message" class="alert alert-info text-center my-4 d-none">
                    <i class="bi bi-info-circle me-2"></i>暂无进行中的活动
                </div>
                <div class="d-flex justify-content-center mt-4">
                    <nav aria-label="活动分页">
                        <ul class="pagination" id="ongoing-pagination">
                            <!-- 分页将动态生成 -->
                        </ul>
                    </nav>
                </div>
            </div>
            
            <!-- 即将开始选项卡 -->
            <div class="tab-pane fade" id="upcoming" role="tabpanel">
                <div id="upcoming-activities-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                    <!-- 活动卡片将动态插入 -->
                </div>
                <div id="upcoming-empty-message" class="alert alert-info text-center my-4 d-none">
                    <i class="bi bi-info-circle me-2"></i>暂无即将开始的活动
                </div>
                <div class="d-flex justify-content-center mt-4">
                    <nav aria-label="活动分页">
                        <ul class="pagination" id="upcoming-pagination">
                            <!-- 分页将动态生成 -->
                        </ul>
                    </nav>
                </div>
            </div>
            
            <!-- 我的活动选项卡 -->
            <div class="tab-pane fade" id="my" role="tabpanel">
                <div id="my-activities-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                    <!-- 活动卡片将动态插入 -->
                </div>
                <div id="my-empty-message" class="alert alert-info text-center my-4 d-none">
                    <i class="bi bi-info-circle me-2"></i>您还没有参加任何活动
                </div>
                <div class="d-flex justify-content-center mt-4">
                    <nav aria-label="活动分页">
                        <ul class="pagination" id="my-pagination">
                            <!-- 分页将动态生成 -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </main>

    <!-- 活动详情模态框 -->
    <div class="modal fade" id="activityDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="activity-title">活动详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4" id="activity-poster-container">
                        <img src="../static/img/activity-placeholder.jpg" id="activity-poster" class="img-fluid rounded" alt="活动海报">
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><i class="bi bi-geo-alt me-2"></i><strong>地点：</strong><span id="activity-location"></span></p>
                            <p><i class="bi bi-calendar-date me-2"></i><strong>时间：</strong><span id="activity-time"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><i class="bi bi-person me-2"></i><strong>组织者：</strong><span id="activity-organizer"></span></p>
                            <p><i class="bi bi-telephone me-2"></i><strong>联系方式：</strong><span id="activity-contact"></span></p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6><i class="bi bi-people me-2"></i>参与人数</h6>
                            <span id="activity-participants"></span>
                        </div>
                        <div class="progress progress-sm">
                            <div id="activity-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6><i class="bi bi-file-text me-2"></i>活动详情</h6>
                        <div id="activity-content" class="border rounded p-3 bg-light">
                            <!-- 活动内容将动态插入 -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="w-100 d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary" id="signup-btn">报名参加</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="footer mt-auto py-3 bg-light">
        <div class="container text-center">
            <span class="text-muted">&copy; 2023 智慧校园服务系统. 保留所有权利.</span>
        </div>
    </footer>

    <!-- 脚本 -->
    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/bootstrap.bundle.min.js"></script>
    <script src="../static/js/api.js"></script>
    <script>
        // 定义全局变量
        let currentPage = 1;
        let pageSize = 9;
        let totalPages = 1;
        let currentTab = 'all';
        let currentFilter = 'all';
        let currentActivityId = null;
        
        // 页面加载完成后执行
        $(document).ready(function() {
            // 隐藏加载遮罩
            $('#loading-mask').fadeOut();
            
            // 获取当前用户信息
            API.user.checkToken(function(response) {
                if (response.success) {
                    $('#username').text(response.data.username);
                } else {
                    window.location.href = '../login.html';
                }
            });
            
            // 加载全部活动
            loadActivities('all', currentPage, pageSize);
            
            // 标签页切换事件
            $('#activityTabs button').on('click', function(e) {
                const tab = $(this).attr('id').replace('-tab', '');
                currentTab = tab;
                currentPage = 1;
                loadActivities(tab, currentPage, pageSize);
            });
            
            // 筛选按钮点击事件
            $('.filter-btn').on('click', function() {
                $('.filter-btn').removeClass('active');
                $(this).addClass('active');
                currentFilter = $(this).data('filter');
                currentPage = 1;
                loadActivities(currentTab, currentPage, pageSize, currentFilter);
            });
            
            // 搜索按钮点击事件
            $('#search-btn').on('click', function() {
                const keyword = $('#activity-search').val().trim();
                if (keyword) {
                    searchActivities(keyword, currentPage, pageSize);
                } else {
                    loadActivities(currentTab, currentPage, pageSize, currentFilter);
                }
            });
            
            // 回车搜索
            $('#activity-search').on('keyup', function(e) {
                if (e.key === 'Enter') {
                    $('#search-btn').click();
                }
            });
            
            // 退出登录
            $('#logout-btn').on('click', function(e) {
                e.preventDefault();
                API.user.logout(function() {
                    window.location.href = '../login.html';
                });
            });
            
            // 报名按钮点击事件
            $('#signup-btn').on('click', function() {
                if (!currentActivityId) return;
                
                const $btn = $(this);
                const originalText = $btn.text();
                
                if ($btn.hasClass('btn-danger')) {
                    // 取消报名
                    $btn.prop('disabled', true).text('处理中...');
                    API.activity.cancelActivitySignUp(currentActivityId, function(response) {
                        $btn.prop('disabled', false);
                        if (response.success) {
                            $btn.removeClass('btn-danger').addClass('btn-primary').text('报名参加');
                            showToast('成功取消报名');
                            // 刷新我的活动列表
                            if (currentTab === 'my') {
                                loadActivities('my', currentPage, pageSize);
                            }
                        } else {
                            $btn.text(originalText);
                            showToast('取消报名失败: ' + response.message, 'danger');
                        }
                    });
                } else {
                    // 报名参加
                    $btn.prop('disabled', true).text('处理中...');
                    API.activity.signUpActivity(currentActivityId, function(response) {
                        $btn.prop('disabled', false);
                        if (response.success) {
                            $btn.removeClass('btn-primary').addClass('btn-danger').text('取消报名');
                            showToast('报名成功');
                        } else {
                            $btn.text(originalText);
                            showToast('报名失败: ' + response.message, 'danger');
                        }
                    });
                }
            });
        });
        
        // 加载活动列表
        function loadActivities(tab, page, size, filter) {
            const params = {
                page: page,
                size: size,
                type: filter !== 'all' ? filter : null
            };
            
            // 清空容器并显示加载中状态
            $(`#${tab}-activities-container`).html('<div class="col-12 text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">加载中...</span></div></div>');
            
            let apiMethod;
            switch(tab) {
                case 'ongoing':
                    apiMethod = API.activity.getOngoingActivities;
                    break;
                case 'upcoming':
                    apiMethod = API.activity.getUpcomingActivities;
                    break;
                case 'my':
                    apiMethod = API.activity.getMyActivities;
                    break;
                default:
                    apiMethod = API.activity.getAllActivities;
            }
            
            apiMethod(params, function(response) {
                if (response.success) {
                    const { content, totalElements, totalPages: pages } = response.data;
                    totalPages = pages;
                    
                    $(`#${tab}-activities-container`).empty();
                    
                    if (content && content.length > 0) {
                        content.forEach(activity => {
                            $(`#${tab}-activities-container`).append(createActivityCard(activity));
                        });
                        $(`#${tab}-empty-message`).addClass('d-none');
                    } else {
                        $(`#${tab}-empty-message`).removeClass('d-none');
                    }
                    
                    // 更新分页
                    updatePagination(tab, page, pages);
                } else {
                    $(`#${tab}-activities-container`).html(`<div class="col-12"><div class="alert alert-danger">加载活动失败: ${response.message}</div></div>`);
                    $(`#${tab}-empty-message`).addClass('d-none');
                }
            });
        }
        
        // 搜索活动
        function searchActivities(keyword, page, size) {
            const params = {
                page: page,
                size: size
            };
            
            $(`#${currentTab}-activities-container`).html('<div class="col-12 text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">搜索中...</span></div></div>');
            
            API.activity.searchActivities(keyword, params, function(response) {
                if (response.success) {
                    const { content, totalElements, totalPages: pages } = response.data;
                    totalPages = pages;
                    
                    $(`#${currentTab}-activities-container`).empty();
                    
                    if (content && content.length > 0) {
                        content.forEach(activity => {
                            $(`#${currentTab}-activities-container`).append(createActivityCard(activity));
                        });
                        $(`#${currentTab}-empty-message`).addClass('d-none');
                    } else {
                        $(`#${currentTab}-activities-container`).html('<div class="col-12"><div class="alert alert-info">未找到匹配的活动</div></div>');
                        $(`#${currentTab}-empty-message`).addClass('d-none');
                    }
                    
                    // 更新分页
                    updatePagination(currentTab, page, pages);
                } else {
                    $(`#${currentTab}-activities-container`).html(`<div class="col-12"><div class="alert alert-danger">搜索失败: ${response.message}</div></div>`);
                    $(`#${currentTab}-empty-message`).addClass('d-none');
                }
            });
        }
        
        // 创建活动卡片
        function createActivityCard(activity) {
            // 确定活动状态和样式
            let statusBadge = '';
            if (new Date(activity.startTime) > new Date()) {
                statusBadge = '<span class="badge bg-info activity-badge">即将开始</span>';
            } else if (new Date(activity.endTime) < new Date()) {
                statusBadge = '<span class="badge bg-secondary activity-badge">已结束</span>';
            } else {
                statusBadge = '<span class="badge bg-success activity-badge">进行中</span>';
            }
            
            // 活动类型标签
            let categoryBadge = '';
            switch(activity.activityType) {
                case 'academic':
                    categoryBadge = '<span class="badge bg-primary activity-category">学术讲座</span>';
                    break;
                case 'cultural':
                    categoryBadge = '<span class="badge bg-success activity-category">文化活动</span>';
                    break;
                case 'sports':
                    categoryBadge = '<span class="badge bg-danger activity-category">体育赛事</span>';
                    break;
                case 'volunteer':
                    categoryBadge = '<span class="badge bg-warning activity-category">志愿服务</span>';
                    break;
                case 'career':
                    categoryBadge = '<span class="badge bg-info activity-category">就业招聘</span>';
                    break;
                default:
                    categoryBadge = '<span class="badge bg-secondary activity-category">其他</span>';
            }
            
            // 格式化日期
            const startDate = new Date(activity.startTime);
            const formattedDate = `${startDate.getFullYear()}-${(startDate.getMonth()+1).toString().padStart(2, '0')}-${startDate.getDate().toString().padStart(2, '0')} ${startDate.getHours().toString().padStart(2, '0')}:${startDate.getMinutes().toString().padStart(2, '0')}`;
            
            // 参与人数进度条
            const progress = Math.round((activity.currentParticipants / activity.maxParticipants) * 100);
            let progressClass = 'bg-success';
            if (progress > 80) {
                progressClass = 'bg-danger';
            } else if (progress > 60) {
                progressClass = 'bg-warning';
            }
            
            // 创建卡片HTML
            return `
                <div class="col">
                    <div class="card activity-card">
                        <div class="position-relative">
                            <img src="${activity.posterUrl || '../static/img/activity-placeholder.jpg'}" class="card-img-top" alt="${activity.title}">
                            ${statusBadge}
                            ${categoryBadge}
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">${activity.title}</h5>
                            <p class="activity-date mb-2"><i class="bi bi-calendar3 me-1"></i>${formattedDate}</p>
                            <p class="card-text text-truncate">${activity.content}</p>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small>${activity.currentParticipants}/${activity.maxParticipants} 人已报名</small>
                                <span class="text-muted">${progress}%</span>
                            </div>
                            <div class="progress progress-sm mb-3">
                                <div class="progress-bar ${progressClass}" role="progressbar" style="width: ${progress}%"></div>
                            </div>
                            <button class="btn btn-sm btn-outline-primary w-100" onclick="showActivityDetail(${activity.id})">
                                查看详情
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 更新分页
        function updatePagination(tab, currentPage, totalPages) {
            const $pagination = $(`#${tab}-pagination`);
            $pagination.empty();
            
            // 如果只有一页，不显示分页
            if (totalPages <= 1) {
                return;
            }
            
            // 上一页按钮
            $pagination.append(`
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="javascript:void(0)" onclick="changePage('${tab}', ${currentPage - 1})">上一页</a>
                </li>
            `);
            
            // 页码
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                $pagination.append(`
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="javascript:void(0)" onclick="changePage('${tab}', ${i})">${i}</a>
                    </li>
                `);
            }
            
            // 下一页按钮
            $pagination.append(`
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="javascript:void(0)" onclick="changePage('${tab}', ${currentPage + 1})">下一页</a>
                </li>
            `);
        }
        
        // 切换页码
        function changePage(tab, page) {
            if (page < 1 || page > totalPages) {
                return;
            }
            currentPage = page;
            
            const keyword = $('#activity-search').val().trim();
            if (keyword) {
                searchActivities(keyword, page, pageSize);
            } else {
                loadActivities(tab, page, pageSize, currentFilter);
            }
        }
        
        // 显示活动详情
        function showActivityDetail(activityId) {
            currentActivityId = activityId;
            
            // 重置按钮状态
            $('#signup-btn').removeClass('btn-danger').addClass('btn-primary').text('报名参加').prop('disabled', true);
            
            // 打开模态框并加载数据
            const modal = new bootstrap.Modal(document.getElementById('activityDetailModal'));
            modal.show();
            
            // 显示加载状态
            $('#activity-title').html('<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">加载中...</span></div> 加载中...');
            $('#activity-content').html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">加载中...</span></div></div>');
            
            // 获取活动详情
            API.activity.getActivityById(activityId, function(response) {
                if (response.success) {
                    const activity = response.data;
                    
                    // 填充活动详情
                    $('#activity-title').text(activity.title);
                    $('#activity-location').text(activity.location);
                    
                    // 格式化日期
                    const startDate = new Date(activity.startTime);
                    const endDate = new Date(activity.endTime);
                    const startFormatted = `${startDate.getFullYear()}-${(startDate.getMonth()+1).toString().padStart(2, '0')}-${startDate.getDate().toString().padStart(2, '0')} ${startDate.getHours().toString().padStart(2, '0')}:${startDate.getMinutes().toString().padStart(2, '0')}`;
                    const endFormatted = `${endDate.getFullYear()}-${(endDate.getMonth()+1).toString().padStart(2, '0')}-${endDate.getDate().toString().padStart(2, '0')} ${endDate.getHours().toString().padStart(2, '0')}:${endDate.getMinutes().toString().padStart(2, '0')}`;
                    
                    $('#activity-time').text(`${startFormatted} 至 ${endFormatted}`);
                    $('#activity-organizer').text(activity.organizerName);
                    $('#activity-contact').text(activity.contact);
                    $('#activity-participants').text(`${activity.currentParticipants}/${activity.maxParticipants}`);
                    
                    // 设置进度条
                    const progress = Math.round((activity.currentParticipants / activity.maxParticipants) * 100);
                    $('#activity-progress').css('width', progress + '%');
                    
                    if (progress > 80) {
                        $('#activity-progress').removeClass('bg-success bg-warning').addClass('bg-danger');
                    } else if (progress > 60) {
                        $('#activity-progress').removeClass('bg-success bg-danger').addClass('bg-warning');
                    } else {
                        $('#activity-progress').removeClass('bg-warning bg-danger').addClass('bg-success');
                    }
                    
                    // 设置海报
                    if (activity.posterUrl) {
                        $('#activity-poster').attr('src', activity.posterUrl);
                        $('#activity-poster-container').removeClass('d-none');
                    } else {
                        $('#activity-poster-container').addClass('d-none');
                    }
                    
                    // 设置活动内容
                    $('#activity-content').html(activity.content);
                    
                    // 检查用户是否已报名
                    API.activity.checkActivitySignUpStatus(activityId, function(statusResponse) {
                        $('#signup-btn').prop('disabled', false);
                        if (statusResponse.success && statusResponse.data) {
                            $('#signup-btn').removeClass('btn-primary').addClass('btn-danger').text('取消报名');
                        }
                    });
                    
                    // 检查活动状态
                    const now = new Date();
                    if (now > new Date(activity.endTime)) {
                        // 活动已结束
                        $('#signup-btn').prop('disabled', true).text('活动已结束');
                    } else if (now < new Date(activity.startTime) && activity.currentParticipants >= activity.maxParticipants) {
                        // 活动未开始但人数已满
                        $('#signup-btn').prop('disabled', true).text('名额已满');
                    }
                } else {
                    $('#activity-title').text('加载失败');
                    $('#activity-content').html(`<div class="alert alert-danger">获取活动详情失败: ${response.message}</div>`);
                }
            });
        }
        
        // 显示提示消息
        function showToast(message, type = 'success') {
            // 移除已有的toast
            $('.toast').remove();
            
            // 创建新的toast
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type} position-fixed bottom-0 end-0 m-3" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            $('body').append(toastHtml);
            
            // 显示toast
            const toastElement = document.querySelector('.toast');
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
        }
    </script>
</body>
</html> 