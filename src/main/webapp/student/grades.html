<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成绩查询 - 学生中心</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../static/css/style.css">
    <script src="../static/js/api.js"></script>
    <script src="../static/js/ui.js"></script>
    <style>
        .grades-page {
            padding: 1.5rem;
        }
        
        .page-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .page-title h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .filter-bar {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .filter-item {
            display: flex;
            align-items: center;
        }
        
        .filter-item label {
            margin-right: 0.5rem;
            font-weight: 500;
        }
        
        .filter-item select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
        }
        
        .grades-card {
            background-color: #fff;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 2rem;
        }
        
        .grades-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .grades-table th,
        .grades-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .grades-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .grades-table tr:last-child td {
            border-bottom: none;
        }
        
        .grades-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .grade-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 500;
            text-align: center;
            min-width: 3rem;
        }
        
        .grade-excellent {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .grade-good {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .grade-pass {
            background-color: #fff3e0;
            color: #e65100;
        }
        
        .grade-fail {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .term-tag {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background-color: #f0f0f0;
            color: #666;
            font-size: 0.85rem;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background-color: #fff;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
        }
        
        .stat-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .stat-trend {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
        }
        
        .stat-trend-up {
            color: #2e7d32;
        }
        
        .stat-trend-down {
            color: #c62828;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            color: #3498db;
            text-decoration: none;
            margin-bottom: 1rem;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .back-link i {
            margin-right: 0.5rem;
        }
        
        .grades-summary {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .summary-label {
            font-weight: 500;
            color: #666;
        }
        
        .summary-value {
            font-weight: 600;
        }
        
        .chart-container {
            height: 250px;
            margin-top: 1.5rem;
            position: relative;
        }
        
        /* 仅作为示意的图表样式 */
        .chart-placeholder {
            width: 100%;
            height: 100%;
            background-color: #f8f9fa;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .filter-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .grades-table th,
            .grades-table td {
                padding: 0.5rem;
                font-size: 0.9rem;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 加载遮罩 -->
    <div id="loadingMask" class="loading-mask">
        <div class="spinner"></div>
    </div>

    <!-- 页面头部 -->
    <header class="header">
        <div class="logo-container">
            <h1 class="logo">学生中心</h1>
        </div>
        <div class="user-menu">
            <span id="userName" class="user-name">同学</span>
            <i class="bi bi-person-circle"></i>
            <div class="dropdown-menu">
                <a href="profile.html" class="menu-item">
                    <i class="bi bi-person"></i>
                    <span>个人信息</span>
                </a>
                <a href="settings.html" class="menu-item">
                    <i class="bi bi-gear"></i>
                    <span>设置</span>
                </a>
                <a href="#" id="logoutBtn" class="menu-item">
                    <i class="bi bi-box-arrow-right"></i>
                    <span>退出登录</span>
                </a>
            </div>
        </div>
    </header>

    <!-- 主要内容 -->
    <main class="main-content">
        <div class="grades-page">
            <a href="index.html" class="back-link">
                <i class="bi bi-arrow-left"></i> 返回首页
            </a>
            
            <div class="page-title">
                <h2>我的成绩</h2>
            </div>
            
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-title">平均学分绩点 (GPA)</div>
                    <div class="stat-value" id="overallGPA">3.85</div>
                    <div class="stat-trend stat-trend-up">
                        <i class="bi bi-arrow-up"></i> 较上学期提高0.15
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">已修学分</div>
                    <div class="stat-value" id="totalCredits">86</div>
                    <div class="stat-trend">
                        <span>总学分要求: 150</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">本学期学分绩点</div>
                    <div class="stat-value" id="currentGPA">3.92</div>
                    <div class="stat-trend stat-trend-up">
                        <i class="bi bi-arrow-up"></i> 较上学期提高0.22
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">本学期修读课程</div>
                    <div class="stat-value" id="currentCourses">8门</div>
                    <div class="stat-trend">
                        <span>学分: 26</span>
                    </div>
                </div>
            </div>
            
            <div class="filter-bar">
                <div class="filter-item">
                    <label for="termSelect">学期:</label>
                    <select id="termSelect">
                        <option value="all">所有学期</option>
                        <option value="2023-2024-1" selected>2023-2024学年第一学期</option>
                        <option value="2022-2023-2">2022-2023学年第二学期</option>
                        <option value="2022-2023-1">2022-2023学年第一学期</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="courseTypeSelect">课程类型:</label>
                    <select id="courseTypeSelect">
                        <option value="all" selected>全部</option>
                        <option value="required">必修课</option>
                        <option value="elective">选修课</option>
                        <option value="public">公共课</option>
                        <option value="professional">专业课</option>
                    </select>
                </div>
            </div>
            
            <div class="grades-summary" id="termSummary">
                <div class="summary-row">
                    <span class="summary-label">所选学期:</span>
                    <span class="summary-value">2023-2024学年第一学期</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">课程总数:</span>
                    <span class="summary-value">8门</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">总学分:</span>
                    <span class="summary-value">26学分</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">平均成绩:</span>
                    <span class="summary-value">92.5分</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">学期GPA:</span>
                    <span class="summary-value">3.92</span>
                </div>
            </div>
            
            <div class="grades-card">
                <table class="grades-table" id="gradesTable">
                    <thead>
                        <tr>
                            <th>课程名称</th>
                            <th>学分</th>
                            <th>课程类型</th>
                            <th>学期</th>
                            <th>成绩</th>
                            <th>绩点</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 成绩数据将通过JavaScript加载 -->
                    </tbody>
                </table>
            </div>
            
            <div class="chart-container">
                <div class="chart-placeholder">成绩趋势图表将在这里显示</div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="footer">
        <div class="copyright">
            &copy; 智慧校园服务系统 - 版权所有
        </div>
    </footer>

    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 检查登录状态
            if (!API.isLoggedIn()) {
                // 未登录，重定向到登录页
                window.location.href = '../index.html';
                return;
            }
            
            // 检查用户角色
            const role = API.getUserRole();
            if (role !== 'STUDENT') {
                UI.showMessage('您不是学生用户，无法访问学生中心', 'error');
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 2000);
                return;
            }
            
            // 显示加载动画
            showLoading();
            
            // 加载用户信息
            loadUserInfo();
            
            // 初始化成绩查询
            initGrades();
            
            // 绑定事件
            bindEvents();
            
            // 隐藏加载动画（延迟1秒）
            hideLoading(1000);
        });
        
        /**
         * 绑定事件
         */
        function bindEvents() {
            // 退出登录按钮
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    logout();
                });
            }
            
            // 用户菜单
            const userMenu = document.querySelector('.user-menu');
            if (userMenu) {
                userMenu.addEventListener('click', function() {
                    this.classList.toggle('active');
                });
                
                // 点击外部关闭菜单
                document.addEventListener('click', function(e) {
                    if (!userMenu.contains(e.target)) {
                        userMenu.classList.remove('active');
                    }
                });
            }
            
            // 学期选择变化
            const termSelect = document.getElementById('termSelect');
            if (termSelect) {
                termSelect.addEventListener('change', function() {
                    filterGrades();
                });
            }
            
            // 课程类型选择变化
            const courseTypeSelect = document.getElementById('courseTypeSelect');
            if (courseTypeSelect) {
                courseTypeSelect.addEventListener('change', function() {
                    filterGrades();
                });
            }
        }
        
        /**
         * 加载用户信息
         */
        function loadUserInfo() {
            const userName = document.getElementById('userName');
            
            // 从本地存储获取用户信息
            const user = JSON.parse(localStorage.getItem('user')) || {};
            const username = user.name || user.username || '同学';
            
            // 设置用户名
            if (userName) {
                userName.textContent = username;
            }
            
            // 如果本地没有完整的用户信息，则从API获取
            if (!user.realName) {
                API.request('/api/users/current')
                    .then(userInfo => {
                        if (userInfo) {
                            // 更新本地存储
                            localStorage.setItem('user', JSON.stringify(userInfo));
                            
                            // 更新界面
                            const fullName = userInfo.realName || userInfo.username || '同学';
                            if (userName) {
                                userName.textContent = fullName;
                            }
                        }
                    })
                    .catch(error => {
                        console.error('获取用户信息失败:', error);
                    });
            }
        }
        
        /**
         * 初始化成绩查询
         */
        function initGrades() {
            // 加载成绩数据
            loadGradesData();
        }
        
        /**
         * 加载成绩数据
         */
        function loadGradesData() {
            // 请求成绩数据
            API.request('/api/grades/my')
                .then(gradesData => {
                    // 存储成绩数据
                    window.allGradesData = gradesData || [];
                    
                    // 渲染成绩表格
                    renderGradesTable(gradesData);
                    
                    // 更新统计信息
                    updateStatistics(gradesData);
                })
                .catch(error => {
                    console.error('获取成绩数据失败:', error);
                    
                    // 临时使用模拟数据
                    const mockData = generateMockGradesData();
                    window.allGradesData = mockData;
                    
                    // 渲染成绩表格
                    renderGradesTable(mockData);
                    
                    // 更新统计信息
                    updateStatistics(mockData);
                });
        }
        
        /**
         * 筛选成绩数据
         */
        function filterGrades() {
            const termSelect = document.getElementById('termSelect');
            const courseTypeSelect = document.getElementById('courseTypeSelect');
            
            if (!termSelect || !courseTypeSelect || !window.allGradesData) return;
            
            const selectedTerm = termSelect.value;
            const selectedType = courseTypeSelect.value;
            
            // 筛选数据
            let filteredData = window.allGradesData;
            
            // 按学期筛选
            if (selectedTerm !== 'all') {
                filteredData = filteredData.filter(item => item.term === selectedTerm);
            }
            
            // 按课程类型筛选
            if (selectedType !== 'all') {
                filteredData = filteredData.filter(item => item.courseType === selectedType);
            }
            
            // 重新渲染成绩表格
            renderGradesTable(filteredData);
            
            // 更新学期统计信息
            updateTermSummary(filteredData, selectedTerm);
        }
        
        /**
         * 渲染成绩表格
         * @param {Array} gradesData 成绩数据
         */
        function renderGradesTable(gradesData) {
            const tableBody = document.querySelector('#gradesTable tbody');
            if (!tableBody) return;
            
            // 清空表格
            tableBody.innerHTML = '';
            
            if (!gradesData || gradesData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" style="text-align: center; padding: 2rem 0;">暂无成绩数据</td>';
                tableBody.appendChild(row);
                return;
            }
            
            // 获取学期显示名称的映射
            const termNames = {
                '2023-2024-1': '2023-2024学年第一学期',
                '2022-2023-2': '2022-2023学年第二学期',
                '2022-2023-1': '2022-2023学年第一学期'
            };
            
            // 添加成绩行
            gradesData.forEach(grade => {
                const row = document.createElement('tr');
                
                // 根据分数计算等级和样式
                let gradeClass = '';
                if (grade.score >= 90) {
                    gradeClass = 'grade-excellent';
                } else if (grade.score >= 80) {
                    gradeClass = 'grade-good';
                } else if (grade.score >= 60) {
                    gradeClass = 'grade-pass';
                } else {
                    gradeClass = 'grade-fail';
                }
                
                // 课程类型中文显示
                const courseTypeText = {
                    'required': '必修',
                    'elective': '选修',
                    'public': '公共',
                    'professional': '专业'
                }[grade.courseType] || grade.courseType;
                
                row.innerHTML = `
                    <td>${grade.courseName}</td>
                    <td>${grade.credit}</td>
                    <td>${courseTypeText}</td>
                    <td><span class="term-tag">${termNames[grade.term] || grade.term}</span></td>
                    <td><span class="grade-badge ${gradeClass}">${grade.score}</span></td>
                    <td>${grade.gpa.toFixed(2)}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        /**
         * 更新统计信息
         * @param {Array} gradesData 成绩数据
         */
        function updateStatistics(gradesData) {
            if (!gradesData || gradesData.length === 0) return;
            
            const overallGPA = document.getElementById('overallGPA');
            const totalCredits = document.getElementById('totalCredits');
            const currentGPA = document.getElementById('currentGPA');
            const currentCourses = document.getElementById('currentCourses');
            
            // 计算总GPA和总学分
            let totalGpaPoints = 0;
            let credits = 0;
            
            gradesData.forEach(grade => {
                totalGpaPoints += grade.gpa * grade.credit;
                credits += grade.credit;
            });
            
            const gpa = totalGpaPoints / credits;
            
            // 获取当前学期数据
            const currentTerm = '2023-2024-1'; // 假设当前学期
            const currentTermData = gradesData.filter(grade => grade.term === currentTerm);
            
            let currentTermGpa = 0;
            let currentTermCredits = 0;
            
            currentTermData.forEach(grade => {
                currentTermGpa += grade.gpa * grade.credit;
                currentTermCredits += grade.credit;
            });
            
            const termGpa = currentTermData.length > 0 ? currentTermGpa / currentTermCredits : 0;
            
            // 更新界面显示
            if (overallGPA) overallGPA.textContent = gpa.toFixed(2);
            if (totalCredits) totalCredits.textContent = credits;
            if (currentGPA) currentGPA.textContent = termGpa.toFixed(2);
            if (currentCourses) currentCourses.textContent = `${currentTermData.length}门`;
            
            // 更新学期统计
            updateTermSummary(currentTermData, currentTerm);
        }
        
        /**
         * 更新学期统计信息
         * @param {Array} termData 学期数据
         * @param {string} term 学期
         */
        function updateTermSummary(termData, term) {
            const termSummary = document.getElementById('termSummary');
            if (!termSummary) return;
            
            // 获取学期显示名称
            const termNames = {
                '2023-2024-1': '2023-2024学年第一学期',
                '2022-2023-2': '2022-2023学年第二学期',
                '2022-2023-1': '2022-2023学年第一学期',
                'all': '所有学期'
            };
            
            // 计算学期统计信息
            let totalCredits = 0;
            let totalScore = 0;
            let totalGpaPoints = 0;
            
            termData.forEach(grade => {
                totalCredits += grade.credit;
                totalScore += grade.score;
                totalGpaPoints += grade.gpa * grade.credit;
            });
            
            const avgScore = termData.length > 0 ? totalScore / termData.length : 0;
            const termGpa = termData.length > 0 ? totalGpaPoints / totalCredits : 0;
            
            // 更新显示
            termSummary.innerHTML = `
                <div class="summary-row">
                    <span class="summary-label">所选学期:</span>
                    <span class="summary-value">${termNames[term] || term}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">课程总数:</span>
                    <span class="summary-value">${termData.length}门</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">总学分:</span>
                    <span class="summary-value">${totalCredits}学分</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">平均成绩:</span>
                    <span class="summary-value">${avgScore.toFixed(1)}分</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">学期GPA:</span>
                    <span class="summary-value">${termGpa.toFixed(2)}</span>
                </div>
            `;
        }
        
        /**
         * 生成模拟成绩数据
         * @returns {Array} 模拟成绩数据
         */
        function generateMockGradesData() {
            // 课程名称列表
            const courseNames = [
                '高等数学', '大学物理', '数据结构', '计算机网络', '操作系统',
                '软件工程', 'Java程序设计', '数据库原理', '英语', '马克思主义基本原理',
                '计算机组成原理', '人工智能导论', 'Web前端开发', '网络安全', '移动应用开发',
                '高级算法设计', '云计算技术', '大数据分析', '计算机图形学', '编译原理'
            ];
            
            // 学期列表
            const terms = ['2023-2024-1', '2022-2023-2', '2022-2023-1'];
            
            // 课程类型列表
            const courseTypes = ['required', 'elective', 'public', 'professional'];
            
            // 生成随机成绩数据
            const gradesData = [];
            
            // 当前学期课程
            for (let i = 0; i < 8; i++) {
                const score = Math.floor(Math.random() * 30) + 70; // 70-100之间的随机分数
                const credit = [2, 3, 4, 5][Math.floor(Math.random() * 4)]; // 2-5之间的随机学分
                
                gradesData.push({
                    courseName: courseNames[i],
                    credit: credit,
                    courseType: courseTypes[Math.floor(Math.random() * courseTypes.length)],
                    term: '2023-2024-1',
                    score: score,
                    gpa: calculateGpa(score)
                });
            }
            
            // 上学期课程
            for (let i = 8; i < 15; i++) {
                const score = Math.floor(Math.random() * 30) + 70;
                const credit = [2, 3, 4, 5][Math.floor(Math.random() * 4)];
                
                gradesData.push({
                    courseName: courseNames[i],
                    credit: credit,
                    courseType: courseTypes[Math.floor(Math.random() * courseTypes.length)],
                    term: '2022-2023-2',
                    score: score,
                    gpa: calculateGpa(score)
                });
            }
            
            // 上上学期课程
            for (let i = 15; i < courseNames.length; i++) {
                const score = Math.floor(Math.random() * 30) + 70;
                const credit = [2, 3, 4, 5][Math.floor(Math.random() * 4)];
                
                gradesData.push({
                    courseName: courseNames[i],
                    credit: credit,
                    courseType: courseTypes[Math.floor(Math.random() * courseTypes.length)],
                    term: '2022-2023-1',
                    score: score,
                    gpa: calculateGpa(score)
                });
            }
            
            return gradesData;
        }
        
        /**
         * 根据分数计算GPA
         * @param {number} score 分数
         * @returns {number} GPA
         */
        function calculateGpa(score) {
            if (score >= 90) return 4.0;
            if (score >= 85) return 3.7;
            if (score >= 80) return 3.3;
            if (score >= 75) return 3.0;
            if (score >= 70) return 2.7;
            if (score >= 65) return 2.3;
            if (score >= 60) return 2.0;
            return 0;
        }
        
        /**
         * 退出登录
         */
        function logout() {
            UI.confirm('确定要退出登录吗？', '', () => {
                API.clearToken();
                UI.showMessage('已退出登录', 'info');
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 1000);
            });
        }
        
        /**
         * 显示加载动画
         */
        function showLoading() {
            const loadingMask = document.getElementById('loadingMask');
            if (loadingMask) {
                loadingMask.style.display = 'flex';
            }
        }
        
        /**
         * 隐藏加载动画
         * @param {number} delay 延迟时间（毫秒）
         */
        function hideLoading(delay = 0) {
            const loadingMask = document.getElementById('loadingMask');
            if (loadingMask) {
                setTimeout(() => {
                    loadingMask.style.display = 'none';
                }, delay);
            }
        }
    </script>
</body>
</html> 