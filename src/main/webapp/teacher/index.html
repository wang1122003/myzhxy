<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸ˆç©ºé—´ - æ™ºæ…§æ ¡å›­</title>
    <link rel="stylesheet" href="../static/css/style.css">
    <script src="../static/js/auth.js"></script>
    <script src="../static/js/api.js"></script>
    <script src="../static/js/ui.js"></script>
</head>
<body>
    <!-- åŠ è½½ä¸­æç¤º -->
    <div id="loading" class="loading-container">
        <div class="loading-spinner"></div>
        <div class="loading-text">åŠ è½½ä¸­...</div>
    </div>
    
    <!-- ä¸»ç•Œé¢ -->
    <div id="mainContent">
        <div class="teacher-layout">
            <!-- å¤´éƒ¨å¯¼èˆª -->
            <header class="header">
                <div class="container header-container">
                    <div class="logo">
                        <h1>æ™ºæ…§æ ¡å›­</h1>
                    </div>
                    <ul class="nav-links">
                        <li><a href="/campus/index.html">é¦–é¡µ</a></li>
                        <li><a href="/campus/forum.html">æ ¡å›­è®ºå›</a></li>
                        <li><a href="/campus/index.html" id="logoutBtn">é€€å‡ºç™»å½•</a></li>
                    </ul>
                </div>
            </header>

            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar">
                <div class="user-profile">
                    <div class="avatar">
                        <img src="https://via.placeholder.com/80" alt="ç”¨æˆ·å¤´åƒ">
                    </div>
                    <div class="user-info">
                        <h3 id="teacherName">åŠ è½½ä¸­...</h3>
                        <p id="teacherId">å·¥å·ï¼šåŠ è½½ä¸­...</p>
                    </div>
                </div>
                <div class="sidebar-menu">
                    <div class="menu-item active" data-target="dashboard">ä¸ªäººä¸­å¿ƒ</div>
                    <div class="menu-item" data-target="schedule">æˆ‘çš„è¯¾è¡¨</div>
                    <div class="menu-item" data-target="courses">æˆ‘çš„è¯¾ç¨‹</div>
                    <div class="menu-item" data-target="grades">æˆç»©å½•å…¥</div>
                    <div class="menu-item" data-target="students">å­¦ç”Ÿç®¡ç†</div>
                    <div class="menu-item" data-target="posts">æˆ‘çš„å¸–å­</div>
                </div>
            </div>

            <!-- ä¸»å†…å®¹åŒº -->
            <div class="main-panel">
                <!-- é¢åŒ…å±‘å¯¼èˆª -->
                <div class="breadcrumb">
                    <span id="currentModule">ä¸ªäººä¸­å¿ƒ</span>
                </div>

                <!-- å†…å®¹åŒºåŸŸ -->
                <div class="content-wrapper">
                    <!-- ä¸ªäººä¸­å¿ƒæ¨¡å— -->
                    <div id="dashboard" class="module-content active">
                        <div class="welcome-banner">
                            <h2>æ¬¢è¿å›æ¥ï¼Œ<span id="welcomeName">è€å¸ˆ</span></h2>
                            <p>ä»Šå¤©æ˜¯ <span id="currentDate"></span>ï¼Œç¥æ‚¨å·¥ä½œæ„‰å¿«ï¼</p>
                        </div>
                        
                        <div class="info-cards">
                            <div class="info-card">
                                <div class="card-icon">ğŸ“š</div>
                                <div class="card-info">
                                    <h3>æˆ‘çš„è¯¾ç¨‹</h3>
                                    <p>æœ¬å­¦æœŸå…± <span id="coursesCount">0</span> é—¨è¯¾ç¨‹</p>
                                </div>
                                <a href="#" onclick="switchTab('courses')" class="card-link">æŸ¥çœ‹è¯¦æƒ…</a>
                            </div>
                            
                            <div class="info-card">
                                <div class="card-icon">ğŸ—“ï¸</div>
                                <div class="card-info">
                                    <h3>ä»Šæ—¥è¯¾ç¨‹</h3>
                                    <p>ä»Šå¤©æœ‰ <span id="todayClassCount">0</span> èŠ‚è¯¾</p>
                                </div>
                                <a href="#" onclick="switchTab('schedule')" class="card-link">æŸ¥çœ‹è¯¦æƒ…</a>
                            </div>
                            
                            <div class="info-card">
                                <div class="card-icon">ğŸ‘¨â€ğŸ“</div>
                                <div class="card-info">
                                    <h3>å­¦ç”Ÿäººæ•°</h3>
                                    <p>å…±æœ‰ <span id="studentsCount">0</span> åå­¦ç”Ÿ</p>
                                </div>
                                <a href="#" onclick="switchTab('students')" class="card-link">æŸ¥çœ‹è¯¦æƒ…</a>
                            </div>
                        </div>
                        
                        <div class="dashboard-sections">
                            <div class="dashboard-section">
                                <h3>æœ€è¿‘å…¬å‘Š</h3>
                                <div id="recentNotices" class="notice-list">
                                    <div class="loading-placeholder">æ­£åœ¨åŠ è½½å…¬å‘Š...</div>
                                </div>
                            </div>
                            
                            <div class="dashboard-section">
                                <h3>ä»Šæ—¥è¯¾ç¨‹</h3>
                                <div id="todayClasses" class="class-list">
                                    <div class="loading-placeholder">æ­£åœ¨åŠ è½½è¯¾ç¨‹...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å…¶ä»–æ¨¡å— -->
                    <div id="schedule" class="module-content">
                        <h2>æˆ‘çš„è¯¾è¡¨</h2>
                        <div class="action-bar">
                            <select id="termSelect" class="form-control">
                                <option value="">å½“å‰å­¦æœŸ</option>
                            </select>
                            <button id="printScheduleBtn" class="btn btn-secondary"><i class="bi bi-printer"></i> æ‰“å°è¯¾è¡¨</button>
                            <button id="exportScheduleBtn" class="btn btn-secondary"><i class="bi bi-download"></i> å¯¼å‡ºè¯¾è¡¨</button>
                        </div>
                        
                        <div class="schedule-container">
                            <table class="schedule-table">
                                <thead>
                                    <tr>
                                        <th class="time-col">æ—¶é—´</th>
                                        <th>å‘¨ä¸€</th>
                                        <th>å‘¨äºŒ</th>
                                        <th>å‘¨ä¸‰</th>
                                        <th>å‘¨å››</th>
                                        <th>å‘¨äº”</th>
                                        <th>å‘¨å…­</th>
                                        <th>å‘¨æ—¥</th>
                                    </tr>
                                </thead>
                                <tbody id="scheduleTableBody">
                                    <!-- è¿™é‡Œå°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½è¯¾è¡¨æ•°æ® -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="courses" class="module-content">
                        <h2>æˆ‘çš„è¯¾ç¨‹</h2>
                        <div class="action-bar">
                            <button id="refreshCourseBtn" class="btn btn-primary"><i class="bi bi-arrow-clockwise"></i> åˆ·æ–°è¯¾ç¨‹</button>
                        </div>
                        <div id="teacherCourseList" class="course-list">
                            <div class="loading-placeholder">æ­£åœ¨åŠ è½½è¯¾ç¨‹...</div>
                        </div>
                    </div>
                    
                    <div id="grades" class="module-content">
                        <h2>æˆç»©å½•å…¥</h2>
                        <div class="grade-panel">
                            <div class="grade-selector">
                                <h3>é€‰æ‹©è¯¾ç¨‹</h3>
                                <select id="gradesCourseSelect" class="form-control">
                                    <option value="">--è¯·é€‰æ‹©è¯¾ç¨‹--</option>
                                </select>
                            </div>
                            <div id="courseStudentList" class="grade-student-list">
                                <div class="empty-state">è¯·å…ˆé€‰æ‹©è¯¾ç¨‹</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="students" class="module-content">
                        <h2>å­¦ç”Ÿç®¡ç†</h2>
                        <div class="action-bar">
                            <select id="courseSelectForStudents" class="form-control">
                                <option value="">é€‰æ‹©è¯¾ç¨‹</option>
                            </select>
                            <button id="refreshStudentsBtn" class="btn btn-primary"><i class="bi bi-arrow-clockwise"></i> åˆ·æ–°å­¦ç”Ÿåˆ—è¡¨</button>
                        </div>
                        
                        <div class="students-container">
                            <div class="students-header">
                                <div class="search-box">
                                    <input type="text" id="studentSearchInput" class="form-control" placeholder="æœç´¢å­¦ç”Ÿ..." />
                                    <button id="studentSearchBtn" class="btn"><i class="bi bi-search"></i></button>
                                </div>
                            </div>
                            
                            <div class="students-table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>å­¦å·</th>
                                            <th>å§“å</th>
                                            <th>æ€§åˆ«</th>
                                            <th>ç­çº§</th>
                                            <th>ä¸“ä¸š</th>
                                            <th>å‡ºå‹¤ç‡</th>
                                            <th>æˆç»©</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentsTableBody">
                                        <!-- è¿™é‡Œå°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½å­¦ç”Ÿæ•°æ® -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="pagination-container" id="studentsPagination">
                                <!-- åˆ†é¡µæ§ä»¶å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                            </div>
                        </div>
                    </div>
                    
                    <div id="posts" class="module-content">
                        <h2>æˆ‘çš„å¸–å­</h2>
                        <div class="action-bar">
                            <button id="newPostBtn" class="btn btn-primary"><i class="bi bi-plus"></i> å‘å¸ƒæ–°å¸–å­</button>
                            <button id="refreshPostsBtn" class="btn btn-secondary"><i class="bi bi-arrow-clockwise"></i> åˆ·æ–°</button>
                        </div>
                        
                        <div class="posts-container">
                            <div class="posts-header">
                                <div class="search-box">
                                    <input type="text" id="postSearchInput" class="form-control" placeholder="æœç´¢å¸–å­..." />
                                    <button id="postSearchBtn" class="btn"><i class="bi bi-search"></i></button>
                                </div>
                                <div class="filter-box">
                                    <select id="postCategoryFilter" class="form-control">
                                        <option value="">å…¨éƒ¨åˆ†ç±»</option>
                                        <option value="1">æ•™å­¦è®¨è®º</option>
                                        <option value="2">å­¦æœ¯äº¤æµ</option>
                                        <option value="3">æ ¡å›­ç”Ÿæ´»</option>
                                        <option value="4">å…¶ä»–</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="posts-list" id="teacherPostsList">
                                <!-- è¿™é‡Œå°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½å¸–å­æ•°æ® -->
                            </div>
                            
                            <div class="pagination-container" id="postsPagination">
                                <!-- åˆ†é¡µæ§ä»¶å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                            </div>
                        </div>
                        
                        <!-- æ–°å»ºå¸–å­å¯¹è¯æ¡† -->
                        <div id="newPostDialog" class="dialog-container" style="display: none;">
                            <div class="dialog-content">
                                <div class="dialog-header">
                                    <h3>å‘å¸ƒæ–°å¸–å­</h3>
                                    <button class="close-btn" id="closeNewPostBtn">&times;</button>
                                </div>
                                <div class="dialog-body">
                                    <form id="newPostForm">
                                        <div class="form-group">
                                            <label for="postTitle">æ ‡é¢˜</label>
                                            <input type="text" id="postTitle" class="form-control" required />
                                        </div>
                                        <div class="form-group">
                                            <label for="postCategory">åˆ†ç±»</label>
                                            <select id="postCategory" class="form-control" required>
                                                <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                                                <option value="1">æ•™å­¦è®¨è®º</option>
                                                <option value="2">å­¦æœ¯äº¤æµ</option>
                                                <option value="3">æ ¡å›­ç”Ÿæ´»</option>
                                                <option value="4">å…¶ä»–</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="postContent">å†…å®¹</label>
                                            <textarea id="postContent" class="form-control" rows="8" required></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label for="postTags">æ ‡ç­¾ (ç”¨é€—å·åˆ†éš”)</label>
                                            <input type="text" id="postTags" class="form-control" placeholder="ä¾‹å¦‚: æ•™å­¦,è®¨è®º,åˆ†äº«" />
                                        </div>
                                    </form>
                                </div>
                                <div class="dialog-footer">
                                    <button class="btn btn-secondary" id="cancelNewPostBtn">å–æ¶ˆ</button>
                                    <button class="btn btn-primary" id="submitNewPostBtn">å‘å¸ƒ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¨¡å—åˆ‡æ¢
        function switchTab(tabId) {
            // æ›´æ–°æ´»åŠ¨èœå•é¡¹
            document.querySelectorAll('.sidebar .menu-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.sidebar .menu-item[data-target="${tabId}"]`).classList.add('active');
            
            // æ›´æ–°æ´»åŠ¨å†…å®¹
            document.querySelectorAll('.module-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            
            // æ›´æ–°é¢åŒ…å±‘
            const moduleTitles = {
                'dashboard': 'ä¸ªäººä¸­å¿ƒ',
                'schedule': 'æˆ‘çš„è¯¾è¡¨',
                'courses': 'æˆ‘çš„è¯¾ç¨‹',
                'grades': 'æˆç»©å½•å…¥',
                'students': 'å­¦ç”Ÿç®¡ç†',
                'posts': 'æˆ‘çš„å¸–å­'
            };
            document.getElementById('currentModule').textContent = moduleTitles[tabId];
            
            // æ ¹æ®é€‰æ‹©çš„æ ‡ç­¾åŠ è½½ç›¸åº”å†…å®¹
            if (tabId === 'schedule') {
                loadTeacherSchedule();
            } else if (tabId === 'courses') {
                loadTeacherCourses();
            } else if (tabId === 'grades') {
                loadGradesCourseSelect();
            } else if (tabId === 'students') {
                loadStudentManagement();
            } else if (tabId === 'posts') {
                loadTeacherPosts();
            }
        }
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLogin() {
            if (!API.isLoggedIn()) {
                window.location.href = '/campus/index.html';
                return false;
            }
            
            // æ£€æŸ¥ç”¨æˆ·ç±»å‹
            const userType = parseInt(localStorage.getItem('userType'));
            if (userType !== 2 && userType !== 0) { // æ•™å¸ˆæˆ–ç®¡ç†å‘˜å¯ä»¥è®¿é—®
                UI.showMessage('æ‚¨æ²¡æœ‰è®¿é—®æ•™å¸ˆä¸­å¿ƒçš„æƒé™', 'error');
                setTimeout(() => {
                    window.location.href = '/campus/index.html';
                }, 1500);
                return false;
            }
            
            return true;
        }
        
        // åŠ è½½æ•™å¸ˆä¿¡æ¯
        async function loadTeacherInfo() {
            UI.showLoading();
            
            try {
                const userId = API.getUserId();
                if (!userId) {
                    throw new Error('ç”¨æˆ·æœªç™»å½•');
                }
                
                const user = await API.user.getById(userId);
                if (user) {
                    document.getElementById('welcomeName').textContent = user.realName || 'è€å¸ˆ';
                    document.getElementById('teacherName').textContent = user.realName || 'æœªè®¾ç½®å§“å';
                    document.getElementById('teacherId').textContent = 'å·¥å·ï¼š' + (user.username || 'æœªçŸ¥');
                }
                
                // æ›´æ–°å½“å‰æ—¥æœŸ
                const now = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                document.getElementById('currentDate').textContent = now.toLocaleDateString('zh-CN', options);
                
                // åŠ è½½è¯¾ç¨‹ç»Ÿè®¡
                await loadDashboardData();
            } catch (error) {
                console.error('åŠ è½½æ•™å¸ˆä¿¡æ¯å¤±è´¥:', error);
                UI.showMessage('åŠ è½½ä¸ªäººä¿¡æ¯å¤±è´¥', 'error');
            } finally {
                UI.hideLoading();
            }
        }
        
        // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
        async function loadDashboardData() {
            try {
                // åŠ è½½è¯¾ç¨‹ç»Ÿè®¡
                const courses = await API.request('/api/courses/teacher/' + API.getUserId());
                if (courses) {
                    document.getElementById('coursesCount').textContent = courses.length || 0;
                    
                    // ä»Šæ—¥è¯¾ç¨‹
                    const today = new Date().getDay(); // 0æ˜¯å‘¨æ—¥ï¼Œ1æ˜¯å‘¨ä¸€
                    const todayClasses = courses.filter(course => {
                        return course.schedules && course.schedules.some(schedule => 
                            schedule.dayOfWeek === (today === 0 ? 7 : today)
                        );
                    });
                    
                    document.getElementById('todayClassCount').textContent = todayClasses.length || 0;
                    updateTodayClasses(todayClasses);
                }
                
                // åŠ è½½å­¦ç”Ÿç»Ÿè®¡
                const studentCount = await API.request('/api/statistics/teacherStudentCount/' + API.getUserId());
                if (studentCount !== undefined) {
                    document.getElementById('studentsCount').textContent = studentCount;
                }
                
                // åŠ è½½å…¬å‘Š
                const notices = await API.notice.getAll(1, 3);
                if (notices && notices.content) {
                    updateRecentNotices(notices.content);
                }
            } catch (error) {
                console.error('åŠ è½½ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥:', error);
                UI.showMessage('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥', 'error');
            }
        }
        
        // æ›´æ–°ä»Šæ—¥è¯¾ç¨‹
        function updateTodayClasses(courses) {
            const todayClassesContainer = document.getElementById('todayClasses');
            
            if (!courses || courses.length === 0) {
                todayClassesContainer.innerHTML = '<div class="empty-state">ä»Šæ—¥æ²¡æœ‰è¯¾ç¨‹å®‰æ’</div>';
                return;
            }
            
            let html = '';
            courses.forEach(course => {
                const schedules = course.schedules || [];
                const today = new Date().getDay(); // 0æ˜¯å‘¨æ—¥ï¼Œ1æ˜¯å‘¨ä¸€
                const todaySchedules = schedules.filter(s => s.dayOfWeek === (today === 0 ? 7 : today));
                
                todaySchedules.forEach(schedule => {
                    html += `
                        <div class="class-item">
                            <div class="class-time">${schedule.startTime || ''} - ${schedule.endTime || ''}</div>
                            <div class="class-info">
                                <div class="class-name">${course.name || 'æœªå‘½åè¯¾ç¨‹'}</div>
                                <div class="class-location">${schedule.classroom || 'æœªåˆ†é…æ•™å®¤'}</div>
                            </div>
                        </div>
                    `;
                });
            });
            
            todayClassesContainer.innerHTML = html;
        }
        
        // æ›´æ–°æœ€è¿‘å…¬å‘Š
        function updateRecentNotices(notices) {
            const noticesContainer = document.getElementById('recentNotices');
            
            if (!notices || notices.length === 0) {
                noticesContainer.innerHTML = '<div class="empty-state">æš‚æ— å…¬å‘Š</div>';
                return;
            }
            
            let html = '';
            notices.forEach(notice => {
                const date = new Date(notice.createTime || Date.now());
                const dateString = date.toLocaleDateString('zh-CN');
                
                html += `
                    <div class="notice-item">
                        <div class="notice-title">${notice.title || 'æœªå‘½åå…¬å‘Š'}</div>
                        <div class="notice-date">${dateString}</div>
                    </div>
                `;
            });
            
            noticesContainer.innerHTML = html;
        }
        
        // åŠ è½½æ•™å¸ˆè¯¾è¡¨
        async function loadTeacherSchedule() {
            UI.showLoading();
            
            try {
                // åŠ è½½å­¦æœŸé€‰é¡¹
                const terms = await API.request('/api/terms');
                const termSelect = document.getElementById('termSelect');
                termSelect.innerHTML = '<option value="">å½“å‰å­¦æœŸ</option>';
                
                if (terms && terms.length > 0) {
                    terms.forEach(term => {
                        const option = document.createElement('option');
                        option.value = term.id;
                        option.textContent = term.name;
                        if (term.current) {
                            option.selected = true;
                        }
                        termSelect.appendChild(option);
                    });
                }
                
                const userId = API.getUserId();
                const termId = termSelect.value || '';
                
                // åŠ è½½æ•™å¸ˆè¯¾è¡¨
                const schedules = await API.request(`/api/schedules/teacher/${userId}?termId=${termId}`);
                renderScheduleTable(schedules);
            } catch (error) {
                console.error('åŠ è½½è¯¾è¡¨å¤±è´¥:', error);
                UI.showMessage('åŠ è½½è¯¾è¡¨å¤±è´¥', 'error');
            } finally {
                UI.hideLoading();
            }
        }
        
        // æ¸²æŸ“è¯¾è¡¨
        function renderScheduleTable(schedules) {
            const tableBody = document.getElementById('scheduleTableBody');
            tableBody.innerHTML = '';
            
            // å®šä¹‰æ—¶é—´æ®µ
            const timeSlots = [
                { start: '08:00', end: '09:40', name: 'ç¬¬ä¸€èŠ‚' },
                { start: '10:00', end: '11:40', name: 'ç¬¬äºŒèŠ‚' },
                { start: '14:00', end: '15:40', name: 'ç¬¬ä¸‰èŠ‚' },
                { start: '16:00', end: '17:40', name: 'ç¬¬å››èŠ‚' },
                { start: '19:00', end: '20:40', name: 'ç¬¬äº”èŠ‚' }
            ];
            
            // åˆ›å»ºè¯¾è¡¨è¡Œ
            timeSlots.forEach(slot => {
                const row = document.createElement('tr');
                
                // æ·»åŠ æ—¶é—´åˆ—
                const timeCell = document.createElement('td');
                timeCell.className = 'time-col';
                timeCell.innerHTML = `<div>${slot.name}</div><div>${slot.start}-${slot.end}</div>`;
                row.appendChild(timeCell);
                
                // æ·»åŠ æ¯å¤©çš„å•å…ƒæ ¼
                for (let day = 1; day <= 7; day++) {
                    const cell = document.createElement('td');
                    
                    // æŸ¥æ‰¾å½“å‰æ—¶é—´æ®µå’Œæ˜ŸæœŸçš„è¯¾ç¨‹
                    const schedule = schedules ? schedules.find(s => 
                        s.dayOfWeek === day && 
                        s.startTime === slot.start && 
                        s.endTime === slot.end
                    ) : null;
                    
                    if (schedule) {
                        cell.className = 'has-class';
                        cell.innerHTML = `
                            <div class="class-info">
                                <div class="class-name">${schedule.courseName || 'æœªçŸ¥è¯¾ç¨‹'}</div>
                                <div class="class-room">${schedule.classroom || 'æœªåˆ†é…æ•™å®¤'}</div>
                                <div class="class-weeks">ç¬¬${schedule.weeks || 'å…¨'}å‘¨</div>
                            </div>
                        `;
                    }
                    
                    row.appendChild(cell);
                }
                
                tableBody.appendChild(row);
            });
        }
        
        // æ‰“å°è¯¾è¡¨
        function printSchedule() {
            window.print();
        }
        
        // å¯¼å‡ºè¯¾è¡¨
        function exportSchedule() {
            UI.showMessage('æ­£åœ¨å‡†å¤‡å¯¼å‡ºè¯¾è¡¨...', 'info');
            setTimeout(() => {
                UI.showMessage('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…', 'info');
            }, 1500);
        }
        
        // åŠ è½½å­¦ç”Ÿç®¡ç†
        async function loadStudentManagement() {
            UI.showLoading();
            
            try {
                // åŠ è½½æ•™å¸ˆè¯¾ç¨‹ä¸‹æ‹‰æ¡†
                const userId = API.getUserId();
                const courses = await API.request(`/api/courses/teacher/${userId}`);
                
                const courseSelect = document.getElementById('courseSelectForStudents');
                courseSelect.innerHTML = '<option value="">é€‰æ‹©è¯¾ç¨‹</option>';
                
                if (courses && courses.length > 0) {
                    courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.name;
                        courseSelect.appendChild(option);
                    });
                }
                
                // å¦‚æœæœ‰è¯¾ç¨‹ï¼ŒåŠ è½½ç¬¬ä¸€ä¸ªè¯¾ç¨‹çš„å­¦ç”Ÿ
                if (courses && courses.length > 0) {
                    courseSelect.value = courses[0].id;
                    await loadCourseStudents(courses[0].id);
                } else {
                    document.getElementById('studentsTableBody').innerHTML = '<tr><td colspan="8" class="empty-state">æš‚æ— è¯¾ç¨‹ä¿¡æ¯</td></tr>';
                }
            } catch (error) {
                console.error('åŠ è½½å­¦ç”Ÿç®¡ç†å¤±è´¥:', error);
                UI.showMessage('åŠ è½½å­¦ç”Ÿä¿¡æ¯å¤±è´¥', 'error');
            } finally {
                UI.hideLoading();
            }
        }
        
        // åŠ è½½è¯¾ç¨‹å­¦ç”Ÿ
        async function loadCourseStudents(courseId, page = 1, size = 10, keyword = '') {
            if (!courseId) {
                document.getElementById('studentsTableBody').innerHTML = '<tr><td colspan="8" class="empty-state">è¯·é€‰æ‹©è¯¾ç¨‹</td></tr>';
                return;
            }
            
            UI.showLoading();
            
            try {
                const result = await API.request(`/api/courses/${courseId}/students?page=${page-1}&size=${size}&keyword=${keyword}`);
                
                const tableBody = document.getElementById('studentsTableBody');
                
                if (!result || !result.content || result.content.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="empty-state">è¯¥è¯¾ç¨‹æš‚æ— å­¦ç”Ÿ</td></tr>';
                    return;
                }
                
                tableBody.innerHTML = '';
                
                result.content.forEach(student => {
                    const tr = document.createElement('tr');
                    
                    tr.innerHTML = `
                        <td>${student.studentNo || ''}</td>
                        <td>${student.realName || ''}</td>
                        <td>${student.gender === 1 ? 'ç”·' : student.gender === 2 ? 'å¥³' : 'æœªçŸ¥'}</td>
                        <td>${student.className || ''}</td>
                        <td>${student.majorName || ''}</td>
                        <td>${student.attendance || '0'}%</td>
                        <td>${student.score !== undefined ? student.score : 'æœªè¯„åˆ†'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary view-student-btn" data-id="${student.id}">æŸ¥çœ‹</button>
                            <button class="btn btn-sm btn-secondary grade-student-btn" data-id="${student.id}">è¯„åˆ†</button>
                        </td>
                    `;
                    
                    tableBody.appendChild(tr);
                });
                
                // è®¾ç½®åˆ†é¡µ
                const paginationContainer = document.getElementById('studentsPagination');
                paginationContainer.innerHTML = '';
                
                if (result.totalPages > 1) {
                    const pagination = document.createElement('div');
                    pagination.className = 'pagination';
                    
                    // ä¸Šä¸€é¡µ
                    const prevBtn = document.createElement('button');
                    prevBtn.className = 'page-btn' + (page === 1 ? ' disabled' : '');
                    prevBtn.innerHTML = '&lt;';
                    prevBtn.onclick = () => {
                        if (page > 1) loadCourseStudents(courseId, page - 1, size, keyword);
                    };
                    pagination.appendChild(prevBtn);
                    
                    // é¡µç 
                    const startPage = Math.max(1, page - 2);
                    const endPage = Math.min(result.totalPages, startPage + 4);
                    
                    for (let i = startPage; i <= endPage; i++) {
                        const pageBtn = document.createElement('button');
                        pageBtn.className = 'page-btn' + (i === page ? ' active' : '');
                        pageBtn.textContent = i;
                        pageBtn.onclick = () => loadCourseStudents(courseId, i, size, keyword);
                        pagination.appendChild(pageBtn);
                    }
                    
                    // ä¸‹ä¸€é¡µ
                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'page-btn' + (page === result.totalPages ? ' disabled' : '');
                    nextBtn.innerHTML = '&gt;';
                    nextBtn.onclick = () => {
                        if (page < result.totalPages) loadCourseStudents(courseId, page + 1, size, keyword);
                    };
                    pagination.appendChild(nextBtn);
                    
                    paginationContainer.appendChild(pagination);
                }
            } catch (error) {
                console.error('åŠ è½½è¯¾ç¨‹å­¦ç”Ÿå¤±è´¥:', error);
                UI.showMessage('åŠ è½½å­¦ç”Ÿåˆ—è¡¨å¤±è´¥', 'error');
            } finally {
                UI.hideLoading();
            }
        }
        
        // åŠ è½½æ•™å¸ˆå¸–å­
        async function loadTeacherPosts(page = 1, size = 10, category = '', keyword = '') {
            UI.showLoading();
            
            try {
                const userId = API.getUserId();
                const result = await API.request(`/api/posts/user/${userId}?page=${page-1}&size=${size}&category=${category}&keyword=${keyword}`);
                
                const postsContainer = document.getElementById('teacherPostsList');
                
                if (!result || !result.content || result.content.length === 0) {
                    postsContainer.innerHTML = '<div class="empty-state">æš‚æ— å¸–å­</div>';
                    return;
                }
                
                postsContainer.innerHTML = '';
                
                result.content.forEach(post => {
                    const postCard = document.createElement('div');
                    postCard.className = 'post-card';
                    
                    // æ ¼å¼åŒ–æ—¥æœŸ
                    const createTime = post.createTime ? new Date(post.createTime) : new Date();
                    const dateStr = createTime.toLocaleDateString('zh-CN');
                    
                    // å¸–å­åˆ†ç±»
                    const categories = {
                        1: 'æ•™å­¦è®¨è®º',
                        2: 'å­¦æœ¯äº¤æµ',
                        3: 'æ ¡å›­ç”Ÿæ´»',
                        4: 'å…¶ä»–'
                    };
                    
                    postCard.innerHTML = `
                        <div class="post-header">
                            <h3 class="post-title">${post.title || 'æ— æ ‡é¢˜'}</h3>
                            <div class="post-meta">
                                <span class="post-date">${dateStr}</span>
                                <span class="post-category">${categories[post.category] || 'æœªåˆ†ç±»'}</span>
                                <span class="post-views">æµè§ˆ ${post.views || 0}</span>
                                <span class="post-comments">è¯„è®º ${post.commentCount || 0}</span>
                            </div>
                        </div>
                        <div class="post-content">${post.content ? post.content.substring(0, 150) + '...' : 'æ— å†…å®¹'}</div>
                        <div class="post-footer">
                            <div class="post-tags">
                                ${post.tags ? post.tags.map(tag => `<span class="post-tag">${tag.name}</span>`).join('') : ''}
                            </div>
                            <div class="post-actions">
                                <button class="btn btn-sm btn-secondary edit-post-btn" data-id="${post.id}">ç¼–è¾‘</button>
                                <button class="btn btn-sm btn-danger delete-post-btn" data-id="${post.id}">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                    
                    postsContainer.appendChild(postCard);
                });
                
                // è®¾ç½®åˆ†é¡µ
                const paginationContainer = document.getElementById('postsPagination');
                paginationContainer.innerHTML = '';
                
                if (result.totalPages > 1) {
                    const pagination = document.createElement('div');
                    pagination.className = 'pagination';
                    
                    // ä¸Šä¸€é¡µ
                    const prevBtn = document.createElement('button');
                    prevBtn.className = 'page-btn' + (page === 1 ? ' disabled' : '');
                    prevBtn.innerHTML = '&lt;';
                    prevBtn.onclick = () => {
                        if (page > 1) loadTeacherPosts(page - 1, size, category, keyword);
                    };
                    pagination.appendChild(prevBtn);
                    
                    // é¡µç 
                    const startPage = Math.max(1, page - 2);
                    const endPage = Math.min(result.totalPages, startPage + 4);
                    
                    for (let i = startPage; i <= endPage; i++) {
                        const pageBtn = document.createElement('button');
                        pageBtn.className = 'page-btn' + (i === page ? ' active' : '');
                        pageBtn.textContent = i;
                        pageBtn.onclick = () => loadTeacherPosts(i, size, category, keyword);
                        pagination.appendChild(pageBtn);
                    }
                    
                    // ä¸‹ä¸€é¡µ
                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'page-btn' + (page === result.totalPages ? ' disabled' : '');
                    nextBtn.innerHTML = '&gt;';
                    nextBtn.onclick = () => {
                        if (page < result.totalPages) loadTeacherPosts(page + 1, size, category, keyword);
                    };
                    pagination.appendChild(nextBtn);
                    
                    paginationContainer.appendChild(pagination);
                }
            } catch (error) {
                console.error('åŠ è½½æ•™å¸ˆå¸–å­å¤±è´¥:', error);
                UI.showMessage('åŠ è½½å¸–å­åˆ—è¡¨å¤±è´¥', 'error');
            } finally {
                UI.hideLoading();
            }
        }
        
        // æ˜¾ç¤ºæ–°å»ºå¸–å­å¯¹è¯æ¡†
        function showNewPostDialog() {
            document.getElementById('newPostDialog').style.display = 'flex';
            document.getElementById('postTitle').focus();
        }
        
        // éšè—æ–°å»ºå¸–å­å¯¹è¯æ¡†
        function hideNewPostDialog() {
            document.getElementById('newPostDialog').style.display = 'none';
            document.getElementById('newPostForm').reset();
        }
        
        // æäº¤æ–°å¸–å­
        async function submitNewPost() {
            const title = document.getElementById('postTitle').value.trim();
            const category = document.getElementById('postCategory').value;
            const content = document.getElementById('postContent').value.trim();
            const tagsStr = document.getElementById('postTags').value.trim();
            
            if (!title || !category || !content) {
                UI.showMessage('è¯·å¡«å†™å®Œæ•´å¸–å­ä¿¡æ¯', 'warning');
                return;
            }
            
            UI.showLoading();
            
            try {
                const tags = tagsStr ? tagsStr.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
                
                const postData = {
                    title,
                    category: parseInt(category),
                    content,
                    tags,
                    userId: API.getUserId()
                };
                
                const result = await API.request('/api/posts', 'POST', postData);
                
                if (result) {
                    UI.showMessage('å¸–å­å‘å¸ƒæˆåŠŸ', 'success');
                    hideNewPostDialog();
                    loadTeacherPosts();
                } else {
                    throw new Error('å‘å¸ƒå¤±è´¥');
                }
            } catch (error) {
                console.error('å‘å¸ƒå¸–å­å¤±è´¥:', error);
                UI.showMessage('å¸–å­å‘å¸ƒå¤±è´¥', 'error');
            } finally {
                UI.hideLoading();
            }
        }
        
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (checkLogin()) {
                // åŠ è½½æ•™å¸ˆä¿¡æ¯
                loadTeacherInfo();
                
                // ç»‘å®šäº‹ä»¶
                document.querySelectorAll('.sidebar .menu-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const tabId = this.getAttribute('data-target');
                        switchTab(tabId);
                    });
                });
                
                // é€€å‡ºç™»å½•
                document.getElementById('logoutBtn').addEventListener('click', function(e) {
                    e.preventDefault();
                    API.logout();
                    window.location.href = '/campus/index.html';
                });
                
                // è¯¾è¡¨ç›¸å…³äº‹ä»¶
                document.getElementById('termSelect').addEventListener('change', loadTeacherSchedule);
                document.getElementById('printScheduleBtn').addEventListener('click', printSchedule);
                document.getElementById('exportScheduleBtn').addEventListener('click', exportSchedule);
                
                // å­¦ç”Ÿç®¡ç†ç›¸å…³äº‹ä»¶
                document.getElementById('courseSelectForStudents').addEventListener('change', function() {
                    loadCourseStudents(this.value);
                });
                document.getElementById('refreshStudentsBtn').addEventListener('click', function() {
                    const courseId = document.getElementById('courseSelectForStudents').value;
                    loadCourseStudents(courseId);
                });
                document.getElementById('studentSearchBtn').addEventListener('click', function() {
                    const courseId = document.getElementById('courseSelectForStudents').value;
                    const keyword = document.getElementById('studentSearchInput').value.trim();
                    loadCourseStudents(courseId, 1, 10, keyword);
                });
                document.getElementById('studentSearchInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const courseId = document.getElementById('courseSelectForStudents').value;
                        const keyword = this.value.trim();
                        loadCourseStudents(courseId, 1, 10, keyword);
                    }
                });
                
                // å¸–å­ç›¸å…³äº‹ä»¶
                document.getElementById('newPostBtn').addEventListener('click', showNewPostDialog);
                document.getElementById('closeNewPostBtn').addEventListener('click', hideNewPostDialog);
                document.getElementById('cancelNewPostBtn').addEventListener('click', hideNewPostDialog);
                document.getElementById('submitNewPostBtn').addEventListener('click', submitNewPost);
                document.getElementById('refreshPostsBtn').addEventListener('click', function() {
                    loadTeacherPosts();
                });
                document.getElementById('postSearchBtn').addEventListener('click', function() {
                    const category = document.getElementById('postCategoryFilter').value;
                    const keyword = document.getElementById('postSearchInput').value.trim();
                    loadTeacherPosts(1, 10, category, keyword);
                });
                document.getElementById('postCategoryFilter').addEventListener('change', function() {
                    const category = this.value;
                    const keyword = document.getElementById('postSearchInput').value.trim();
                    loadTeacherPosts(1, 10, category, keyword);
                });
                document.getElementById('postSearchInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const category = document.getElementById('postCategoryFilter').value;
                        const keyword = this.value.trim();
                        loadTeacherPosts(1, 10, category, keyword);
                    }
                });
            }
        });
    </script>
</body>
</html> 