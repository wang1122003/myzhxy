<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的课表 - 教师中心</title>
    <link rel="stylesheet" href="../static/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/css/font-awesome.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .schedule-container {
            margin-top: 20px;
            overflow-x: auto;
        }
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
        }
        .schedule-table th, .schedule-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            height: 80px;
            vertical-align: middle;
        }
        .schedule-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .time-col {
            width: 100px;
            background-color: #f8f9fa;
        }
        .schedule-course {
            background-color: #e3f2fd;
            padding: 8px;
            border-radius: 5px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .course-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .course-room {
            font-size: 0.8rem;
            color: #666;
        }
        .schedule-filter {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .schedule-filter label {
            margin-right: 10px;
            margin-bottom: 0;
        }
        .schedule-filter select {
            margin-right: 20px;
        }
        .term-title {
            font-size: 1.2rem;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            text-align: center;
        }
        .print-btn {
            margin-left: auto;
        }
        @media print {
            .sidebar, header, .navbar, .btn, footer {
                display: none !important;
            }
            .schedule-container {
                margin: 0;
                width: 100%;
            }
            body {
                padding: 0;
                margin: 0;
            }
            .schedule-table th, .schedule-table td {
                padding: 5px;
                font-size: 11px;
                height: 50px;
            }
        }
    </style>
</head>
<body>
    <div id="loading-mask">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">加载中...</span>
        </div>
    </div>

    <header>
        <div class="logo">
            <img src="../static/img/logo.png" alt="校园系统">
            <span>校园系统</span>
        </div>
        <div class="user-menu">
            <div class="user-info">
                <img src="../static/img/avatar.png" alt="用户头像" class="user-avatar">
                <span class="user-name">加载中...</span>
            </div>
            <div class="dropdown-menu">
                <a href="profile.html">个人资料</a>
                <a href="javascript:void(0)" onclick="logout()">退出登录</a>
            </div>
        </div>
    </header>

    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-2 sidebar">
                <div class="sidebar-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">
                                <i class="fa fa-home"></i> 首页
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="courses.html">
                                <i class="fa fa-book"></i> 我的课程
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="schedule.html">
                                <i class="fa fa-calendar"></i> 我的课表
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="../forum.html">
                                <i class="fa fa-comments"></i> 校园论坛
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="profile.html">
                                <i class="fa fa-user"></i> 个人资料
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-10 ml-sm-auto px-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">我的课表</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button id="printScheduleBtn" class="btn btn-outline-secondary">
                            <i class="fa fa-print"></i> 打印课表
                        </button>
                        <button id="exportScheduleBtn" class="btn btn-outline-secondary ml-2">
                            <i class="fa fa-download"></i> 导出课表
                        </button>
                    </div>
                </div>

                <!-- 课表筛选 -->
                <div class="schedule-filter">
                    <label for="termSelect">学期:</label>
                    <select id="termSelect" class="form-control" style="width: 180px;">
                        <option value="">当前学期</option>
                    </select>
                    
                    <label for="weekSelect" class="ml-3">周次:</label>
                    <select id="weekSelect" class="form-control" style="width: 120px;">
                        <option value="">全部</option>
                    </select>
                </div>
                
                <!-- 学期标题 -->
                <div class="term-title" id="currentTermTitle">
                    2023-2024学年 第一学期 第1周 (2023年09月01日 - 2023年09月07日)
                </div>

                <!-- 课表容器 -->
                <div class="schedule-container">
                    <table class="schedule-table" id="scheduleTable">
                        <thead>
                            <tr>
                                <th class="time-col">时间</th>
                                <th>周一</th>
                                <th>周二</th>
                                <th>周三</th>
                                <th>周四</th>
                                <th>周五</th>
                                <th>周六</th>
                                <th>周日</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 课表内容将通过JS动态生成 -->
                            <tr>
                                <td colspan="8" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">加载中...</span>
                                    </div>
                                    <p class="mt-2">正在加载课表数据...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>

    <!-- 课程详情模态框 -->
    <div class="modal fade" id="courseDetailModal" tabindex="-1" role="dialog" aria-labelledby="courseDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="courseDetailModalLabel">课程详情</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="course-detail">
                        <h4 id="detailCourseName">课程名称</h4>
                        <p class="text-muted" id="detailCourseCode">课程代码</p>
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>上课时间:</strong> <span id="detailCourseTime">周一 第1-2节</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>上课地点:</strong> <span id="detailCourseRoom">教学楼101</span></p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>学分:</strong> <span id="detailCourseCredit">3.0</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>人数:</strong> <span id="detailCourseStudents">45/50</span></p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <p><strong>教学班级:</strong> <span id="detailCourseClass">计算机科学1班，2班</span></p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <p><strong>课程描述:</strong></p>
                                <p id="detailCourseDesc" class="border p-2 bg-light">课程描述内容</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="gotoManageBtn">管理课程</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/bootstrap.bundle.min.js"></script>
    <script src="../static/js/api.js"></script>
    <script src="../static/js/teacherUI.js"></script>
    <script>
        $(document).ready(function() {
            // 初始化用户信息
            var userInfo = JSON.parse(localStorage.getItem('userInfo')) || {};
            $('.user-name').text(userInfo.name || '教师');
            
            // 用户菜单交互
            $('.user-info').click(function(e) {
                e.stopPropagation();
                $('.dropdown-menu').toggleClass('show');
            });
            
            $(document).click(function() {
                $('.dropdown-menu').removeClass('show');
            });

            // 加载学期下拉框
            loadTerms();
            
            // 加载课表
            loadSchedule();
            
            // 绑定学期选择事件
            $('#termSelect').on('change', function() {
                loadSchedule();
            });
            
            // 绑定周次选择事件
            $('#weekSelect').on('change', function() {
                loadSchedule();
            });
            
            // 绑定打印按钮事件
            $('#printScheduleBtn').on('click', function() {
                window.print();
            });
            
            // 绑定导出按钮事件
            $('#exportScheduleBtn').on('click', function() {
                exportSchedule();
            });
        });
        
        // 加载学期下拉框
        function loadTerms() {
            $('#termSelect').empty().append('<option value="">当前学期</option>');
            $('#termSelect').append('<option value="202301">2023-2024 第一学期</option>');
            $('#termSelect').append('<option value="202302">2023-2024 第二学期</option>');
            $('#termSelect').append('<option value="202201">2022-2023 第一学期</option>');
            $('#termSelect').append('<option value="202202">2022-2023 第二学期</option>');
            
            // 加载周次下拉框
            $('#weekSelect').empty().append('<option value="">全部</option>');
            for (let i = 1; i <= 20; i++) {
                $('#weekSelect').append('<option value="' + i + '">第' + i + '周</option>');
            }
        }
        
        // 加载课表
        function loadSchedule() {
            const termId = $('#termSelect').val();
            const weekNum = $('#weekSelect').val();
            
            // 显示加载中
            $('#scheduleTable tbody').html('<tr><td colspan="8" class="text-center py-5">' +
                '<div class="spinner-border text-primary" role="status">' +
                '<span class="sr-only">加载中...</span></div>' +
                '<p class="mt-2">正在加载课表数据...</p></td></tr>');
            
            // 移除loading-mask
            $('#loading-mask').hide();
            
            // 模拟调用API
            setTimeout(function() {
                API.teacher.getSchedule(function(success, data) {
                    if (success) {
                        // 更新学期标题
                        updateTermTitle(termId, weekNum);
                        
                        // 渲染课表
                        renderSchedule(data);
                    } else {
                        $('#scheduleTable tbody').html('<tr><td colspan="8" class="text-center py-5">' +
                            '<i class="fa fa-exclamation-circle text-warning fa-3x"></i>' +
                            '<p class="mt-3">加载课表失败: ' + data + '</p></td></tr>');
                    }
                });
            }, 1000);
        }
        
        // 更新学期标题
        function updateTermTitle(termId, weekNum) {
            let termText = "当前学期";
            if (termId) {
                const year = termId.substring(0, 4);
                const term = termId.substring(4, 6);
                termText = year + "-" + (parseInt(year) + 1) + "学年 第" + (term === "01" ? "一" : "二") + "学期";
            }
            
            let weekText = weekNum ? "第" + weekNum + "周" : "全部周次";
            
            // 获取当前日期范围
            const now = new Date();
            const firstDay = new Date(now);
            firstDay.setDate(now.getDate() - now.getDay() + 1);
            const lastDay = new Date(firstDay);
            lastDay.setDate(firstDay.getDate() + 6);
            
            const formatDate = function(date) {
                return date.getFullYear() + "年" + 
                       String(date.getMonth() + 1).padStart(2, '0') + "月" + 
                       String(date.getDate()).padStart(2, '0') + "日";
            };
            
            const dateRange = formatDate(firstDay) + " - " + formatDate(lastDay);
            
            $('#currentTermTitle').text(termText + " " + weekText + " (" + dateRange + ")");
        }
        
        // 渲染课表
        function renderSchedule(scheduleData) {
            const timeSlots = [
                { name: "第1节", time: "08:00-08:45" },
                { name: "第2节", time: "08:55-09:40" },
                { name: "第3节", time: "10:00-10:45" },
                { name: "第4节", time: "10:55-11:40" },
                { name: "第5节", time: "14:00-14:45" },
                { name: "第6节", time: "14:55-15:40" },
                { name: "第7节", time: "16:00-16:45" },
                { name: "第8节", time: "16:55-17:40" },
                { name: "第9节", time: "19:00-19:45" },
                { name: "第10节", time: "19:55-20:40" },
                { name: "第11节", time: "20:50-21:35" }
            ];
            
            // 模拟课表数据
            const mockSchedule = [
                { id: 1, name: "高等数学", code: "MATH101", classroom: "教学楼A101", dayOfWeek: 1, startSlot: 1, endSlot: 2, credit: 3, capacity: 50, studentCount: 45, classes: "数学1班,数学2班" },
                { id: 2, name: "大学英语", code: "ENG101", classroom: "教学楼B203", dayOfWeek: 2, startSlot: 3, endSlot: 4, credit: 2, capacity: 40, studentCount: 38, classes: "英语1班" },
                { id: 3, name: "数据结构", code: "CS201", classroom: "实验楼C305", dayOfWeek: 3, startSlot: 5, endSlot: 6, credit: 4, capacity: 35, studentCount: 30, classes: "计算机1班,计算机2班" },
                { id: 4, name: "计算机网络", code: "CS301", classroom: "实验楼D405", dayOfWeek: 4, startSlot: 7, endSlot: 8, credit: 3, capacity: 45, studentCount: 40, classes: "计算机2班,软件1班" },
                { id: 5, name: "编译原理", code: "CS401", classroom: "教学楼A505", dayOfWeek: 5, startSlot: 3, endSlot: 4, credit: 3, capacity: 30, studentCount: 28, classes: "计算机2班" }
            ];
            
            // 生成课表HTML
            let tableHtml = '';
            timeSlots.forEach((slot, index) => {
                tableHtml += '<tr>';
                tableHtml += '<td class="time-col">' + slot.name + '<br><small>' + slot.time + '</small></td>';
                
                // 周一到周日
                for (let day = 1; day <= 7; day++) {
                    const course = mockSchedule.find(c => c.dayOfWeek === day && c.startSlot <= (index + 1) && c.endSlot >= (index + 1));
                    if (course && course.startSlot === (index + 1)) {
                        const rowspan = course.endSlot - course.startSlot + 1;
                        tableHtml += '<td rowspan="' + rowspan + '">';
                        tableHtml += '<div class="schedule-course" data-course-id="' + course.id + '">';
                        tableHtml += '<div class="course-name">' + course.name + '</div>';
                        tableHtml += '<div class="course-room">' + course.classroom + '</div>';
                        tableHtml += '</div>';
                        tableHtml += '</td>';
                    } else if (!course || (course.startSlot !== (index + 1) && course.startSlot < (index + 1))) {
                        tableHtml += '<td></td>';
                    }
                }
                
                tableHtml += '</tr>';
            });
            
            $('#scheduleTable tbody').html(tableHtml);
            
            // 绑定课程点击事件
            $('.schedule-course').on('click', function() {
                const courseId = $(this).data('course-id');
                showCourseDetail(courseId);
            });
        }
        
        // 显示课程详情
        function showCourseDetail(courseId) {
            // 模拟课表数据
            const mockSchedule = [
                { id: 1, name: "高等数学", code: "MATH101", classroom: "教学楼A101", dayOfWeek: 1, startSlot: 1, endSlot: 2, credit: 3, capacity: 50, studentCount: 45, classes: "数学1班,数学2班", description: "本课程主要讲解微积分基础、极限、连续、导数、积分等内容。" },
                { id: 2, name: "大学英语", code: "ENG101", classroom: "教学楼B203", dayOfWeek: 2, startSlot: 3, endSlot: 4, credit: 2, capacity: 40, studentCount: 38, classes: "英语1班", description: "大学英语课程旨在提高学生的英语听说读写能力。" },
                { id: 3, name: "数据结构", code: "CS201", classroom: "实验楼C305", dayOfWeek: 3, startSlot: 5, endSlot: 6, credit: 4, capacity: 35, studentCount: 30, classes: "计算机1班,计算机2班", description: "本课程讲解常用数据结构及其算法，包括线性表、栈、队列、树、图等。" },
                { id: 4, name: "计算机网络", code: "CS301", classroom: "实验楼D405", dayOfWeek: 4, startSlot: 7, endSlot: 8, credit: 3, capacity: 45, studentCount: 40, classes: "计算机2班,软件1班", description: "计算机网络课程介绍网络通信原理、TCP/IP协议族等内容。" },
                { id: 5, name: "编译原理", code: "CS401", classroom: "教学楼A505", dayOfWeek: 5, startSlot: 3, endSlot: 4, credit: 3, capacity: 30, studentCount: 28, classes: "计算机2班", description: "编译原理课程讲解词法分析、语法分析、语义分析和代码生成等内容。" }
            ];
            
            const course = mockSchedule.find(c => c.id === courseId);
            if (!course) return;
            
            // 填充课程详情
            $('#detailCourseName').text(course.name);
            $('#detailCourseCode').text(course.code);
            
            // 获取上课时间
            const weekdays = ["周一", "周二", "周三", "周四", "周五", "周六", "周日"];
            const courseTime = weekdays[course.dayOfWeek - 1] + " 第" + course.startSlot + "-" + course.endSlot + "节";
            $('#detailCourseTime').text(courseTime);
            
            $('#detailCourseRoom').text(course.classroom);
            $('#detailCourseCredit').text(course.credit);
            $('#detailCourseStudents').text(course.studentCount + "/" + course.capacity);
            $('#detailCourseClass').text(course.classes);
            $('#detailCourseDesc').text(course.description || "暂无课程描述");
            
            // 显示模态框
            $('#courseDetailModal').modal('show');
            
            // 绑定管理课程按钮事件
            $('#gotoManageBtn').off('click').on('click', function() {
                window.location.href = 'courses.html';
            });
        }
        
        // 导出课表
        function exportSchedule() {
            alert('课表导出功能开发中...');
        }
        
        // 退出登录
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                localStorage.removeItem('token');
                localStorage.removeItem('userInfo');
                window.location.href = '../index.html';
            }
        }
    </script>
</body>
</html> 